"use strict";(self["webpackChunkgl_starter"]=self["webpackChunkgl_starter"]||[]).push([[4233],{13579:function(e,t,i){var s=i(57195),r=i(16203);const h=34963;class a extends s.Z{constructor(e,t=e.UNSIGNED_SHORT,i,s=e.STATIC_DRAW,r){super(),this.gl=e,this.usage=s,this.buffer=void 0!==r?r:e.createBuffer(),this.type=0,this.typeSize=0,this.byteLength=0,this.setType(t),i&&this.data(i)}bind(){this.gl.bindBuffer(h,this.buffer)}setType(e){this.type=e,this.typeSize=(0,r.Z4)(e)}data(e){const t=this.gl;t.bindBuffer(h,this.buffer),t.bufferData(h,e,this.usage),t.bindBuffer(h,null),this.byteLength=(0,r.$P)(e)?e.byteLength:e}subData(e,t){const i=this.gl;i.bindBuffer(h,this.buffer),i.bufferSubData(h,t,e),i.bindBuffer(h,null)}dispose(){this.gl.deleteBuffer(this.buffer)}draw(e,t,i=0){t=void 0===t?this.byteLength/this.typeSize:t,this.gl.drawElements(e,t,this.type,0|i)}}t["Z"]=a},22999:function(e,t,i){function s(e){return e.startsWith("/")&&(e=e.substring(1)),i.p+e}i.d(t,{Z:function(){return s}})},84233:function(e,t,i){i.r(t),i.d(t,{default:function(){return T}});var s=i(2262),r=i(65031),h=i(63887),a=i(85645),n=i(1579),o=i(97703),c=i(13579),d=i(18158),l=i(61987),u=i(31236),v=i(46009),g=i(22999);class f{constructor(e,t={}){this.handleScroll=e=>{const t=Date.now();this.isCooldownActive&&t-this.lastEventTime<this.cooldownTime||(this.isCooldownActive=!1,this.accumulatedDelta+=e.deltaY,Math.abs(this.accumulatedDelta)>=this.threshold&&(this.callback(this.accumulatedDelta>0?"down":"up"),this.accumulatedDelta=0,this.isCooldownActive=!0,this.lastEventTime=t))},this.callback=e,this.threshold=t.threshold||100,this.cooldownTime=t.cooldownTime||750,this.accumulatedDelta=0,this.lastEventTime=0,this.isCooldownActive=!1}}const w=(e,t=300)=>{let i;return function(...s){clearTimeout(i),i=setTimeout((()=>e.apply(this,s)),t)}},p=h.vec3.create(),m=h.mat4.create();class T{constructor(e){if(this.renderer=e,this.accumulatedDeltaY=0,this.threshold=100,this.eventTriggered=!1,this.startY=0,this.onScroll=e=>{if(!this.eventTriggered&&(this.accumulatedDeltaY+=e.deltaY,Math.abs(this.accumulatedDeltaY)>=this.threshold)){const e=this.accumulatedDeltaY>0?"down":"up";this.onNavigation(e),this.accumulatedDeltaY=0}},this.onTouchStart=e=>{this.startY=e.touches[0].clientY,this.eventTriggered=!1},this.onTouchMove=e=>{if(this.eventTriggered)return;const t=e.touches[0].clientY,i=this.startY-t;if(Math.abs(i)>=this.threshold){const e=i>0?"down":"up";this.onNavigation(e),this.startY=t}},this.setArchive=async e=>{var t;const i=o["default"].state.getSnapshot().context.step,s=null===(t=this.archives[e])||void 0===t?void 0:t.allImgLoaded;!this.eventTriggered&&s&&i!==e&&(this.eventTriggered=!0,this.archives[i].resumeAnimation(),await this.archives[i].canNextEnter(),this.nextArchive=e,this.archives[this.nextArchive].start(),await this.archives[i].animationEnded(),this.currentArchive=this.nextArchive,this.archives[i].stop())},this.gotoArchive=async e=>{this.eventTriggered||(await this.setArchive(e),o["default"].state.send("SET_STEP",{step:e}),this.eventTriggered=!1)},this.onNavigation=async e=>{if(this.eventTriggered)return;const t=o["default"].state.getSnapshot().context.step;let i="up"===e?t-1:t+1;const s=i>this.archives.length-1||i<0;s&&(i=i<0?this.archives.length-1:0),await this.setArchive(i),s?o["default"].state.send("SET_STEP",{step:i}):"up"===e?o["default"].state.send("PREV"):o["default"].state.send("NEXT"),this.eventTriggered=!1},this.quadData=new Float32Array([-1,-1,1,0,0,1,-1,1,1,0,1,1,1,1,1,-1,1,1,0,1]),this.prg=(0,u["default"])(this.renderer.gl).get("archivesManager"),this.wNoise=this.renderer.scene.texturePool.get("whiteNoise").texture,this.createCamera(),this.uSaturation=1.15,this.canChangeStep=(0,s.iH)(!0),!T.worker){const e=(0,g.Z)("js/archives.worker.js");T.worker=new Worker(e),this.initWorkerMessage()}this.scrollNormalizer=new f((e=>{this.onNavigation(e)}),{threshold:100,cooldownTime:1e3}),this.onTouchMoveDebounced=w(this.onTouchMove,100)}initWorkerMessage(){T.worker.onmessage=({data:e})=>{const{imageBase64:t,layerIndex:i,frameIndex:s,key:r}=e,h=this.archives[r];h&&h.handleWorkerMessage(t,i,s)}}static getWorker(){return T.worker}createDebug(){const e=v.Z.folder("Archives");e.add(this,"uSaturation",{min:0,max:2,step:.01})}createRenderQuad(){this.buffer=new d.Z(this.renderer.gl,this.quadData),this.bufferIndex=new c.Z(this.renderer.gl,this.renderer.gl.UNSIGNED_SHORT,new Uint16Array([0,1,2,0,2,3])),this.buffer.attrib("aPosition",3,this.renderer.gl.FLOAT),this.buffer.attrib("aTexCoord",2,this.renderer.gl.FLOAT),this.node=new l.Z,this.node.scale.set([1.6,1,1.6]),this.node.invalidate(),this.node.updateWorldMatrix()}createCamera(){this.archiveCam=new a.Z(new n.Z),this.archiveCam.lens.near=.1,this.archiveCam.lens.far=50,this.archiveCam.z=5,this.archiveCam.lookAt(p)}onResize(){const e=Math.max(window.innerHeight/window.innerWidth,1),t=Math.max(window.innerWidth/window.innerHeight,1),i=1;this.archiveCam.lens.setBound(-i*t,i*t,-i*e,i*e)}async initArchives(){const e=(await Promise.all([i.e(9400),i.e(9650),i.e(6478),i.e(8997)]).then(i.bind(i,48997))).default;this.archives=[];for(let t=0;t<4;t++)this.archives.push(new e(this.renderer,this.archiveCam,t))}async load(){await this.initArchives()}unload(){this.stop(),this.archives.forEach((e=>e.stop()))}start(){const e=o["default"].state.getSnapshot().context.step;this.currentArchive=e||0,this.nextArchive=void 0,this.createRenderQuad(),this.onResize(),this.renderer.postprocess.enabled=!1,this.tPlaceholder=new r.Z(this.renderer.gl,this.renderer.gl.RGBA),this.tPlaceholder.fromData(1,1,new Uint8Array([0,0,0,0])),this.archives[this.currentArchive].start(),window.addEventListener("resize",this.onResize.bind(this)),window.addEventListener("wheel",this.scrollNormalizer.handleScroll,{passive:!1}),window.addEventListener("touchstart",this.onTouchStart,{passive:!1}),window.addEventListener("touchmove",this.onTouchMoveDebounced,{passive:!1})}async animeOut(){this.archives[this.currentArchive].resumeAnimation(),await this.archives[this.currentArchive].animationEnded(),this.renderer.scene.prepareTransition(!0),o["default"].state.send("GO_TO_SCENE")}stop(){this.archives.forEach((e=>e.stop())),this.renderer.postprocess.enabled=!0,this.buffer.dispose(),this.bufferIndex.dispose(),this.tPlaceholder.dispose(),this.archives.every((e=>e.allImgLoaded))&&T.worker.terminate(),window.removeEventListener("resize",this.onResize.bind(this)),window.removeEventListener("wheel",this.scrollNormalizer.handleScroll),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMoveDebounced)}preRender(){var e,t;this.canChangeStep.value=!this.eventTriggered,null===(e=this.archives[this.currentArchive])||void 0===e||e.preRender(),void 0!==this.nextArchive&&this.nextArchive!==this.currentArchive&&(null===(t=this.archives[this.nextArchive])||void 0===t||t.preRender())}rttPass(){var e,t;null===(e=this.archives[this.currentArchive])||void 0===e||e.rttPass(),void 0!==this.nextArchive&&this.nextArchive!==this.currentArchive&&(null===(t=this.archives[this.nextArchive])||void 0===t||t.rttPass())}render(){this.renderer.gl.clearColor(239/255,234/255,218/255,0),this.renderer.gl.clear(this.renderer.gl.COLOR_BUFFER_BIT),this.archiveCam.updateWorldMatrix(),this.archiveCam.updateViewProjectionMatrix(this.renderer.viewport.width,this.renderer.viewport.height),this.archiveCam.modelViewProjectionMatrix(m,this.node._wmatrix),this.prg.use(),this.prg.uMVP(m),this.prg.uSaturation(this.uSaturation),this.prg.uWNoiseTex(this.wNoise),this.prg.uRez(this.renderer.viewport.width,this.renderer.viewport.height),this.prg.uCurrentTex(this.archives[this.currentArchive].fbo.getColorTexture()),void 0!==this.nextArchive&&this.nextArchive!==this.currentArchive?this.prg.uNextTex(this.archives[this.nextArchive].fbo.getColorTexture()):this.prg.uNextTex(this.tPlaceholder),this.buffer.attribPointer(this.prg),this.bufferIndex.bind(),this.bufferIndex.drawTriangles()}}}}]);
//# sourceMappingURL=4233.2ef4966c.js.map