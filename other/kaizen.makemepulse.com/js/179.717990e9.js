(self["webpackChunkgl_starter"]=self["webpackChunkgl_starter"]||[]).push([[179],{38617:function(t){var e=function(t){var e="";return e+="\n#ifndef _H_DECODE_RGBD_\n#define _H_DECODE_RGBD_\n\nvec3 decodeRGBD(vec4 rgbd)\n{\n  return rgbd.rgb / rgbd.a;\n}\n\n#endif",e};e.toString=e,t.exports=e,e.onHmr=function(){}},64419:function(t){var e=function(t){var e="";return e+="\n#ifndef _H_DECODE_RGBE_\n#define _H_DECODE_RGBE_\n\nvec3 decodeRGBE( vec4 hdr ){\n  return hdr.rgb * exp2( (hdr.a*255.0)-128.0 );\n  // return hdr.rgb * pow( 2.0, (hdr.a*255.0)-128.0 );\n}\n\n#endif",e};e.toString=e,t.exports=e,e.onHmr=function(){}},9641:function(t){var e=function(t){var e="";return e+="\n#ifndef _H_DECODE_RGBM_\n#define _H_DECODE_RGBM_\n\nvec3 decodeRGBM16( vec4 rgbm ){\n  vec3 c = ( rgbm.rgb * 16.0 * rgbm.a );\n  return c*c;\n}\n\n#endif",e};e.toString=e,t.exports=e,e.onHmr=function(){}},96953:function(t){var e=function(t){var e="";return e+="#ifndef _H_IBLBOXPROJECTION_\n#define _H_IBLBOXPROJECTION_\n\n\n#if enableBoxProjection\n  uniform vec3 uBoxProjMin;\n  uniform vec3 uBoxProjMax;\n  uniform vec3 uBoxProjPos;\n\n  vec3 _iblBoxProj( vec3 reflectionWS, vec3 positionWS ) {\n\n    vec3 boxMinMax = vec3(\n      (reflectionWS.x > 0.0) ? uBoxProjMax.x : uBoxProjMin.x,\n      (reflectionWS.y > 0.0) ? uBoxProjMax.y : uBoxProjMin.y,\n      (reflectionWS.z > 0.0) ? uBoxProjMax.z : uBoxProjMin.z\n    );\n\n    vec3 rbMinMax = (boxMinMax - positionWS) / reflectionWS;\n\n    float fa = min(min(rbMinMax.x, rbMinMax.y), rbMinMax.z);\n\n    vec3 worldPos = positionWS - uBoxProjPos;\n\n    vec3 result = worldPos + reflectionWS * fa;\n    return result;\n  }\n\n#endif\n\nvec3 IblBoxProjection(vec3 reflectionWS, vec3 positionWS ){\n  #if enableBoxProjection\n  return _iblBoxProj( reflectionWS, positionWS );\n  #else\n  return reflectionWS;\n  #endif\n}\n\n#endif",e};e.toString=e,t.exports=e,e.onHmr=function(){}},53394:function(t){var e=function(t){var e="";return e+="#ifndef _H_IBLROTATION_\n#define _H_IBLROTATION_\n\n\n#if enableRotation\n  uniform mat3 uEnvMatrix;\n#endif\n\nvec3 IblRotateDir(vec3 dir){\n  #if enableRotation\n  return uEnvMatrix * dir;\n  #else\n  return dir;\n  #endif\n}\n\n#endif",e};e.toString=e,t.exports=e,e.onHmr=function(){}},69045:function(t){var e=function(t){var e="";return e+="\n#ifndef _H_OCTWRAP_DECODE_\n#define _H_OCTWRAP_DECODE_\n\nvec2 octwrapDecode( vec3 v ) {\n  // Project the sphere onto the octahedron, and then onto the xy plan\n  vec2 p = v.xy / dot(  abs( v ) , vec3(1.0) );\n  p = vec2( p.x+p.y-1.0, p.x-p.y );\n\n  if( v.z < 0.0 )\n    p.x *= -1.0;\n\n  // p.x *= sign( v.z );\n  return p;\n}\n\n#endif",e};e.toString=e,t.exports=e,e.onHmr=function(){}},99195:function(t){var e=function(t){var e="";return e+='#ifndef _H_SAMPLE_SH_\n#define _H_SAMPLE_SH_\n\n// ================================\n// compute Spherical Harmonics\n// ================================\n//\n// "Stupid Spherical Harmonics (SH) Tricks"\n// http://www.ppsloan.org/publications/StupidSH36.pdf\n//\n//\nvec3 SampleSH7( vec3 Normal, vec4 shCoefs[7] )\n{\n  Normal.xz = Normal.zx;\n  vec4 NormalVector = vec4(Normal, 1.0);\n\n  // todo transpose coeffs directly\n  // NormalVector.xyz = NormalVector.zyx;\n\n  vec3 X0, X1, X2;\n  X0.x = dot( shCoefs[0].xyz, Normal) + shCoefs[0].w;\n  X0.y = dot( shCoefs[1].xyz, Normal) + shCoefs[1].w;\n  X0.z = dot( shCoefs[2].xyz, Normal) + shCoefs[2].w;\n\n  vec4 vB = NormalVector.zyxx * NormalVector.yxxz;\n  X1.x = dot( shCoefs[3].xyz, vB.xyz) + (shCoefs[3].w * vB.w);\n  X1.y = dot( shCoefs[4].xyz, vB.xyz) + (shCoefs[4].w * vB.w);\n  X1.z = dot( shCoefs[5].xyz, vB.xyz) + (shCoefs[5].w * vB.w);\n\n  float vC = NormalVector.z * NormalVector.z - NormalVector.y * NormalVector.y;\n  X2 =  shCoefs[6].xyz * vC;\n\n  return ( X0 + X1 + X2 );\n//  return max( vec3(0.0) , X0 + X1 + X2 );\n}\n\n#endif\n',e};e.toString=e,t.exports=e,e.onHmr=function(){}},74176:function(t){var e=function(t){var e="";return e+="#ifndef _H_SAMPLE_SH_\n#define _H_SAMPLE_SH_\n\n// ================================\n// compute Spherical Harmonics\n// ================================\n//\n// 5.3.4.1\n// Diffuse BRDF integration\n// https://google.github.io/filament/Filament.md.html#lighting/imagebasedlights/distantlightprobes\nvec3 SampleSH9( vec3 Normal, vec3 shCoeffs[9] )\n{\n\n  vec3 n = Normal;\n  vec3 value = \n        shCoeffs[0]\n      + shCoeffs[1] * (n.y)\n      + shCoeffs[2] * (n.z)\n      + shCoeffs[3] * (n.x)\n      + shCoeffs[4] * (n.y * n.x)\n      + shCoeffs[5] * (n.y * n.z)\n      + shCoeffs[6] * (3.0 * n.z * n.z - 1.0)\n      + shCoeffs[7] * (n.z * n.x)\n      + shCoeffs[8] * (n.x * n.x - n.y * n.y);\n\n  return max(vec3(0.0), value);\n\n}\n\n\n#endif\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},23478:function(t){var e=function(t){var e="";return e+="\n{\n  Light light;\n\n  light.direction = uLDirDirections  ["+t.index+"]    ;\n  light.color     = uLDirColors      ["+t.index+"].rgb;\n  light.attenuation = 1.0;\n\n  ",t.shadowIndex>-1?e+="\n    ShadowMapData shadowmapData = GET_SHADOWMAP_DATA( "+t.shadowIndex+" );\n    light.shadowAttenuation = SampleShadowAttenuation(shadowmapData, tShadowMap"+t.shadowIndex+", geometryData.worldPos, geometryData.worldNrm );\n  ":e+="\n    light.shadowAttenuation = 1.0;\n  ",e+="\n\n  LightingPhysicallyBased(brdfData,  geometryData, lightingData, light );\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},66980:function(t){var e=function(t){var e="";return e+="#define NUM_D_LIGHTS "+t.count+"\n\n",t.count>0&&(e+="\nuniform vec3 uLDirDirections [NUM_D_LIGHTS];\nuniform vec4 uLDirColors     [NUM_D_LIGHTS]; // rgb + iblShadowing\n"),e+="\n\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},96658:function(t,e,n){var i=function(t){var e="";return e+="#ifndef _H_IBL_PRE_F_SH_\n#define _H_IBL_PRE_F_SH_\n\n  #if perVertexIrrad\n    IN vec3 vIrradiance;\n  #else\n  \n    #if shFormat( SH7 )\n      uniform vec4 uSHCoeffs[7];\n      "+n(99195)()+"\n      #define SampleSH(dir, coeffs) SampleSH7(dir, coeffs)\n    #endif\n    \n    #if shFormat( SH9 )\n      uniform vec3 uSHCoeffs[9];\n      "+n(74176)()+"\n      #define SampleSH(dir, coeffs) SampleSH9(dir, coeffs)\n    #endif\n\n  #endif\n\n#endif\n",e};i.toString=i,t.exports=i,i.onHmr=function(){}},4694:function(t,e,n){var i=function(t){var e="";return e+="#ifndef _H_SPECULAR_IBL_\n#define _H_SPECULAR_IBL_\n\n"+n(53394)()+"\n"+n(96953)()+"\n\n\n#if iblHdrEncoding( RGBM )\n  "+n(9641)()+"\n  #define DECODE_HDR( x ) decodeRGBM16( x )\n#elif iblHdrEncoding( RGBE )\n  "+n(64419)()+"\n  #define DECODE_HDR( x ) decodeRGBE( x )\n#elif iblHdrEncoding( RGBD )\n  "+n(38617)()+"\n  #define DECODE_HDR( x ) decodeRGBD( x )\n#endif\n\n"+n(96658)()+"\n\n\n\nvec3 ComputeIBLDiffuse( vec3 worldNormal ){\n  // TODO: the model should set this varying in vertex shader\n  #if perVertexIrrad\n    return vIrradiance;\n  #else\n    return SampleSH(IblRotateDir(worldNormal), uSHCoeffs )*iblIntensities().x;\n  #endif\n}\n#endif\n\n/* =========================================================\n  OCTA\n========================================================= */\n#if iblFormat( OCTA )\n  \n\n  #define OCTA_LEVELS iblNumMipLevel()\n  #define OCTA_MAXLOD (OCTA_LEVELS-1.0)\n\n  "+n(69045)()+"\n\n  uniform sampler2D tEnv;\n\n  #define SpecularIBL( skyDir, perceptualRoughness, wpos ) SampleIBL( skyDir, perceptualRoughness, wpos )*iblIntensities().y\n\n  const vec2 _IBL_UVM = vec2(\n    0.25*(254.0/256.0),\n    0.125*0.5*(254.0/256.0)\n  );\n\n  vec3 SampleIBL( vec3 skyDir, float perceptualRoughness, vec3 wpos)\n  {\n    skyDir = IblBoxProjection(skyDir, wpos);\n    skyDir = IblRotateDir(skyDir);\n    vec2 uvA = octwrapDecode( skyDir );\n    \n    float lodLevel   = OCTA_MAXLOD*perceptualRoughness * (2.0 - perceptualRoughness);\n    float frac = fract(lodLevel);\n\n    uvA = uvA * _IBL_UVM + vec2(\n      0.5,\n      0.125*0.5 + 0.125 * ( lodLevel - frac )\n    );\n\n    #if glossNearest\n\n      return DECODE_HDR( texture2D(tEnv,uvA) );\n\n    #else\n\n      vec2 uvB=uvA+vec2(0.0,0.125);\n      return  mix(\n        DECODE_HDR( texture2D(tEnv,uvA) ),\n        DECODE_HDR( texture2D(tEnv,uvB) ),\n        frac\n      );\n\n    #endif\n\n  }\n\n\n/* =========================================================\n  PMREM\n========================================================= */\n#elif iblFormat( PMREM ) && __VERSION__ == 300\n\n  // assume 256 to 16 mip levels\n  #define PMREM_LEVELS iblNumMipLevel()\n  #define PMREM_MAXLOD (PMREM_LEVELS-1.0)\n  \n  uniform samplerCube tEnv;\n\n  #define SpecularIBL( skyDir, perceptualRoughness, wpos ) SampleIBLPMRem( skyDir, perceptualRoughness, wpos )*iblIntensities().y\n\n  vec3 SampleIBLPMRem( vec3 skyDir, float perceptualRoughness, vec3 wpos)\n  {\n    skyDir = IblBoxProjection(skyDir, wpos);\n    skyDir = IblRotateDir(skyDir);\n\n    float lodLevel   = PMREM_MAXLOD*perceptualRoughness * (2.0 - perceptualRoughness);\n    // float lodLevel   = PMREM_MAXLOD*perceptualRoughness;\n    return DECODE_HDR( textureLod( tEnv, skyDir, lodLevel) );\n  }\n\n\n#endif\n\n\n\n",e};i.toString=i,t.exports=i,i.onHmr=function(){}},27734:function(t){var e=function(t){var e="";return e+="EnvironmentBRDF( brdfData, geometryData, lightingData, surface.occlusion );",e};e.toString=e,t.exports=e,e.onHmr=function(){}},70275:function(t){var e=function(t){var e="";return e+="\n{\n  vec3 lightPositionWS                    = uLPointPositions ["+t.index+"].xyz;\n  mediump vec3 lightColor                 = uLPointColors    ["+t.index+"].rgb;\n\n  vec3 lightVector = lightPositionWS - geometryData.worldPos;\n  float distanceSqr = dot(lightVector, lightVector);\n\n  mediump vec3 lightDirection = vec3(lightVector * inversesqrt(distanceSqr));\n\n  ",t.infinite?e+="\n    mediump float attenuation = DistanceAttenuation(distanceSqr);\n  ":e+="\n    float oneOverRangeSquared = uLPointPositions["+t.index+"].w;\n    mediump float attenuation = DistanceAttenuationRange(distanceSqr, vec2(oneOverRangeSquared, 0.0));\n  ",e+="\n\n\n  Light light;\n  light.direction = lightDirection;\n  light.attenuation = attenuation;\n  light.color = lightColor;\n  light.shadowAttenuation = 1.0;\n  \n  LightingPhysicallyBased(brdfData,  geometryData, lightingData, light );\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},85996:function(t){var e=function(t){var e="";return e+="#define NUM_P_LIGHTS "+t.count+"\n\n",t.count>0&&(e+="\nuniform vec4 uLPointPositions  [NUM_P_LIGHTS]; //w is radius\nuniform vec3 uLPointFalloff    [NUM_P_LIGHTS];\nuniform vec3 uLPointColors     [NUM_P_LIGHTS]; // rgb\n"),e+="\n\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},92050:function(t){var e=function(t){var e="";return e+="\n// post light setup\n// todo: should not be\n// specularColor += lSpecularColor * input.specularF0;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},55265:function(t){var e=function(t){var e="";return e+="",e};e.toString=e,t.exports=e,e.onHmr=function(){}},99114:function(t){var e=function(t){var e="";e+="\n\n#define SHADOW_COUNT "+t.shadowCount+"\n\n#if __VERSION__ == 300\n  precision lowp sampler2DShadow;\n\n  #define DepthSampler sampler2DShadow\n  \n#else\n  #define DepthSampler sampler2D\n#endif\n\n\n";for(var n=0;n<t.shadowCount;n++)e+="\n  uniform DepthSampler tShadowMap"+n+";\n";return e+="\n\n\n\n\nuniform highp vec2 uShadowKernelRotation;\nuniform highp mat4 uShadowMatrices[SHADOW_COUNT];\nuniform highp vec4 uShadowTexelBiasVector[SHADOW_COUNT];\nuniform       vec2 uShadowMapSize[SHADOW_COUNT];\n\n\nstruct ShadowMapData {\n  mat4 projection;\n  vec4 texelBiasVector;\n  vec2 size; // size , 1/size\n};\n\n#define GET_SHADOWMAP_DATA(i) ShadowMapData( uShadowMatrices[i], uShadowTexelBiasVector[i], uShadowMapSize[i])\n\n\n// RGB depth decoding\n// ------------------\nhighp float decodeDepthRGB(highp vec3 rgb){\n  return(rgb.x+rgb.y*(1.0/255.0))+rgb.z*(1.0/65025.0);\n}\n\n\n#if __VERSION__ == 300\n  \n      \n  float textureShadow( DepthSampler t, float ref, vec2 uvs ){\n    return texture(t, vec3( uvs, ref ) );\n  }\n\n  vec2 textureShadow( DepthSampler t, float ref, vec4 uvs ){\n    \n    return vec2(\n      texture(t, vec3( uvs.xy, ref ) ),\n      texture(t, vec3( uvs.zw, ref ) )\n    );\n\n  }\n\n  vec4 textureShadow( DepthSampler t, float ref, vec4 uvs0, vec4 uvs1 ){\n    \n    return vec4(\n      texture(t, vec3( uvs0.xy, ref ) ),\n      texture(t, vec3( uvs0.zw, ref ) ),\n      texture(t, vec3( uvs1.xy, ref ) ),\n      texture(t, vec3( uvs1.zw, ref ) )\n    );\n\n  }\n\n\n\n#else\n\n\n\n  #if depthFormat( D_RGB )\n    float FETCH_DEPTH( DepthSampler t, vec2 uvs ){\n      return decodeDepthRGB( texture2D(t,uvs).xyz );\n    }\n    //define FETCH_DEPTH(t,uvs) decodeDepthRGB( texture2D(t,uvs).xyz )\n  #endif\n\n  #if depthFormat( D_DEPTH )\n    float FETCH_DEPTH( DepthSampler t, vec2 uvs ){\n      return texture2D(t,uvs).x;\n    }\n    //define FETCH_DEPTH(t,uvs) texture2D(t,uvs).x\n  #endif\n\n  \n  float textureShadow( DepthSampler t, float ref, vec2 uvs ){\n    return step( ref, FETCH_DEPTH(t,uvs));\n  }\n\n  vec2 textureShadow( DepthSampler t, float ref, vec4 uvs ){\n    \n    vec2 occl = vec2(\n      FETCH_DEPTH(t,uvs.xy),\n      FETCH_DEPTH(t,uvs.zw)\n    );\n\n    return step( vec2(ref), occl );\n  }\n\n  vec4 textureShadow( DepthSampler t, float ref, vec4 uvs0, vec4 uvs1 ){\n    \n    vec4 occl = vec4(\n      FETCH_DEPTH(t,uvs0.xy),\n      FETCH_DEPTH(t,uvs0.zw),\n      FETCH_DEPTH(t,uvs1.xy),\n      FETCH_DEPTH(t,uvs1.zw)\n    );\n\n    return step( vec4(ref), occl );\n  }\n\n#endif\n\n\n\n\n\n\n\nfloat resolveShadowNoFiltering(highp float fragZ, DepthSampler depth,highp vec2 uv ){\n    return textureShadow( depth, fragZ, uv );\n}\n\n\n#if __VERSION__ == 300\n  // Bilinear is natively supported in ES3\n  // Shadowmap filtering must be set by sampler2DShadow filter parameter\n\n  float resolveShadow2x1(highp float fragZ, DepthSampler depth,highp vec2 uv, vec2 mapSize ){\n    return textureShadow( depth, fragZ, uv );\n  }\n\n  float resolveShadow2x2(highp float fragZ, DepthSampler depth,highp vec2 uv, vec2 mapSize ){\n    return textureShadow( depth, fragZ, uv );\n  }\n\n#else\n\n  float resolveShadow2x1(highp float fragZ, DepthSampler depth,highp vec2 uv, vec2 mapSize ){\n\n    highp float coordsPx = uv.x*mapSize.x;\n    highp float uvMin = floor( coordsPx ) * mapSize.y;\n    highp float uvMax = ceil(  coordsPx ) * mapSize.y;\n\n    vec2 occl = textureShadow( depth, fragZ, vec4(\n      uvMin,uv.y,\n      uvMax,uv.y\n    ));\n\n    highp float ratio = coordsPx - uvMin*mapSize.x;\n    return ( ratio * occl.y + occl.x ) - ratio * occl.x;\n\n  }\n\n  float resolveShadow2x2(highp float fragZ, DepthSampler depth,highp vec2 uv, vec2 mapSize ){\n\n    highp vec2 coordsPx = uv*mapSize.x;\n    highp vec2 uvMin=floor( coordsPx ) *mapSize.y;\n    highp vec2 uvMax=ceil(  coordsPx ) *mapSize.y;\n\n    vec4 occl = textureShadow( depth, fragZ, \n      vec4(\n        uvMin,\n        vec2(uvMax.x,uvMin.y)\n      ),\n      vec4(\n        vec2(uvMin.x,uvMax.y),\n        uvMax\n      )\n    );\n\n    highp vec2 ratio = coordsPx - uvMin*mapSize.x;\n    vec2  t = ( ratio.y * occl.zw + occl.xy ) - ratio.y * occl.xy;\n\n    return(ratio.x*t.y+t.x)-ratio.x*t.x;\n  }\n\n#endif\n\n\nfloat calcLightOcclusions(DepthSampler depth, highp vec3 fragCoord, vec2 mapSize ){\n  float s;\n\n  highp vec2 kernelOffset = uShadowKernelRotation * mapSize.y;\n\n  // NO FILTER\n  #if shadowFilter( PCFNONE )\n\n    s = resolveShadowNoFiltering( fragCoord.z, depth, fragCoord.xy );\n  #endif\n\n  // PCF4x1\n  #if shadowFilter( PCF4x1 )\n\n    s = resolveShadowNoFiltering( fragCoord.z, depth, fragCoord.xy + kernelOffset                    );\n    s+= resolveShadowNoFiltering( fragCoord.z, depth, fragCoord.xy - kernelOffset                    );\n    s+= resolveShadowNoFiltering( fragCoord.z, depth, fragCoord.xy + vec2(-kernelOffset.y,kernelOffset.x)  );\n    s+= resolveShadowNoFiltering( fragCoord.z, depth, fragCoord.xy + vec2(kernelOffset.y,-kernelOffset.x)  );\n    s /= 4.0;\n  #endif\n\n  // PCF4x4\n  #if shadowFilter( PCF4x4 )\n\n    s = resolveShadow2x2( fragCoord.z, depth, fragCoord.xy + kernelOffset                         , mapSize );\n    s+= resolveShadow2x2( fragCoord.z, depth, fragCoord.xy - kernelOffset                         , mapSize );\n    s+= resolveShadow2x2( fragCoord.z, depth, fragCoord.xy + vec2(-kernelOffset.y,kernelOffset.x) , mapSize );\n    s+= resolveShadow2x2( fragCoord.z, depth, fragCoord.xy + vec2(kernelOffset.y,-kernelOffset.x) , mapSize );\n    s /= 4.0;\n  #endif\n\n  // PCF2x2\n  #if shadowFilter( PCF2x2 )\n\n    s = resolveShadow2x1( fragCoord.z, depth, fragCoord.xy + kernelOffset , mapSize);\n    s+= resolveShadow2x1( fragCoord.z, depth, fragCoord.xy - kernelOffset , mapSize);\n    s /= 2.0;\n  #endif\n\n\n  if( any( greaterThan( abs( fragCoord - vec3(.5) ), vec3(.5) ) ) ){\n    s = 1.0;\n  }\n\n  return s;\n\n}\n\n// float3 ApplyShadowBias(float3 positionWS, float3 normalWS, float3 lightDirection)\n// {\n//     float invNdotL = 1.0 - saturate(dot(lightDirection, normalWS));\n//     float scale = invNdotL * _ShadowBias.y;\n\n//     // normal bias is negative since we want to apply an inset normal offset\n//     positionWS = lightDirection * _ShadowBias.xxx + positionWS;\n//     positionWS = normalWS * scale.xxx + positionWS;\n//     return positionWS;\n// }\n\nvec3 calcShadowPosition( vec4 texelBiasVector, mat4 shadowProjection, vec3 worldPos, vec3 worldNormal, float invMapSize )\n{\n  float WoP = dot( texelBiasVector, vec4( worldPos, 1.0 ) );\n\n  WoP *= .0005+2.0*invMapSize;\n\n  highp vec4 fragCoord = shadowProjection * vec4( worldPos + WoP * worldNormal, 1.0);\n  return fragCoord.xyz / fragCoord.w;\n}\n\n\n\nvec3 calcShadowPosition( ShadowMapData shadowmap, vec3 worldPos, vec3 worldNormal )\n{\n  float WoP = dot( shadowmap.texelBiasVector, vec4( worldPos, 1.0 ) );\n\n  WoP *= .005+2.0*shadowmap.size.y;\n\n  highp vec4 fragCoord = shadowmap.projection * vec4( worldPos + WoP * worldNormal, 1.0);\n  return fragCoord.xyz / fragCoord.w;\n}\n\n\nmediump float SampleShadowAttenuation( ShadowMapData shadowmap, DepthSampler texture, vec3 worldPos, vec3 worldNormal  ) {\n  highp vec3 coords = calcShadowPosition( shadowmap, worldPos, worldNormal );\n  return calcLightOcclusions( texture, coords, shadowmap.size );\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},12637:function(t){var e=function(t){var e="";return e+="\n{\n  vec3 lightPositionWS                    = uLSpotPositions  ["+t.index+"]    ;\n  mediump vec3 spotDirection              = uLSpotDirections ["+t.index+"]    ;\n  mediump vec3 lightColor                 = uLSpotColors     ["+t.index+"].rgb;\n  mediump vec4 distanceAndSpotAttenuation = uLSpotAttenuation["+t.index+"]    ;\n\n  vec3 lightVector = lightPositionWS - geometryData.worldPos;\n  float distanceSqr = dot(lightVector, lightVector);\n\n  mediump vec3 lightDirection = vec3(lightVector * inversesqrt(distanceSqr));\n\n  mediump float attenuation = AngleAttenuation(spotDirection.xyz, lightDirection, distanceAndSpotAttenuation.zw);\n  ",t.infinite?e+="\n    attenuation *= DistanceAttenuation(distanceSqr);\n  ":e+="\n    attenuation *= DistanceAttenuationRange(distanceSqr, distanceAndSpotAttenuation.xy);\n  ",e+="\n\n\n  Light light;\n  light.direction = lightDirection;\n  light.attenuation = attenuation;\n  light.color = lightColor;\n\n  ",t.shadowIndex>-1?e+="\n    ShadowMapData shadowmapData = GET_SHADOWMAP_DATA( "+t.shadowIndex+" );\n    light.shadowAttenuation = SampleShadowAttenuation(shadowmapData, tShadowMap"+t.shadowIndex+", geometryData.worldPos, geometryData.worldNrm );\n  ":e+="\n    light.shadowAttenuation = 1.0;\n  ",e+="\n  \n  // TODO store ibl contrib in separate struct\n  // #if iblShadowing\n  //   float sDamp = uLSpotColors["+t.index+"].a;\n  //   specularColor *= mix( sDamp, 1.0, shOccl );\n  // #endif\n\n  \n  // mediump vec3 attenuatedLightColor = light.color * (light.attenuation * light.shadowAttenuation);\n  // LS_DIFFUSE  += LightingLambert(attenuatedLightColor, light.direction, geometryData.worldNrm);\n  // LS_SPECULAR += LightingSpecular(attenuatedLightColor, light.direction, geometryData.worldNrm, geometryData.viewDir, specularGloss, smoothness);\n\n  LightingPhysicallyBased(brdfData,  geometryData, lightingData, light );\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},12032:function(t){var e=function(t){var e="";return e+="#define NUM_S_LIGHTS "+t.count+"\n\n",t.count>0&&(e+="\nuniform vec3 uLSpotPositions  [NUM_S_LIGHTS];\nuniform vec3 uLSpotDirections [NUM_S_LIGHTS];\nuniform vec4 uLSpotColors     [NUM_S_LIGHTS]; // rgb + iblShadowing\nuniform vec4 uLSpotAttenuation[NUM_S_LIGHTS]; \n"),e+="\n\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},61790:function(t){var e=function(t){var e="";return e+="\nc=c*uContrastScale+uContrastBias;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},24705:function(t){var e=function(t){var e="";return e+="uniform vec3 uContrastScale;\nuniform vec3 uContrastBias;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},95871:function(t){var e=function(t){var e="";return e+="\nc = texture2D(tInput,texCoordVP).xyz;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},61537:function(t){var e=function(t){var e="";return e+="\n\n#if __VERSION__ == 300\n  #define IN in\n  out vec4 FragColor;\n  #define texture2D(a,b) texture( a, b )\n#else\n  #define IN varying\n  #define FragColor gl_FragColor\n#endif\n\nuniform sampler2D tInput;\nIN vec2 vTexCoordVP;\nIN vec2 vTexCoordFull;\n\n#if NEED_DEPTH\n  uniform sampler2D tDepth;\n#endif\n\n\n#if TEXTURE_DEPTH\n  float FETCH_DEPTH( sampler2D t, vec2 uvs ){\n    return texture2D(t,uvs).x;\n  }\n#else\n  \n  highp float decodeDepthRGB(highp vec3 rgb){\n    return(rgb.x+rgb.y*(1.0/255.0))+rgb.z*(1.0/65025.0);\n  }\n\n  float FETCH_DEPTH( sampler2D t, vec2 uvs ){\n    return decodeDepthRGB( texture2D(t,uvs).xyz );\n  }\n#endif\n\n\n\nvec3 sRGB( vec3 c )\n{\n  return c * ( c * ( c*0.305306011 + vec3(0.682171111) ) + vec3(0.012522878) );\n}\n\nfloat luminance( vec3 c )\n{\n  return dot( c, vec3(0.3,0.59,0.11) );\n}\n\n\n\n"+t.precode+"\n\n\nvoid main(void){\n  vec3 c;\n\n  vec2 texCoordVP   = vTexCoordVP;\n  vec2 texCoordFull = vTexCoordFull;\n\n\n  #if NEED_DEPTH\n    float sceneDepth = FETCH_DEPTH( tDepth, texCoordVP );\n  #endif\n\n  "+t.code+"\n\n  FragColor.xyz=c;\n  FragColor.w=1.0;\n\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},96540:function(t){var e=function(t){var e="";return e+="precision highp float;\n\n#if __VERSION__ == 300\n  #define IN in\n  #define OUT out\n#else\n  #define IN attribute\n  #define OUT varying\n#endif\n\n\nIN vec2 aTexCoord0;\n\nOUT vec2 vTexCoordVP;\nOUT vec2 vTexCoordFull;\n\nuniform vec2 uViewportScale;\n\nvoid main(void)\n{\n  vTexCoordVP   = aTexCoord0 * uViewportScale;\n  vTexCoordFull = aTexCoord0;\n\n  gl_Position.xy = 2.0 * aTexCoord0-vec2(1.0,1.0);\n  gl_Position.zw = vec2(0.0,1.0);\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},84910:function(t){var e=function(t){var e="";return e+="\n\nfloat gray = luminance( c );\nc = mix( vec3(gray), c, uSaturation );",e};e.toString=e,t.exports=e,e.onHmr=function(){}},81592:function(t){var e=function(t){var e="";return e+="uniform vec3 uSaturation;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},98237:function(t){var e=function(t){var e="";return e+="\n{\n  vec2 pPos=texCoordFull*uVignetteAspect.xy-uVignetteAspect.zw;\n\n  vec3 ramp=clamp(vec3(1.0,1.0,1.0)-uVignette.xyz*dot(pPos,pPos),0.0,1.0);\n  vec3 ramp5=ramp*ramp;\n\n  ramp5*=ramp;\n\n  c*=mix(ramp,ramp5,uVignette.w);\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},51498:function(t){var e=function(t){var e="";return e+="uniform vec4 uVignette;\nuniform vec4 uVignetteAspect;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},69404:function(t){var e=function(t){var e="";return e+="precision highp float;\n\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D tInput;\nuniform float uSpread;\nuniform vec3 uKernel[NUM_SAMPLES];\n\n\n\nvoid main(void){\n\n  vec3 color = vec3( 0.0 );\n\n  float alpha = .02 + .98*texture2D( tInput, vTexCoord ).a;\n\n  for(int i=0; i<NUM_SAMPLES; ++i)\n  {\n    vec3 kernel = uKernel[i].xyz;\n    color += texture2D( tInput, vTexCoord + kernel.xy * uSpread * alpha ).xyz * kernel.z;\n  }\n\n\n  gl_FragColor = vec4( color, alpha );\n  \n\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},65654:function(t){var e=function(t){var e="";return e+="precision highp float;\n\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord = aTexCoord;\n\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},2931:function(t){var e=function(t){var e="";return e+="vec2 frameCoords = texCoordFull * uFrameAspect;\nfloat frameNoiseTime = uFrameTime * 0.000008;\nvec4 frameNoise = texture2D(uFrameNoise, vec2(texCoordFull.x * uFrameNoiseRepeat + uFrameNoiseOffset.x + frameNoiseTime, texCoordFull.y * uFrameNoiseRepeat + uFrameNoiseOffset.y + frameNoiseTime));\n\nvec4 frameShape1 = frame(frameCoords, uFrameBorderWidth1, frameNoise.r, texCoordFull);\nvec4 frameShape2 = frame(frameCoords, uFrameBorderWidth2, frameNoise.g, texCoordFull);\nvec4 frameShape3 = frame(frameCoords, uFrameBorderWidth3, frameNoise.b, texCoordFull);\n\nc = blendFrame(c, uFrameColor, frameShape1);\nc = blendFrame(c, uFrameColor, frameShape2);\nc = blendFrame(c, uFrameColor, frameShape3);",e};e.toString=e,t.exports=e,e.onHmr=function(){}},47478:function(t){var e=function(t){var e="";return e+="#define PI 3.1415926535897932384626433832795\n\nuniform sampler2D uFrameNoise;\nuniform float uFrameTime;\nuniform vec3 uFrameColor;\nuniform vec2 uFrameAspect;\nuniform float uFrameStrength;\nuniform vec2 uFrameNoiseOffset;\nuniform float uFrameNoiseRepeat;\nuniform vec4 uFrameBorderWidth1;\nuniform vec4 uFrameBorderWidth2;\nuniform vec4 uFrameBorderWidth3;\n\n// from https://github.com/jamieowen/glsl-blend\n\nfloat blendSoftLight(float base, float blend) {\n\treturn (blend<0.5)?(2.0*base*blend+base*base*(1.0-2.0*blend)):(sqrt(base)*(2.0*blend-1.0)+2.0*base*(1.0-blend));\n}\n\nvec3 blendSoftLight(vec3 base, vec3 blend) {\n\treturn vec3(blendSoftLight(base.r,blend.r),blendSoftLight(base.g,blend.g),blendSoftLight(base.b,blend.b));\n}\n\nvec3 blendSoftLight(vec3 base, vec3 blend, float opacity) {\n\treturn (blendSoftLight(base, blend) * opacity + base * (1.0 - opacity));\n}\n\n// frame\n\nfloat frameBorder(float aspect, float width, float coords, float noise) {\n  float frameStep = aspect - width;\n  return smoothstep(\n    frameStep,\n    frameStep + 0.002,\n    coords - smoothstep(0.3, 1., noise) * width * 2.\n  );\n}\n\nvec4 frame(vec2 coords, vec4 width, float noise, vec2 screenCoords) {\n  return vec4(\n    frameBorder(uFrameAspect.y, width.x, coords.y, noise),\n    frameBorder(uFrameAspect.y, width.y, uFrameAspect.y - coords.y, noise),\n    frameBorder(uFrameAspect.x, width.z, uFrameAspect.x - coords.x, noise),\n    frameBorder(uFrameAspect.x, width.w, coords.x, noise)\n  );\n}\n\nvec3 blendFrame(vec3 baseColor, vec3 frameColor, vec4 frameShape) {\n  vec3 blend1 = blendSoftLight(baseColor, frameColor, frameShape.x * uFrameStrength);\n  vec3 blend2 = blendSoftLight(blend1, frameColor, frameShape.y * uFrameStrength);\n  vec3 blend3 = blendSoftLight(blend2, frameColor, frameShape.z * uFrameStrength);\n  return blendSoftLight(blend3, frameColor, frameShape.w * uFrameStrength);\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},9769:function(t){var e=function(t){var e="";return e+="precision highp float;\n\n#if __VERSION__ == 300\n  #define IN in\n  #define OUT out\n#else\n  #define IN attribute\n  #define OUT varying\n#endif\n\n\nIN vec2 aTexCoord0;\n\nOUT vec2 vTexCoordVP;\nOUT vec2 vTexCoordFull;\n\nuniform vec2 uViewportScale;\n\n"+t.precode+"\n\nvoid main(void)\n{\n  vTexCoordVP   = aTexCoord0 * uViewportScale;\n  vTexCoordFull = aTexCoord0;\n\n  "+t.code+"\n\n  gl_Position.xy = 2.0 * aTexCoord0-vec2(1.0,1.0);\n  gl_Position.zw = vec2(0.0,1.0);\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},39983:function(t){var e=function(t){var e="";return e+="\n\n{\n\n  #define CS_SAMPLES 8\n  #define CS_P .068\n  vec2 tc = texCoordVP - vec2(.5);\n  vec3 add = vec3(0.);\n  for( int i = 0; i < CS_SAMPLES; i++ ){\n    float shift = float(i)/float(CS_SAMPLES-1);\n\n    vec2 ftc = tc * (1.0 + uAmount*(shift - .5));\n    add += texture2D( tInput, ftc + .5 ).xyz * texture2D( tChromaShiftTex, vec2( shift * (1.0-2.0*CS_P) + CS_P , .5 ) ).rgb;\n  }\n\n  c = mix(c, (c + add) / (float( CS_SAMPLES ) * .55), uAmount);\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},57897:function(t){var e=function(t){var e="";return e+="\nuniform sampler2D tChromaShiftTex;\n\nuniform float uAmount;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},5024:function(t){var e=function(t){var e="";return e+="\n#pragma SLOT definitions\n#pragma SLOT precision\n\n\n#if __VERSION__ == 300\n  #define IN in\n#else\n  #define IN varying\n#endif\n\n#pragma SLOT pf\n\nIN vec3 vWorldPos;\n\nuniform vec3 uCamPos;\nuniform float uDistScale;\nuniform float uGroundHeight;\n\nvoid main(void){\n\n  #pragma SLOT f\n  float camDist = length( uCamPos - vWorldPos );\n  float dist = camDist / ( 1.0 + (uCamPos.y/vWorldPos.y ) );\n  if(vWorldPos.y < uGroundHeight) discard;\n  // gl_FragColor = vec4( 0.0, 0.0, 0.0, vWorldPos.y*uDistScale );\n  gl_FragColor = gl_FragColor*0.0001 + vec4( 0.0, 0.0, 0.0, vWorldPos.y*uDistScale*dist );\n\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},15015:function(t){var e=function(t){var e="";return e+="\n#pragma SLOT definitions\n#pragma SLOT precision\n\n#if __VERSION__ == 300\n  #define IN in\n  #define OUT out\n#else\n  #define IN attribute\n  #define OUT varying\n#endif\n\n#pragma SLOT pv\n\nattribute vec3 aPosition;\nattribute vec3 aNormal;\n\nuniform mat4 uMVP;\nuniform mat4 uWorldMatrix;\nuniform mat4 uVP;\n\nOUT vec3 vWorldPos;\n\n\nstruct VertexData {\n  highp vec3 position;\n  highp vec3 worldPos;\n  #if hasNormals\n    vec3 normal;\n  #endif\n  #if hasTangents\n    vec3 tangent;\n  #endif\n  mat4 worldMatrix;\n};\n\n\nvoid InitVertexData( out VertexData vertex ){\n\n  vertex.position = aPosition;\n  #if hasNormals\n    vertex.normal = aNormal;\n  #endif\n  #if hasTangents\n    vertex.tangent = aTangent.xyz;\n  #endif\n\n  vertex.worldMatrix = uWorldMatrix;\n   \n}\n\n\nvoid main(void) {\n\n  #pragma SLOT v\n\n\n  VertexData vertex;\n  InitVertexData( vertex );\n\n  #pragma SLOT vertex_warp\n\n  vec4 worldPos = vertex.worldMatrix * vec4( vertex.position, 1.0 );\n  vertex.worldPos.xyz = worldPos.xyz / worldPos.w;\n  worldPos.w = 1.0;\n\n  #pragma SLOT vertex_warp_world\n\n  vWorldPos = worldPos.xyz;\n  gl_Position = uVP * worldPos;\n\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},54686:function(t){var e=function(t){var e="";return e+="vec2 uvS = (texCoordFull - vec2(0.5, 0.5) + vec2(1.0, 0.0) * uTimeSplat * uSpeedSplat) * uScaleSplat;\nvec2 uvS2 = (texCoordFull - vec2(0.5, 0.5) + vec2(0.0, 1.3) * uTimeSplat * uSpeedSplat) * uScaleSplat;\n\nfloat effect = fBm(uvS, uH, uLacunarity, uFreq, uOctaves) * uSplatStrength * fBm(uvS2, uH, uLacunarity, uFreq, uOctaves);\n\nfloat effectSmooth = smoothstep(0.0, 0.9, effect);\n// c += c * effectSmooth;\n\n//compute vignette\nfloat vignette = 1.0 - length( texCoordFull - 0.5 ) * 1.1;\n\nfloat graySplat = luminance( c );\nc = mix( vec3(graySplat), c, 1.0 + (effectSmooth * (1.0 - vignette)));",e};e.toString=e,t.exports=e,e.onHmr=function(){}},23314:function(t){var e=function(t){var e="";return e+="uniform float uSplatStrength;\nuniform float uTimeSplat;\nuniform float uH;\nuniform float uLacunarity;\nuniform float uFreq;\nuniform float uOctaves;\nuniform float uScaleSplat;\nuniform float uSpeedSplat;\n\nvec3 mod289(vec3 x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec2 mod289(vec2 x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec3 permute(vec3 x) {\n  return mod289(((x*34.0)+1.0)*x);\n}\n\nfloat snoise(vec2 v)\n{\n  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                     -0.577350269189626,  // -1.0 + 2.0 * C.x\n                      0.024390243902439); // 1.0 / 41.0\n// First corner\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n\n// Other corners\n  vec2 i1;\n  //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0\n  //i1.y = 1.0 - i1.x;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  // x0 = x0 - 0.0 + 0.0 * C.xx ;\n  // x1 = x0 - i1 + 1.0 * C.xx ;\n  // x2 = x0 - 1.0 + 2.0 * C.xx ;\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n\n// Permutations\n  i = mod289(i); // Avoid truncation effects in permutation\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n\t\t+ i.x + vec3(0.0, i1.x, 1.0 ));\n\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n\n// Gradients: 41 points uniformly over a line, mapped onto a diamond.\n// The ring size 17*17 = 289 is close to a multiple of 41 (41*7 = 287)\n\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n\n// Normalise gradients implicitly by scaling m\n// Approximation of: m *= inversesqrt( a0*a0 + h*h );\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n\n// Compute final noise value at P\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n\nfloat fBm(vec2 p, float H, float lacunarity, float freq, float octaves)\n{\n\tfloat value = 0.0;\n\tfloat rmd = 0.0;\n\tfloat pwHL = pow(lacunarity, -H);\n\tfloat pwr = pwHL; \n\n\tfor (int i=0; i<65535; i++)\n\t{\n\t\tvalue += snoise(p * freq) * pwr;\n\t\tp *= lacunarity;\n\t\tpwr *= pwHL;\n\t\tif (i==int(octaves)-1) break;\n\t}\n\n\trmd = octaves - floor(octaves);\n\tif (rmd != 0.0) value += rmd * snoise(p * freq) * pwr;\n\n\treturn value;\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},62985:function(t){var e=function(t){var e="";return e+="vec4 noiseJitter = texture2D(uNoise, texCoordFull + vec2(floor(uTime2 * uTimeScale) * .1));\nvec2 shakeUV = texCoordFull;\n\nshakeUV = shakeUV - vec2(0.5, 0.5);\nshakeUV = shakeUV * vec2(uRepeat * uAspect, uRepeat);\nshakeUV = shakeUV + vec2(0.5, 0.5);\n\nshakeUV += (noiseJitter.rg - 0.5) * uDisplacement;\n\nvec3 tex = texture2D(uTexture, shakeUV).rgb;\ntex *= uTextureLuminosity;\n\nfloat greyBackground = greyscale(c);\nfloat greyBackgroundContrasted = easeInOutCubic(greyBackground);\ngreyBackground = greyBackgroundContrasted;\n\nfloat blendingOpacity = uOpacity;\nblendingOpacity = clamp(uOpacity - greyBackground * uBackgroundLum, 0., 1.);\nc = blendOverlay(c, tex, blendingOpacity);\n// c = vec3(greyBackground);",e};e.toString=e,t.exports=e,e.onHmr=function(){}},4258:function(t){var e=function(t){var e="";return e+="uniform sampler2D uTexture;\nuniform sampler2D uNoise;\nuniform float uRepeat;\nuniform float uOpacity;\nuniform float uAspect;\nuniform float uTime2;\nuniform float uDisplacement;\nuniform float uTimeScale;\nuniform float uTextureLuminosity;\nuniform float uBackgroundLum;\n\nfloat blendOverlay(float base, float blend) {\n  return base<0.5?(2.0*base*blend):(1.0-2.0*(1.0-base)*(1.0-blend));\n}\n\nvec3 blendOverlay(vec3 base, vec3 blend) {\n  return vec3(blendOverlay(base.r,blend.r),blendOverlay(base.g,blend.g),blendOverlay(base.b,blend.b));\n}\n\nvec3 blendOverlay(vec3 base, vec3 blend, float opacity) {\n  return (blendOverlay(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat greyscale(vec3 col){\n  float grey = dot(col, vec3(0.299, 0.587, 0.114));\n  return grey;\n}\n\nfloat easeInOutCubic(float x) {\n  return x < 0.5 ? 4.0 * x * x * x : 1.0 - pow(-2. * x + 2., 3.) / 2.;\n}",e};e.toString=e,t.exports=e,e.onHmr=function(){}},95119:function(t){var e=function(t){var e="";return e+="vec2 transitionUvs = mix(texCoordFull.xy, texCoordFull.yx, uTransitionRotate);\nvec4 transitionColor = texture2D(uTransitionTex, transitionUvs);\nc = mix(c, transitionColor.rgb, transitionColor.a);",e};e.toString=e,t.exports=e,e.onHmr=function(){}},88960:function(t){var e=function(t){var e="";return e+="uniform float uTransitionRotate;\nuniform sampler2D uTransitionTex;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},86883:function(t){var e=function(t){var e="";return e+="precision mediump float;\n\nuniform sampler2D tInput;\n\nuniform vec4 uKernel[BLUR_SAMPLES];\nvarying vec2 vTexCoordVP;\n\nvoid main(void) {\n  vec3 color = vec3(0.0);\n\n  for(int i = 0; i < BLUR_SAMPLES; ++i) {\n    vec3 kernel = uKernel[i].xyz;\n    color += texture2D(tInput, vTexCoordVP + kernel.xy).xyz * kernel.z;\n  }\n\n  gl_FragColor = vec4(color, 0.0);\n}\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},99374:function(t){var e=function(t){var e="";return e+="vec2 ratioUV = (texCoordFull - vec2(0.5, 0.5)) * vec2(uRatio, 1) + vec2(0.5, 0.5);\nc = mix(\n  c,\n  texture2D(tBlur, texCoordFull).xyz,\n  smoothstep(\n    uStart,\n    uStart + uStrength,\n    distance(vec2(0.5, 0.5), ratioUV) * uEffect\n  )\n);\n",e};e.toString=e,t.exports=e,e.onHmr=function(){}},63394:function(t){var e=function(t){var e="";return e+="uniform sampler2D tBlur;\nuniform float uStrength;\nuniform float uStart;\nuniform float uRatio;\nuniform float uEffect;",e};e.toString=e,t.exports=e,e.onHmr=function(){}},76881:function(t,e,n){"use strict";n.d(e,{Z:function(){return a}});var i=n(63887);const r=new Float32Array([Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]),s=new Float32Array(6),o=i.vec3.create();class a{constructor(){this._mmData=new Float32Array(6),this.min=new Float32Array(this._mmData.buffer,0,3),this.max=new Float32Array(this._mmData.buffer,12,3)}zero(){this.min.set([0,0,0]),this.max.set([0,0,0])}copyFrom(t){this.min.set(t.min),this.max.set(t.max)}fromMinMax(t,e){this.min.set(t),this.max.set(e)}static union(t,e,n){for(var i=0;i<3;i++)t.min[i]=Math.min(e.min[i],n.min[i]),t.max[i]=Math.max(e.max[i],n.max[i])}static transform(t,e,n){const a=s,h=e.min,l=e.max;a.set(r);for(var c=0;8>c;++c)o[0]=1&c?l[0]:h[0],o[1]=2&c?l[1]:h[1],o[2]=4&c?l[2]:h[2],i.vec3.transformMat4(o,o,n),a[0]=Math.min(a[0],o[0]),a[1]=Math.min(a[1],o[1]),a[2]=Math.min(a[2],o[2]),a[3]=Math.max(a[3],o[0]),a[4]=Math.max(a[4],o[1]),a[5]=Math.max(a[5],o[2]);t._mmData.set(s)}}},68209:function(t,e,n){"use strict";var i;n.d(e,{I:function(){return i},Z:function(){return r}}),function(t){t[t["NONE"]=0]="NONE",t[t["DEPTH"]=2]="DEPTH",t[t["LINEAR"]=4]="LINEAR"}(i||(i={}));class r{constructor(){this.post=null,this._flags=0}_init(t){this.post!==t&&(this.post=t,this.init())}}},99840:function(t,e,n){"use strict";n.d(e,{Z:function(){return s}});var i=n(18158);const r=new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,1,1,1]);class s extends i.Z{constructor(t,e=-1,n=-1,i=2,s=2){super(t);const o=r;o[0]=o[4]=e,o[1]=o[9]=n,o[8]=o[12]=e+i,o[5]=o[13]=n+s,this.data(o),this.attrib("aPosition",2,t.FLOAT),this.attrib("aTexCoord",2,t.FLOAT)}render(){this.drawTriangleStrip()}}},94292:function(t,e,n){"use strict";n.d(e,{Z:function(){return c}});var i=n(81952);const r=16,s=i.A$;class o{constructor(){this._stack=new Uint16Array((0|s)*r|0),this._sets=new Uint32Array(0|r),this._size=0|r,this._ptr=0,this._headPos=0,this._wcfg=new i.ZP}initFromGL(t){this._ptr=0,this._wcfg.fromGL(t),this._sets[0]=0,this._stack.set(this._wcfg._dat)}push(t){this._ptr+1===this._size&&this._grow();const e=t._set,n=++this._ptr,r=n*(0|s),o=t._dat,a=this._stack;this._sets[n]=this._sets[n-1]|e;for(var h=0;h<(0|s);h++){var l,c=i.zx[h];l=0!==(e&c)?o[h]:a[r+h-(0|s)],a[r+h]=l}}pop(){const t=--this._ptr;this._headPos>t&&(this._sets[t]|=this._sets[t+1],this._headPos=t)}flush(){while(this._ptr>0)this.pop()}commit(t){const e=this._ptr;this.copyConfig(e,t),this._headPos=e,e>0&&(this._sets[e-1]|=this._sets[e]),this._sets[e]=0}copyConfig(t,e){const n=e._dat,i=this._stack,r=0|t*(0|s);for(var o=0;o<(0|s);o++)n[o]=i[r+o];e._set=this._sets[t]}_grow(){const t=this._size<<1,e=new Uint16Array(t*(0|s)),n=new Uint32Array(t);e.set(this._stack,0),n.set(this._sets,0),this._stack=e,this._sets=n,this._size=t}}var a=o;const h=new i.ZP,l=new i.ZP;class c{constructor(t){this._state=new i.ZP,this.gl=t,this.cfgStack=new a,this.cfgStack.initFromGL(t),this.cfgStack.copyConfig(0,this._state),this._validCfg=!1}static get(t){let e=this._instances.get(t);return e||(e=new c(t),this._instances.set(t,e)),e}push(t){this.cfgStack.push(t),this._validCfg=!1}pop(){this.cfgStack.pop(),this._validCfg=!1}apply(){this._validCfg||(this.cfgStack.commit(l),l.patch(this._state,h),h.setupGL(this.gl),this._validCfg=!0)}now(t){this.push(t),this.apply(),this.pop()}config(){return new u(this)}}c._instances=new WeakMap;class u extends i.ZP{constructor(t){super(),this.state=t}apply(){this.state.now(this)}}},18158:function(t,e,n){"use strict";var i=n(57195),r=n(16203);const s=34962;class o extends i.Z{constructor(t,e,n=t.STATIC_DRAW,i){super(),this.gl=t,this.usage=n,this.buffer=void 0!==i?i:t.createBuffer(),this.attribs=[],this.stride=0,this.byteLength=0,this.length=0,e&&this.data(e)}bind(){this.gl.bindBuffer(s,this.buffer)}attrib(t,e,n,i=!1){return this.attribs.push({name:t,type:0|n,size:0|e,normalize:i,offset:this.stride,stride:0}),this.stride+=(0,r.Z4)(n)*e,this._computeLength(),this}data(t){const e=this.gl;e.bindBuffer(s,this.buffer),e.bufferData(s,t,this.usage),e.bindBuffer(s,null),this.byteLength=(0,r.$P)(t)?t.byteLength:t,this._computeLength()}subData(t,e){const n=this.gl;n.bindBuffer(s,this.buffer),n.bufferSubData(s,e,t),n.bindBuffer(s,null)}attribPointer(t){const e=this.gl;e.bindBuffer(s,this.buffer);for(var n=0;n<this.attribs.length;n++){var i=this.attribs[n];if(void 0!==t[i.name]){var r=t[i.name]();e.enableVertexAttribArray(r),e.vertexAttribPointer(r,i.size,i.type,i.normalize,i.stride||this.stride,i.offset)}}}draw(t,e=this.length,n=0){this.gl.drawArrays(t,n,0|e)}dispose(){this.gl.deleteBuffer(this.buffer)}_computeLength(){this.stride>0&&(this.length=this.byteLength/this.stride)}}e["Z"]=o},57195:function(t,e){"use strict";class n{drawPoints(t,e){this.draw(0,t,e)}drawLines(t,e){this.draw(1,t,e)}drawLineLoop(t,e){this.draw(2,t,e)}drawLineStrip(t,e){this.draw(3,t,e)}drawTriangles(t,e){this.draw(4,t,e)}drawTriangleStrip(t,e){this.draw(5,t,e)}drawTriangleFan(t,e){this.draw(6,t,e)}}e["Z"]=n},88271:function(t,e,n){"use strict";function i(t,e,n){return t*(1-n)+e*n}function r(t,e,n){const i=(1-n)*Math.cos(t)+n*Math.cos(e),r=(1-n)*Math.sin(t)+n*Math.sin(e);return Math.atan2(r,i)}n.d(e,{Z:function(){return i},t:function(){return r}})},40179:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return $e}});function i(t,e,n,i){var r,s=arguments.length,o=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)o=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,n,o):r(e,n))||o);return s>3&&o&&Object.defineProperty(e,n,o),o}Object.create;Object.create;var r=n(21370),s=n(63887),o=n(81952),a=n(29845),h=n(34072),l=n(65654),c=n.n(l),u=n(69404),d=n.n(u),f=n(94292);class p{setSize(t){this.size=t,this.computeKernel(this.blurKernelA,!0,1/this.size),this.computeKernel(this.blurKernelB,!1,1/this.size),this.blurA_fbo.resize(this.size,this.size),this.blurB_fbo.resize(this.size,this.size)}constructor(t,e){const n=t.renderer.gl;this.gl=n,this.scene=t,this.state=new f.Z(this.gl),this.blurSamples=4,this.size=e,this.spread=1,this.blurCfg=this.state.config().enableCullface(!1).depthMask(!1).enableDepthTest(!1),this.blurPrg=new a.Z(n,c()(),d()(),"#define NUM_SAMPLES "+this.blurSamples),this.blurKernelA=new Float32Array(3*this.blurSamples),this.blurKernelB=new Float32Array(3*this.blurSamples),this.computeKernel(this.blurKernelA,!0,1/this.size),this.computeKernel(this.blurKernelB,!1,1/this.size),this.blurA_fbo=this.makeBlurFbo(!0),this.blurB_fbo=this.makeBlurFbo()}process(t){const e=this.blurPrg,n=this.gl;n.clearColor(1,1,1,0),e.use(),e.uSpread(this.spread);const i=this.scene.quad;i.attribPointer(e),this.blurA_fbo.bind(),n.clear(n.COLOR_BUFFER_BIT),e.tInput(t),e.uKernel(this.blurKernelA),this.state.push(this.blurCfg),i.render(),this.blurB_fbo.bind(),n.clear(n.COLOR_BUFFER_BIT),e.tInput(this.blurA_fbo.getColor()),e.uKernel(this.blurKernelB),i.render(),this.state.pop(),this.state.apply()}clear(){this.blurB_fbo.bind(),this.blurB_fbo.defaultViewport(),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}getBlurredTex(){return this.blurB_fbo.getColorTexture()}getBlurredFbo(){return this.blurB_fbo}makeBlurFbo(t=!1){const e=this.gl,n=new h.Z(e);n.bind(),n.attachColor(t?e.RGBA:e.RGB,e.UNSIGNED_BYTE),n.resize(this.size,this.size);const i=n.getColorTexture();return i.bind(),i.clamp(),i.setFilter(!0,!1,!1),n}computeKernel(t,e,n){const i=e?0:1,r=e?1:0,s=Math.sqrt(Math.PI);let o=0;for(let a=0;a<this.blurSamples;++a){const e=3*a,h=a-Math.round((this.blurSamples-1)/2);let l=4*h/this.blurSamples;l=Math.exp(-l*l/2)/s,o+=l,t[e+i]=h*n,t[e+r]=0,t[e+2]=l}for(let a=0;a<this.blurSamples;++a)t[3*a+2]/=o}}var m=n(8098),g=n(65031),v=n(57123);class _{constructor(t,e){this.gl=t,this._useMsaa=(0,m.I)(t)&&e>1,this.renderFbo=new h.Z(t),this.renderFbo.bind(),(0,m.I)(t)&&this._useMsaa?(this.renderFbo.attach(t.COLOR_ATTACHMENT0,new v.Z(t,t.RGBA8,e)),this.renderFbo.attach(t.DEPTH_ATTACHMENT,new v.Z(t,t.DEPTH_COMPONENT16,e)),this.blitFbo=new h.Z(t),this.blitFbo.attachColor(t.RGBA,t.UNSIGNED_BYTE)):(this.renderFbo.attach(t.COLOR_ATTACHMENT0,new g.Z(t,t.RGBA,t.UNSIGNED_BYTE)),this.renderFbo.attach(t.DEPTH_ATTACHMENT,new v.Z(t,t.DEPTH_COMPONENT16)),this.blitFbo=this.renderFbo)}blitMsaa(){if(this._useMsaa){const t=this.gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFbo.fbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.blitFbo.fbo),t.clearBufferfv(t.COLOR,0,[0,0,0,1]),t.blitFramebuffer(0,0,this.renderFbo.width,this.renderFbo.height,0,0,this.renderFbo.width,this.renderFbo.height,t.COLOR_BUFFER_BIT,t.NEAREST)}}getColorTexture(){return this.blitFbo.getColorTexture()}setSize(t,e){this.renderFbo.resize(t,e),this.blitFbo.resize(t,e)}}const x=s.mat4.create(),b=s.mat4.create(),w=.5;class S{setQuality(t,e){t!==this.size&&(this.size=t,this.blur.setSize(t),this.fbo.setSize(t,t)),e!==this.msaa&&(this.msaa=e,this.fbo._useMsaa!==e&&this.allocateFbo())}constructor(t,e){this.cameraDisto=-1,this.msaa=!1,this.groundHeight=-.13,this.viewprojCopy=s.mat4.create(),this.scene=t,this.plane=e,this.size=1024,this.blur=new p(t,this.size*w),this.blur.spread=14,this.globalCfg=new o.ZP,this.allocateFbo()}allocateFbo(){const t=this.scene.renderer.gl,e=new _(t,this.msaa?16:0);e.setSize(this.size,this.size);const n=e.getColorTexture();n.bind(),n.clamp(),n.setFilter(!0,!1,!1),this.fbo=e}blitRenderBuffer(){this.fbo.blitMsaa()}bindAndClear(){const t=this.scene.renderer.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.fbo.renderFbo.fbo),t.viewport(0,0,this.size,this.size),t.clearColor(1,1,1,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}processOutput(){this.scene.renderer.gl.viewport(0,0,this.size*w,this.size*w),this.blur.process(this.fbo.getColorTexture())}getRawOutput(){return this.fbo.getColorTexture()}getOutput(){return this.blur.getBlurredTex()}getOutputFbo(){return this.blur.getBlurredFbo()}clear(){this.blur.clear()}processCamera(t){this.scene.renderer.gl.viewport(0,0,this.size,this.size),this.viewprojCopy.set(t._viewProj),s.mat4.identity(x),x[5]=this.cameraDisto,x[13]=2*this.groundHeight,s.mat4.multiply(b,x,t._wmatrix),s.mat4.invert(b,b),s.mat4.multiply(t._viewProj,t.lens.getProjection(),b)}restoreCamera(t){t._viewProj.set(this.viewprojCopy)}}var C=n(99840),T=n(2262),E=n(88271),F=n(2246),P=n(14697),D=n(38545),y=n(5839),R=n(42946);const L={async create(t,e){switch(console.log("create activity",t),t){case"scene1":const{default:t}=await Promise.all([n.e(9975),n.e(9400),n.e(5409),n.e(9650),n.e(6478),n.e(1236),n.e(8215),n.e(9327),n.e(6381),n.e(1153),n.e(5124),n.e(6070)]).then(n.bind(n,46070));return console.log("get scene 1"),new t(e,1);case"scene2":const{default:i}=await Promise.all([n.e(9975),n.e(9400),n.e(5409),n.e(9650),n.e(6478),n.e(1236),n.e(8215),n.e(9327),n.e(6381),n.e(1153),n.e(5124),n.e(9793)]).then(n.bind(n,59793));return new i(e,2);case"scene3":const{default:r}=await Promise.all([n.e(9975),n.e(9400),n.e(5409),n.e(9650),n.e(6478),n.e(1236),n.e(8215),n.e(9327),n.e(6381),n.e(1153),n.e(5124),n.e(2369)]).then(n.bind(n,22369));return new r(e,3);case"scene4":const{default:s}=await Promise.all([n.e(9975),n.e(9400),n.e(5409),n.e(9650),n.e(6478),n.e(1236),n.e(8215),n.e(9327),n.e(6381),n.e(1153),n.e(5124),n.e(2829)]).then(n.bind(n,62829));return new s(e,4);case"outroduction":const{default:o}=await Promise.all([n.e(9975),n.e(9400),n.e(9650),n.e(6478),n.e(8215),n.e(9327),n.e(1153),n.e(7799)]).then(n.bind(n,47799));return new o(e);case"conclusion":const{default:a}=await Promise.all([n.e(9400),n.e(6478),n.e(1236),n.e(8215),n.e(9327),n.e(6381),n.e(1674)]).then(n.bind(n,41674));return new a(e);case"brushes":const{default:h}=await Promise.all([n.e(9975),n.e(6683)]).then(n.bind(n,6683));return new h(e);case"intro":const{default:l}=await Promise.all([n.e(9975),n.e(5409),n.e(6381),n.e(7771)]).then(n.bind(n,8034));return new l(e);case"archives":const{default:c}=await Promise.all([n.e(1236),n.e(4233)]).then(n.bind(n,84233));return new c(e)}}};class M{get active(){return this._activeList.map((t=>this.activities.get(t)))}constructor(t){this.renderer=t,this.activities=new Map,this._activeList=[]}_assertActivityDoesNotExist(t){if(this.activities.has(t))throw new Error(`Activity ${t} already exists`)}_assertActivityExists(t){if(!this.activities.has(t))throw new Error(`Activity ${t} does not exist`)}_assetNotActive(t){if(this._activeList.includes(t))throw new Error(`Activity ${t} is already active`)}async createActivity(t){this._assertActivityDoesNotExist(t);const e=await L.create(t,this.renderer);return this.activities.set(t,e),e}loadActivity(t){return this.activities.has(t)||this.createActivity(t),this.activities.get(t).load()}startActivity(t){if(this._assertActivityExists(t),this._assetNotActive(t),this._activeList.push(t),"archives"===t){const t=this._activeList.indexOf("brushes");-1!==t&&this._activeList.reverse()}this.activities.get(t).start()}stopActivity(t){this._assertActivityExists(t),this.activities.get(t).stop(),this._activeList.splice(this._activeList.indexOf(t),1)}unloadActivity(t){this._assertActivityExists(t),this.activities.get(t).unload(),this.activities.delete(t)}getActivity(t){return this.activities.get(t)}}var A=n(63132);class B{constructor(t){this.renderer=t,this.isHolding=!1,this.canHold=!0,this.wasHolding=!1,this.blockHold=!1,this.blockHoldDown=!1,this.wasBlockHold=!1,this.blockRelease=!1,this.isGoingBack=!1,this.wasGoingBack=!1,this.holdFactor=1,this.easeHoldDecrease=!1,this.holdingSequenceTime=1,this.texturePool=new Map,this.holdValue=0,this.hold=0,this.loaded=!1,this.onTouchActive=new P.Z,this.activities=new M(this.renderer),this.quad=new C.Z(this.renderer.gl),this.holdRef=(0,T.iH)(0),this.holdDuration=(0,T.iH)(0),this.currIntroPercentage=(0,T.iH)(0),this.currOutroPercentage=(0,T.iH)(0),this.canReleaseRef=(0,T.iH)(!0),this.isIntroPlaying=(0,T.iH)(!1),this.isOutroPlaying=(0,T.iH)(!1),this.isTitlePlaying=(0,T.iH)(!1),this.firstRelease=(0,T.iH)(!1),this.isTransitionToPortailPlaying=(0,T.iH)(!1),this.showTitle=(0,T.iH)(!1)}async load(){const{default:t}=await Promise.all([n.e(9400),n.e(6478),n.e(8215),n.e(9327),n.e(8173)]).then(n.bind(n,18173));this.trailManager=new t(this.renderer,this.texturePool),this.lighting=new D.Z(this.renderer.gl),await Promise.all([this.trailManager.load(),this.lighting.load(),...Array.from(this.texturePool.values()).map((t=>t.load()))]),this.trailManager.onLoaded(),this.loaded=!0}async loadTransition(){const{default:t}=await Promise.all([n.e(9400),n.e(6478),n.e(8592)]).then(n.bind(n,58592));this.transitionToPortail=new t(this.renderer)}unload(){}async createTexturePool(){const t=(await Promise.all([n.e(9400),n.e(6478)]).then(n.bind(n,56478))).default;this.texturePool.set("tile",t.getTexture("textures/tile.webp",this.renderer.gl,{alpha:!0})),this.texturePool.set("fbmNoise",t.getTexture("textures/fbm.webp",this.renderer.gl,{smooth:!1})),this.texturePool.set("perlinNoise",t.getTexture("textures/perlinNoise.webp",this.renderer.gl,{alpha:!0})),this.texturePool.set("fractalNoise",t.getTexture("textures/fractalNoise.jpg",this.renderer.gl,{alpha:!0})),this.texturePool.set("turbulenceNoise",t.getTexture("textures/turbulenceNoise.webp",this.renderer.gl,{alpha:!0}));const e=t.getTexture("textures/wnoise.webp",this.renderer.gl,{smooth:!1});e.texture.setFormat(this.renderer.gl.LUMINANCE),this.texturePool.set("whiteNoise",e),this.renderer.createPostProcess()}async warmup(){const t=[this.activities.getActivity("scene1")];for(let r=0;r<t.length;r++)t[r].start(),t[r].preRender(),t[r].rttPass();const e=this.renderer.camera,n=this.renderer.viewport;e.updateViewProjectionMatrix(n.width,n.height);const i=this.renderer.gl;i.bindFramebuffer(i.FRAMEBUFFER,null),n.setupGl(i),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.context.withCamera(this.renderer.camera);for(let r=0;r<t.length;r++)t[r].render(this.renderer.context.withMask(y.Z.OPAQUE)),t[r].render(this.renderer.context.withMask(y.Z.BLENDED).withPass(R.Z.DEPTH));for(let r=0;r<t.length;r++)t[r].stop();await(0,F.Z)(200)}prepareTransition(t){this.transitionToPortail.isTransitionToScene(t),this.transitionToPortail.prepare()}playTransitionToPortail(){this.transitionToPortail.play()}preRender(){var t,e;if(!this.loaded)return;null===(t=this.transitionToPortail)||void 0===t||t.preRender(),this.trailManager.preRender();const n=this.holdValue;if(this.wasGoingBack=this.isGoingBack,this.wasBlockHold=this.blockHold,this.canHold=!this.blockHold,this.canReleaseRef.value=!this.blockRelease&&!this.blockHoldDown,this.isTransitionToPortailPlaying.value=(null===(e=this.transitionToPortail)||void 0===e?void 0:e.isPlaying)||!1,!this.blockHold){const t=r.Z.scaledDt/1e3;this.holdFactor=this.isHolding&&this.canHold?1:this.easeHoldDecrease?(0,E.Z)(this.holdFactor,-1,.05):this.blockHoldDown?0:-1;const e=1;this.holdValue+=t*this.holdFactor*e,this.holdValue=(0,A.uZ)(this.holdValue,0,this.holdingSequenceTime),this.holdRef.value=this.holdValue/this.holdingSequenceTime,this.holdDuration.value=this.holdingSequenceTime,this.hold=this.holdValue}this.isGoingBack=Math.sign(this.holdValue-n)<0;for(const i of this.activities.active)i.preRender();this.wasHolding=this.isHolding}rttPass(){if(this.loaded)for(const t of this.activities.active)t.rttPass()}render(t){if(this.loaded){this.trailManager.renderAbove||this.trailManager.render(t);for(const e of this.activities.active)e.render(t);this.trailManager.renderAbove&&this.trailManager.render(t)}}}var O=n(28140);const H=["pointercancel","pointerdown","pointerenter","pointerleave","pointermove","pointerout","pointerover","pointerup"];var I,N;(function(t){t[t["Left"]=1]="Left",t[t["Right"]=2]="Right",t[t["Middle"]=4]="Middle",t[t["Back"]=8]="Back",t[t["Forward"]=16]="Forward",t[t["Eraser"]=32]="Eraser"})(I||(I={}));class z{constructor(){this.client=s.vec2.create(),this.viewport=s.vec2.create()}}class Z{get lastEvent(){return this._lastEvent}get pointerId(){return this._pointerId}constructor(t){this._inputs=t,this.coord=new z,this.downCoord=new z,this.onDown=new P.Z,this.onUp=new P.Z,this._lastEvent=null,this._pointerId=-1,this._pressed=0,this._depressed=0}isDown(t=I.Left){return null!==this._lastEvent&&0!==(this._lastEvent.buttons&t)}isPressed(t=I.Left){return 0!==(this._pressed&t)}isDepressed(t=I.Left){return 0!==(this._depressed&t)}_handleEvent(t){switch(this._lastEvent=t,this._pointerId=t.pointerId,this._computeCoords(this.coord,t),t.type){case"pointercancel":case"pointerleave":"mouse"!==t.pointerType&&(this._pointerId=-1);break;case"pointerdown":this._computeCoords(this.downCoord,t),this.onDown.emit(t),this._pressed=t.buttons;break;case"pointerup":this.onUp.emit(t),this._depressed=t.buttons;break}}_computeCoords(t,e){t.client[0]=e.offsetX,t.client[1]=e.offsetY,t.viewport[0]=e.offsetX/this._inputs.viewportSize[0]*2-1,t.viewport[1]=-e.offsetY/this._inputs.viewportSize[1]*2+1}endFrame(){this._pressed=0,this._depressed=0}}class k{constructor(t){this.el=t,this.primary=new Z(this),this.secondary=new Z(this),this.viewportSize=s.vec2.create(),this._onPointerEvent=t=>{let e=null;t.pointerId===this.secondary.pointerId?e=this.secondary:t.pointerId===this.primary.pointerId||t.isPrimary?e=this.primary:-1===this.secondary.pointerId&&(e=this.secondary),null!==e&&e._handleEvent(t)},H.forEach((e=>{t.addEventListener(e,this._onPointerEvent)})),this._resizeObs=new ResizeObserver((t=>{const{width:e,height:n}=t[0].contentRect;this.viewportSize[0]=e,this.viewportSize[1]=n})),this._resizeObs.observe(t)}dispose(){H.forEach((t=>{this.el.removeEventListener(t,this._onPointerEvent)})),this._resizeObs.disconnect()}endFrame(){this.primary.endFrame(),this.secondary.endFrame()}}(function(t){t[t["NONE"]=-1]="NONE",t[t["IDLE"]=0]="IDLE",t[t["ORBIT"]=1]="ORBIT",t[t["PAN"]=2]="PAN",t[t["DOLLY"]=3]="DOLLY"})(N||(N={}));const U=s.quat.create(),V=s.quat.create(),G=s.quat.create(),W=s.vec3.create(),X=s.vec3.create(),j=s.mat4.create(),q=10;function K(t,e,n){n[0]=2*t.clientX/window.innerWidth-1,n[1]=-(2*t.clientY/window.innerHeight-1)}class Y{start(){}update(){}}class ${constructor(t){this.ctrl=t,this.initialX=s.vec3.create(),this.initialR=s.quat.create(),this.initialP=s.vec3.create(),this.startMouse=s.vec3.create(),this.focus=s.vec3.create()}start(t,e,n){this.cam=t,s.vec3.copy(this.initialX,this.cam._matrix),s.vec3.copy(this.startMouse,n),s.quat.copy(this.initialR,t.rotation),s.vec3.subtract(this.initialP,t.position,e),s.vec3.copy(this.focus,e)}update(t){s.vec3.subtract(W,t,this.startMouse),s.quat.setAxisAngle(G,this.initialX,5*W[1]),s.quat.rotateY(V,U,5*-W[0]),s.quat.multiply(V,V,G),s.quat.multiply(this.cam.rotation,V,this.initialR),s.vec3.transformQuat(W,this.initialP,V),s.vec3.add(this.cam.position,this.focus,W),this.cam.invalidate()}}class Q{constructor(t){this.ctrl=t,this.initialX=s.vec3.create(),this.initialY=s.vec3.create(),this.initialP=s.vec3.create(),this.startMouse=s.vec3.create(),this.focus=s.vec3.create()}start(t,e,n){this.cam=t,s.vec3.copy(this.initialX,this.cam._matrix),s.vec3.copy(this.initialP,this.cam.position),this.initialY[0]=this.cam._matrix[4],this.initialY[1]=this.cam._matrix[5],this.initialY[2]=this.cam._matrix[6],s.vec3.copy(this.startMouse,n),s.vec3.copy(this.focus,e)}update(t){s.vec3.subtract(W,t,this.startMouse),s.vec3.scale(X,this.initialX,-W[0]*q),s.vec3.scaleAndAdd(X,X,this.initialY,-W[1]*q),s.vec3.add(this.cam.position,this.initialP,X),this.cam.invalidate()}}class J{constructor(t){this.ctrl=t,this.initialZ=s.vec3.create(),this.initialP=s.vec3.create(),this.startMouse=s.vec3.create(),this.focus=s.vec3.create()}start(t,e,n){this.cam=t,s.vec3.copy(this.initialP,this.cam.position),s.vec3.subtract(this.initialZ,this.cam.position,e),s.vec3.copy(this.startMouse,n),s.vec3.copy(this.focus,e)}update(t){s.vec3.subtract(W,t,this.startMouse);const e=this.ctrl.controlScheme.inverseDolly?-1:1;s.vec3.scale(W,this.initialZ,5*W[1]*e),s.vec3.add(this.cam.position,this.initialP,W),this.cam.invalidate()}}class tt{constructor(t){this.onMouseMove=t=>{var e,n;const i=null!==(n=null===(e=this.controlScheme)||void 0===e?void 0:e.getModeForEvt(t))&&void 0!==n?n:N.IDLE;this.setMode(i),K(t,this.el,this.mouse),this.action.update(this.mouse)},this.el=t,this.mouse=s.vec3.fromValues(0,0,1),this.cam=null,this.orbitRadius=-30,this.mode=N.NONE}start(t){this.cam=t,this.cam.updateWorldMatrix(),this.orbitRadius=-s.vec3.length(this.cam._wposition),this.el.addEventListener("mousemove",this.onMouseMove),this.mode=-1,this.setMode(N.IDLE)}stop(){this.cam=null,this.el.removeEventListener("mousemove",this.onMouseMove)}update(t){}setMode(t){if(this.mode!==t){switch(this.mode=t,t){case N.IDLE:this.action=new Y;break;case N.ORBIT:this.action=new $(this);break;case N.PAN:this.action=new Q(this);break;case N.DOLLY:this.action=new J(this);break}this.unproject(W),this.action.start(this.cam,W,this.mouse)}}unproject(t){this.cam.updateMatrix(),s.mat4.invert(j,this.cam.lens._proj),s.vec3.transformMat4(W,this.mouse,j);const e=-s.vec3.length(this.cam._wposition);s.vec3.scale(W,W,e/W[2]),s.vec3.transformMat4(t,W,this.cam._matrix)}}class et{constructor(){this.inverseDolly=!0}getModeForEvt(t){return 0==(1&t.buttons)?N.IDLE:N.ORBIT}}class nt{constructor(t){this.camera=t,this._active=!1}setControler(t){var e;null===(e=this._controler)||void 0===e||e.stop(),this._controler=t,this._active&&(null===t||void 0===t||t.start(this.camera))}start(){var t;this._active||(this._active=!0,null===(t=this._controler)||void 0===t||t.start(this.camera))}stop(){var t;this._active&&(this._active=!1,null===(t=this._controler)||void 0===t||t.stop())}preRender(){var t;null===(t=this._controler)||void 0===t||t.update(r.Z.dt)}}function it(t){const e=new tt(t.ilayer);e.controlScheme=new et;const n=new nt(at.makeDefaultCamera());return n.setControler(e),n}var rt=n(85645),st=n(20508),ot=n(61987);class at{constructor(t){this.renderer=t,this._managers=new Map;const e=new nt(at.makeDefaultCamera());this.registerCamera(e,"main");const n=it(t);this.registerCamera(n,"orbit"),this.use("main")}get camera(){return this._current.camera}get mainCamera(){return this._managers.get("main").camera}get current(){return this._current}use(t){var e,n;null===(e=this._current)||void 0===e||e.stop(),console.assert(this._managers.has(t),`camera manager ${t} doesn't exist`),this._current=this._managers.get(t),null===(n=this._current)||void 0===n||n.start()}registerCamera(t,e){console.assert(!this._managers.has(e),`camera manager ${e} already registered`),this._managers.set(e,t)}preRender(){this.current.preRender(),this.camera.updateWorldMatrix()}static makeDefaultCamera(){const t=new rt.Z(new st.Z);t.lens.setAutoFov(35*A.qW),t.lens.near=.1,t.lens.far=2e3;const e=new ot.Z;return e.add(t),t.setMatrix(new Float32Array([.7726250290870667,-1.4619167210128126e-8,-.6348624229431152,0,-.03074836730957,.9988264441490173,-.037420663982629776,0,.6341174244880676,.048433128744363785,.7717183828353882,0,5.253443717956543,1.3910399675369263,6.792383193969727,1])),t}}var ht=n(88760),lt=n(55411),ct=n(18158);function ut(t){return void 0!==t.texStorage3D}class dt{constructor(t){this.gl=t,this.EXT_texture_float=t.getExtension("OES_texture_float"),this.EXT_texture_half_float=t.getExtension("OES_texture_half_float"),this.EXT_texture_half_float_linear=t.getExtension("OES_texture_half_float_linear"),this.EXT_texture_float_linear=t.getExtension("OES_texture_float_linear"),this.EXT_color_buffer_float=t.getExtension("EXT_color_buffer_float"),this.EXT_color_buffer_half_float=t.getExtension("EXT_color_buffer_half_float"),this.WEBGL_depth_texture=t.getExtension("WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture");const e=t,n=t;void 0===n.HALF_FLOAT&&this.EXT_texture_half_float&&(e.HALF_FLOAT=this.EXT_texture_half_float.HALF_FLOAT_OES),void 0===n.UNSIGNED_INT_24_8&&this.WEBGL_depth_texture&&(e.UNSIGNED_INT_24_8=34042),this._availables={},this._renderables={},this.RGB8=ft(t.RGB,n.RGB,n.UNSIGNED_BYTE),this.RGBA8=ft(t.RGBA,n.RGBA,n.UNSIGNED_BYTE),this.RGB32F=ft(t.RGB,n.RGB32F,n.FLOAT),this.RGBA32F=ft(t.RGBA,n.RGBA32F,n.FLOAT),this.RGB16F=ft(t.RGB,n.RGB16F,n.HALF_FLOAT),this.RGBA16F=ft(t.RGBA,n.RGBA16F,n.HALF_FLOAT),this.A2B10G10R10=ft(t.RGBA,n.RGB10_A2,n.UNSIGNED_INT_2_10_10_10_REV)}static getInstance(t){const e=t;var n=e.__pf;return void 0===n&&(e.__pf=n=new dt(t)),n}dispose(){this.EXT_texture_float=null,this.EXT_texture_half_float=null,this.EXT_texture_half_float_linear=null,this.EXT_texture_float_linear=null,this.EXT_color_buffer_float=null,this.EXT_color_buffer_half_float=null;const t=this.gl;t.__pf===this&&delete t.__pf}hasDepthTexture(){return ut(this.gl)?this.isAvailable(this.gl.DEPTH_COMPONENT,this.gl.UNSIGNED_INT,this.gl.DEPTH_COMPONENT24):this.isAvailable(this.gl.DEPTH_COMPONENT,this.gl.UNSIGNED_INT,this.gl.DEPTH_COMPONENT)}isAvailable(t,e,n){if(void 0===t||void 0===e)return!1;void 0===n&&(n=t);var i=pt(t,e,n);return void 0===this._availables[i]&&(this._availables[i]=this._testAvailable(t,e,n)),this._availables[i]}isRenderable(t,e,n){if(void 0===t||void 0===e)return!1;void 0===n&&(n=t);const i=pt(t,e,n);if(void 0===this._renderables[i]){const r=this.isAvailable(t,e,n);this._renderables[i]=r&&this._testRenderable(t,e,n)}return this._renderables[i]}getRenderableFormat(t){for(var e=0;e<t.length;e++){var n=t[e];if(this.isRenderable(n.format,n.type,n.internal))return n}return null}_testAvailable(t,e,n){const i=this.gl;i.getError();const r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.texImage2D(i.TEXTURE_2D,0,n,4,4,0,t,e,null),i.deleteTexture(r),0===i.getError()}_testRenderable(t,e,n){const i=this.gl,r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texImage2D(i.TEXTURE_2D,0,n,4,4,0,t,e,null);const s=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,s),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,r,0);const o=i.checkFramebufferStatus(i.FRAMEBUFFER)===i.FRAMEBUFFER_COMPLETE;return i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindTexture(i.TEXTURE_2D,null),i.deleteTexture(r),i.deleteFramebuffer(s),o}}function ft(t,e,n){return{format:t,internal:e,type:n}}function pt(t,e,n){return t^e<<8^n<<16}var mt=dt,gt=n(61537),vt=n.n(gt),_t=n(96540),xt=n.n(_t),bt=n(68209);class wt{constructor(t,e=!1){if(this.gl=t,this._effects=[],this._flags=0,this._shaderInvalid=!0,this.renderWidth=1,this.renderHeight=1,this.bufferWidth=1,this.bufferHeight=1,this.enabled=!0,this.mipmap=e,this.float_texture_ext=t.getExtension("OES_texture_float"),this.halfFloat=t.getExtension("OES_texture_half_float"),this.float_texture_ext_l=t.getExtension("OES_texture_half_float_linear"),this.halfFloat_l=t.getExtension("OES_texture_float_linear"),this.color_buffer_float=t.getExtension("EXT_color_buffer_float"),this.hasDepthTexture=mt.getInstance(t).hasDepthTexture(),this.mainFbo=this.genFbo(),this.mainColor=this.mainFbo.getColor(0),this.mipmap){this.mainColor.bind(),t.generateMipmap(t.TEXTURE_2D);const e=t.getError();e&&(this.mipmap=!1,this.mainFbo.dispose(),this.mainFbo=this.genFbo(),this.mainColor=this.mainFbo.getColor(0))}this.mainColor.setFilter(!1,this.mipmap,!1),this.prg=new a.Z(t);const n=new Float32Array([0,0,1,0,0,1,1,1]);this.fsPlane=new ct.Z(t,n),this.fsPlane.attrib("aTexCoord0",2,t.FLOAT)}dispose(){this.mainFbo.dispose(),this.fsPlane.dispose(),this.prg.dispose()}_needDepth(){return 0!==(this._flags&bt.I.DEPTH)}_needLinear(){return 0!==(this._flags&bt.I.LINEAR)}genFbo(){const t=this.gl,e=mt.getInstance(t),n=t.getContextAttributes(),i=[e.RGB16F,e.RGBA16F,e.RGB32F,e.RGBA32F,e.RGB8];(0,m.I)(t);const r=e.getRenderableFormat(i),s=new h.Z(t);s.bind(),s.attachColor(r.format,r.type,r.internal),s.attachDepth(n.depth,n.stencil,this.hasDepthTexture),s.resize(4,4);const o=s.getColor(0);if(o.bind(),o.clamp(),this.hasDepthTexture){const t=s.getDepth();t.bind(),t.clamp(),t.setFilter(!1,!1,!1)}return s}add(t){-1===this._effects.indexOf(t)&&(this._effects.push(t),t._init(this),t.resize(this.renderWidth,this.renderHeight),this._flags|=t._flags,this._shaderInvalid=!0)}remove(t){const e=this._effects.indexOf(t);if(e>-1&&(this._effects.splice(e,1),t.release(),t.post=null,this._shaderInvalid=!0,0!==t._flags)){this._flags=0;for(var n=0;n<this._effects.length;n++)this._flags|=t._flags}}resize(t,e){this.bufferWidth=t,this.bufferHeight=e,this.mainFbo.resize(this.bufferWidth,this.bufferHeight);for(var n=0;n<this._effects.length;n++)this._effects[n].resize(t,e)}preRender(t,e){if(this.renderWidth=t,this.renderHeight=e,this.enabled){const n=this.mipmap?Ct(t):t,i=this.mipmap?Ct(e):e;this.bufferWidth===n&&this.bufferHeight===i||this.resize(n,i)}}needDepthPass(){return this.enabled&&this._needDepth()&&!this.hasDepthTexture}bindColor(){const t=this.gl;this.enabled?this.mainFbo.bind():t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.renderWidth,this.renderHeight),this.mainFbo.clear()}render(t){if(!this.enabled)return;const e=this.gl;this.mainColor.bind(),this.mipmap&&e.generateMipmap(e.TEXTURE_2D);for(var n=0;n<this._effects.length;n++)this._effects[n].preRender();void 0!==t?(t.resize(this.renderWidth,this.renderHeight),t.bind()):e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.renderWidth,this.renderHeight),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._shaderInvalid&&this.buildProgram(),this.prg.use();for(n=0;n<this._effects.length;n++)this._effects[n].setupProgram(this.prg);if(this.prg.tInput(this.mainColor),this._needDepth()){if(!this.hasDepthTexture)throw"no depth texture";this.prg.tDepth(this.mainFbo.getDepth())}this.fillScreen(this.prg)}fillScreen(t,e=!1){!0===e?t.uViewportScale(1,1):t.uViewportScale(this.renderWidth/this.bufferWidth,this.renderHeight/this.bufferHeight),this.fsPlane.attribPointer(t),this.fsPlane.drawTriangleStrip()}buildProgram(){for(var t=[],e=[],n=this._effects,i=0;i<n.length;i++)n[i].genCode(e,t);const r=t.join("\n"),s=e.join("\n");var o=vt()({code:r,precode:s}),a=xt()(),h=this._needDepth()&&this.hasDepthTexture,l="";(0,m.I)(this.gl)&&(l+="#version 300 es\n"),l+="precision highp float;\n",l+="#define NEED_DEPTH "+ +this._needDepth()+"\n",l+="#define TEXTURE_DEPTH "+ +h+"\n",this.prg.compile(a,o,l),this._shaderInvalid=!1,this.mainColor.bind(),this.mainColor.setFilter(this._needLinear(),this.mipmap,!1)}}const St=4096;function Ct(t){var e=1;while(e<t)e<<=1;return e>St&&(e=St),e}var Tt=n(95871),Et=n.n(Tt);class Ft extends bt.Z{constructor(){super(),this._code=Et()()}genCode(t,e){e.push(this._code)}init(){}release(){}preRender(){}setupProgram(t){}resize(t,e){}}var Pt=n(35979);class Dt{set msaa(t){this._msaa!==t&&(this._msaa=Math.min(t,this._maxMsaa),this._allocate())}get msaa(){return this._msaa}constructor(t,e=!1,n=4,i=!0,r=!1){this.gl=t,this._alpha=e,this._depth=i,this._stencil=r,this.msaaFbo=null,this.blitFbo=null,this._msaa=1,this._maxMsaa=1,this._width=4,this._height=4,this._maxMsaa=(0,m.I)(t)?t.getParameter(t.MAX_SAMPLES):0,this.msaa=n}_allocate(){var t;const e=this.gl,n=Pt.Z.getInstance(e),i=n.getRenderableFormat([n.RGBA16F,n.RGBA32F,n.RGBA8]),r=n.getRenderableFormat([n.RGB16F,n.RGB32F,n.RGB8]),s=this._alpha?i:r,o=this._depth,a=e.DEPTH_ATTACHMENT,l=o&&(0,m.I)(e)?e.DEPTH_COMPONENT24:e.DEPTH_COMPONENT16;(0,m.I)(e)&&this._msaa>0&&null===this.msaaFbo&&(this.msaaFbo=new h.Z(e),this.msaaFbo.attach(e.COLOR_ATTACHMENT0,new v.Z(e,s.internal,this._msaa)),this._depth&&this.msaaFbo.attach(a,new v.Z(e,l,this._msaa)),this.msaaFbo.resize(this._width,this._height)),this._msaa<1&&(null===(t=this.msaaFbo)||void 0===t||t.dispose(),this.msaaFbo=null),null===this.blitFbo&&(this.blitFbo=new h.Z(e),this.blitFbo.attach(e.COLOR_ATTACHMENT0,new g.Z(e,s.format,s.type,s.internal)),this._depth&&this.blitFbo.attach(a,new v.Z(e,l)),this.blitFbo.getColorTexture(0).setFilter(!1,!1,!1),this.blitFbo.resize(this._width,this._height))}get renderFbo(){var t;return null!==(t=this.msaaFbo)&&void 0!==t?t:this.blitFbo}blitMsaa(){if(this.msaaFbo){const t=this.gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.msaaFbo.fbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.blitFbo.fbo),t.clearBufferfv(t.COLOR,0,[0,0,0,1]),t.clearBufferfv(t.DEPTH,0,[0,0,0,1]);let e=t.COLOR_BUFFER_BIT;this._depth&&(e|=t.DEPTH_BUFFER_BIT),this._stencil&&(e|=t.STENCIL_BUFFER_BIT),t.blitFramebuffer(0,0,this.msaaFbo.width,this.msaaFbo.height,0,0,this.msaaFbo.width,this.msaaFbo.height,e,t.NEAREST)}}getColorTexture(){return this.blitFbo.getColorTexture()}setSize(t,e){var n;this._width=t,this._height=e,null===(n=this.msaaFbo)||void 0===n||n.resize(t,e),this.blitFbo.resize(t,e)}}var yt=n(24705),Rt=n.n(yt),Lt=n(61790),Mt=n.n(Lt);class At extends bt.Z{constructor(t,e,n){super(),this.contrast=t,this.brightness=e,this.bias=n,this.contrastTint=[1,1,1],this.brightnessTint=[1,1,1],this.biasTint=[1,1,1],this._preCode=Rt()(),this._code=Mt()()}genCode(t,e){t.push(this._preCode),e.push(this._code)}setupProgram(t){const e=this.contrast,n=this.contrastTint,i=this.brightness,r=this.brightnessTint,s=this.bias,o=this.biasTint;t.uContrastScale(n[0]*e*(r[0]*i),n[1]*e*(r[1]*i),n[2]*e*(r[2]*i)),t.uContrastBias(o[0]*s*(-n[0]*e+1)*(r[0]*i),o[1]*s*(-n[1]*e+1)*(r[1]*i),o[2]*s*(-n[2]*e+1)*(r[2]*i))}init(){}release(){}preRender(){}resize(t,e){}}var Bt=n(81592),Ot=n.n(Bt),Ht=n(84910),It=n.n(Ht);class Nt extends bt.Z{constructor(t){super(),this.tint=[1,1,1],this.amount=t,this._preCode=Ot()(),this._code=It()()}genCode(t,e){t.push(this._preCode),e.push(this._code)}setupProgram(t){const e=this.amount,n=this.tint;t.uSaturation(n[0]*e,n[1]*e,n[2]*e)}init(){}release(){}preRender(){}resize(t,e){}}var zt=n(51498),Zt=n.n(zt),kt=n(98237),Ut=n.n(kt);class Vt extends bt.Z{constructor(t,e,n){super(),this.color=t,this.curve=n,this.strength=e,this._preCode=Zt()(),this._code=Ut()()}genCode(t,e){t.push(this._preCode),e.push(this._code)}setupProgram(t){const e=this.color,n=this.strength,i=this.post.renderWidth,r=this.post.renderHeight,s=Math.max(i,r);t.uVignetteAspect(i/s,r/s,.5*i/s,.5*r/s),t.uVignette(2*(1-e[0])*n,2*(1-e[1])*n,2*(1-e[2])*n,this.curve)}init(){}release(){}preRender(){}resize(t,e){}}var Gt=n(86883),Wt=n.n(Gt),Xt=n(9769),jt=n.n(Xt),qt=n(63394),Kt=n.n(qt),Yt=n(99374),$t=n.n(Yt);const Qt=128;class Jt extends bt.Z{constructor(t,e,n){super(),this.enabled=!0,this.effectStrength=0,this.size=t,this.vignetteSize=n,this.vignetteStart=e,this.blurTargets=[],this.blurSamples=0,this.blurKernel=null,this.prcPrg=null,this._fragPreCode=Kt()(),this._fragCode=$t()()}init(){const t=this.post.gl,e=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),n=Pt.Z.getInstance(t),i=[n.RGB16F,n.RGBA16F,n.RGB32F,n.RGBA32F,n.RGB8],r=n.getRenderableFormat(i);for(let o=0;o<2;++o){this.blurTargets[o]=new h.Z(t),this.blurTargets[o].bind(),this.blurTargets[o].attachColor(r.format,r.type,r.internal),this.blurTargets[o].resize(Qt,Qt);const e=this.blurTargets[o].getColor(0);e.setFilter(!0,!1,!1),e.clamp()}for(this.blurSamples=16;this.blurSamples+16>=e;)this.blurSamples/=2;this.blurKernel=new Float32Array(4*this.blurSamples);let s="\n";s+="precision highp float;\n",s+=`#define BLUR_SAMPLES ${this.blurSamples} \n`,this.prcPrg=new a.Z(t),this.prcPrg.compile(jt()({precode:"",code:""}),Wt()(),s)}resize(){}release(){null!==this.prcPrg&&this.prcPrg.dispose(),this.prcPrg=null;for(let t=0;t<2;++t)this.blurTargets[t].dispose();this.blurTargets=[]}genCode(t,e){t.push(this._fragPreCode),e.push(this._fragCode)}preRender(){if(!this.enabled)return;const t=this.prcPrg,e=this.post;this.computeKernel(),this.blurTargets[0].bind(),this.blurTargets[0].defaultViewport(),this.blurTargets[0].clear(),t.use(),t.tInput(e.mainColor),t.uKernel(this.blurKernel),e.fillScreen(t),this.transposeKernel(),this.blurTargets[1].bind(),this.blurTargets[1].defaultViewport(),this.blurTargets[1].clear(),t.tInput(this.blurTargets[0].getColor(0)),t.uKernel(this.blurKernel),e.fillScreen(t)}setupProgram(t){this.enabled&&(t.tBlur(this.blurTargets[1].getColor(0)),t.uStrength(this.vignetteSize),t.uEffect(this.effectStrength),t.uStart(this.vignetteStart),t.uRatio(this.post.renderWidth/this.post.renderHeight))}computeKernel(){const t=this.blurKernel,e=Math.sqrt(Math.PI);let n=0;for(let i=0;i<this.blurSamples;++i){const r=4*i,s=2*i/(this.blurSamples-1)-1;let o=4*s;o=Math.exp(-o*o/2)/e,n+=o,t[r+0]=s*this.size,t[r+1]=0,t[r+2]=o,t[r+3]=0}for(let i=0;i<this.blurSamples;++i)t[4*i+2]/=n}transposeKernel(){const t=this.blurKernel,e=this.post.renderWidth/this.post.renderHeight;for(let n=0;n<this.blurSamples;++n){const i=n<<2;t[i+1]=t[i]*e,t[i]=0}}}var te=Jt,ee=n(89133);const ne=3553;class ie extends ee.Z{constructor(t,e,n,i){super(t,e,n,i),this.textureType=3553,this._target=ne,t.bindTexture(ne,this.id),this.setFilter(!0)}fromImage(t){const e=this.gl;this.width=t.width,this.height=t.height,e.bindTexture(ne,this.id),e.texImage2D(ne,0,this.internal,this.format,this.type,t)}fromData(t,e,n=null){const i=this.gl;this.width=t,this.height=e,n=n||null,i.bindTexture(ne,this.id),i.texImage2D(ne,0,this.internal,t,e,0,this.format,this.type,n)}}var re=n(39983),se=n.n(re),oe=n(57897),ae=n.n(oe);const he=new Uint8Array(9);he[0]=255,he[4]=255,he[8]=255;class le extends bt.Z{preRender(){}constructor(){super(),this._flags|=bt.I.LINEAR,this._code=se()(),this._preCode=ae()(),this._rgbTex=null,this.amount=.015}init(){const t=this.post.gl;this._rgbTex=new ie(t,t.RGB),this._rgbTex.fromData(3,1,he),this._rgbTex.clamp(),this._rgbTex.setFilter(!0,!1,!1)}release(){this._rgbTex.dispose(),this._rgbTex=null}genCode(t,e){t.push(this._preCode),e.push(this._code)}setupProgram(t){t.tChromaShiftTex&&t.tChromaShiftTex(this._rgbTex),t.uAmount(this.amount)}resize(){}}var ce=le,ue=n(2931),de=n.n(ue),fe=n(47478),pe=n.n(fe);class me extends bt.Z{constructor(t){super(),this.noiseTex=t,this.aspectRatio=[1,1],this.color=s.vec3.fromValues(234/255,228/255,203/255),this.noiseRepeat=.1,this.noiseOffset=s.vec2.fromValues(Math.random(),Math.random()),this.borderWidth=[s.vec4.fromValues(0,0,0,0),s.vec4.fromValues(0,0,0,0),s.vec4.fromValues(0,0,0,0)],this.effectStrength=1,this._preCode=pe()(),this._code=de()()}genCode(t,e){t.push(this._preCode),e.push(this._code)}init(){}release(){}setupProgram(t){t.uFrameTime(r.Z.time),t.uFrameColor(this.color),t.uFrameNoise(this.noiseTex),t.uFrameAspect(this.aspectRatio),t.uFrameStrength(this.effectStrength),t.uFrameNoiseOffset(this.noiseOffset),t.uFrameNoiseRepeat(this.noiseRepeat),t.uFrameBorderWidth1(this.borderWidth[0]),t.uFrameBorderWidth2(this.borderWidth[1]),t.uFrameBorderWidth3(this.borderWidth[2])}resize(t,e){0!==t&&0!==e&&(this.aspectRatio=[t/e,1])}preRender(){}}var ge=n(23314),ve=n.n(ge),_e=n(54686),xe=n.n(_e);class be extends bt.Z{constructor(){super(),this.effectStrength=1,this.h=2,this.lacunarity=1,this.frequency=1.4,this.octaves=2,this.scale=1,this.speed=2,this._preCode=ve()(),this._code=xe()()}genCode(t,e){t.push(this._preCode),e.push(this._code)}init(){}release(){}setupProgram(t){t.uSplatStrength(this.effectStrength),t.uTimeSplat(1e-4*r.Z.scaledTime),t.uH(this.h),t.uLacunarity(this.lacunarity),t.uFreq(this.frequency),t.uOctaves(this.octaves),t.uScaleSplat(this.scale),t.uSpeedSplat(this.speed)}preRender(){}resize(t,e){}}var we=n(68872),Se=n(95119),Ce=n.n(Se),Te=n(88960),Ee=n.n(Te);class Fe extends bt.Z{constructor(t){super(),this.renderer=t,this._preCode=Ee()(),this._code=Ce()(),this.texture=new g.Z(t.gl)}genCode(t,e){t.push(this._preCode),e.push(this._code)}init(){}release(){}setupProgram(t){t.uTransitionTex(this.texture),t.uTransitionRotate(this.renderer.viewport.width>this.renderer.viewport.height?0:1)}preRender(){var t;(null===(t=this.renderer.scene.transitionToPortail)||void 0===t?void 0:t.allImgLoaded)&&this.renderer.scene.transitionToPortail.atlas&&(this.texture=this.renderer.scene.transitionToPortail.atlas[0].texture)}resize(t,e){}}class Pe{get enabled(){return this.post.enabled}set enabled(t){this.post.enabled=t}constructor(t){this.renderer=t,this._effectList=[],this.clearColor=s.vec4.fromValues(1,1,1,1),this.noiseTex=t.scene.texturePool.get("perlinNoise").texture,this.post=new wt(t.gl,!1),this.post.enabled=!0,this.fetch=new Ft,this.chroma=new ce,this.chroma.amount=0,this.saturation=new Nt(1.1),this.contrast=new At(1.04,1,1.07),this.texturepass=new we.ZP(t),this.transitionPass=new Fe(t),this.vignette=new Vt([0,0,0],0,-.2),this.frame=new me(this.noiseTex),this.post.add(this.fetch),this.post.add(this.chroma),this.post.add(this.vignette),this.post.add(this.contrast),this.post.add(this.saturation),this.post.add(this.texturepass),this.msaa=new Dt(t.gl,!0,8,!0,!1),this.post.mainColor=this.msaa.blitFbo.getColorTexture(),this.post.mainFbo=this.msaa.blitFbo;const e=.01,n=.11,i=.47;this.vignetteblur=new te(e,n,i),this.vignetteblur.effectStrength=0,this.splat=new be,this.splat.effectStrength=0}paneSetup(){}preRender(t,e){this.post.preRender(t,e),this.msaa.setSize(t,e)}bindColor(t){if(s.vec4.copy(this.clearColor,t),!this.post.enabled){const e=this.post.gl;e.bindFramebuffer(e.FRAMEBUFFER,null);const n=t;return e.clearColor(n[0],n[1],n[2],n[3]),void e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}this.msaa.renderFbo.bind(),this.renderer.gl.viewport(0,0,this.post.renderWidth,this.post.renderHeight),this.msaa.renderFbo.clear()}render(t=0,e=0,n=this.post.renderWidth,i=this.post.renderHeight){const r=this.post;if(!r.enabled)return;const s=r.gl;this.msaa.blitMsaa();for(let a=0;a<r._effects.length;a++)r._effects[a].preRender();s.bindFramebuffer(s.FRAMEBUFFER,null);const o=this.clearColor;s.clearColor(o[0],o[1],o[2],o[3]),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.viewport(t,e,n,i),r._shaderInvalid&&r.buildProgram(),r.prg.use();for(let a=0;a<r._effects.length;a++)r._effects[a].setupProgram(r.prg);if(r._needDepth()){if(!r.hasDepthTexture)throw"no depth texture";r.prg.tDepth(this.msaa.blitFbo.getDepth())}r.prg.tInput(this.msaa.getColorTexture()),r.fillScreen(r.prg)}}var De=n(46009);function ye(t,e){return De.Z}function Re(t){return()=>{}}function Le(t,e,n){const i=Re(((n,i)=>t(n,i,e)));if(void 0===e||void 0===n)return i;i(e,n)}function Me(t,e){return Le(((t,e,n)=>{const i=ye(t,n).addColor(t,e);return(null===n||void 0===n?void 0:n.label)&&i.setLabel(n.label),i}),t,e)}const Ae=16686892,Be={enabled:!1,init(t){},drawGuizmo(t){},drawFrustum(t){},drawCone(t){},drawSpotLight(t){},drawTexture(t,e,n=!1){},drawText(t,e){},drawLine(t,e,n=Ae){},drawPoint(t){},render(t){}};var Oe=Be,He=n(96323),Ie=n(93497),Ne=n(41863),ze=n(35189),Ze=n.n(ze),ke=n(4378),Ue=n(15015),Ve=n.n(Ue),Ge=n(5024),We=n.n(Ge),Xe=n(97703);const je=Ze().create(),qe="refd";class Ke extends ke.Z{constructor(t="reflect-dist-pass"){super({uid:qe,vert:Ve()(),frag:We()()}),this.distScale=1,this.groundHeight=0,this.version=this.inputs.add(new Ne.Z("100")),this.precision=this.inputs.add(new Ie.Z("mediump")),this.shaderid=this.inputs.add(new He.Z("id_"+qe,!0)),this.glconfig.enableDepthTest()}prepare(t,e,n){t.uMVP&&(n.modelViewProjectionMatrix(je,e._wmatrix),t.uMVP(je)),t.uWorldMatrix(e._wmatrix),t.uVP(n._viewProj),t.uCamPos&&t.uCamPos(n._wposition),t.uDistScale(this.distScale),this.groundHeight=Xe["default"].Scene.renderer.reflect.groundHeight,t.uGroundHeight(this.groundHeight)}}class Ye{get gl(){return this._gl}get viewport(){return this._viewport}get camera(){return this._camera}get mask(){return this._mask}get pass(){return this._pass}get glConfig(){return this._glConfig}constructor(t,e,n=null,i=536870911,r=R.Z.COLOR,s){this._gl=t,this._viewport=e,this._camera=n,this._mask=i,this._pass=r,this._glConfig=s}withMask(t){return this._mask=t,this}withPass(t){return this._pass=t,this}withConfig(t){return this._glConfig=t,this}withCamera(t){return this._camera=t,this}withViewport(t){return this._viewport=t,this}}class $e{constructor(t){this.glview=t,this.clearColor=s.vec4.fromValues(0,.25,.4,1),this.isReflect=!1,this.viewport=new O.Z,this._onViewRender=t=>{r.Z.enterFrame(),this.context.withCamera(this.camera),this.viewport.setSize(this.glview.width,this.glview.height),this.renderScene(this.scene),this.pointers.endFrame()},t.onRender.on(this._onViewRender),this.ilayer=t.canvas,Oe.init(t.gl),this.context=new Ye(this.gl,this.viewport),this.pointers=new k(this.ilayer),this.cameras=new at(this),this.scene=new B(this),(0,lt.Z)(this.gl).report()}createPostProcess(){this.postprocess=new Pe(this)}startReflect(){this.reflect||(this.reflect=new S(this.scene),this.reflectDistPass=new Ke,this.reflectDistPass.mask=y.Z.REFLECTED)}get gl(){return this.glview.gl}get camera(){return this.cameras.camera}get width(){return this.glview.width}get height(){return this.glview.height}renderScene(t){if(!t||!this.postprocess)return;const e=this.gl;if(this.cameras.preRender(),t.preRender(),this.camera.updateViewProjectionMatrix(this.viewport.width,this.viewport.height),t.rttPass(),this.isReflect){ht.Z.setSize(this.glview.width,this.glview.height);const n=this.camera;this.reflect.bindAndClear(),this.reflect.processCamera(n),f.Z.get(e).now(this.reflect.globalCfg),t.render(this.context.withMask(y.Z.REFLECTED).withPass(R.Z.REFLECT_DEPTH)),this.reflect.blitRenderBuffer(),this.reflect.restoreCamera(n),this.reflect.processOutput()}this.postprocess.preRender(this.viewport.width,this.viewport.height),this.postprocess.bindColor(this.clearColor),this.viewport.setupGl(e),t.render(this.context.withMask(y.Z.OPAQUE).withPass(R.Z.COLOR)),t.render(this.context.withMask(y.Z.BLENDED).withPass(R.Z.COLOR)),f.Z.get(e).apply(),this.postprocess.render()}dispose(){this.pointers.dispose()}}i([Me({folder:"General"})],$e.prototype,"clearColor",void 0)},21370:function(t,e,n){"use strict";let i=1/60,r=-1,s=1/60,o=0,a=1,h=60,l=0;const c=60,u=1;function d(t){return(t>200||t<1e3/180)&&(t=1e3/60),t}const f={get dt(){return i},get time(){return r},get scaledDt(){return s},get scaledTime(){return o},set timeScale(t){this.timeScale=t},get timeScale(){return u},get stableDt(){return a},enterFrame(){const t=performance.now(),e=t-r;r>0&&(i=d(e)),r=t,s=i*u,h+=s/(1e3/c),l++,l>60&&(a=h/l,l=0,h=0),o+=s}};e["Z"]=f},5839:function(t,e){"use strict";var n;(function(t){t[t["OPAQUE"]=1]="OPAQUE",t[t["BLENDED"]=2]="BLENDED",t[t["SHADOW_CASTER"]=1024]="SHADOW_CASTER",t[t["REFLECTED_DEPTH"]=2048]="REFLECTED_DEPTH",t[t["REFLECTED_COLOR"]=4096]="REFLECTED_COLOR",t[t["REFLECTED_BLENDED"]=8192]="REFLECTED_BLENDED",t[t["REFLECTED"]=6144]="REFLECTED"})(n||(n={})),e["Z"]=n},42946:function(t,e){"use strict";var n;(function(t){t["COLOR"]="color",t["DEPTH"]="depth",t["REFLECT_DEPTH"]="reflect-depth",t["DEFAULT"]="color"})(n||(n={})),e["Z"]=n},28140:function(t,e,n){"use strict";n.d(e,{Z:function(){return i}});class i{static fromSize(t,e){return new i(0,0,t,e)}constructor(t=0,e=0,n=0,i=0){this.x=t,this.y=e,this.width=n,this.height=i}setSize(t,e){this.width=t,this.height=e}setupGl(t){t.viewport(this.x,this.y,this.width,this.height)}}},46009:function(t,e,n){"use strict";n.d(e,{Z:function(){return a}});class i{constructor(t){this._value=t}valueOf(){return this._value}get value(){return this._value}onChange(){return this}setLabel(t){return this}setHint(t){return this}remove(){}}function r(){const t={add(t,e){return new i(t[e])},range(t,e){return new i(t[e])},monitor(t,e){return new i(t[e])},addColor(t,e){return new i(t[e])},addRotation(t,e){return new i(t[e])},addSelect(t,e){return new i(t[e])},addRadios(t,e){return new i(t[e])},folder(){return t},btns(){},clear(){},clearTarget(){},clearFolder(){},open(){return this},close(){return this},btn(){return new i(null)},select:function(){return new i(null)},radios:function(){return new i(null)}};return t}const s=r();var o=s,a=o},38545:function(t,e,n){"use strict";n.d(e,{Z:function(){return pt}});var i=n(61987),r=n(46009),s=n(24033),o=n(42946),a=n(49500),h=n(76595),l=n(48752),c=n(76881),u=n(96323),d=n(79763);const f=["PCFNONE","PCF4x1","PCF4x4","PCF2x2"];var p=n(66980),m=n.n(p),g=n(12032),v=n.n(g),_=n(85996),x=n.n(_),b=n(23478),w=n.n(b),S=n(12637),C=n.n(S),T=n(70275),E=n.n(T),F=n(99114),P=n.n(F),D=n(55265),y=n.n(D),R=n(92050),L=n.n(R),M=n(4694),A=n.n(M),B=n(27734),O=n.n(B),H=n(76670);class I extends d.Z{constructor(t,e){super(!0,!0),this.lights=[],this.shadowIndices=[],this.preCodeTemplate=e,this.codeTemplate=t}addLight(t){-1===this.lights.indexOf(t)&&(this.lights.push(t),this.shadowIndices.push(-1),this.invalidateCode())}removeLight(t){const e=this.lights.indexOf(t);e>-1&&(this.lights.splice(e,1),this.shadowIndices.splice(e,1),this.invalidateCode())}_genCode(t){if(0==this.lights.length)return;let e=this.preCodeTemplate({count:this.lights.length});t.add("pf",e),e="";for(var n=0;n<this.lights.length;n++)e+=this.genCodePerLights(this.lights[n],n,this.shadowIndices[n]);t.add("lightsf",e)}}class N extends I{setup(t){for(var e=0;e<this.shadowIndices.length;e++){var n=this.shadowIndices[e];if(n>-1){var i=this.lights[e].getShadowmap();t["tShadowMap"+n](i)}}}}class z extends N{constructor(t,e){super(t,e),this.type=H.Z.DIRECTIONAL,this._directions=null,this._colors=null}genCodePerLights(t,e,n){var i={index:e,shadowIndex:n};return this.codeTemplate(i)}allocate(t){null!==this._colors&&this._colors.length/4===t||(this._directions=new Float32Array(3*t),this._colors=new Float32Array(4*t))}prepare(t,e){var n=this.lights;this.allocate(n.length);for(var i=0;i<n.length;i++){var r=n[i];if(this._directions.set(r._wdir,3*i),this._colors.set(r._color,4*i),this._colors[4*i+3]=r.iblShadowing,r.castShadows){r.initShadowmap(t);var s=e.shadowChunk.addLight(r);this.shadowIndices[i]!==s&&this.invalidateCode(),this.shadowIndices[i]=s}else this.shadowIndices[i]=-1}this._invalid=!0}setup(t){this.lights.length>0&&(super.setup(t),t.uLDirDirections(this._directions),t.uLDirColors(this._colors),this._invalid=!1)}}class Z extends N{constructor(t,e){super(t,e),this.type=H.Z.SPOT,this._positions=null,this._directions=null,this._colors=null,this._attenuation=null}genCodePerLights(t,e,n){var i={index:e,shadowIndex:n,infinite:t.radius<=0};return this.codeTemplate(i)}allocate(t){null!==this._colors&&this._colors.length/4===t||(this._positions=new Float32Array(3*t),this._directions=new Float32Array(3*t),this._colors=new Float32Array(4*t),this._attenuation=new Float32Array(4*t))}prepare(t,e){const n=this.lights;this.allocate(n.length);for(var i=0;i<n.length;i++){var r=n[i];if(this._positions.set(r._wposition,3*i),this._directions.set(r._wdir,3*i),this._colors.set(r._color,4*i),this._attenuation.set(r._attenuationData,4*i),this._colors[4*i+3]=r.iblShadowing,r.castShadows){r.initShadowmap(t);var s=e.shadowChunk.addLight(r);this.shadowIndices[i]!==s&&this.invalidateCode(),this.shadowIndices[i]=s}else this.shadowIndices[i]=-1}this._invalid=!0}setup(t){this.lights.length>0&&(super.setup(t),t.uLSpotPositions(this._positions),t.uLSpotDirections(this._directions),t.uLSpotColors(this._colors),t.uLSpotAttenuation(this._attenuation),this._invalid=!1)}}class k extends I{constructor(t,e){super(t,e),this.type=H.Z.POINT,this._colors=null,this._positions=null}genCodePerLights(t,e,n){var i={index:e,shadowIndex:n,infinite:t.radius<=0};return this.codeTemplate(i)}allocate(t){null!==this._colors&&this._colors.length/3===t||(this._colors=new Float32Array(3*t),this._positions=new Float32Array(4*t))}prepare(t,e){const n=this.lights;this.allocate(n.length);for(var i=0;i<n.length;i++){var r=n[i];this._colors.set(r._color,3*i),this._positions.set(r._wposition,4*i),this._positions[4*i+3]=1/(r.radius*r.radius),this.shadowIndices[i]=-1}this._invalid=!0}setup(t){this.lights.length>0&&(super.setup(t),t.uLPointColors(this._colors),t.uLPointPositions(this._positions),this._invalid=!1)}}var U=n(63887);const V=U.mat3.create(),G=U.vec3.create(),W=["OCTA","PMREM"],X=["SH9","SH7"],j=["RGBM","RGBD","RGBE"];class q extends I{constructor(t,e){super(t,e),this.type=H.Z.IBL,this.enableRotation=new u.Z("enableRotation"),this.enableBoxProjection=new u.Z("enableBoxProjection"),this.iblFormat=new s.Z("iblFormat",W),this.shFormat=new s.Z("shFormat",X),this.hdrEncoding=new s.Z("iblHdrEncoding",j),this.intensities=new a.ZP("iblIntensities",2),this.mipLevels=new a.ZP("iblNumMipLevel",1),this.mipLevelsValue=this.mipLevels.attachConstant(5),this.intensitiesValue=this.intensities.attachConstant([1,1]),this.addChild(this.enableRotation),this.addChild(this.enableBoxProjection),this.addChild(this.iblFormat),this.addChild(this.shFormat),this.addChild(this.hdrEncoding),this.addChild(this.mipLevels),this.addChild(this.intensities)}genCodePerLights(t,e,n){return this.codeTemplate(this)}prepare(t,e){const n=this.lights[0];n&&(this.enableRotation.set(n.enableRotation),this.enableBoxProjection.set(n.enableBoxProjection),this.iblFormat.set(n.iblFormat),this.shFormat.set(n.shFormat),this.hdrEncoding.set(n.hdrEncoding),this.mipLevelsValue.set(n.mipLevels),this.intensitiesValue.set([n.intensity*n.ambiantIntensity,n.intensity*n.specularIntensity]))}addLight(t){if(this.lights.length>0)throw new Error("IblModel support only one Ibl Light");super.addLight(t)}setup(t){if(this.lights.length>0){const e=this.lights[0];t.tEnv(e.env),t.uSHCoeffs(e.sh),e.enableRotation&&(U.mat3.fromMat4(V,e._wmatrix),U.mat3.invert(V,V),t.uEnvMatrix(V)),e.enableBoxProjection&&(U.vec3.scaleAndAdd(G,e._wposition,e.boxProjectionSize,-.5),t.uBoxProjMin(G),U.vec3.scaleAndAdd(G,e._wposition,e.boxProjectionSize,.5),t.uBoxProjMax(G),U.vec3.add(G,e._wposition,e.boxProjectionOffset),t.uBoxProjPos(G))}}}class K{constructor(){this.dirPreCode=m(),this.spotPreCode=v(),this.pointPreCode=x(),this.dirLightCode=w(),this.spotLightCode=C(),this.pointLightCode=E(),this.shadPreCode=P(),this.preLightCode=y(),this.postLightCode=L(),this.iblPreCode=A(),this.iblCode=O()}}class Y{constructor(t){void 0===t&&(t=new K),this.modelCode=t,this._datas={},this._dataList=[],this._setup=null,this.preLightsChunk=new $(this.modelCode.preLightCode),this.postLightsChunk=new Q(this.modelCode.postLightCode),this.shadowChunk=new et(this),this.shadowFilter=new s.Z("shadowFilter",f),this.iblShadowing=new u.Z("iblShadowing",!1),this.registerLightModel(new k(t.pointLightCode,t.pointPreCode)),this.registerLightModel(new Z(t.spotLightCode,t.spotPreCode)),this.registerLightModel(new z(t.dirLightCode,t.dirPreCode)),this.registerLightModel(new q(t.iblCode,t.iblPreCode))}registerLightModel(t){this._datas[t.type]=t,this._dataList.push(t)}getLightSetup(){if(null===this._setup)throw new Error("LightSetup is null");return this._setup}setLightSetup(t){this._setup=t}add(t){var e=this._datas[t._type];e.addLight(t)}remove(t){var e=this._datas[t._type];e.removeLight(t)}prepare(t){this.shadowChunk.shadowCount=0;for(var e=0;e<this._dataList.length;e++)this._dataList[e].prepare(t,this);this.shadowChunk.check()}getChunks(){const t=[this.iblShadowing,this.shadowFilter,this.shadowChunk,this.preLightsChunk];for(var e=0;e<this._dataList.length;e++)t.push(this._dataList[e]);return t.push(this.postLightsChunk),t}}class $ extends d.Z{constructor(t){super(!0,!1),this.code=t}_genCode(t){t.add("lightsf",this.code(this))}}class Q extends d.Z{constructor(t){super(!0,!1),this.code=t}_genCode(t){t.add("lightsf",this.code(this))}}const J=4,tt=Math.PI/4;class et extends d.Z{constructor(t){super(!0,!0),this.lightModel=t,this.shadowCount=0,this.genCount=0,this._matrices=new Float32Array(16*J),this._texelBiasVector=new Float32Array(4*J),this._shadowmapSizes=new Float32Array(2*J),this._umatrices=null,this._utexelBiasVector=null,this._ushadowmapSizes=null}_genCode(t){this.shadowCount>0&&t.add("pf",this.lightModel.modelCode.shadPreCode(this))}addLight(t){const e=this.shadowCount,n=this.lightModel.getLightSetup();this.shadowCount++,this._matrices.set(t.getShadowProjection(n.bounds),16*e),this._texelBiasVector.set(t.getTexelBiasVector(),4*e);const i=t.shadowmapSize;if(this._shadowmapSizes[2*e+0]=i,this._shadowmapSizes[2*e+1]=1/i,0===e){var r=t.hasDepthShadowmap();n.depthFormat.set(r?"D_DEPTH":"D_RGB")}return e}check(){this.genCount!==this.shadowCount&&(this.genCount=this.shadowCount,this._umatrices=new Float32Array(this._matrices.buffer,0,16*this.shadowCount),this._utexelBiasVector=new Float32Array(this._texelBiasVector.buffer,0,4*this.shadowCount),this._ushadowmapSizes=new Float32Array(this._shadowmapSizes.buffer,0,2*this.shadowCount),this.invalidateCode()),this._invalid=!0}setup(t){this.shadowCount>0&&(t.uShadowMatrices(this._umatrices),t.uShadowTexelBiasVector(this._utexelBiasVector),t.uShadowMapSize(this._ushadowmapSizes),void 0!==t.uShadowKernelRotation&&t.uShadowKernelRotation(1*Math.cos(tt),1*Math.sin(tt)),this._invalid=!1)}}var nt=Y,it=n(17422);class rt{constructor(){this._lights=[],this._models=[],this._modelsMap={},this.depthFormat=new s.Z("depthFormat",it.Z),this.bounds=new c.Z,this.stdModel=new nt,this._registerModel("std",this.stdModel)}add(t){if(-1===this._lights.indexOf(t)){this._lights.push(t);for(var e=0;e<this._models.length;e++)this._models[e].add(t)}}remove(t){var e=this._lights.indexOf(t);if(e>-1)for(this._lights.splice(e,1),e=0;e<this._models.length;e++)this._models[e].remove(t)}prepare(t){for(var e=0;e<this._models.length;e++)this._models[e].prepare(t)}getChunks(t){void 0===t&&(t="std");var e=this._modelsMap[t].getChunks();return e.unshift(this.depthFormat),e}_registerModel(t,e){if(void 0===this._modelsMap[t]){this._modelsMap[t]=e,this._models.push(e),e.setLightSetup(this);for(var n=0;n<this._lights.length;n++)e.add(this._lights[n])}}}var st=rt,ot=n(86375),at=n(94292),ht=n(81952),lt=n(5839),ct=n(28140);class ut{static render(t,e,n){const i=e._lights,r=at.Z.get(t),s="D_RGB"===e.depthFormat.value(),a=(new ht.ZP).enableCullface(!0).enableDepthTest(!0).depthMask(!0).colorMask(s,s,s,s);r.push(a),r.apply();for(const h of i)(0,ot.t)(h)&&h.castShadows&&(h.bindShadowmap(),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),n({gl:t,viewport:new ct.Z(0,0,h.shadowmapSize,h.shadowmapSize),glConfig:a,camera:h.getCamera(),mask:lt.Z.OPAQUE,pass:o.Z.DEPTH}));r.pop(),r.apply()}}const dt=1,ft=2.2;class pt{get exposure(){return this._exposure}set exposure(t){this._exposure=t,null===this.expoUniform&&(this.expoUniform=this.exposureInput.attachUniform("utmExpo")),this.expoUniform.set(this._exposure)}get gamma(){return this._gamma}set gamma(t){this._gamma=t,null===this.gammaUniform&&(this.gammaUniform=this.gammaInput.attachUniform("_u_gamma")),this.gammaUniform.set(1/this._gamma)}constructor(t){this.gl=t,this.expoUniform=null,this.gammaUniform=null,this._exposure=dt,this._gamma=ft,this.root=new i.Z,this.lightSetup=new st,this.lightSetup.bounds.fromMinMax([-1,-1,-1],[1,1,1]),this.gammaMode=new s.Z("gammaMode",h.n),this.gammaInput=new a.ZP("gamma",1,a.ZP.ALL),this.exposureInput=new a.ZP("exposure",1,a.ZP.ALL),this.gammaInput.attachConstant(1/this.gamma),this.exposureInput.attachConstant(this.exposure),this.gammaMode.set("GAMMA_STD"),this.lightSetup.stdModel.shadowFilter.set("PCF4x4"),this.lightSetup.depthFormat.set("D_RGB")}renderLightmaps(t){ut.render(this.gl,this.lightSetup,t)}setupMaterial(t){const e=t.getPass(o.Z.COLOR).pass;e instanceof l.Fp&&this.setupStandardPass(e)}setupStandardPass(t){t.setLightSetup(this.lightSetup),t.iGamma.proxy(this.gammaInput),t.iExposure.proxy(this.exposureInput),t.gammaMode.proxy(this.gammaMode)}load(){return Promise.resolve()}dispose(){r.Z.clearFolder("Lighting")}}},88760:function(t,e,n){"use strict";var i=n(49500);const r=new i.ZP("ScreenSize",2),s=r.attachUniform("uscreensize"),o={setSize(t,e){s.set(t,e)},get input(){return r}};e["Z"]=o},68872:function(t,e,n){"use strict";n.d(e,{PX:function(){return c},ZP:function(){return u},po:function(){return l}});var i=n(68209),r=n(62985),s=n.n(r),o=n(4258),a=n.n(o),h=n(21370);const l=1.24,c=.4;class u extends i.Z{constructor(t){super(),this.renderer=t,this.effectStrength=1,this.textureRepeat=3.1,this.textureOpacity=.6,this.aspectRatio=1,this.displacement=.07,this.timeScale=.004,this.textureLuminosity=l,this.backgroundInfluence=.5,this._preCode=a()(),this._code=s()(),this.texture=t.scene.texturePool.get("tile").texture,this.noise=t.scene.texturePool.get("perlinNoise").texture}genCode(t,e){t.push(this._preCode),e.push(this._code)}init(){}release(){}setupProgram(t){t.uTexture(this.texture),t.uNoise(this.noise),t.uRepeat(this.textureRepeat),t.uOpacity(this.textureOpacity),t.uAspect(this.aspectRatio),t.uTime2(h.Z.time),t.uDisplacement(this.displacement),t.uTimeScale(this.timeScale),t.uTextureLuminosity(this.textureLuminosity),t.uBackgroundLum(this.backgroundInfluence)}preRender(){}resize(t,e){this.aspectRatio=t/e}}},63132:function(t,e,n){"use strict";n.d(e,{CD:function(){return s},CW:function(){return o},qW:function(){return i},uZ:function(){return r}});Math.PI;const i=Math.PI/180;function r(t,e,n){return Math.min(n,Math.max(e,t))}function s(t,e,n){return t*(1-n)+e*n}function o(t,e,n){const i=Math.max(0,Math.min(1,(n-t)/(e-t)));return i*i*(3-2*i)}}}]);
//# sourceMappingURL=179.717990e9.js.map