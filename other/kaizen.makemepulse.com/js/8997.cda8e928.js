"use strict";(self["webpackChunkgl_starter"]=self["webpackChunkgl_starter"]||[]).push([[8997],{33047:function(t,e,s){s.d(e,{po:function(){return o},zo:function(){return n}});const i=(t,e)=>new Promise(((s,i)=>{const a=new Image;a.src=`data:image/${t};base64,${e}`,a.onload=()=>{s(!0)},a.onerror=()=>{i(t.toUpperCase()+" format not supported")}})),a=()=>i("avif","AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A="),r=()=>i("webp","UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA=="),o=(t,{async:e=!1}={})=>new Promise(((s,i)=>{const a=new Image;function r(){a.onload=null,a.onerror=null}e&&(a.decoding="async"),a.onload=()=>{r(),s(a)},a.onerror=()=>{r(),i(`Image with name '...${t}' was not found.`)},a.src=t})),n=async(t="png")=>await a().catch(console.warn)?"avif":await r().catch(console.warn)?"webp":t},48997:function(t,e,s){s.r(e),s.d(e,{default:function(){return L}});var i=s(34072),a=s(61987),r=s(2246),o=s(63887),n=s(31236),h=s(39650),l=s(18158),A=s(13579),p=s(84233),d=s(14739),u=s(94292);const m=[{fps:16,loopFps:8,endFrameIn:35,totalFrames:72,loopFrames:48,layers:[{path:"archives/papillon/brush3",isMultiply:!1,isLoop:!1,isShaking:!1},{path:"archives/papillon/animal",isMultiply:!1,isLoop:!0,isShaking:!1},{path:"archives/papillon/brush2",isMultiply:!0,isLoop:!1,isShaking:!1},{path:"archives/papillon/brush1",isMultiply:!1,isLoop:!1,isShaking:!0}]},{fps:16,loopFps:8,endFrameIn:35,totalFrames:73,loopFrames:48,layers:[{path:"archives/poisson/brush3",isMultiply:!1,isLoop:!1,isShaking:!1},{path:"archives/poisson/animal",isMultiply:!1,isLoop:!0,isShaking:!1},{path:"archives/poisson/brush2",isMultiply:!0,isLoop:!1,isShaking:!1},{path:"archives/poisson/brush1",isMultiply:!1,isLoop:!1,isShaking:!0}]},{fps:16,loopFps:8,endFrameIn:38,totalFrames:73,loopFrames:48,layers:[{path:"archives/grenouille/brush3",isMultiply:!1,isLoop:!1,isShaking:!1},{path:"archives/grenouille/animal",isMultiply:!1,isLoop:!0,isShaking:!1},{path:"archives/grenouille/brush2",isMultiply:!0,isLoop:!1,isShaking:!1},{path:"archives/grenouille/brush1",isMultiply:!1,isLoop:!1,isShaking:!0}]},{fps:16,loopFps:8,endFrameIn:38,totalFrames:73,loopFrames:48,layers:[{path:"archives/grue/brush3",isMultiply:!1,isLoop:!1,isShaking:!1},{path:"archives/grue/animal",isMultiply:!1,isLoop:!0,isShaking:!1},{path:"archives/grue/brush2",isMultiply:!0,isLoop:!1,isShaking:!1},{path:"archives/grue/brush1",isMultiply:!1,isLoop:!1,isShaking:!0}]}],g=800,c=400,f=.85;class L{constructor(t,e,s){this.renderer=t,this.cam=e,this.archiveIdx=s,this.atlas=Array(4),this.allImgLoaded=!1,this.time=0,this.canShowLoop=!1,this.loopAlpha=0,this.viewport=[0,0],this.isAnimOut=!1,this.mouseCoord=o.vec2.create(),this.fbo=null,this.quadData=new Float32Array([-1,-1,1,0,0,1,-1,1,1,0,1,1,1,1,1,-1,1,1,0,1]),this.time=0,this.node=new a.Z,this.prg=(0,n["default"])(this.renderer.gl).get("archives"),this.worker=p["default"].getWorker(),this._noiseTex=this.renderer.scene.texturePool.get("perlinNoise").texture,this.cfg=u.Z.get(t.gl).config().depthMask(!1).enableDepthTest(!1).enableBlend(!0).blendFunc(t.gl.ONE,t.gl.ONE_MINUS_SRC_ALPHA),this.spriteManager=new d.G(t,m[s],this.worker,s,[],(()=>{}),(()=>this.allImgLoaded=!0))}handleWorkerMessage(t,e,s){this.spriteManager.handleWorkerMessage(t,e,s)}initBuffers(){this.buffer=new l.Z(this.renderer.gl,this.quadData),this.bufferIndex=new A.Z(this.renderer.gl,this.renderer.gl.UNSIGNED_SHORT,new Uint16Array([0,1,2,0,2,3])),this.buffer.attrib("aPosition",3,this.renderer.gl.FLOAT),this.buffer.attrib("aTexCoord",2,this.renderer.gl.FLOAT)}setFbo(){this.fbo=new i.Z(this.renderer.gl),this.fbo.attachColor();const t=this.fbo.getColorTexture();t.setFilter(!1,!1,!1),t.bind(),t.setFormat(this.renderer.gl.RGBA),t.repeat()}async startAnimation(){this.isAnimOut||(this.spriteManager.updateLoopState({hasStarted:!0,isPlaying:!0,isLoopPlaying:!1,canContinue:!1}),await(0,r.Z)(g),this.isAnimOut||(this.canShowLoop=!0,this.spriteManager.updateLoopState({hasStarted:!0,isPlaying:!0,isLoopPlaying:!0,canContinue:!1})))}async resumeAnimation(){this.isAnimOut=!0,this.spriteManager.updateLoopState({hasStarted:!0,isPlaying:!0,isLoopPlaying:!0,canContinue:!0}),await(0,r.Z)(c),this.canShowLoop=!1}resetAnimation(){this.time=0,this.canShowLoop=!1,this.isAnimOut=!1,this.loopAlpha=0,this.spriteManager.reset()}onEndAnim(){var t;this.isAnimOut=!1,null===(t=this.resolveAnimationEnded)||void 0===t||t.call(this)}canNextEnter(){return this.canNextEnterPromise}animationEnded(){return this.animationEndedPromise?this.animationEndedPromise:Promise.resolve()}updateLoopAlpha(){let t=1/60;t*=this.canShowLoop?1:-1,this.loopAlpha=Math.min(1,Math.max(0,this.loopAlpha+t))}updateMouseCoord(){const t=h["default"].isMobile?[0,0]:this.renderer.pointers.primary.coord.viewport;o.vec2.lerp(this.mouseCoord,this.mouseCoord,t,.02)}async load(){return Promise.resolve()}unload(){}start(){this.initBuffers(),this.setFbo(),this.animationEndedPromise=new Promise((t=>{this.resolveAnimationEnded=t})),this.canNextEnterPromise=new Promise((t=>{this.resolveCanNextEnter=t}));const t=[{targetFrame:Math.floor((m[this.archiveIdx].totalFrames-1)*f),callback:this.resolveCanNextEnter.bind(this)}];this.spriteManager.setFramesEvents(t),this.spriteManager.setOnEndEvent(this.onEndAnim.bind(this)),this.startAnimation()}stop(){var t,e,s,i,a;null===(t=this.buffer)||void 0===t||t.dispose(),null===(e=this.bufferIndex)||void 0===e||e.dispose(),null===(s=this.fbo)||void 0===s||s.dispose(),this.spriteManager.stop(),null===(i=this.resolveAnimationEnded)||void 0===i||i.call(this),null===(a=this.resolveCanNextEnter)||void 0===a||a.call(this),this.animationEndedPromise=null,this.canNextEnterPromise=null,this.resolveAnimationEnded=null,this.resolveCanNextEnter=null,this.isAnimOut=!1,this.resetAnimation()}preRender(){const t=this.renderer.viewport;this.fbo.resize(t.width,t.height),this.spriteManager.preRender(),this.time=this.spriteManager.getTime(),this.atlas=this.spriteManager.getAtlas()}rttPass(){var t,e;this.renderer.gl.bindFramebuffer(this.renderer.gl.FRAMEBUFFER,null),this.atlas.some((t=>!t.allLoaded))||(this.cfg.apply(),this.fbo.bind(),this.fbo.defaultViewport(),this.renderer.gl.clearColor(0,0,0,0),this.renderer.gl.clear(this.renderer.gl.COLOR_BUFFER_BIT),this.prg.use(),this.updateLoopAlpha(),this.updateMouseCoord(),null===(e=(t=this.prg).uTime)||void 0===e||e.call(t,this.time),this.prg.uNoiseTex(this._noiseTex),this.prg.uLoopAlpha(this.loopAlpha),this.prg.uCoord(this.mouseCoord),this.prg.uTex1(this.atlas[0].texture),this.prg.uShaking1(this.atlas[0].isShaking),this.prg.uTex2(this.atlas[1].texture),this.prg.uShaking2(this.atlas[1].isShaking),this.prg.uTex3(this.atlas[2].texture),this.prg.uShaking3(this.atlas[2].isShaking),this.prg.uTex4(this.atlas[3].texture),this.prg.uShaking4(this.atlas[3].isShaking),this.buffer.attribPointer(this.prg),this.bufferIndex.bind(),this.bufferIndex.drawTriangles())}render(){}}},14739:function(t,e,s){s.d(e,{G:function(){return n}});var i=s(33047),a=s(56478),r=s(65031),o=s(21370);class n{constructor(t,e,s,i,a=[],r=(()=>{}),o=(()=>{}),n=!1){this.renderer=t,this.spiteObject=e,this.worker=s,this.key=i,this.frameEvents=a,this.onEndEvent=r,this.onLoaded=o,this.handleWorkerLocally=n,this.totalFrames=0,this.totalLoopFrames=0,this.allImgLoaded=!1,this.time=0,this.loopTime=0,this.frame=0,this.currentFrame=0,this.currentLoopFrame=0,this.lastLoopFrameDrawn=-1,this.lastFrameDrawn=-1,this.hasStarted=!1,this.isPlaying=!1,this.canContinue=!1,this.isLoopPlaying=!1,this.isReverse=!1,this.createTextures(),n&&(this.worker.onmessage=t=>{const{imageBase64:e,layerIndex:s,frameIndex:i}=t.data;this.handleWorkerMessage(e,s,i)})}async createTextures(){const{fps:t,loopFps:e,layers:s,endFrameIn:o,totalFrames:n,loopFrames:h}=this.spiteObject;this.firstTextureLoaded=!1,this.framerate=t,this.loopFramerate=e,this.frameStop=o,this.totalFrames=n,this.totalLoopFrames=h,this.atlas=Array(s.length),s.forEach(((t,e)=>{const s=new r.Z(this.renderer.gl,this.renderer.gl.RGBA);s.bind(),s.clamp(),this.atlas[e]={images:Array(t.isLoop?h:n).fill(null),texture:s,isLoop:t.isLoop,isShaking:t.isShaking}}));const l=window.location.origin,A=await(0,i.zo)("webp"),p=s.flatMap(((t,e)=>Array.from({length:t.isLoop?h:n},((s,i)=>{const r=i>9?i.toString():`0${i}`,o=l+"/"+a["default"].getAssetPath(decodeURI(`${t.path}/${A}/${r}.${A}`));return{assetPath:o,layerIndex:e,frameIndex:i}}))));this.worker.postMessage({imageLoadRequests:p,key:this.key}),this.renderer.gl.pixelStorei(this.renderer.gl.UNPACK_FLIP_Y_WEBGL,!0)}handleWorkerMessage(t,e,s){const i=new Image;i.onload=()=>{0===s&&this.atlas[e].texture.fromImage(i),this.firstTextureLoaded||(this.firstTextureLoaded=!0),this.atlas[e].images[s]=i,this.atlas[e].images.every((t=>null!=t))&&(this.atlas[e].allLoaded=!0),this.atlas.every((t=>t.allLoaded))&&(this.allImgLoaded=!0,this.onLoaded())},i.src=t}getAtlas(){return this.atlas}getTime(){return this.loopTime}updateLoopState(t){const{hasStarted:e,isPlaying:s,isLoopPlaying:i,canContinue:a}=t;this.hasStarted=e,this.isPlaying=s,this.isLoopPlaying=i,this.canContinue=a}setFramesEvents(t){this.frameEvents=t}setOnEndEvent(t){this.onEndEvent=t}setOnLoaded(t){this.onLoaded=t}reset(){this.time=0,this.loopTime=0,this.frame=0,this.currentFrame=0,this.currentLoopFrame=0,this.lastLoopFrameDrawn=-1,this.lastFrameDrawn=-1,this.hasStarted=!1,this.isPlaying=!1,this.canContinue=!1,this.isLoopPlaying=!1,this.isReverse=!1,this.updateTextures(0,0)}updateFrame(){this.updateTextures(this.currentFrame,this.currentLoopFrame)}updateTextures(t,e){if(!this.allImgLoaded)return;const s=this.isReverse?this.totalFrames-t-1:t,i=this.isReverse?this.totalLoopFrames-e-1:e;if(!(this.lastLoopFrameDrawn===i&&this.isLoopPlaying||this.lastFrameDrawn===s&&this.isPlaying)){this.lastLoopFrameDrawn=i,this.lastFrameDrawn=s;for(let t=0;t<this.atlas.length;t++){const e=this.atlas[t].images[this.atlas[t].isLoop?i:s];this.atlas[t].texture.fromImage(e)}}}start(){}stop(){}load(){}preRender(){var t,e;if(this.hasStarted){this.frameStop&&this.currentFrame>=this.frameStop&&!this.canContinue&&(this.isPlaying=!1);for(const e of this.frameEvents)e.targetFrame===this.currentFrame&&(null===(t=e.callback)||void 0===t||t.call(e));this.currentFrame>=this.totalFrames-1&&(this.isPlaying=!1,null===(e=this.onEndEvent)||void 0===e||e.call(this)),this.isLoopPlaying&&(this.loopTime+=Math.min(.2,o.Z.dt/1e3),this.currentLoopFrame=Math.floor(this.loopTime*this.loopFramerate)%this.totalLoopFrames),this.isPlaying&&(this.time+=Math.min(.2,o.Z.dt/1e3),this.currentFrame=Math.min(Math.floor(this.time*this.framerate),this.totalFrames-1)),this.updateTextures(this.currentFrame,this.currentLoopFrame)}}}}}]);
//# sourceMappingURL=8997.cda8e928.js.map