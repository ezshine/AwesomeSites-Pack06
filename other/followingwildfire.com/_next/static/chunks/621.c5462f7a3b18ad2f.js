"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[621],{621:function(e,t,i){i.r(t),i.d(t,{MapScene:function(){return ef}});var n,r,o=i(1527),a=i(959),s=i(8954),l=i(355),c=i(686),u=i(9856),d=i(6426),h=i(7340),f=i(3895),p=i(8699),m=i(2190),v=i(8043),g=i(4360),b=i(2031),y=i(1726),x=i(1608),w=i(5264),M=i(2066),C=i(8174),S=i(1770);class F extends S.Ib{fetchTile(e,t,i){return new Promise(async(n,r)=>{try{if(e<this.maxZoom){let e=new OffscreenCanvas(16,16),t=e.getContext("2d"),i=new p.Color(2105376);t.fillStyle=i.getStyle(),t.fillRect(0,0,16,16),n(e);return}this.protomapsUrl.pathname="raw/canada-contours/".concat(e,"/").concat(t,"/").concat(i,".png");let r=await this.imageLoader.loadAsync(this.protomapsUrl.toString());n(r)}catch(e){r(e)}})}constructor(e,t,i){super(),this.maxZoom=6,this.protomapsUrl=new URL(e),this.imageLoader=new p.ImageLoader}}var k=i(8148),T=i(1935);function V(e){let{fov:t=52}=e,i=(0,d.A)(e=>e.viewport),n=(0,d.A)(e=>e.size),r=(0,g.k9)(e=>e.minimapDiv),s=(0,a.useRef)(null),c=(0,a.useMemo)(()=>{if(!r)return;let e=r.getBoundingClientRect();return{scale:[e.width,e.height,1],position:[e.left+.5*e.width-.5*n.width,-e.top-.5*e.height+.5*n.height,0],rect:e}},[n,r]),h=n.height/Math.tan(t*Math.PI/360)*.5,f=((null==c?void 0:c.rect.width)||1)*i.dpr;return(0,o.jsxs)(w.u,{renderPriority:2,children:[(0,o.jsx)(l.c,{makeDefault:!0,position:[0,0,h],fov:t}),(0,o.jsx)(u.Cd,{args:[.5,32],position:(null==c?void 0:c.position)||[0,0,0],scale:(null==c?void 0:c.scale)||1,ref:s,children:(0,o.jsx)("meshBasicMaterial",{children:(0,o.jsx)(M.T,{attach:"map",width:f,height:f,children:(0,o.jsx)(B,{})})})})]})}k.D.EARTH_PERIMETER,T.f6;let P=new p.Object3D;function B(){let e=(0,a.useRef)(null),t=(0,a.useRef)(null),i=(0,a.useRef)(null),[n,r]=(0,g.k9)(e=>[e.mapGroup,e.mapCamera]),s=new p.Vector3,l=new p.Vector3;return(0,d.C)(()=>{n&&r&&(e.current.position.x=n.position.x,e.current.position.z=n.position.z,r.getWorldDirection(s),l.set(0,0,0),l.addScaledVector(s,10),l.y=0,P.lookAt(l),t.current.quaternion.copy(P.quaternion),i.current.color.setHSL(0,0,(0,x.uZ)((0,y.UI)(n.position.y,-75,-73,0,.5),.1,.9)))}),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("color",{attach:"background",args:["black"]}),(0,o.jsx)(C.i,{makeDefault:!0,position:[0,2,0],rotation:[-Math.PI/2,0,0],zoom:8e-4,left:-1,right:1,top:1,bottom:-1}),(0,o.jsx)("group",{ref:t,scale:[300,1,300],rotation:[0,0,0],position:[0,1,0],children:(0,o.jsx)(u.Qq,{args:[.5,1.2,4,1],rotation:[0,Math.PI/2,Math.PI/2],children:(0,o.jsx)("meshBasicMaterial",{color:"#CDCDCD",toneMapped:!1,ref:i})})}),(0,o.jsx)("group",{ref:e,children:(0,o.jsx)(A,{})})]})}let D=new F(T.Yt);function A(e){let{debug:t=!1,...i}=e,n=(0,a.useRef)(null);return(0,o.jsx)("mapView",{...i,ref:n,args:[void 0,D],scale:[k.D.EARTH_PERIMETER*T.f6,1,k.D.EARTH_PERIMETER*T.f6]})}(0,d.e)({MapView:S.bz});var j=i(1092);class O extends S.Ib{fetchTile(e,t,i){return new Promise(async(n,r)=>{try{if(this.boundsLat){let t=function(e,t){let i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))}(i,e);if(t<this.boundsLat[0]||t>this.boundsLat[1]){r("out of bounds");return}}if(this.boundsLon){let i=t/Math.pow(2,e)*360-180;if(i<this.boundsLon[0]||i>this.boundsLon[1]){r("out of bounds");return}}this.protomapsUrl.pathname="/".concat(this.demPath).concat(e,"/").concat(t,"/").concat(i,".webp");let o=await this.imageLoader.loadAsync(this.protomapsUrl.toString());n(o)}catch(e){r(e)}})}async fetchFireSmokeTile(e,t,i,n){return new Promise(async(r,o)=>{try{"realtime"===e?this.protomapsUrl.pathname="/realtime/2024-04-23/".concat(t,"/").concat(i,"/").concat(n,".png"):this.protomapsUrl.pathname="/".concat(this.fireSmokeFolder,"/").concat(e,"-fbs/").concat(t,"/").concat(i,"/").concat(n,".png");let o=await this.imageLoader.loadAsync(this.protomapsUrl.toString());r(o)}catch(e){this.imageLoader.loadAsync("/textures/empty.png").then(e=>r(e)).catch(e=>o(e))}})}constructor(e,t,i){super(),this.minZoom=1,this.maxZoom=9,this.demPath="dem/canada-dem-masked/",this.maskFolder="20240313",this.fireSmokeFolder="20240401",this.boundsLat=t,this.boundsLon=i,this.protomapsUrl=new URL(e),this.imageLoader=new p.ImageLoader}}var R=i(3897),E=i(6377);let U=new p.Vector2,L=new p.Vector3,N=new p.Vector3;class z extends p.InstancedBufferGeometry{static buildPlane(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0,s=arguments.length>7?arguments[7]:void 0,l=e/2,c=t/2,u=Math.floor(i)+.5,d=Math.floor(n)+.5,h=e/i,f=t/n;for(let e=0;e<d-1;e++){let t=e*f-c;for(let c=0;c<u-1;c++){let u=c*h-l;r.push(u,t),o.push(c/i,1-e/n),a.push(1+Math.random()),s.push(0),r.push(u,t),o.push(c/i,1-e/n),a.push(1+Math.random()),s.push(1),c%6==0&&e%6==0&&(r.push(u,t),o.push(c/i,1-e/n),a.push(1+Math.random()),s.push(2))}}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new p.Sphere);let e=this.attributes.inst_position;if(void 0!==e){let t=0;for(let i=0,n=e.count;i<n;i++)U.fromBufferAttribute(e,i),L.set(U.x,0,U.y),t=Math.max(t,N.distanceToSquared(L));this.boundingSphere.radius=Math.sqrt(t),isNaN(this.boundingSphere.radius)&&console.error("MapHeightParticleGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}constructor(e=1,t=1,i=1,n=1){super();let r=[],o=[],a=[],s=[];z.buildPlane(e,t,i,n,r,o,a,s);let l=new p.Float32BufferAttribute(r,2),c=new p.Float32BufferAttribute(o,2),u=new p.Float32BufferAttribute(a,1),d=new p.Uint32BufferAttribute(s,1),h=new p.InstancedBufferAttribute(l.array,2),f=new p.InstancedBufferAttribute(c.array,2),m=new p.InstancedBufferAttribute(u.array,1),v=new p.InstancedBufferAttribute(d.array,1),g=new p.PlaneGeometry(.01,.01,1,1);this.copy(g),this.instanceCount=l.count,console.log("instanceCount",this.instanceCount),this.setAttribute("inst_position",h),this.setAttribute("inst_uv",f),this.setAttribute("size",m),this.setAttribute("mask",v)}}z.key=p.MathUtils.generateUUID();var _=i(8439);let I=(0,_.g)({map:null,fireSmokeMap:null,fireSmokeMapTo:null,fireSmokeMapTransition:0,gNoiseTexture:null,uBaseParticleSize:10,uBlur:.65,uBlurParticle:1,uBlurRadius:.65,uFocus:10,gTime:0,gCamDistance:0,gCamFar:1e4,gCloseness:1,uFireThreshold:.5,uElevationScale:.15,uFireSpeedX:.05,uFireSpreadX:.01,uFireSpeedY:5,uFireSpreadY:3e3,uFireScale:5,uPointFarThreshold:.5,uPointNearThreshold:.4,uPointNearScale:20,uPointColor:new p.Color("#fff"),uFireColor:new p.Color("#f00"),uSmokeColor:new p.Color("#333"),uBurntVegetationColor:new p.Color("#666"),uFireIntensity:3,gFBSMask:new p.Vector3(1,0,0)},"\n    attribute vec2 inst_position;\n    attribute vec2 inst_uv;\n    attribute float size;\n    attribute uint mask;\n\n    uniform sampler2D fireSmokeMap;\n    uniform sampler2D fireSmokeMapTo;\n    uniform float fireSmokeMapTransition;\n\n    uniform sampler2D map;\n    uniform sampler2D gNoiseTexture;\n    uniform float uBaseParticleSize;\n    uniform float gTime;\n    uniform float uFocus;\n    uniform float uBlurRadius;\n    uniform float gCamDistance;\n    uniform float gCamFar;\n    uniform float gCloseness;\n\n    uniform float uFireThreshold;\n    uniform float uElevationScale;\n    uniform float uFireSpeedX;\n    uniform float uFireSpreadX;\n    uniform float uFireSpeedY;\n    uniform float uFireSpreadY;\n    uniform float uFireScale;\n    uniform float uPointFarThreshold;\n    uniform float uPointNearThreshold;\n    uniform float uPointNearScale;\n    uniform vec3 gFBSMask;\n\n    varying vec3 vMapColor;\n    varying float vElevation;\n    varying float vDistance;\n    varying vec2 vUv;\n\n    varying vec3 vFBS; // Fire, Burnt Vegetation, Smoke\n    varying float vAvgFbs; // Masked average of FBS\n    varying float vColored;\n    varying float vDiscard;\n\n    float decodeElevation(vec3 color) {\n      float R = color.r * 255.0;\n      float G = color.g * 255.0;\n      float B = color.b * 255.0;\n\n      // Factors and base shift as per Mapzen Terrarium encoding\n      float redFactor = 256.0;\n      float greenFactor = 1.0;\n      float blueFactor = 1.0 / 256.0;\n      float baseShift = 32768.0;\n\n      float elevation = (R * redFactor + G * greenFactor + B * blueFactor) - baseShift;\n      return elevation;\n    }\n\n    float curve( float x ) {\n      // larger to smaller\n      return (1.0 - x);\n    }\n\n    void main() {\n\n      vUv = uv;\n      vec4 texelColor = texture2D(map, inst_uv);\n      vMapColor = texelColor.rgb;\n      vDiscard = 0.;\n\n      // ignore blue value if it's over 0.99\n      vec3 cleanTexelColor = vec3(texelColor.r, texelColor.g, texelColor.b * step(0.99, texelColor.b));\n      float elevation = decodeElevation(cleanTexelColor);\n      vElevation = elevation;\n\n      vec3 fireSmokeColor = texture2D(fireSmokeMap, inst_uv).rgb;\n      if (fireSmokeMapTransition > 0.0) {\n        fireSmokeColor = mix(fireSmokeColor, texture2D(fireSmokeMapTo, inst_uv).rgb, fireSmokeMapTransition);\n      }\n\n      vFBS = smoothstep(0.0, uFireThreshold, fireSmokeColor);\n      vec3 maskedFbs = vFBS * gFBSMask;\n      vAvgFbs = (maskedFbs.r + maskedFbs.g + maskedFbs.b) / 3.0;\n      vColored = 0.;\n\n\n      // water is encoder as blue > 0.99\n      float waterMask = smoothstep(0.95, 0.99, texelColor.b);\n      // if elevation is under 1, also use as watermask\n      if (elevation < 50.) {\n        waterMask = 1.0;\n        vDiscard = 1.;\n      }\n\n      vec3 transformed = vec3(inst_position.x, 0.0, inst_position.y);\n      float pointsize = 0.0;\n\n      if (waterMask < 0.1) {\n        transformed.y += elevation * uElevationScale;\n        if (mask == 0u) {\n          pointsize = uBaseParticleSize * size;\n          // if showing burnt vegetation, make it smaller\n          if (maskedFbs.g > 0.05) {\n            vColored = 1.;\n          }\n          pointsize *= 1.0 - maskedFbs.g;\n        } else if (mask == 1u && maskedFbs.r > 0.05) {\n          vColored = 1.;\n          transformed.y += 0.1;\n          vec3 fireTransform = vec3(0., 0., 0.);\n          float noise = texture2D(gNoiseTexture, inst_uv * 10.).r;\n          fireTransform.x = (texture2D(gNoiseTexture, inst_uv.xy * noise + gTime * uFireSpeedX).r * 2. - 1.) * uFireSpreadX;\n          fireTransform.z = (texture2D(gNoiseTexture, inst_uv.yx * noise + 2.0 + gTime * uFireSpeedX).r * 2. - 1.) * uFireSpreadX;\n          fireTransform.y = mod(noise + gTime * noise * uFireSpeedY, 1.);\n\n          float fireLinear = smoothstep(0., 1., fireTransform.y);\n          float fireCurve = curve(fireLinear);\n\n          transformed += mix(vec3(0.0), fireTransform * vec3(1., uFireSpreadY, 1.), vFBS.r);\n          pointsize = mix(pointsize, fireCurve * uFireScale * (1.), vFBS.r);\n          pointsize = clamp(pointsize, 0., 150.);\n        } else if (mask == 2u && maskedFbs.b > 0.05) {\n          // smoke\n          vColored = 1.;\n          pointsize = uBaseParticleSize;\n          pointsize *= 30. * size * smoothstep(0.1, 1., maskedFbs.b);\n          transformed.y += 10.;\n        }\n      } else {\n        vDiscard = 1.;\n        transformed.x = -99999.;\n      }\n\n\n      vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\n      float vPosZ = mvPosition.z;\n\n      float pointDistanceAttenuation = uBlurRadius;\n      pointDistanceAttenuation *= (1.0 - smoothstep(gCamFar * uPointFarThreshold, gCamFar, abs(vPosZ)));\n      pointDistanceAttenuation *= 1.0 + (1.0 - smoothstep(0.0, gCamFar * uPointNearThreshold, abs(vPosZ))) * uPointNearScale;\n\n      pointsize *= pointDistanceAttenuation;\n\n      vDistance = clamp(abs(uFocus + vPosZ * .5), -25., 25.);\n\n      pointsize *= - mvPosition.z;\n\n      if (pointsize < 100.0) {\n        mvPosition = vec4(vec3(-9999.), 0.0);\n        vDiscard = 1.;\n      } else {\n        mvPosition.xyz += (position.xyz * pointsize * 0.1);\n      }\n\n      gl_Position = projectionMatrix * mvPosition;\n    }\n    ","\n    uniform float uBlur;\n    uniform float uBlurParticle;\n\n    uniform vec3 uPointColor;\n    uniform vec3 uFireColor;\n    uniform vec3 uSmokeColor;\n    uniform vec3 uBurntVegetationColor;\n    uniform float uFireIntensity;\n    uniform vec3 gFBSMask;\n\n    varying vec3 vMapColor;\n    varying float vElevation;\n    varying float vDistance;\n    varying vec2 vUv;\n    varying vec3 vFBS;\n    varying float vAvgFbs;\n    varying float vColored;\n    varying float vDiscard;\n\n    // select either color1, color2, or color3 based on mask val (0-1 for color1, 0-1 for color2, 0-1 for color3)\n    vec3 selectedColor(vec3 color1, vec3 color2, vec3 color3, vec3 mask) {\n      vec3 color = mix(vec3(0.0), color1, mask.r);\n      color = mix(color, color2, mask.g);\n      color = mix(color, color3, mask.b);\n      return color;\n    }\n\n    void main() {\n      if (vDiscard > 0.5) {\n        discard;\n      }\n      vec2 cxy = 2.0 * vUv - 1.0;\n      vec3 color = uPointColor;\n      if (vColored > 0.5) {\n        vec3 fbsColor = selectedColor(uFireColor, uBurntVegetationColor * 30., uSmokeColor, gFBSMask);\n        color = fbsColor * uFireIntensity;\n      }\n\n      float distanceToCenter = distance(vUv, vec2(0.5));\n      if(distanceToCenter > 0.5) {\n        discard;\n      }\n      if (dot(cxy, cxy) > 1.) discard;\n\n      float blurF = (1.05 - clamp(vDistance, 0.0, 1.0));\n      float blurParticle = clamp(.05 / distanceToCenter - 0.1, 0., 1.);\n      float blurParticleF = mix( 1. , blurParticle, uBlurParticle);\n\n      float vAlpha = 1.0; // TODO: compute alpha\n\n      gl_FragColor = vec4(color.rgb, mix(vAlpha, blurF * vAlpha, uBlur) * blurParticleF);\n\n    }\n  ",e=>{if(!e)return});(0,d.e)({MapHeightParticleMaterial:I});class Y extends p.BufferGeometry{computeNormals(e,t){let i=this.getAttribute("position");if(void 0!==i){let n=this.getAttribute("normal"),r=t*e;for(let e=0;e<r;e++)n.setXYZ(e,0,0,0);let o=new p.Vector3,a=new p.Vector3,s=new p.Vector3,l=new p.Vector3,c=new p.Vector3,u=new p.Vector3,d=new p.Vector3,h=new p.Vector3,f=t*e*6;for(let e=0;e<f;e+=3){let t=this.index.getX(e+0),r=this.index.getX(e+1),f=this.index.getX(e+2);o.fromBufferAttribute(i,t),a.fromBufferAttribute(i,r),s.fromBufferAttribute(i,f),d.subVectors(s,a),h.subVectors(o,a),d.cross(h),l.fromBufferAttribute(n,t),c.fromBufferAttribute(n,r),u.fromBufferAttribute(n,f),l.add(d),c.add(d),u.add(d),n.setXYZ(t,l.x,l.y,l.z),n.setXYZ(r,c.x,c.y,c.z),n.setXYZ(f,u.x,u.y,u.z)}this.normalizeNormals(),n.needsUpdate=!0}}constructor(e=1,t=1,i=1,n=1,r=!1,o=10,a,s=!0){super();let l=[],c=[],u=[],d=[];S.JO.buildPlane(e,t,i,n,l,c,u,d);let h=a.data;for(let e=0,t=0;e<h.length&&t<c.length;e+=4,t+=3){let i=256*h[e]+1*h[e+1]+1*h[e+2]/256-32768;c[t+1]=i}r&&S.JO.buildSkirt(e,t,i,n,o,l,c,u,d),this.setIndex(l),this.setAttribute("position",new p.Float32BufferAttribute(c,3)),this.setAttribute("normal",new p.Float32BufferAttribute(u,3)),this.setAttribute("uv",new p.Float32BufferAttribute(d,2)),s&&this.computeNormals(i,n)}}let Z=function(){let e={};for(let t=0;t<6;t++)e[t]=new z(1,1,16*Math.pow(2,t),16*Math.pow(2,t));return{0:e[0],1:e[0],2:e[4],3:e[3],4:e[2],5:e[3],6:e[2],7:e[1],8:e[0],9:e[5]}}();class G extends p.Mesh{async initialize(){await this.loadData(),this.nodeReady()}createChildNodes(){let e=this.level+1,t=Object.getPrototypeOf(this).constructor,i=2*this.x,n=2*this.y,r=new t(this,this.mapView,S.jU.topLeft,e,i,n,this.fireYear);r.scale.set(.5,1,.5),r.position.set(-.25,0,-.25),this.group.add(r),r.updateMatrix(),r.updateMatrixWorld(!0),(r=new t(this,this.mapView,S.jU.topRight,e,i+1,n,this.fireYear)).scale.set(.5,1,.5),r.position.set(.25,0,-.25),this.group.add(r),r.updateMatrix(),r.updateMatrixWorld(!0),(r=new t(this,this.mapView,S.jU.bottomLeft,e,i,n+1,this.fireYear)).scale.set(.5,1,.5),r.position.set(-.25,0,.25),this.group.add(r),r.updateMatrix(),r.updateMatrixWorld(!0),(r=new t(this,this.mapView,S.jU.bottomRight,e,i+1,n+1,this.fireYear)).scale.set(.5,1,.5),r.position.set(.25,0,.25),this.group.add(r),r.updateMatrix(),r.updateMatrixWorld(!0)}subdivide(){if(!this.mapView)return;let e=this.mapView.maxZoom();this.group.children.length>0||this.level+1>e||null!==this.parentNode&&this.parentNode.nodesLoaded<S.VT.childrens||(this.subdivided=!0,this.mapView.cacheTiles&&null!==this.childrenCache?(this.isMesh=!1,this.points&&(this.points.visible=!1),this.darkMesh&&(this.darkMesh.visible=!1),this.group.children=this.childrenCache,this.nodesLoaded=this.childrenCache.length):this.createChildNodes())}simplify(){if(!this.mapView)return;let e=this.mapView.minZoom();if(!(this.level-1<e)){if(this.mapView.cacheTiles)this.childrenCache=this.group.children;else for(let e=0;e<this.group.children.length;e++)this.group.children[e].dispose();this.subdivided=!1,this.isMesh=!0,this.points&&(this.points.visible=!0),this.darkMesh&&(this.darkMesh.visible=!0),this.group.children=[],this.nodesLoaded=0}}async loadData(){if(this.mapView&&this.mapView.provider&&!(this.level<this.mapView.provider.minZoom)&&!(this.level>this.mapView.provider.maxZoom)){try{let[e,t]=await Promise.all([this.mapView.provider.fetchTile(this.level,this.x,this.y),this.mapView.provider.fetchFireSmokeTile(this.fireYear,this.level,this.x,this.y)]);if(this.disposed)return;let i=new p.Texture(e);i.generateMipmaps=!1,i.format=p.RGBAFormat,i.magFilter=p.LinearFilter,i.minFilter=p.LinearFilter,i.needsUpdate=!0;let n=new p.Texture(t);n.generateMipmaps=!1,n.format=p.RGBAFormat,n.magFilter=p.LinearFilter,n.minFilter=p.LinearFilter,n.needsUpdate=!0;let r=new I({defines:{USE_POINTS:"true"},polygonOffset:!1,depthTest:!0,depthWrite:!1,transparent:!1,blending:p.AdditiveBlending});for(let e in T.O0)T.O0.hasOwnProperty(e)&&(r.uniforms[e]=T.O0[e]);r.uniformsNeedUpdate=!0;let o=Z[this.level];if(this.points=new p.Mesh(o,r),this.add(this.points),this.points.renderOrder=1,this.points.material.uniforms.map.value=i,this.points.material.uniforms.fireSmokeMap.value=n,this.level>8){let t=S.Pc.createOffscreenCanvas(129,129),i=t.getContext("2d");i.imageSmoothingEnabled=!1,i.drawImage(e,0,0,256,256,0,0,t.width,t.height);let n=i.getImageData(0,0,t.width,t.height),r=new Y(1,1,128,128,!0,1,n);r.boundsTree=new R.r(r);let o=new p.Mesh(r,G.darkMeshMaterial);o.layers.enable(T.fc),o.layers.enable(0),o.scale.y=b.c9.getState().mapElevation,o.raycast=E.uL,this.darkMesh=o,this.darkMesh.unsubHeight=b.c9.subscribe(e=>e.mapElevation,e=>{o.scale.y=e}),this.add(this.darkMesh)}}catch(e){if(this.disposed)return}this.textureLoaded=!0}}nodeReady(){if(this.disposed){this.dispose();return}if(null!==this.parentNode){if(this.parentNode.nodesLoaded++,this.parentNode.nodesLoaded===G.childrens){!0===this.parentNode.subdivided&&(this.parentNode.isMesh=!1,this.parentNode.points&&(this.parentNode.points.visible=!1),this.parentNode.darkMesh&&(this.parentNode.darkMesh.visible=!1));for(let e=0;e<this.parentNode.group.children.length;e++){let t=this.parentNode.group.children[e];t.visible=!0,this.level<5&&t.points&&(t.points.material.depthTest=!1)}}this.parentNode.nodesLoaded>G.childrens&&console.error("Geo-Three: Loaded more children objects than expected.",this.parentNode.nodesLoaded,this)}else this.visible=!0}dispose(){var e,t,i;this.disposed=!0;try{let t=null===(e=this.points)||void 0===e?void 0:e.material;t&&(t.dispose(),t.uniforms.map.value&&t.uniforms.map.value!==S.VT.defaultTexture&&t.uniforms.map.value.dispose(),t.uniforms.fireSmokeMap.value&&t.uniforms.fireSmokeMap.value!==S.VT.defaultTexture&&t.uniforms.fireSmokeMap.value.dispose())}catch(e){console.error("Geo-Three: Failed to dispose node resources.",e)}try{this.darkMesh&&(this.darkMesh.geometry.dispose(),null===(t=(i=this.darkMesh).unsubHeight)||void 0===t||t.call(i))}catch(e){console.error("Geo-Three: Failed to dispose node resources.",e)}}get fireYear(){return this._fireYear}set fireYear(e){this._fireYear=e,this.mapView&&this.mapView.provider&&this.mapView.provider instanceof O&&this.mapView.provider.fetchFireSmokeTile(e,this.level,this.x,this.y).then(e=>{if(this.disposed||!this.points)return;let t=new p.Texture(e);if(t.generateMipmaps=!1,t.format=p.RGBAFormat,t.magFilter=p.LinearFilter,t.minFilter=p.LinearFilter,t.needsUpdate=!0,!this.isMesh){this.points.material.uniforms.fireSmokeMap.value=t;return}this.points.material.uniforms.fireSmokeMapTo.value=t,h.p8.fromTo(this.points.material.uniforms.fireSmokeMapTransition,{value:0},{value:1,duration:1,onComplete:()=>{this.points&&(this.points.material.uniforms.fireSmokeMap.value=t,this.points.material.uniforms.fireSmokeMapTransition.value=0)}})}).catch(e=>{})}raycast(e,t){!0===this.isMesh&&E.uL.bind(this)(e,t)}constructor(e=null,t=null,i=S.jU.root,n=0,r=0,o=0,a="realtime"){super(G.baseGeometry,G.baseMaterial),this.mapView=null,this.parentNode=null,this.subdivided=!1,this.disposed=!1,this.nodesLoaded=0,this.childrenCache=null,this.textureLoaded=!1,this.geometrySize=16,this.geometryNormals=!1,this.isMesh=!0,this.points=null,this.darkMesh=null,this.layers=T.gc,this._fireYear=a,this.mapView=t,this.parentNode=e,this.disposed=!1,this.location=i,this.level=n,this.x=r,this.y=o,this.name="".concat(this.level,"/").concat(this.x,"/").concat(this.y),this.group=new p.Group,this.add(this.group),this.isMesh=!0,this.visible=!1,this.matrixAutoUpdate=!1,this.initialize()}}G.defaultTexture=S.O.createFillTexture(),G.childrens=4,G.tileSize=256,G.darkMeshGeometry=new S.JO(1,1,256,256),G.darkMeshMaterial=new p.MeshBasicMaterial({color:"#183733",polygonOffset:!0,polygonOffsetFactor:.5,polygonOffsetUnits:1}),G.baseGeometry=new S.JO(1,1,1,1),G.baseMaterial=new p.MeshBasicMaterial({color:"black",depthTest:!1,depthWrite:!1}),G.baseScale=new p.Vector3(k.D.EARTH_PERIMETER,1,k.D.EARTH_PERIMETER);let H=new p.Vector3,X=new p.Vector3(0,-1,0),W=new p.Vector3(-1,0,0),q=new p.Vector3,J=new p.Matrix4;class Q extends S.Ij{updateLOD(e,t,i,n){let r=T.O0.gCamDistance.value;if(t.getWorldPosition(H),r>55e3){e.traverseVisible(e=>{(e instanceof S.z6||e instanceof G)&&(e&&e.level>2?e.simplify():e.level<2&&e.subdivide())}),this.simplifyAllToLevel(e,2);return}if(r>35500){e.traverseVisible(e=>{(e instanceof S.z6||e instanceof G)&&(e&&e.level>3?e.simplify():e.level<3&&e.subdivide())}),this.simplifyAllToLevel(e,3);return}r>3e4?this.simplifyAllToLevel(e,4):r>1e4?this.simplifyAllToLevel(e,6):r>6e3&&this.simplifyAllToLevel(e,7);let o=[];W.copy(H),this.raycaster.set(W,X),this.raycaster.intersectObjects(e.children,!0,o),this._raySpread=(0,y.uZ)(.5*r,220,5e4);for(let t=0;t<4;t++)W.copy(H),W.x+=(2*Math.random()-1)*this._raySpread,W.z+=(2*Math.random()-1)*this._raySpread,this.raycaster.set(W,X),this.raycaster.intersectObjects(e.children,!0,o);o.forEach(e=>{(e.object instanceof S.z6||e.object instanceof G)&&(this._distance=e.distance,J.copy(e.object.matrixWorld),q.set(J.elements[0],J.elements[1],J.elements[2]),this._distance=q.length()/this._distance,this._level=e.object.level,this._distance>.6?e.object.subdivided||e.object.subdivide():this._distance<.15&&e.object.parentNode&&e.object.parentNode.simplify())}),this.dbgDiv&&(this.dbgDiv.innerHTML="\n      lastDistance?: ".concat(this._distance,"<br>\n      camPosition: ").concat(H.toArray(),"<br>\n      camDistance: ").concat(r,"<br>\n      level: ").concat(this._level,"<br>\n      rayspread: ").concat(this._raySpread,"\n      "))}get debug(){return this._debug}set debug(e){if(this._debug=e,e)this.dbgDiv=document.body.querySelector("#lod-vertical-frustum-debug")||document.createElement("p"),this.dbgDiv.id="lod-vertical-frustum-debug",this.dbgDiv.className="absolute top-0 left-0 bg-dark-gray bg-opacity-50 p-2 font-mono text-xs text-white",document.body.appendChild(this.dbgDiv);else{var t;null===(t=document.body.querySelector("#lod-vertical-frustum-debug"))||void 0===t||t.remove()}}simplifyAllToLevel(e,t){e.traverseVisible(e=>{(e instanceof S.z6||e instanceof G)&&e.level>t&&e.simplify()})}constructor(e=150,t=400,i=2){super(e,t),this.testCenter=!0,this.pointOnly=!1,this.raycaster=new p.Raycaster,this.dbgDiv=null,this._debug=!1,this._distance=0,this._level=0,this._raySpread=0,this.nodeCenterCutoff=i,this.raycaster.layers.disableAll(),this.raycaster.layers.set(T.I0),this.raycaster.firstHitOnly=!0}}Q.key=p.MathUtils.generateUUID(),(0,d.e)({MapView:S.bz,LODVerticalFrustum:Q,LODRaycast:S.xC,LODRadial:S.Ij});let K=new O(T.Yt,[41,100],[-180,-51.358481]);function $(e){let{debug:t=!1,...i}=e,n=(0,a.useRef)(null),r=(0,a.useRef)(!1),s=(0,g.k9)(e=>e.mapYear),l=(0,a.useMemo)(()=>new G,[]);return(0,a.useEffect)(()=>{if(!r.current){r.current=!0;return}n.current.visible&&n.current.traverse(e=>{e instanceof G&&(e.fireYear=s)})},[s]),(0,o.jsx)("mapView",{...i,ref:n,args:[l,K],scale:[k.D.EARTH_PERIMETER*T.f6,1,k.D.EARTH_PERIMETER*T.f6],children:(0,o.jsx)("lODVerticalFrustum",{args:[300,800,2],attach:"lod",debug:!1,children:(0,o.jsx)("raycaster",{attach:"raycaster",layers:T.gc})},Q.key)})}var ee=i(1525);function et(){return(et=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)({}).hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(null,arguments)}var ei=function(e){return a.createElement("svg",et({viewBox:"0 0 36 36",fill:"none",xmlns:"http://www.w3.org/2000/svg",preserveAspectRatio:"xMidYMid meet"},e),n||(n=a.createElement("rect",{x:18,y:1.736,width:23,height:23,rx:1.5,transform:"rotate(45 18 1.736)",fill:"#0E1A19",fillOpacity:.5,stroke:"#CDCDCD"})),r||(r=a.createElement("path",{fill:"#FF4F28",d:"M15 15h6v6h-6z"})))};let en=new p.Vector3,er=new p.Vector3;function eo(e){let{data:t,onClick:i}=e,n=(0,a.useRef)(null),r=(0,a.useRef)(null),s=(0,d.A)(e=>e.camera),l=(0,g.k9)(e=>e.mapElevationRounded),c=(0,a.useMemo)(()=>{let e=k.D.datumsToSpherical(t.lat,t.lng);return new p.Vector3(e.x*T.f6,(t.elevation||50)*l,-e.y*T.f6)},[t,l]);return(0,d.C)(()=>{if(!n.current||!(s instanceof p.PerspectiveCamera))return;let e=en.setFromMatrixPosition(r.current.matrixWorld),t=er.setFromMatrixPosition(s.matrixWorld),i=s.fov*Math.PI/180,o=e.distanceTo(t);n.current.style.transform="scale(".concat((0,x.uZ)(Math.log(1/(2*Math.tan(i/2)*o)*5e3),.75,2),")")},2),(0,o.jsx)("group",{position:c,ref:r,children:(0,o.jsx)(ee.V,{sprite:!0,center:!0,zIndexRange:[1,100],ref:n,children:(0,o.jsx)("button",{className:"w-9 h-9 transition-transform hover:scale-125",onClick:i,children:(0,o.jsx)(ei,{})})})})}let ea=(0,_.g)({time:0,color:new p.Color("#FF4F28")},"\n  varying vec2 vUv;\n\n  void main() {\n    vUv = uv;\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.);\n    gl_Position = projectionMatrix * mvPosition;\n  }\n  ","\n  uniform float time;\n  uniform vec3 color;\n  varying vec2 vUv;\n\n  float sdHexagon( in vec2 p, in float r )\n  {\n      const vec3 k = vec3(-0.866025404,0.5,0.577350269);\n      p = abs(p);\n      p -= 2.0*min(dot(k.xy,p),0.0)*k.xy;\n      p -= vec2(clamp(p.x, -k.z*r, k.z*r), r);\n      return length(p)*sign(p.y);\n  }\n\n  void main() {\n    // circle sdf\n    vec2 p = vUv - 0.5;\n    float radius = 0.2;\n    // float sdf = 1.0;\n    float shape = sdHexagon(p, 0.2);\n    float sdf = sin(shape * 60. - time);\n    // fade sdf close to edge of uv\n    // sdf *= smoothstep(0., 0.01, shape); // center\n    sdf *= smoothstep(1.25, 0., shape); // outer\n    sdf = clamp(sdf, 0., 1.);\n\n    // float opacity = sdf;\n    float aaf = fwidth(sdf);\n    float opacity = smoothstep(0.95, 0.95 + aaf, sdf);\n    float colorSdf = smoothstep(0.8, 0.8 + aaf, sin(shape * 20. - time / 3. - 0.6));\n    vec3 finalColor = mix(vec3(1.0), color, colorSdf);\n\n    gl_FragColor = vec4(finalColor, opacity);\n  }\n  ",e=>{e&&(e.extensions.derivatives=!0)});(0,d.e)({MapMarkerFlatMaterial:ea});let es=(0,_.g)({time:0},"\n  varying vec2 vUv;\n\n  void main() {\n    vUv = uv;\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.);\n    gl_Position = projectionMatrix * mvPosition;\n  }\n  ","\n  uniform float time;\n  varying vec2 vUv;\n\n  void main() {\n    // float opacity = mix(0.0, 0.5, 1.0 - vUv.y);\n    float opacity = (sin(-time + vUv.y * 10.) + 1.0) / 2.0;\n    opacity += 0.5;\n    opacity = clamp(opacity, 0.0, 1.0);\n    opacity = mix(0.0, opacity, 1.0 - vUv.y) * 0.5;\n\n    gl_FragColor = vec4(vec3(1.0), opacity);\n  }\n  ",e=>{e&&(e.extensions.derivatives=!0)});(0,d.e)({MapMarkerMaterial:es});let el=(0,a.forwardRef)((e,t)=>{let i=(0,a.useRef)(null),n=(0,s.mE)("/textures/target-matcap-3.png");return(0,d.C)((e,t)=>{i.current&&(i.current.rotation.y+=t,i.current.position.y=.5*Math.sin(i.current.rotation.y)+8)}),(0,o.jsxs)("group",{ref:t,...e,children:[(0,o.jsxs)("mesh",{ref:i,position:[0,8,0],scale:1,rotation:[0,0,Math.PI],children:[(0,o.jsx)("coneGeometry",{args:[1,2,3,1]}),(0,o.jsx)("meshMatcapMaterial",{matcap:n,color:"#ff7028",toneMapped:!1})]}),(0,o.jsxs)("mesh",{position:[0,0,0],scale:3,rotation:[0,Math.PI/2,0],children:[(0,o.jsx)("cylinderGeometry",{args:[1,1,2,6,1,!0]}),(0,o.jsx)("mapMarkerMaterial",{side:p.DoubleSide,blending:p.AdditiveBlending,transparent:!0,depthTest:!0,depthWrite:!1,"uniforms-time":T.O0.gTime},es.key)]}),(0,o.jsxs)("mesh",{scale:15,rotation:[-Math.PI/2,0,0],position:[0,0,0],children:[(0,o.jsx)("planeGeometry",{args:[1,1]}),(0,o.jsx)("mapMarkerFlatMaterial",{"uniforms-time":T.O0.gTime,color:"#ff7028",depthWrite:!1,depthTest:!1,transparent:!0},ea.key)]})]})});var ec=i(1403),eu=i.n(ec);async function ed(e,t){let n=(await i.e(107).then(i.t.bind(i,9107,19))).default,r=new(eu())(n).getContainers({type:"Point",coordinates:[t,e]})||void 0;if(r&&r.features.length)switch(r.features[0].properties.name){case"British Columbia":return"BC";case"Alberta":return"AB";case"Saskatchewan":return"SK";case"Manitoba":return"MB";case"Ontario":return"ON";case"Quebec":return"QC";case"New Brunswick":return"NB";case"Nova Scotia":return"NS";case"Prince Edward Island":return"PE";case"Newfoundland and Labrador":return"NL";case"Northwest Territories":return"NT";case"Yukon":return"YU";case"Nunavut":return"NU";default:return}}let eh=new p.Vector3(0,-1,0);function ef(){let{mapState:e,activeThreat:t,provinceKey:n,filteredThreatsByActiveProvince:r,locationOverride:w,setMapParams:M}=(0,v.L)(),C=(0,m.q)(),S=(0,d.A)(e=>e.camera),F=(0,d.A)(e=>e.raycaster),P=(0,d.A)(e=>e.get),B=(0,f.useRouter)(),[D]=(0,a.useState)(()=>{let e=new p.Raycaster;return e.layers.disableAll(),e.layers.enable(T.fc),e.firstHitOnly=!0,e}),A=(0,a.useRef)(null),O=(0,a.useRef)(null),R=(0,a.useRef)(null),E=(0,a.useRef)(null),[U,L,N]=(0,b.ZP)(e=>[e.setFirstDragged,e.setFirstTapped,e.firstTapped]),[z,_,I]=(0,b.ZP)(e=>[e.overheadSettings,e.detailSettings,e.mapVerticalOffset]),[Y,Z,G,H]=(0,b.ZP)(e=>[e.setMapElevation,e.setMapGroup,e.setMapCamera,e.mapGroup]),X=("overview"===e||"timeline"===e)&&"/map"===B.pathname,[W]=(0,g.iY)(e=>[e.isMobile]);!function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],[t,n]=(0,g.k9)(e=>[e.mapYear,e.setMapYear]),[r,o,s]=(0,g.k9)(e=>[e.updateOverheadSettings,e.updateDetailSettings,e.setMapVerticalOffset]);(0,a.useEffect)(()=>{let a;if(e)return(async()=>{let{Pane:e}=await i.e(486).then(i.bind(i,1455));a=new e({}),window.twPane=a;let l=a.addFolder({title:"Map",expanded:!1}),c=l.addTab({pages:[{title:"Camera"},{title:"Main"}]}),{overheadSettings:u,detailSettings:d,mapVerticalOffset:h}=b.c9.getState();for(let e in c.pages[0].addBinding(u,"cameraPosition",{label:"Overhead Camera Position",step:100}).on("change",e=>{r({cameraPosition:e.value})}),c.pages[0].addBinding(u,"cameraRotation",{label:"Overhead Camera Rotation",step:.001}).on("change",e=>{r({cameraRotation:e.value})}),c.pages[0].addBinding(u,"cameraFar",{label:"Overhead Camera Far",step:10}).on("change",e=>{r({cameraFar:e.value})}),c.pages[0].addBlade({view:"separator"}),c.pages[0].addBinding(d,"cameraOffset",{label:"Detail Camera Offset"}).on("change",e=>{o({cameraOffset:e.value})}),c.pages[0].addBinding(d,"transitionSpeed",{label:"Transition Speed"}).on("change",e=>{o({transitionSpeed:e.value})}),c.pages[0].addBlade({view:"separator"}),c.pages[0].addBinding({value:h},"value",{label:"Vertical Offset"}).on("change",e=>{s(e.value)}),c.pages[1].addBlade({view:"list",label:"Year",options:T.nH.map(e=>({text:e,value:e})),value:t}).on("change",e=>{n(e.value)}),T.O0)if(!e.startsWith("g")&&Object.prototype.hasOwnProperty.call(T.O0,e)){let t=T.O0[e],i=e.replace("u","");try{if(t.value instanceof p.Color){let e={value:"#".concat(t.value.getHexString())};c.pages[1].addBinding(e,"value",{label:i}).on("change",e=>{t.value.set(e.value)})}else c.pages[1].addBinding(t,"value",{label:i})}catch(e){console.error("Failed to add uniform to Tweakpane",e)}}l.addBlade({view:"separator"}),l.addButton({title:"Export"}).on("click",()=>{let e=JSON.stringify(a.exportState(),null,2),t=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download="twkpn-wildfire-".concat(Date.now(),".json"),n.click()}),l.addButton({title:"Import"}).on("click",()=>{let e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>{var t;let i=null===(t=e.target.files)||void 0===t?void 0:t[0];if(i){let e=new FileReader;e.onload=e=>{var t;let i=null===(t=e.target)||void 0===t?void 0:t.result;"string"==typeof i&&a.importState(JSON.parse(i))},e.readAsText(i)}},e.click()})})(),()=>{a&&a.dispose()}},[e])}(C);let q=(0,a.useCallback)((e,t,i)=>{D.setFromCamera(t,e);let n=D.intersectObjects(i.children);if(n.length>0)return n[0]},[D]),J=(0,a.useRef)(new p.Vector3(-999,-999,-999)),Q=(0,a.useCallback)((0,y.P2)((e,t,i)=>{if(T.O0.gCamDistance.value<1e3){let n=q(e,t,i);n&&J.current.copy(n.point)}},100),[q]),K=new p.Vector2,ee=new p.Vector2(1,1);(0,d.C)((e,t)=>{let{camera:i,pointer:n,scene:r}=e;T.O0.gTime.value+=t,function(){F.set(et,eh);let e=F.intersectObject(O.current);0!==e.length&&(S.far=X?z.cameraFar:Math.max(3*e[0].distance,250),S.updateProjectionMatrix(),A.current&&(A.current.far=.7*S.far,A.current.near=.3*S.far),T.O0.gCamFar.value=S.far,T.O0.gCamDistance.value=e[0].distance,T.O0.gTargetPosition.value.copy(e[0].point),T.O0.gCloseness.value=Math.min(1,e[0].distance/1e5))}(),Q(i,n,r),!W&&X&&(K.copy(n),K.rotateAround(ee,-.5),i.rotation.y=p.MathUtils.lerp(i.rotation.y,z.cameraRotation.y-.05*K.x,.1),i.rotation.x=p.MathUtils.lerp(i.rotation.x,z.cameraRotation.x+.05*K.y,.1)),R.current.position.lerp(J.current,.1)});let et=new p.Vector3(0,0,0);(0,s.mE)("/textures/noise.png",e=>{Array.isArray(e)||(e.wrapS=e.wrapT=p.RepeatWrapping,e.minFilter=e.magFilter=p.LinearFilter,e.generateMipmaps=!1,e.needsUpdate=!0,T.O0.gNoiseTexture.value=e)});let ei=(0,a.useRef)(void 0),en=(0,a.useRef)(void 0);return(0,a.useEffect)(()=>{let i;if(!H)return;let{cameraOffset:r,transitionSpeed:o}=_;if(w)i=w;else if(!t&&n&&(ei.current!==n||en.current!==e)){let e=T.cY[n];i=[e.lat,e.lng,e.elevation]}else t&&(i=[t.lat,t.lng,t.elevation||50]);let a=en.current;if(ei.current=n,en.current=e,!i)return;let s=k.D.datumsToSpherical(i[0],i[1]),l=new p.Vector3(s.x*T.f6,i[2],-s.y*T.f6),c=0,u=0,d=h.p8.timeline(),f={progress:0},m=H.position.y;d.to(H.position,{x:-l.x+r.x,z:-l.z+r.z,duration:w&&N&&a===e?o:0,ease:"power1.inOut"}),d.to(f,{progress:1,duration:w&&N&&a===e?o:0,ease:"power1.inOut",onUpdate:()=>{c=p.MathUtils.smoothstep(H.position.x,126500,128506),Y(u=.15-.1*(c=(0,x.uZ)(c,0,1))),T.O0.uElevationScale.value=u,H.position.y=p.MathUtils.lerp(m,-l.y*u-r.y,f.progress)}},"<")},[t,w,_,N,n,e,H,Y]),(0,a.useEffect)(()=>{if(!H||!X)return;let{cameraPosition:e,cameraRotation:t}=z;if(H.position.set(-e.x,-e.y,-e.z),W&&E.current){let e=new p.Vector3;O.current.getWorldPosition(e),E.current.lookInDirectionOf(e.x,e.y,e.z,!1);return}S.rotation.copy(t)},[X,z,S,W,H]),(0,a.useEffect)(()=>{let i=P().events.connected,n=!1,r=!1,o=new p.Vector2,a=new p.Vector2;function s(i){if(H){if(n){n=!1,!t&&"detail"===e&&T.O0.gCamDistance.value<1e3&&U(!0);return}if(r=!1,o.set(0,0),T.O0.gCamDistance.value<1e3){L(!0);let{camera:e,pointer:t,scene:i}=P(),n=q(e,t,i);if(n){n.point.sub(H.position);let e=n.point.multiply(new p.Vector3(100,1/b.c9.getState().mapElevation,100));e.y-=I;let t=k.D.sphericalToDatums(e.x,-e.z);ed(t.latitude,t.longitude).then(i=>{M({loc:"".concat(t.latitude.toFixed(4),",").concat(t.longitude.toFixed(4),",").concat(e.y.toFixed(0)),...i?{province:i}:{}},!0,!0)})}}}}let l=e=>{"touch"!==e.pointerType&&r&&(n=!0)},c=e=>{a.set(e.touches[0].clientX,e.touches[0].clientY),r&&o.distanceTo(a)>10&&(n=!0)},u=e=>{e.preventDefault(),r=!0,n=!1};return i.addEventListener("pointermove",l),i.addEventListener("pointerup",s),i.addEventListener("pointerdown",u),i.addEventListener("touchmove",c),()=>{i.removeEventListener("pointerup",s),i.removeEventListener("pointermove",l),i.removeEventListener("pointerdown",u),i.removeEventListener("touchmove",c)}},[P,M,t,e,U,L,D,I,q,H]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.c,{near:.1,far:15e4,position:[0,0,.01],makeDefault:!0,ref:G}),(0,o.jsx)(c.B,{makeDefault:!0,enabled:W||!X,ref:E,minDistance:1,maxDistance:1,minAzimuthAngle:X?-1.2+2*Math.PI:-1/0,maxAzimuthAngle:X?2*Math.PI:1/0,minPolarAngle:X?1:1.3,maxPolarAngle:X?1.5:2.2,minZoom:0,maxZoom:0,mouseButtons:{left:1,right:2,middle:0,wheel:0},maxSpeed:1e5}),(0,o.jsx)("color",{attach:"background",args:["#1f423f"]}),(0,o.jsx)(j.z,{vignette:[.1,.8,.5,.01],vignetteOffset:[0,0],blurVignette:[.2,.4,.1,.01],scaleX:W?.6:1},"map"),(0,o.jsx)(el,{ref:R,visible:"detail"===e,scale:.75}),"detail"===e&&!W&&(0,o.jsx)(V,{}),(0,o.jsxs)("group",{ref:Z,children:["detail"===e&&r&&r.map(e=>(0,o.jsx)(eo,{data:e,onClick:()=>{M({threat:e.id,loc:null},!0)}},e.id)),(0,o.jsx)($,{position:[0,I,0],debug:C}),(0,o.jsx)(u.JO,{ref:O,scale:[15e4,4e5,1],rotation:[-Math.PI/2,0,0],position:[-11e4,0,-9e4],children:(0,o.jsx)("meshBasicMaterial",{color:C?"red":"black",wireframe:!0})})]})]})}},1092:function(e,t,i){i.d(t,{z:function(){return h}});var n=i(1527),r=i(959),o=i(7929),a=i(468),s=i(8864),l=i(8699);class c extends s.Qm{constructor(){super("Overlay","\n  uniform sampler2D tBloom;\n  uniform vec3 uColor;\n  uniform vec4 uBlurVignette;\n  uniform vec4 uVignette;\n  uniform vec2 uVignetteOffset;\n  uniform float uScale;\n\n  float vignette(vec2 coords, float vignin, float vignout, float vignfade, float fstop) {\n    float dist = distance(coords.xy, vec2(0.5, 0.5));\n    dist = smoothstep(vignout + (fstop / vignfade), vignin + (fstop / vignfade), dist);\n    return clamp(dist, 0.0, 1.0);\n  }\n\n  vec3 contrast(vec3 color, float value) {\n    return 0.5 + value * (color - 0.5);\n  }\n\n  vec4 screen(const in vec4 x, const in vec4 y, const in float opacity) {\n    return mix(x, x + y - min(x * y, 1.0), opacity);\n  }\n\n  void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {\n    vec4 bloom = texture2D(tBloom, uv);\n    bloom.rgb = min(bloom.rgb * 4., 1.); // 4. value matches intensity from orig bloom shader\n    bloom = linearToOutputTexel(bloom);\n    vec2 scaledUV = uv;\n    scaledUV.x = (uv.x - 0.5) * uScale + 0.5;\n\n    float blurMask = vignette(scaledUV + uVignetteOffset, uBlurVignette.x, uBlurVignette.y, uBlurVignette.z, uBlurVignette.w);\n    vec4 inputCol = inputColor;\n    inputCol.rgb = clamp(contrast(inputColor.rgb, 2.) * 0.5, 0., 1.);\n    vec4 color = mix(screen(inputCol, bloom, 0.85), bloom, 1. - blurMask);\n\n    // vignette\n    float vig = vignette(scaledUV + uVignetteOffset, uVignette.x, uVignette.y, uVignette.z, uVignette.w);\n    color.rgb = mix(vec3(0.), color.rgb, vig);\n\n    outputColor = max(color, vec4(uColor, 1.));\n  }\n",{uniforms:new Map([["tBloom",new l.Uniform(null)],["uColor",new l.Uniform(new l.Color("#4a4a4a"))],["uBlurVignette",new l.Uniform(new l.Vector4(.01,.75,.9,.01))],["uVignette",new l.Uniform(new l.Vector4(.1,.55,.5,.01))],["uVignetteOffset",new l.Uniform(new l.Vector2(0,-.2))],["uScale",new l.Uniform(1)]])}),this.inputColorSpace=l.SRGBColorSpace}}let u=l.MathUtils.generateUUID();var d=(0,r.forwardRef)(function(e,t){let{bloomPass:i}=e,o=(0,r.useMemo)(()=>new c(i),[i]);return(0,n.jsx)("primitive",{ref:t,object:o})});let h=(0,r.memo)(e=>{let{vignette:t=[.1,.6,.5,.01],blurVignette:i=[.01,.75,.9,.01],vignetteOffset:c=[0,-.15],scaleX:h=1}=e,f=(0,r.useRef)(),p=(0,r.useRef)();return(0,r.useEffect)(()=>{p.current&&(p.current.uniforms.get("tBloom").value=f.current.texture,p.current.uniforms.get("uVignette").value=new l.Vector4(t[0],t[1],t[2],t[3]),p.current.uniforms.get("uBlurVignette").value=new l.Vector4(i[0],i[1],i[2],i[3]),p.current.uniforms.get("uVignetteOffset").value=new l.Vector2(c[0],c[1]),p.current.uniforms.get("uScale").value=h,p.current.uniforms.get("uColor").value=new l.Color("#0E1A19"))},[t,i,c,h]),(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)(o.x,{disableNormalPass:!0,children:[(0,n.jsx)(a.d,{mipmapBlur:!0,ref:f,luminanceThreshold:.01,luminanceSmoothing:.01,radius:.915,intensity:1,blendFunction:s.YQ.SKIP}),(0,n.jsx)(d,{ref:p},u)]})})})}}]);