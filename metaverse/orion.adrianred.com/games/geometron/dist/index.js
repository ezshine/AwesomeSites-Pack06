(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const f=[{name:"Triangle",vertices:[{x:0,y:-1},{x:1,y:.5},{x:-1,y:.5}],symmetry:1},{name:"Square",vertices:[{x:-.8,y:-.8},{x:.8,y:-.8},{x:.8,y:.8},{x:-.8,y:.8}],symmetry:4},{name:"Cross",vertices:[{x:-.2,y:-1},{x:.2,y:-1},{x:.2,y:-.2},{x:1,y:-.2},{x:1,y:.2},{x:.2,y:.2},{x:.2,y:1},{x:-.2,y:1},{x:-.2,y:.2},{x:-1,y:.2},{x:-1,y:-.2},{x:-.2,y:-.2}],symmetry:4},{name:"T-Shape",vertices:[{x:-1.5,y:-.5},{x:1.5,y:-.5},{x:1.5,y:.5},{x:.5,y:.5},{x:.5,y:1.5},{x:-.5,y:1.5},{x:-.5,y:.5},{x:-1.5,y:.5}],symmetry:1},{name:"L-Shape",vertices:[{x:-1.5,y:-.5},{x:.5,y:-.5},{x:.5,y:1.5},{x:-.5,y:1.5},{x:-.5,y:.5},{x:-1.5,y:.5}],symmetry:1}],m={TUNNEL_SEGMENT_COUNT:10,TUNNEL_BASE_OPACITY:.35,FIRST_WALL_DELAY_SECONDS:.5};class M{ctx;animationFrame=0;constructor(t){this.ctx=t}update(t){this.animationFrame+=30*t}getPerspective(t){return 1/(1+t*.02)}draw(t,e,s,i){const a=this.ctx.canvas.width/2,o=this.ctx.canvas.height/2,h=50,r=-48,c=m.TUNNEL_SEGMENT_COUNT,l=h-r,d=l/c;this.ctx.save(),this.ctx.translate(a,o),this.ctx.rotate(e);const g=this.animationFrame%d;for(let p=0;p<c;p++){const x=h-(p*d+g);if(x<=-50)continue;const v=this.getPerspective(x),y=(i?100:200)*v,b=(x-r)/l,A=Math.pow(1-b,2)*m.TUNNEL_BASE_OPACITY;this.ctx.strokeStyle=s,this.ctx.globalAlpha=A,this.ctx.lineWidth=Math.max(1,3*v),this.ctx.beginPath(),t.vertices.forEach((S,I)=>{const w=S.x*y,C=S.y*y;I===0?this.ctx.moveTo(w,C):this.ctx.lineTo(w,C)}),this.ctx.closePath(),this.ctx.stroke()}this.ctx.restore()}}class R{audioCtx=null;constructor(){}init(){this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext))}playPassSound(){if(this.init(),!this.audioCtx)return;const t=this.audioCtx.createOscillator(),e=this.audioCtx.createGain();t.connect(e),e.connect(this.audioCtx.destination),t.type="sine",t.frequency.setValueAtTime(440,this.audioCtx.currentTime),t.frequency.exponentialRampToValueAtTime(880,this.audioCtx.currentTime+.1),e.gain.setValueAtTime(.3,this.audioCtx.currentTime),e.gain.exponentialRampToValueAtTime(.001,this.audioCtx.currentTime+.2),t.start(),t.stop(this.audioCtx.currentTime+.2)}playShapeChangeSound(){if(this.init(),!this.audioCtx)return;const t=this.audioCtx.createOscillator(),e=this.audioCtx.createGain();t.connect(e),e.connect(this.audioCtx.destination),t.type="triangle",t.frequency.setValueAtTime(220,this.audioCtx.currentTime),e.gain.setValueAtTime(.2,this.audioCtx.currentTime),e.gain.exponentialRampToValueAtTime(.001,this.audioCtx.currentTime+.1),t.start(),t.stop(this.audioCtx.currentTime+.1)}playGameOverSound(){if(this.init(),!this.audioCtx)return;const t=this.audioCtx.createOscillator(),e=this.audioCtx.createGain();t.connect(e),e.connect(this.audioCtx.destination),t.type="sawtooth",t.frequency.setValueAtTime(220,this.audioCtx.currentTime),t.frequency.exponentialRampToValueAtTime(55,this.audioCtx.currentTime+.5),e.gain.setValueAtTime(.4,this.audioCtx.currentTime),e.gain.exponentialRampToValueAtTime(.001,this.audioCtx.currentTime+.5),t.start(),t.stop(this.audioCtx.currentTime+.5)}}function D(n){if(!n.vertices||n.vertices.length===0)return{x:0,y:0};const t=n.vertices.map(h=>h.x),e=n.vertices.map(h=>h.y),s=Math.min(...t),i=Math.max(...t),a=Math.min(...e),o=Math.max(...e);return{x:(s+i)/2,y:(a+o)/2}}function u(n,t,e,s,i,a,o,h="rgba(0, 255, 0, 1)",r=!1){if(n.save(),n.translate(e,s),n.rotate(i),r){const l=D(t);n.translate(-l.x*a,-l.y*a)}const c=h.replace("1)",`${o})`);n.shadowBlur=10,n.shadowColor=c,n.beginPath(),t.vertices.forEach((l,d)=>{const g=l.x*a,p=l.y*a;d===0?n.moveTo(g,p):n.lineTo(g,p)}),n.closePath(),n.strokeStyle=c,n.lineWidth=5,n.stroke(),n.restore()}class T{ctx;shapes;currentShapeIndex;rotation;soundManager;onShapeChange=null;constructor(t,e){this.ctx=t,this.shapes=f,this.currentShapeIndex=0,this.rotation=0,this.soundManager=e}get currentShape(){return this.shapes[this.currentShapeIndex]}getPreviousShape(){const t=(this.currentShapeIndex-1+this.shapes.length)%this.shapes.length;return this.shapes[t]}getNextShape(){const t=(this.currentShapeIndex+1)%this.shapes.length;return this.shapes[t]}get rotationAngle(){return this.rotation}setRotation(t){this.rotation=t}previousShape(){this.currentShapeIndex--,this.currentShapeIndex<0&&(this.currentShapeIndex=this.shapes.length-1),this.soundManager.playShapeChangeSound(),this.onShapeChange&&this.onShapeChange()}nextShape(){this.currentShapeIndex=(this.currentShapeIndex+1)%this.shapes.length,this.soundManager.playShapeChangeSound(),this.onShapeChange&&this.onShapeChange()}draw(t){const e=this.ctx.canvas.width/2,s=this.ctx.canvas.height/2,i=t?100:200;if(u(this.ctx,this.currentShape,e,s,this.rotation,i,1),!t){const a=i/3;u(this.ctx,this.getNextShape(),this.ctx.canvas.width-a*2,s,0,a,.25,"rgba(0, 255, 0, 1)",!0),u(this.ctx,this.getPreviousShape(),a*2,s,0,a,.25,"rgba(0, 255, 0, 1)",!0)}}}class W{ctx;z;shape;rotation;color;speedMultiplier=1;processed=!1;constructor(t,e,s,i){this.ctx=t,this.z=e,this.shape=s,this.color=i,this.rotation=Math.floor(Math.random()*8)*(Math.PI/4)}update(t,e){this.z-=t*this.speedMultiplier*60*e}project(t,e){return{x:t.x*e,y:t.y*e}}getPerspective(){return 1/(1+this.z*.02)}draw(t){if(this.z<=0)return;const e=this.getPerspective(),s=this.ctx.canvas.width/2,i=this.ctx.canvas.height/2,o=(t?100:200)*e;this.ctx.save(),this.ctx.shadowBlur=20,this.ctx.shadowColor=this.color,this.ctx.strokeStyle=this.color,this.ctx.lineWidth=Math.max(1,5*e),this.ctx.translate(s,i),this.ctx.rotate(this.rotation),this.ctx.beginPath(),this.shape.vertices.forEach((h,r)=>{const c=this.project(h,o);r===0?this.ctx.moveTo(c.x,c.y):this.ctx.lineTo(c.x,c.y)}),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()}}const P=["#FF00FF","#00FFFF","#FFFF00","#FF007F","#00FF7F","#7F00FF"];class L{ctx;_walls=[];speed=.1;spawnTimer=0;firstWallSpawned=!1;constructor(t){this.ctx=t}get walls(){return this._walls}get nextWallShape(){if(this._walls.length===0)return null;const t=this._walls.filter(e=>e.z>0);return t.length===0?null:(t.sort((e,s)=>e.z-s.z),t[0].shape)}get nextWallRotation(){if(this._walls.length===0)return 0;const t=this._walls.filter(e=>e.z>0);return t.length===0?0:(t.sort((e,s)=>e.z-s.z),t[0].rotation)}get nextWallColor(){if(this._walls.length===0)return"#FFFFFF";const t=this._walls.filter(e=>e.z>0);return t.length===0?"#FFFFFF":(t.sort((e,s)=>e.z-s.z),t[0].color)}dropWall(){if(this._walls.length===0)return;const t=this._walls.filter(s=>s.z>0);if(t.length===0)return;t.sort((s,i)=>s.z-i.z);const e=t[0];e.speedMultiplier=10}increaseSpeed(){this.speed<.3&&(this.speed+=.005)}update(t){if(this.firstWallSpawned)this._walls.length===0&&this.spawnWall();else{this.spawnTimer+=t;const e=m.FIRST_WALL_DELAY_SECONDS;this.spawnTimer>=e&&(this.spawnWall(),this.firstWallSpawned=!0)}this._walls.forEach(e=>e.update(this.speed,t))}draw(t){this._walls.forEach(e=>{e.draw(t)})}cullWalls(){this._walls=this._walls.filter(t=>t.z>0)}spawnWall(){const t=Math.floor(Math.random()*f.length),e=f[t],s=Math.floor(Math.random()*P.length),i=P[s],a=new W(this.ctx,50,e,i);this._walls.push(a)}}class E{ctx;shockwaves=[];constructor(t){this.ctx=t}trigger(t,e,s){this.shockwaves.push({shape:t,rotation:e,color:s,life:1,initialLife:1,scale:200})}update(t){this.shockwaves.forEach(s=>{s.life-=t,s.scale+=900*t}),this.shockwaves=this.shockwaves.filter(s=>s.life>0)}draw(){this.shockwaves.forEach(t=>{this.ctx.save();const e=t.life/t.initialLife*.8,s=t.color;this.ctx.shadowBlur=15,this.ctx.shadowColor=s,this.ctx.strokeStyle=s,this.ctx.lineWidth=Math.max(1,7*(t.life/t.initialLife)),this.ctx.globalAlpha=e,this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.rotate(t.rotation),this.ctx.beginPath(),t.shape.vertices.forEach((i,a)=>{const o=i.x*t.scale,h=i.y*t.scale;a===0?this.ctx.moveTo(o,h):this.ctx.lineTo(o,h)}),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()})}}class k{canvas;ctx;tunnel;player;wallManager;soundManager;effectManager;gameState="playing";score=0;collisionZone=1;isLoopRunning=!1;isDemo=!1;lastTime=0;joystickManagerLeft;joystickManagerRight;leftZone=null;rightZone=null;prevShapeCanvas=null;nextShapeCanvas=null;touchStartX=0;touchStartY=0;constructor(t=!1){this.canvas=document.getElementById("game-canvas"),this.ctx=this.canvas.getContext("2d"),this.isDemo=t,this.attachEventListeners(),this.resize(),this.reset()}start(){this.isLoopRunning||(this.isLoopRunning=!0,this.lastTime=performance.now(),this.gameLoop())}restart(){this.isDemo=!1,this.destroyTouchControls(),this.reset(),this.initTouchControls(),document.body.classList.add("game-active")}attachEventListeners(){window.addEventListener("resize",()=>this.resize()),this.canvas.addEventListener("click",t=>{if(!this.isDemo){if(this.gameState==="gameOver"){this.restart();return}this.gameState==="playing"&&(this.isTouchDevice()?t.clientX<this.canvas.width/2?this.player.previousShape():this.player.nextShape():this.player.previousShape())}}),this.isTouchDevice()||this.canvas.addEventListener("contextmenu",t=>{t.preventDefault(),!this.isDemo&&this.gameState==="playing"&&this.player.nextShape()}),this.canvas.addEventListener("mousemove",t=>{this.isDemo||this.gameState==="playing"&&this.updatePlayerRotation(t.clientX,t.clientY)}),window.addEventListener("keydown",t=>{this.isDemo||this.gameState==="playing"&&t.code==="Space"&&(t.preventDefault(),this.wallManager.dropWall())}),this.canvas.addEventListener("touchstart",t=>{this.gameState==="playing"&&this.isTouchDevice()&&(this.touchStartX=t.touches[0].clientX,this.touchStartY=t.touches[0].clientY)},{passive:!0}),this.canvas.addEventListener("touchend",t=>{if(this.gameState==="playing"&&this.isTouchDevice()){const e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY,i=e-this.touchStartX,a=s-this.touchStartY;Math.abs(i)>Math.abs(a)&&(i>50?this.player.nextShape():i<-50&&this.player.previousShape())}},{passive:!0})}isTouchDevice(){return!!("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints&&navigator.msMaxTouchPoints>0)}destroyTouchControls(){this.joystickManagerLeft&&(this.joystickManagerLeft.destroy(),this.joystickManagerLeft=null),this.joystickManagerRight&&(this.joystickManagerRight.destroy(),this.joystickManagerRight=null),this.leftZone&&(this.leftZone.remove(),this.leftZone=null),this.rightZone&&(this.rightZone.remove(),this.rightZone=null),this.prevShapeCanvas&&(this.prevShapeCanvas.remove(),this.prevShapeCanvas=null),this.nextShapeCanvas&&(this.nextShapeCanvas.remove(),this.nextShapeCanvas=null),document.body.classList.remove("game-active")}updateShapePreviews(){if(!this.isTouchDevice())return;const t=25,e=.5;if(this.prevShapeCanvas){const s=this.prevShapeCanvas.getContext("2d");s.clearRect(0,0,this.prevShapeCanvas.width,this.prevShapeCanvas.height),u(s,this.player.getPreviousShape(),this.prevShapeCanvas.width/2,this.prevShapeCanvas.height/2,0,t,e,"rgba(0, 255, 0, 1)",!0)}if(this.nextShapeCanvas){const s=this.nextShapeCanvas.getContext("2d");s.clearRect(0,0,this.nextShapeCanvas.width,this.nextShapeCanvas.height),u(s,this.player.getNextShape(),this.nextShapeCanvas.width/2,this.nextShapeCanvas.height/2,0,t,e,"rgba(0, 255, 0, 1)",!0)}}initTouchControls(){if(!this.isTouchDevice())return;this.prevShapeCanvas=document.createElement("canvas"),this.prevShapeCanvas.id="prev-shape-canvas",this.prevShapeCanvas.width=150,this.prevShapeCanvas.height=150,document.body.appendChild(this.prevShapeCanvas),this.nextShapeCanvas=document.createElement("canvas"),this.nextShapeCanvas.id="next-shape-canvas",this.nextShapeCanvas.width=150,this.nextShapeCanvas.height=150,document.body.appendChild(this.nextShapeCanvas),this.updateShapePreviews();const t=100,s=80-t/2;this.leftZone=document.createElement("div"),this.leftZone.style.position="absolute",this.leftZone.style.left=`${s}px`,this.leftZone.style.bottom=`${s}px`,this.leftZone.style.width=`${t}px`,this.leftZone.style.height=`${t}px`,this.leftZone.style.zIndex="10",document.body.appendChild(this.leftZone),this.rightZone=document.createElement("div"),this.rightZone.style.position="absolute",this.rightZone.style.right=`${s}px`,this.rightZone.style.bottom=`${s}px`,this.rightZone.style.width=`${t}px`,this.rightZone.style.height=`${t}px`,this.rightZone.style.zIndex="10",this.rightZone.classList.add("right-joystick-zone"),document.body.appendChild(this.rightZone),this.joystickManagerLeft=nipplejs.create({zone:this.leftZone,mode:"static",position:{left:"50%",top:"50%"},color:"rgba(255, 255, 255, 0.5)",size:t}),this.joystickManagerLeft.on("move",(i,a)=>{if(this.gameState==="playing"){let h=-a.angle.radian+Math.PI/2;h<0&&(h+=Math.PI*2);const r=Math.PI/4,l=Math.round(h/r)%8*r;this.player.setRotation(l)}}),this.joystickManagerRight=nipplejs.create({zone:this.rightZone,mode:"static",position:{left:"50%",top:"50%"},color:"rgba(255, 255, 255, 0.5)",size:t}),this.joystickManagerRight.on("start",()=>{this.gameState==="playing"&&this.wallManager.dropWall()})}updatePlayerRotation(t,e){const s=this.canvas.width/2,i=this.canvas.height/2,a=s-t,o=i-e;let h=Math.atan2(o,a)+Math.PI/2;h<0&&(h+=Math.PI*2);const r=Math.PI/4,l=Math.round(h/r)%8*r;this.player.setRotation(l)}reset(){this.gameState=this.isDemo?"demo":"playing",this.score=0,this.soundManager=new R,this.effectManager=new E(this.ctx),this.tunnel=new M(this.ctx),this.player=new T(this.ctx,this.soundManager),this.player.onShapeChange=()=>this.updateShapePreviews(),this.wallManager=new L(this.ctx)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.isLoopRunning&&(this.tunnel=new M(this.ctx),this.player=new T(this.ctx,this.soundManager),this.player.onShapeChange=()=>this.updateShapePreviews(),this.wallManager=new L(this.ctx),this.effectManager=new E(this.ctx))}update(t){this.gameState!=="gameOver"&&(this.gameState==="demo"&&this.autoPlay(),this.tunnel.update(t),this.wallManager.update(t),this.effectManager.update(t),this.checkCollisions(),this.wallManager.cullWalls())}autoPlay(){const t=this.wallManager.walls.find(e=>e.z>this.collisionZone);if(t){for(;this.player.currentShape.name!==t.shape.name;)this.player.nextShape();this.player.setRotation(t.rotation)}}checkCollisions(){this.wallManager.walls.forEach(t=>{if(t.z<this.collisionZone&&!t.processed){t.processed=!0;const e=this.player.currentShape;if(e.name===t.shape.name){const i=e.symmetry,a=Math.PI*2/i,o=this.player.rotationAngle%a,h=t.rotation%a;Math.abs(o-h)<.1?(this.score+=this.isDemo?0:100,this.wallManager.increaseSpeed(),this.soundManager.playPassSound(),this.effectManager.trigger(t.shape,t.rotation,t.color),t.z=-1):(this.soundManager.playGameOverSound(),this.isDemo?this.wallManager.walls[0].z=-1:(this.gameState="gameOver",this.destroyTouchControls()))}else this.soundManager.playGameOverSound(),this.isDemo?this.wallManager.walls[0].z=-1:(this.gameState="gameOver",this.destroyTouchControls())}})}draw(){if(this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.gameState==="playing"){const t=this.wallManager.nextWallShape;if(t){const e=this.wallManager.nextWallRotation,s=this.wallManager.nextWallColor;this.tunnel.draw(t,e,s,this.isTouchDevice())}this.wallManager.draw(this.isTouchDevice()),this.player.draw(this.isTouchDevice()),this.effectManager.draw(),this.drawScore()}else if(this.gameState==="gameOver")this.drawGameOver();else if(this.gameState==="demo"){const t=this.wallManager.nextWallShape;if(t){const e=this.wallManager.nextWallRotation,s=this.wallManager.nextWallColor;this.tunnel.draw(t,e,s,this.isTouchDevice())}this.wallManager.draw(this.isTouchDevice()),this.player.draw(this.isTouchDevice()),this.effectManager.draw()}}drawScore(){this.isDemo||(this.ctx.fillStyle="white",this.ctx.font="30px sans-serif",this.ctx.textAlign="left",this.ctx.fillText(`Score: ${this.score}`,20,40))}drawGameOver(){this.ctx.fillStyle="white",this.ctx.font="50px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("GAME OVER",this.canvas.width/2,this.canvas.height/2-50),this.ctx.font="30px sans-serif",this.ctx.fillText(`Final Score: ${this.score}`,this.canvas.width/2,this.canvas.height/2),this.ctx.font="20px sans-serif",this.ctx.fillText("Click to Restart",this.canvas.width/2,this.canvas.height/2+50),this.isTouchDevice()||(this.ctx.font="16px sans-serif",this.ctx.fillText('Hint: Press "Space" to drop the blocks faster.',this.canvas.width/2,this.canvas.height-30))}gameLoop(){if(!this.isLoopRunning)return;const t=performance.now();let e=(t-this.lastTime)/1e3;this.lastTime=t,e>.5&&(e=.5),this.update(e),this.draw(),requestAnimationFrame(()=>this.gameLoop())}}const F=document.getElementById("start-screen"),z=new k(!0);z.start();F.addEventListener("click",()=>{F.style.display="none",z.restart()});
