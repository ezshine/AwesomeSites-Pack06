//  Merci-Michel [R]
//  https://www.merci-michel.com/
//  Build 20241209-145825

!function(){"use strict";function t(t,e,s){return Math.max(e,Math.min(s,t))}function e(t,e,s){return(1-s)*t+s*e}function s(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function r(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}const n={h:0,s:0,l:0},i={h:0,s:0,l:0};function a(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+6*(e-t)*(2/3-s):t}class h{constructor(t,e,s){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,s)}set(t,e,s){if(void 0===e&&void 0===s){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,s);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this}setRGB(t,e,s){return this.r=t,this.g=e,this.b=s,this}setHSL(e,s,r){var n;if(e=(e%(n=1)+n)%n,s=t(s,0,1),r=t(r,0,1),0===s)this.r=this.g=this.b=r;else{const t=r<=.5?r*(1+s):r+s-r*s,n=2*r-t;this.r=a(n,t,e+1/3),this.g=a(n,t,e),this.b=a(n,t,e-1/3)}return this}setStyle(t){function e(t){void 0!==t&&parseFloat(t)}let s;if(s=/^(\w+)\(([^\)]*)\)/.exec(t)){let t;const r=s[1],n=s[2];switch(r){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return e(t[4]),this.setRGB(Math.min(255,parseInt(t[1],10))/255,Math.min(255,parseInt(t[2],10))/255,Math.min(255,parseInt(t[3],10))/255);if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return e(t[4]),this.setRGB(Math.min(100,parseInt(t[1],10))/100,Math.min(100,parseInt(t[2],10))/100,Math.min(100,parseInt(t[3],10))/100);break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return e(t[4]),this.setHSL(parseFloat(t[1])/360,parseFloat(t[2])/100,parseFloat(t[3])/100)}}else if(s=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=s[1],e=t.length;if(3===e)return this.setRGB(parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15);if(6===e)return this.setHex(parseInt(t,16))}else if(t&&t.length>0)return this.setColorName(t);return this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=s(t.r),this.g=s(t.g),this.b=s(t.b),this}copyLinearToSRGB(t){return this.r=r(t.r),this.g=r(t.g),this.b=r(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return o.copy(this),65536*Math.round(t(255*o.r,0,255))+256*Math.round(t(255*o.g,0,255))+Math.round(t(255*o.b,0,255))}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(t){o.copy(this);const e=o.r,s=o.g,r=o.b,n=Math.max(e,s,r),i=Math.min(e,s,r);let a,h;const c=(i+n)/2;if(i===n)a=0,h=0;else{const t=n-i;switch(h=c<=.5?t/(n+i):t/(2-n-i),n){case e:a=(s-r)/t+(s<r?6:0);break;case s:a=(r-e)/t+2;break;case r:a=(e-s)/t+4}a/=6}return t.h=a,t.s=h,t.l=c,t}getRGB(t){return o.copy(this),t.r=o.r,t.g=o.g,t.b=o.b,t}offsetHSL(t,e,s){return this.getHSL(n),this.setHSL(n.h+t,n.s+e,n.l+s)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,s){return this.r=t.r+(e.r-t.r)*s,this.g=t.g+(e.g-t.g)*s,this.b=t.b+(e.b-t.b)*s,this}lerpHSL(t,s){this.getHSL(n),t.getHSL(i);const r=e(n.h,i.h,s),a=e(n.s,i.s,s),h=e(n.l,i.l,s);return this.setHSL(r,a,h),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,s=this.g,r=this.b,n=t.elements;return this.r=n[0]*e+n[3]*s+n[6]*r,this.g=n[1]*e+n[4]*s+n[7]*r,this.b=n[2]*e+n[5]*s+n[8]*r,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const o=new h,c={};function l(t,e,s){return t*(1-s)+e*s}const u=(t=0,e=0)=>s=>((s=new h(s).offsetHSL(0,t,e)).hex="#"+s.getHexString(),s.getHSL(s),c[s.hex]=0,s),g=new h,d=["#e5a5a5","#e4ad90","#e1bf7f","#e5cd60","#e1d350","#c5d454","#b4d056","#a5ca6c","#9bce7b","#86d383","#80cb8f","#86d4bd","#86d4cd","#90d2dd","#82cad8","#7dbdd2","#87bcdc","#92b4e7","#9dabe2","#a9a1d8","#c0a5df","#c69edf","#d6a5df","#e3aedd","#efbae0","#f0afd2","#e8a7be","#f3bac1"].map(u(0,0)),f=["#a7a7a7","#b9b9b9","#c7c7c7","#d8d8d8"].map(u(0,0)),b=Object.values(f)[Object.values(f).length-1].hex;const p=new Map;function y(t){t.getHSL(t);const e=t.getHexString();if(p.has(e))return p.get(e);let s=Infinity,r=null;if(t.l<.015||t.l>.9||t.s<.08)for(let n=0;n<f.length;n++){const e=f[n],i=Math.abs(e.l-(t.l+.3));i<s&&(s=i,r=e)}else for(let n=0;n<d.length;n++){const e=d[n],i=Math.abs(e.h-t.h);i<s&&(s=i,r=e)}return p.set(e,r),r}const m={};function w(t,e){m[t]={pts:e.slice(),pixels:new Array(e.length/2).fill().map((()=>[0,0,0])),extract(t,e,s){const r=this.pts;!function(){for(let t in c)c[t]=0}();const n=~~(5*r.length/1756);let i=0;for(let o=0;o<r.length;o+=2){const a=~~(r[o]*e),h=4*(~~(r[o+1]*s)*e+a),u=t[h+3]/255,d=u<.5;if(!d||0===i){let e=l(255,t[h+0],u)/255,s=l(255,t[h+1],u)/255,r=l(255,t[h+2],u)/255;const n=y(g.setRGB(e,s,r));c[n.hex]++}d&&(i=(i+1)%n)}let a=Object.keys(c)[0],h=0;for(let o in c)c[o]>h&&(h=c[o],a=o);return function(t){"string"==typeof t?t=x.set(t):t||(t=x.set(b));return"#"+t.getHexString()}(a)}}}let x=new h;const S="readonly",B="readwrite",M="storage",v=new Map;function I(t){return new Promise(((e,s)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>s(t.error)}))}const L="undefined"==typeof window,H=L?new OffscreenCanvas(1,1):document.createElement("canvas"),R=H.getContext("2d"),A={},G=function(t="idb-storage"){if(v.has(t))return v.get(t);let e=null,s=null,r=!1;const n={setItem:h(B,(async(t,e,s=null)=>{await I(t.put(s,e))})),getItem:h(S,(async(t,e,s=null)=>await I(t.get(e))??s)),removeItem:h(B,(async(t,e)=>{await I(t.delete(e))})),updateItem:h(B,(async(t,e,s)=>{const r=s(await I(t.get(e)));await I(t.put(r,e))})),clear:h(B,(async t=>{await I(t.clear())})),keys:h(S,(async t=>I(t.getAllKeys()))),values:h(S,(async t=>I(t.getAll()))),entries:h(S,(async t=>{const[e,s]=await Promise.all([I(t.getAllKeys()),I(t.getAll())]);return e.map(((t,e)=>[t,s[e]]))})),isIdbStorage:!0,destroy:a,close:a};return v.set(t,n),i(),n;function i(){s=(async()=>{e&&(e.onupgradeneeded=null),e=indexedDB.open(t),e.onupgradeneeded=()=>e.result.createObjectStore(M);let s=await I(e);return s.objectStoreNames.contains(M)||(s.close(),await new Promise(((e,s)=>{const r=indexedDB.deleteDatabase(t);r.onsuccess=e,r.onerror=s})),e=indexedDB.open(t),e.onupgradeneeded=()=>e.result.createObjectStore(M),s=await I(e)),s})()}async function a(){r||(r=!0,e&&(e.onupgradeneeded=null),s&&await s.then((t=>t.close())).catch((()=>{})),s=e=null)}function h(t=S,e,n=!1){async function a(n,i){const a=await s;if(r)return null;const h=await a.transaction(M,t).objectStore(M);return r?null:e(h,n,i)}return async function(t,e){var h;const o=s;let c;try{c=await a(t,e)}catch(l){l instanceof Error&&!n&&!r&&(null==(h=null==l?void 0:l.message)?void 0:h.includes("connection is closing"))&&(o===s&&i(),c=await a(t,e))}return c}}}("undw3-imgs"),O=t=>t instanceof ImageBitmap;async function T(t,e,s,r=0,n){let i;if(O(t))H.width=t.width,H.height=t.height,R.drawImage(t,0,0);else{H.width=e,H.height=s;const a=new ImageData(t,e,s);if(n&&m[n]){i=m[n].extract(t,e,s)}if(r>0){for(let s=0;s<t.length;s+=4){const e=1/Math.max(1e-4,t[s+3]/255);t[s+0]=t[s+0]*e,t[s+1]=t[s+1]*e,t[s+2]=t[s+2]*e}const e=await createImageBitmap(a,{premultiplyAlpha:"none",imageOrientation:r>1?"flipY":"none"});R.drawImage(e,0,0)}else R.putImageData(a,0,0)}return i}function j(){return L?H.convertToBlob({type:"image/png"}):new Promise((t=>H.toBlob(t,"image/png")))}function k(t){const e=[];for(const s in t)t[s]instanceof ArrayBuffer||O(t[s])?e.push(t[s]):t[s].buffer&&e.push(t[s].buffer);t.isExportRtResponse=!0,globalThis.postMessage(t,e)}A.getBuffer=async function(t){const e=t.opts.cleanLevel??0;await T(t.arr,t.width,t.height,e);const s=await j();return{buffer:await s.arrayBuffer()}},A.getBlobUrl=async function(t){const e=t.opts.cleanLevel??0;await T(t.arr,t.width,t.height,e);const s=await j();return{url:URL.createObjectURL(s)}},A.toIndexedDb=async function(t){var e,s;const r=await T(t.arr,t.width,t.height,0,null==(e=t.opts)?void 0:e.item),n=await j(),i=await n.arrayBuffer(),a=(null==(s=t.opts)?void 0:s.key)??"rt";return await G.setItem(a,i),{key:a,color:r}},A.registerSamplePointsArray=async function(t){var e;return w(null==(e=t.opts)?void 0:e.item,t.arr),{success:!0}},globalThis.addEventListener("message",(async({data:t}={})=>{if(!t.isExportRtRequest)return;const{uid:e,arr:s}=t;try{k({success:!0,uid:e,arr:s,result:await A[t.action](t)})}catch(r){k({success:!1,uid:e,arr:s})}}))}();
