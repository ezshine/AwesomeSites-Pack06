//  Merci-Michel [R]
//  https://www.merci-michel.com/
//  Build 20241209-145825

var e,t,s=Object.defineProperty,i=e=>{throw TypeError(e)},r=(e,t,i)=>((e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i),n=(e,t,s)=>t.has(e)||i("Cannot "+s),o=(e,t,s)=>t.has(e)?i("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s);import{s as a,t as A,v as l,x as c,y as h,V as u,z as g,B as d,A as p,D as f,E as m,W as I,G as C,H as B,I as v,J as y,K as E,L as w,R as Q,N as x,M as b,S,O as R,P as D,Q as T,U as M,X as _,Y as F,Z as P,$ as U,a0 as k,a1 as L,a2 as G,a3 as N,a4 as O,a5 as q,a6 as H,a7 as z,a8 as V,a9 as $,aa as Y,ab as J,ac as K,ad as W,ae as j,af as X,ag as Z,ah as ee,ai as te,aj as se,ak as ie,al as re,am as ne,an as oe,ao as ae,ap as Ae,aq as le,ar as ce,as as he,at as ue,au as ge,av as de,aw as pe,ax as fe,ay as me,az as Ie,aA as Ce,aB as Be,aC as ve,aD as ye,aE as Ee,aF as we,aG as Qe,aH as xe,aI as be,aJ as Se,aK as Re,aL as De,aM as Te,aN as Me,aO as _e,aP as Fe,aQ as Pe,aR as Ue,aS as ke,aT as Le,aU as Ge,aV as Ne,aW as Oe,aX as qe,aY as He,aZ as ze,a_ as Ve,a$ as $e,b0 as Ye,b1 as Je,b2 as Ke,b3 as We,b4 as je,b5 as Xe,b6 as Ze,b7 as et,b8 as tt,b9 as st,ba as it,bb as rt,bc as nt,bd as ot,be as at,bf as At,bg as lt,bh as ct,bi as ht,bj as ut,bk as gt,bl as dt,bm as pt,bn as ft,bo as mt,bp as It,bq as Ct,br as Bt,bs as vt,bt as yt,bu as Et,d as wt,bv as Qt,bw as xt,bx as bt,by as St,bz as Rt,bA as Dt,bB as Tt,bC as Mt,bD as _t,bE as Ft,bF as Pt,bG as Ut,bH as kt,bI as Lt,bJ as Gt,bK as Nt,bL as Ot,bM as qt,bN as Ht,bO as zt,bP as Vt,bQ as $t,bR as Yt,bS as Jt,bT as Kt,w as Wt,bU as jt,bV as Xt,bW as Zt,bX as es,bY as ts,bZ as ss,b_ as is,b$ as rs,c0 as ns,c1 as os,c2 as as,c3 as As,c4 as ls,c5 as cs,c6 as hs,c7 as us,c8 as gs,c9 as ds,ca as ps,cb as fs,cc as ms,cd as Is,ce as Cs,cf as Bs,cg as vs,ch as ys,ci as Es,cj as ws,ck as Qs,cl as xs,cm as bs,cn as Ss,co as Rs,cp as Ds}from"./vendor.BVNJwFO8f063f8e7.js";const Ts=Number.MAX_SAFE_INTEGER,Ms=[30,60,120,144,240].map((e=>[(e=1e3/e)+.75,e,e-.75]));const _s={"720p":921600,"1080p":2073600,"1440p":3686400,"2k":3686400,"3k":4665600,"4k":8294400,"5k":14745600,"8k":33177600};let Fs,Ps=1;function Us({format:e=Q,name:t,depth:s=!0,stencil:i=null,width:r,height:n,scale:o=1,srgb:a=!1,colorSpace:A=x,generateMipmaps:l=!1,...c}={}){Fs||(Fs=b());const h=Fs.$renderer.drawingBufferSize;null==t&&(t="RenderTarget."+Ps++);let u,g=!1,d=!1;r&&n&&m(r,n),r&&n||I(o),a&&(A=S),u=new E(r,n,{minFilter:w,magFilter:w,format:e,colorSpace:A,depthBuffer:!!s,stencilBuffer:!!(i??s),...c}),u.texture.generateMipmaps=!!l;const p=u.setSize.bind(u);u.setSize=m,u.setScale=I;const f=u.dispose.bind(u);function m(e=0,t=0){t||(t=e),e<=0||(r=e,n=t,C(),u&&B())}function I(e=0){e<=0||(o=e,function(){if(d)return;d=!0,h.watch(v)}(),v())}function C(){d&&(d=!1,h.unwatch(v))}function B(){u.texture.width===r&&u.texture.height===n||(g=!0,p(r,n),u.depthTexture&&(u.depthTexture.image.width=r,u.depthTexture.image.height=n),g=!1)}function v(){r=Math.floor(h.value.x*o),n=Math.floor(h.value.y*o),u&&B()}return u.dispose=function(){if(f(),g)return;C()},u.texture.name=t,u.clone=function(){},u}const ks=new Int8Array([-1,-1,4,-1,-1,4]),Ls=new R;Ls.setAttribute("position",new D(ks,2));const Gs=new Int8Array([-1,-1,0,4,-1,0,-1,4,0]),Ns=new R;Ns.setAttribute("position",new D(Gs,3));const Os=["precision highp float;","attribute lowp vec2 position;","varying highp vec2 vUv;","void main() {","vUv = position * 0.5 + 0.5;","gl_Position = vec4(position, 0., 1.);","}"].join(""),qs=["precision highp float;","in vec2 position;","out vec2 vUv;","void main() {","vUv = position * 0.5 + 0.5;","gl_Position = vec4(position, 0., 1.);","}"].join(""),Hs=["varying highp vec2 vUv;","void main() {","vUv = position.xy * 0.5 + 0.5;","gl_Position = vec4(position, 1.);","}"].join(""),zs={raw:{Class:F,vertexShader:Os,geometry:Ls,screen:null},normal:{Class:P,vertexShader:Hs,geometry:Ns,screen:null}},Vs=new _;let $s;function Ys({useRawShader:e=!0,vertexShader:t,fragmentShader:s,renderer:i,glsl3:r=!1,...n}={}){$s||($s=b()),i=i??$s.$renderer.instance;const o=e?zs.raw:zs.normal;let a="precision highp float;varying vec2 vUv;void main(){gl_FragColor=vec4(vUv,0.,1.);}",A=o.vertexShader;r&&e&&(a="precision highp float;in vec2 vUv;out vec4 fragColor;void main(){fragColor=vec4(vUv,0.,1.);}",A=qs);const l=new o.Class(Object.assign({},{vertexShader:A,fragmentShader:a,depthTest:!1,depthWrite:!1,transparent:!0},n));r&&(l.glslVersion=T),t&&(t.use?t.use(l):l.vertexShader=t),s&&(s.use?s.use(l):l.fragmentShader=s);let c=o.screen;c||(c=o.screen=new M(o.geometry,l),c.frustumCulled=!1,c.matrixAutoUpdate=!1,c.matrixWorldAutoUpdate=!1);return{cam:Vs,screen:c,material:l,uniforms:l.uniforms,u:l.uniforms,render(){const e=i.sortObjects,t=i.shadowMap.enabled,s=i.autoClear;i.sortObjects=!1,i.shadowMap.enabled=!1,i.autoClear=!1,c.material=l,i.render(c,Vs),i.sortObjects=e,i.shadowMap.enabled=t,i.autoClear=s}}}const Js=()=>{};function Ks(e){const t=U.$threeRenderer.capabilities.isWebGL2,s=new k(e.img);return void 0!==e.flipY&&(s.flipY=e.flipY),void 0!==e.mipmaps&&(s.generateMipmaps=!!e.mipmaps),e.red&&(e.format=t?L:G,e.srgb=!1),e.alpha&&(e.format=N,e.srgb=!1),e.nearest&&(s.magFilter=s.minFilter=O),e.linear&&(s.magFilter=s.minFilter=w),e.magFilter&&(s.magFilter=e.magFilter),e.minFilter&&(s.minFilter=e.minFilter),e.encoding&&(s.encoding=e.encoding),e.colorSpace&&(s.encoding=e.colorSpace),e.data&&(e.srgb=!1),!0===e.srgb?s.colorSpace=S:(!1===e.srgb||e.data)&&(s.colorSpace=x),e.mapping&&(s.mapping=e.mapping),e.premultiplyAlpha&&(s.premultiplyAlpha=!0),e.repeat?(s.wrapS=q,s.wrapT=q):(e.wrapS&&(s.wrapS=e.wrapS),e.wrapT&&(s.wrapT=e.wrapT)),e.format&&(s.format=e.format),e.type&&(s.type=e.type),s.needsUpdate=!0,s}function Ws(e,t,s,i=0){const r=t.size,n=t.scale,o={},a=e.anchor||e.pivot||{x:.5,y:.5};"hint"===s.split("_")[0]&&(a.x=0,a.y=0);const A=e.frame,l=e.sourceSize,c=e.spriteSourceSize;o.id=s;const h=s.split("/");o.sequence=h.pop(),o.group=h.join("/"),o.frameIndex=i,o.spriteFrame=c,o.texCoords=new Float32Array([A.x/r.w,(r.h-A.y-A.h)/r.h,A.w/r.w,A.h/r.h]),o.meshCoords=new Float32Array([.5*c.w+c.x-l.w*a.x,-(.5*c.h+c.y-l.h*a.y),c.w,c.h]);for(let u=0,g=o.meshCoords.length;u<g;u++)o.meshCoords[u]*=n;return o.anchor=a,o.sourceSize=e.sourceSize,o.spriteSourceSize=e.spriteSourceSize,e.vertices&&(o.vertices=e.vertices,o.verticesUV=e.verticesUV,o.triangles=e.triangles,o.geo=function(e){const t=new R,{vertices:s,verticesUV:i,triangles:r,frame:n,spriteSourceSize:o,texCoords:a,size:A}=e,l=e.anchor||e.pivot||{x:.5,y:.5},c=[],h=[],u=[],g=[],d=o.w>o.h?o.w/o.h:1,p=o.h>o.w?o.h/o.w:1;for(let f=0;f<s.length;f+=1){let[e,t]=s[f];e-=o.x+o.w*l.x,t-=o.y+o.h*l.y,e/=o.w,t=1-t/o.h,e*=d,t*=p,c.push(e,t,0),u.push(0,0,1)}for(let f=0;f<i.length;f+=1){let[e,t]=i[f];e/=A.w,t=1-t/A.h,g.push(e,t)}for(let f=0;f<r.length;f+=1){const[e,t,s]=r[f];h.push(e,s,t)}return t.setAttribute("position",new H(c,3)),t.setAttribute("normal",new H(u,3)),t.setAttribute("uv",new H(g,2)),t.setIndex(h),t}({frame:A,size:r,...o})),o}var js=Uint8Array,Xs=Uint16Array,Zs=Int32Array,ei=new js([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ti=new js([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),si=new js([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ii=function(e,t){for(var s=new Xs(31),i=0;i<31;++i)s[i]=t+=1<<e[i-1];var r=new Zs(s[30]);for(i=1;i<30;++i)for(var n=s[i];n<s[i+1];++n)r[n]=n-s[i]<<5|i;return{b:s,r}},ri=ii(ei,2),ni=ri.b,oi=ri.r;ni[28]=258,oi[258]=28;for(var ai=ii(ti,0).b,Ai=new Xs(32768),li=0;li<32768;++li){var ci=(43690&li)>>1|(21845&li)<<1;ci=(61680&(ci=(52428&ci)>>2|(13107&ci)<<2))>>4|(3855&ci)<<4,Ai[li]=((65280&ci)>>8|(255&ci)<<8)>>1}var hi=function(e,t,s){for(var i=e.length,r=0,n=new Xs(t);r<i;++r)e[r]&&++n[e[r]-1];var o,a=new Xs(t);for(r=1;r<t;++r)a[r]=a[r-1]+n[r-1]<<1;if(s){o=new Xs(1<<t);var A=15-t;for(r=0;r<i;++r)if(e[r])for(var l=r<<4|e[r],c=t-e[r],h=a[e[r]-1]++<<c,u=h|(1<<c)-1;h<=u;++h)o[Ai[h]>>A]=l}else for(o=new Xs(i),r=0;r<i;++r)e[r]&&(o[r]=Ai[a[e[r]-1]++]>>15-e[r]);return o},ui=new js(288);for(li=0;li<144;++li)ui[li]=8;for(li=144;li<256;++li)ui[li]=9;for(li=256;li<280;++li)ui[li]=7;for(li=280;li<288;++li)ui[li]=8;var gi=new js(32);for(li=0;li<32;++li)gi[li]=5;var di=hi(ui,9,1),pi=hi(gi,5,1),fi=function(e){for(var t=e[0],s=1;s<e.length;++s)e[s]>t&&(t=e[s]);return t},mi=function(e,t,s){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&s},Ii=function(e,t){var s=t/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&t)},Ci=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Bi=function(e,t,s){var i=new Error(t||Ci[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,Bi),!s)throw i;return i},vi=function(e,t,s,i){var r=e.length;if(!r||t.f&&!t.l)return s||new js(0);var n=!s,o=n||2!=t.i,a=t.i;n&&(s=new js(3*r));var A=function(e){var t=s.length;if(e>t){var i=new js(Math.max(2*t,e));i.set(s),s=i}},l=t.f||0,c=t.p||0,h=t.b||0,u=t.l,g=t.d,d=t.m,p=t.n,f=8*r;do{if(!u){l=mi(e,c,1);var m=mi(e,c+1,3);if(c+=3,!m){var I=e[(R=4+((c+7)/8|0))-4]|e[R-3]<<8,C=R+I;if(C>r){a&&Bi(0);break}o&&A(h+I),s.set(e.subarray(R,C),h),t.b=h+=I,t.p=c=8*C,t.f=l;continue}if(1==m)u=di,g=pi,d=9,p=5;else if(2==m){var B=mi(e,c,31)+257,v=mi(e,c+10,15)+4,y=B+mi(e,c+5,31)+1;c+=14;for(var E=new js(y),w=new js(19),Q=0;Q<v;++Q)w[si[Q]]=mi(e,c+3*Q,7);c+=3*v;var x=fi(w),b=(1<<x)-1,S=hi(w,x,1);for(Q=0;Q<y;){var R,D=S[mi(e,c,b)];if(c+=15&D,(R=D>>4)<16)E[Q++]=R;else{var T=0,M=0;for(16==R?(M=3+mi(e,c,3),c+=2,T=E[Q-1]):17==R?(M=3+mi(e,c,7),c+=3):18==R&&(M=11+mi(e,c,127),c+=7);M--;)E[Q++]=T}}var _=E.subarray(0,B),F=E.subarray(B);d=fi(_),p=fi(F),u=hi(_,d,1),g=hi(F,p,1)}else Bi(1);if(c>f){a&&Bi(0);break}}o&&A(h+131072);for(var P=(1<<d)-1,U=(1<<p)-1,k=c;;k=c){var L=(T=u[Ii(e,c)&P])>>4;if((c+=15&T)>f){a&&Bi(0);break}if(T||Bi(2),L<256)s[h++]=L;else{if(256==L){k=c,u=null;break}var G=L-254;if(L>264){var N=ei[Q=L-257];G=mi(e,c,(1<<N)-1)+ni[Q],c+=N}var O=g[Ii(e,c)&U],q=O>>4;O||Bi(3),c+=15&O;F=ai[q];if(q>3){N=ti[q];F+=Ii(e,c)&(1<<N)-1,c+=N}if(c>f){a&&Bi(0);break}o&&A(h+131072);var H=h+G;if(h<F){var z=0-F,V=Math.min(F,H);for(z+h<0&&Bi(3);h<V;++h)s[h]=i[z+h]}for(;h<H;++h)s[h]=s[h-F]}}t.l=u,t.p=k,t.b=h,t.f=l,u&&(l=1,t.m=d,t.d=g,t.n=p)}while(!l);return h!=s.length&&n?function(e,t,s){return(null==s||s>e.length)&&(s=e.length),new js(e.subarray(t,s))}(s,0,h):s.subarray(0,h)},yi=new js(0);function Ei(e,t){return vi(e.subarray((i=t,(8!=(15&(s=e)[0])||s[0]>>4>7||(s[0]<<8|s[1])%31)&&Bi(6,"invalid zlib data"),(s[1]>>5&1)==+!i&&Bi(6,"invalid zlib data: "+(32&s[1]?"need":"unexpected")+" dictionary"),2+(s[1]>>3&4)),-4),{i:2},t,t);var s,i}var wi="undefined"!=typeof TextDecoder&&new TextDecoder;try{wi.decode(yi,{stream:!0})}catch(ru){}let Qi=new class extends z{constructor(e){super(e),this.type=V}parse(e){const t=65536,s=14,i=65537,r=16384,n=Math.pow(2.7182818,2.2);const o={l:0,c:0,lc:0};function a(e,t,s,i,r){for(;s<e;)t=t<<8|z(i,r),s+=8;s-=e,o.l=t>>s&(1<<e)-1,o.c=t,o.lc=s}const A=new Array(59);function l(e,t,s,r,n,l){const c=t;let h=0,u=0;for(;r<=n;r++){if(c.value-t.value>s)return!1;a(6,h,u,e,c);const i=o.l;if(h=o.c,u=o.lc,l[r]=i,63==i){if(c.value-t.value>s)throw new Error("Something wrong with hufUnpackEncTable");a(8,h,u,e,c);let i=o.l+6;if(h=o.c,u=o.lc,r+i>n+1)throw new Error("Something wrong with hufUnpackEncTable");for(;i--;)l[r++]=0;r--}else if(i>=59){let e=i-59+2;if(r+e>n+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)l[r++]=0;r--}}!function(e){for(let s=0;s<=58;++s)A[s]=0;for(let s=0;s<i;++s)A[e[s]]+=1;let t=0;for(let s=58;s>0;--s){const e=t+A[s]>>1;A[s]=t,t=e}for(let s=0;s<i;++s){const t=e[s];t>0&&(e[s]=t|A[t]++<<6)}}(l)}function c(e){return 63&e}function h(e){return e>>6}const u={c:0,lc:0};function g(e,t,s,i){e=e<<8|z(s,i),t+=8,u.c=e,u.lc=t}const d={c:0,lc:0};function p(e,t,s,i,r,n,o,a,A){if(e==t){i<8&&(g(s,i,r,n),s=u.c,i=u.lc);let e=s>>(i-=8);if(e=new Uint8Array([e])[0],a.value+e>A)return!1;const t=o[a.value-1];for(;e-- >0;)o[a.value++]=t}else{if(!(a.value<A))return!1;o[a.value++]=e}d.c=s,d.lc=i}function f(e){return 65535&e}function m(e){const t=f(e);return t>32767?t-65536:t}const I={a:0,b:0};function C(e,t){const s=m(e),i=m(t),r=s+(1&i)+(i>>1),n=r,o=r-i;I.a=n,I.b=o}function B(e,t){const s=f(e),i=f(t),r=s-(i>>1)&65535,n=i+r-32768&65535;I.a=n,I.b=r}function v(e,t,s,i,r,n,o){const a=o<16384,A=s>r?r:s;let l,c,h=1;for(;h<=A;)h<<=1;for(h>>=1,l=h,h>>=1;h>=1;){c=0;const o=c+n*(r-l),A=n*h,u=n*l,g=i*h,d=i*l;let p,f,m,v;for(;c<=o;c+=u){let r=c;const n=c+i*(s-l);for(;r<=n;r+=d){const s=r+g,i=r+A,n=i+g;a?(C(e[r+t],e[i+t]),p=I.a,m=I.b,C(e[s+t],e[n+t]),f=I.a,v=I.b,C(p,f),e[r+t]=I.a,e[s+t]=I.b,C(m,v),e[i+t]=I.a,e[n+t]=I.b):(B(e[r+t],e[i+t]),p=I.a,m=I.b,B(e[s+t],e[n+t]),f=I.a,v=I.b,B(p,f),e[r+t]=I.a,e[s+t]=I.b,B(m,v),e[i+t]=I.a,e[n+t]=I.b)}if(s&h){const s=r+A;a?C(e[r+t],e[s+t]):B(e[r+t],e[s+t]),p=I.a,e[s+t]=I.b,e[r+t]=p}}if(r&h){let r=c;const n=c+i*(s-l);for(;r<=n;r+=d){const s=r+g;a?C(e[r+t],e[s+t]):B(e[r+t],e[s+t]),p=I.a,e[s+t]=I.b,e[r+t]=p}}l=h,h>>=1}return c}function y(e,t,n,o,a,A){const f=n.value,m=H(t,n),I=H(t,n);n.value+=4;const C=H(t,n);if(n.value+=4,m<0||m>=i||I<0||I>=i)throw new Error("Something wrong with HUF_ENCSIZE");const B=new Array(i),v=new Array(r);!function(e){for(let t=0;t<r;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(v);if(l(e,n,o-(n.value-f),m,I,B),C>8*(o-(n.value-f)))throw new Error("Something wrong with hufUncompress");!function(e,t,i,r){for(;t<=i;t++){const i=h(e[t]),n=c(e[t]);if(i>>n)throw new Error("Invalid table entry");if(n>s){const e=r[i>>n-s];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let s=0;s<e.lit-1;++s)e.p[s]=t[s]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(n){let e=0;for(let o=1<<s-n;o>0;o--){const o=r[(i<<s-n)+e];if(o.len||o.p)throw new Error("Invalid table entry");o.len=n,o.lit=t,e++}}}}(B,m,I,v),function(e,t,i,r,n,o,a,A,l){let f=0,m=0;const I=a,C=Math.trunc(r.value+(n+7)/8);for(;r.value<C;)for(g(f,m,i,r),f=u.c,m=u.lc;m>=s;){const n=t[f>>m-s&16383];if(n.len)m-=n.len,p(n.lit,o,f,m,i,r,A,l,I),f=d.c,m=d.lc;else{if(!n.p)throw new Error("hufDecode issues");let t;for(t=0;t<n.lit;t++){const s=c(e[n.p[t]]);for(;m<s&&r.value<C;)g(f,m,i,r),f=u.c,m=u.lc;if(m>=s&&h(e[n.p[t]])==(f>>m-s&(1<<s)-1)){m-=s,p(n.p[t],o,f,m,i,r,A,l,I),f=d.c,m=d.lc;break}}if(t==n.lit)throw new Error("hufDecode issues")}}const B=8-n&7;for(f>>=B,m-=B;m>0;){const e=t[f<<s-m&16383];if(!e.len)throw new Error("hufDecode issues");m-=e.len,p(e.lit,o,f,m,i,r,A,l,I),f=d.c,m=d.lc}}(B,v,e,n,C,I,A,a,{value:0})}function E(e){for(let t=1;t<e.length;t++){const s=e[t-1]+e[t]-128;e[t]=s}}function w(e,t){let s=0,i=Math.floor((e.length+1)/2),r=0;const n=e.length-1;for(;!(r>n||(t[r++]=e[s++],r>n));)t[r++]=e[i++]}function b(e){let t=e.byteLength;const s=new Array;let i=0;const r=new DataView(e);for(;t>0;){const e=r.getInt8(i++);if(e<0){const n=-e;t-=n+1;for(let e=0;e<n;e++)s.push(r.getUint8(i++))}else{const n=e;t-=2;const o=r.getUint8(i++);for(let e=0;e<n+1;e++)s.push(o)}}return s}function S(e,t,s){let i,r=1;for(;r<64;)i=t[e.value],65280==i?r=64:i>>8==255?r+=255&i:(s[r]=i,r++),e.value++}function R(e,t){t[0]=Z(e[0]),t[1]=Z(e[1]),t[2]=Z(e[5]),t[3]=Z(e[6]),t[4]=Z(e[14]),t[5]=Z(e[15]),t[6]=Z(e[27]),t[7]=Z(e[28]),t[8]=Z(e[2]),t[9]=Z(e[4]),t[10]=Z(e[7]),t[11]=Z(e[13]),t[12]=Z(e[16]),t[13]=Z(e[26]),t[14]=Z(e[29]),t[15]=Z(e[42]),t[16]=Z(e[3]),t[17]=Z(e[8]),t[18]=Z(e[12]),t[19]=Z(e[17]),t[20]=Z(e[25]),t[21]=Z(e[30]),t[22]=Z(e[41]),t[23]=Z(e[43]),t[24]=Z(e[9]),t[25]=Z(e[11]),t[26]=Z(e[18]),t[27]=Z(e[24]),t[28]=Z(e[31]),t[29]=Z(e[40]),t[30]=Z(e[44]),t[31]=Z(e[53]),t[32]=Z(e[10]),t[33]=Z(e[19]),t[34]=Z(e[23]),t[35]=Z(e[32]),t[36]=Z(e[39]),t[37]=Z(e[45]),t[38]=Z(e[52]),t[39]=Z(e[54]),t[40]=Z(e[20]),t[41]=Z(e[22]),t[42]=Z(e[33]),t[43]=Z(e[38]),t[44]=Z(e[46]),t[45]=Z(e[51]),t[46]=Z(e[55]),t[47]=Z(e[60]),t[48]=Z(e[21]),t[49]=Z(e[34]),t[50]=Z(e[37]),t[51]=Z(e[47]),t[52]=Z(e[50]),t[53]=Z(e[56]),t[54]=Z(e[59]),t[55]=Z(e[61]),t[56]=Z(e[35]),t[57]=Z(e[36]),t[58]=Z(e[48]),t[59]=Z(e[49]),t[60]=Z(e[57]),t[61]=Z(e[58]),t[62]=Z(e[62]),t[63]=Z(e[63])}function D(e){const t=.5*Math.cos(.7853975),s=.5*Math.cos(3.14159/16),i=.5*Math.cos(3.14159/8),r=.5*Math.cos(3*3.14159/16),n=.5*Math.cos(.981746875),o=.5*Math.cos(3*3.14159/8),a=.5*Math.cos(1.374445625),A=new Array(4),l=new Array(4),c=new Array(4),h=new Array(4);for(let u=0;u<8;++u){const g=8*u;A[0]=i*e[g+2],A[1]=o*e[g+2],A[2]=i*e[g+6],A[3]=o*e[g+6],l[0]=s*e[g+1]+r*e[g+3]+n*e[g+5]+a*e[g+7],l[1]=r*e[g+1]-a*e[g+3]-s*e[g+5]-n*e[g+7],l[2]=n*e[g+1]-s*e[g+3]+a*e[g+5]+r*e[g+7],l[3]=a*e[g+1]-n*e[g+3]+r*e[g+5]-s*e[g+7],c[0]=t*(e[g+0]+e[g+4]),c[3]=t*(e[g+0]-e[g+4]),c[1]=A[0]+A[3],c[2]=A[1]-A[2],h[0]=c[0]+c[1],h[1]=c[3]+c[2],h[2]=c[3]-c[2],h[3]=c[0]-c[1],e[g+0]=h[0]+l[0],e[g+1]=h[1]+l[1],e[g+2]=h[2]+l[2],e[g+3]=h[3]+l[3],e[g+4]=h[3]-l[3],e[g+5]=h[2]-l[2],e[g+6]=h[1]-l[1],e[g+7]=h[0]-l[0]}for(let u=0;u<8;++u)A[0]=i*e[16+u],A[1]=o*e[16+u],A[2]=i*e[48+u],A[3]=o*e[48+u],l[0]=s*e[8+u]+r*e[24+u]+n*e[40+u]+a*e[56+u],l[1]=r*e[8+u]-a*e[24+u]-s*e[40+u]-n*e[56+u],l[2]=n*e[8+u]-s*e[24+u]+a*e[40+u]+r*e[56+u],l[3]=a*e[8+u]-n*e[24+u]+r*e[40+u]-s*e[56+u],c[0]=t*(e[u]+e[32+u]),c[3]=t*(e[u]-e[32+u]),c[1]=A[0]+A[3],c[2]=A[1]-A[2],h[0]=c[0]+c[1],h[1]=c[3]+c[2],h[2]=c[3]-c[2],h[3]=c[0]-c[1],e[0+u]=h[0]+l[0],e[8+u]=h[1]+l[1],e[16+u]=h[2]+l[2],e[24+u]=h[3]+l[3],e[32+u]=h[3]-l[3],e[40+u]=h[2]-l[2],e[48+u]=h[1]-l[1],e[56+u]=h[0]-l[0]}function T(e){for(let t=0;t<64;++t){const s=e[0][t],i=e[1][t],r=e[2][t];e[0][t]=s+1.5747*r,e[1][t]=s-.1873*i-.4682*r,e[2][t]=s+1.8556*i}}function M(e,t,s){for(let i=0;i<64;++i)t[s+i]=J.toHalfFloat(_(e[i]))}function _(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(n,Math.abs(e)-1)}function F(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function P(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),s=new Uint8Array(b(t)),i=new Uint8Array(s.length);return E(s),w(s,i),new DataView(i.buffer)}function U(e){const t=Ei(e.array.slice(e.offset.value,e.offset.value+e.size)),s=new Uint8Array(t.length);return E(t),w(t,s),new DataView(s.buffer)}function k(e){const s=e.viewer,i={value:e.offset.value},r=new Uint16Array(e.columns*e.lines*(e.inputChannels.length*e.type)),n=new Uint8Array(8192);let o=0;const a=new Array(e.inputChannels.length);for(let t=0,p=e.inputChannels.length;t<p;t++)a[t]={},a[t].start=o,a[t].end=a[t].start,a[t].nx=e.columns,a[t].ny=e.lines,a[t].size=e.type,o+=a[t].nx*a[t].ny*a[t].size;const A=ee(s,i),l=ee(s,i);if(l>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(A<=l)for(let t=0;t<l-A+1;t++)n[t+A]=K(s,i);const c=new Uint16Array(t),h=function(e,s){let i=0;for(let n=0;n<t;++n)(0==n||e[n>>3]&1<<(7&n))&&(s[i++]=n);const r=i-1;for(;i<t;)s[i++]=0;return r}(n,c),u=H(s,i);y(e.array,s,i,u,r,o);for(let t=0;t<e.inputChannels.length;++t){const e=a[t];for(let s=0;s<a[t].size;++s)v(r,e.start+s,e.nx,e.size,e.ny,e.nx*e.size,h)}!function(e,t,s){for(let i=0;i<s;++i)t[i]=e[t[i]]}(c,r,o);let g=0;const d=new Uint8Array(r.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let s=0;s<e.inputChannels.length;s++){const e=a[s],t=e.nx*e.size,i=new Uint8Array(r.buffer,2*e.end,2*t);d.set(i,g),g+=2*t,e.end+=t}return new DataView(d.buffer)}function G(e){const t=Ei(e.array.slice(e.offset.value,e.offset.value+e.size)),s=e.inputChannels.length*e.lines*e.columns*e.totalBytes,i=new ArrayBuffer(s),r=new DataView(i);let n=0,o=0;const a=new Array(4);for(let A=0;A<e.lines;A++)for(let s=0;s<e.inputChannels.length;s++){let i=0;switch(e.inputChannels[s].pixelType){case 1:a[0]=n,a[1]=a[0]+e.columns,n=a[1]+e.columns;for(let s=0;s<e.columns;++s){i+=t[a[0]++]<<8|t[a[1]++],r.setUint16(o,i,!0),o+=2}break;case 2:a[0]=n,a[1]=a[0]+e.columns,a[2]=a[1]+e.columns,n=a[2]+e.columns;for(let s=0;s<e.columns;++s){i+=t[a[0]++]<<24|t[a[1]++]<<16|t[a[2]++]<<8,r.setUint32(o,i,!0),o+=4}}}return r}function N(e){const t=e.viewer,s={value:e.offset.value},i=new Uint8Array(e.columns*e.lines*(e.inputChannels.length*e.type*2)),r={version:W(t,s),unknownUncompressedSize:W(t,s),unknownCompressedSize:W(t,s),acCompressedSize:W(t,s),dcCompressedSize:W(t,s),rleCompressedSize:W(t,s),rleUncompressedSize:W(t,s),rleRawSize:W(t,s),totalAcUncompressedCount:W(t,s),totalDcUncompressedCount:W(t,s),acCompression:W(t,s)};if(r.version<2)throw new Error("EXRLoader.parse: "+ce.compression+" version "+r.version+" is unsupported");const n=new Array;let o=ee(t,s)-2;for(;o>0;){const e=O(t.buffer,s),i=K(t,s),r=i>>2&3,a=new Int8Array([(i>>4)-1])[0],A=K(t,s);n.push({name:e,index:a,type:A,compression:r}),o-=e.length+3}const a=ce.channels,A=new Array(e.inputChannels.length);for(let p=0;p<e.inputChannels.length;++p){const t=A[p]={},s=a[p];t.name=s.name,t.compression=0,t.decoded=!1,t.type=s.pixelType,t.pLinear=s.pLinear,t.width=e.columns,t.height=e.lines}const l={idx:new Array(3)};for(let p=0;p<e.inputChannels.length;++p){const e=A[p];for(let t=0;t<n.length;++t){const s=n[t];e.name==s.name&&(e.compression=s.compression,s.index>=0&&(l.idx[s.index]=p),e.offset=p)}}let c,h,u;if(r.acCompressedSize>0)switch(r.acCompression){case 0:c=new Uint16Array(r.totalAcUncompressedCount),y(e.array,t,s,r.acCompressedSize,c,r.totalAcUncompressedCount);break;case 1:const i=Ei(e.array.slice(s.value,s.value+r.totalAcUncompressedCount));c=new Uint16Array(i.buffer),s.value+=r.totalAcUncompressedCount}if(r.dcCompressedSize>0){const t={array:e.array,offset:s,size:r.dcCompressedSize};h=new Uint16Array(U(t).buffer),s.value+=r.dcCompressedSize}if(r.rleRawSize>0){u=b(Ei(e.array.slice(s.value,s.value+r.rleCompressedSize)).buffer),s.value+=r.rleCompressedSize}let g=0;const d=new Array(A.length);for(let p=0;p<d.length;++p)d[p]=new Array;for(let p=0;p<e.lines;++p)for(let t=0;t<A.length;++t)d[t].push(g),g+=A[t].width*e.type*2;!function(e,t,s,i,r,n){let o=new DataView(n.buffer);const a=s[e.idx[0]].width,A=s[e.idx[0]].height,l=Math.floor(a/8),c=Math.ceil(a/8),h=Math.ceil(A/8),u=a-8*(c-1),g=A-8*(h-1),d={value:0},p=new Array(3),f=new Array(3),m=new Array(3),I=new Array(3),C=new Array(3);for(let v=0;v<3;++v)C[v]=t[e.idx[v]],p[v]=v<1?0:p[v-1]+c*h,f[v]=new Float32Array(64),m[v]=new Uint16Array(64),I[v]=new Uint16Array(64*c);for(let v=0;v<h;++v){let t=8;v==h-1&&(t=g);let n=8;for(let e=0;e<c;++e){e==c-1&&(n=u);for(let e=0;e<3;++e)m[e].fill(0),m[e][0]=r[p[e]++],S(d,i,m[e]),R(m[e],f[e]),D(f[e]);T(f);for(let t=0;t<3;++t)M(f[t],I[t],64*e)}let a=0;for(let i=0;i<3;++i){const r=s[e.idx[i]].type;for(let e=8*v;e<8*v+t;++e){a=C[i][e];for(let t=0;t<l;++t){const s=64*t+8*(7&e);o.setUint16(a+0*r,I[i][s+0],!0),o.setUint16(a+2*r,I[i][s+1],!0),o.setUint16(a+4*r,I[i][s+2],!0),o.setUint16(a+6*r,I[i][s+3],!0),o.setUint16(a+8*r,I[i][s+4],!0),o.setUint16(a+10*r,I[i][s+5],!0),o.setUint16(a+12*r,I[i][s+6],!0),o.setUint16(a+14*r,I[i][s+7],!0),a+=16*r}}if(l!=c)for(let e=8*v;e<8*v+t;++e){const t=C[i][e]+8*l*2*r,s=64*l+8*(7&e);for(let e=0;e<n;++e)o.setUint16(t+2*e*r,I[i][s+e],!0)}}}const B=new Uint16Array(a);o=new DataView(n.buffer);for(let v=0;v<3;++v){s[e.idx[v]].decoded=!0;const t=s[e.idx[v]].type;if(2==s[v].type)for(let e=0;e<A;++e){const s=C[v][e];for(let e=0;e<a;++e)B[e]=o.getUint16(s+2*e*t,!0);for(let e=0;e<a;++e)o.setFloat32(s+2*e*t,Z(B[e]),!0)}}}(l,d,A,c,h,i);for(let p=0;p<A.length;++p){const t=A[p];if(!t.decoded){if(2!==t.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let s=0,r=0;for(let n=0;n<e.lines;++n){let e=d[p][s];for(let s=0;s<t.width;++s){for(let s=0;s<2*t.type;++s)i[e++]=u[r+s*t.width*t.height];r++}s++}}}}return new DataView(i.buffer)}function O(e,t){const s=new Uint8Array(e);let i=0;for(;0!=s[t.value+i];)i+=1;const r=(new TextDecoder).decode(s.slice(t.value,t.value+i));return t.value=t.value+i+1,r}function q(e,t){const s=e.getInt32(t.value,!0);return t.value=t.value+4,s}function H(e,t){const s=e.getUint32(t.value,!0);return t.value=t.value+4,s}function z(e,t){const s=e[t.value];return t.value=t.value+1,s}function K(e,t){const s=e.getUint8(t.value);return t.value=t.value+1,s}const W=function(e,t){let s;return s="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,s};function j(e,t){const s=e.getFloat32(t.value,!0);return t.value+=4,s}function X(e,t){return J.toHalfFloat(j(e,t))}function Z(e){const t=(31744&e)>>10,s=1023&e;return(e>>15?-1:1)*(t?31===t?s?NaN:Infinity:Math.pow(2,t-15)*(1+s/1024):s/1024*6103515625e-14)}function ee(e,t){const s=e.getUint16(t.value,!0);return t.value+=2,s}function te(e,t){return Z(ee(e,t))}function se(e,t,s,i,r){return"string"===i||"stringvector"===i||"iccProfile"===i?function(e,t,s){const i=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+s));return t.value=t.value+s,i}(t,s,r):"chlist"===i?function(e,t,s,i){const r=s.value,n=[];for(;s.value<r+i-1;){const i=O(t,s),r=q(e,s),o=K(e,s);s.value+=3;const a=q(e,s),A=q(e,s);n.push({name:i,pixelType:r,pLinear:o,xSampling:a,ySampling:A})}return s.value+=1,n}(e,t,s,r):"chromaticities"===i?function(e,t){return{redX:j(e,t),redY:j(e,t),greenX:j(e,t),greenY:j(e,t),blueX:j(e,t),blueY:j(e,t),whiteX:j(e,t),whiteY:j(e,t)}}(e,s):"compression"===i?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][K(e,t)]}(e,s):"box2i"===i?function(e,t){return{xMin:q(e,t),yMin:q(e,t),xMax:q(e,t),yMax:q(e,t)}}(e,s):"envmap"===i?function(e,t){return["ENVMAP_LATLONG","ENVMAP_CUBE"][K(e,t)]}(e,s):"tiledesc"===i?function(e,t){const s=H(e,t),i=H(e,t),r=K(e,t);return{xSize:s,ySize:i,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&r],roundingMode:["ROUND_DOWN","ROUND_UP"][r>>4]}}(e,s):"lineOrder"===i?function(e,t){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][K(e,t)]}(e,s):"float"===i?j(e,s):"v2f"===i?function(e,t){return[j(e,t),j(e,t)]}(e,s):"v3f"===i?function(e,t){return[j(e,t),j(e,t),j(e,t)]}(e,s):"int"===i?q(e,s):"rational"===i?function(e,t){return[q(e,t),H(e,t)]}(e,s):"timecode"===i?function(e,t){return[H(e,t),H(e,t)]}(e,s):"preview"===i?(s.value+=r,"skipped"):void(s.value+=r)}function ie(e,t,s){let i=0;switch(e.levelMode){case"ONE_LEVEL":i=1;break;case"MIPMAP_LEVELS":i=function(e,t){const s=Math.log2(e);return"ROUND_DOWN"==t?Math.floor(s):Math.ceil(s)}(Math.max(t,s),e.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return i}function re(e,t,s,i){const r=new Array(e);for(let n=0;n<e;n++){const e=1<<n;let o=t/e|0;"ROUND_UP"==i&&o*e<t&&(o+=1);const a=Math.max(o,1);r[n]=(a+s-1)/s|0}return r}function ne(){const e=this,t=e.offset,s={value:0};for(let i=0;i<e.tileCount;i++){const i=q(e.viewer,t),r=q(e.viewer,t);t.value+=8,e.size=H(e.viewer,t);const n=i*e.blockWidth,o=r*e.blockHeight;e.columns=n+e.blockWidth>e.width?e.width-n:e.blockWidth,e.lines=o+e.blockHeight>e.height?e.height-o:e.blockHeight;const a=e.columns*e.totalBytes,A=e.size<e.lines*a?e.uncompress(e):F(e);t.value+=e.size;for(let t=0;t<e.lines;t++){const i=t*e.columns*e.totalBytes;for(let r=0;r<e.inputChannels.length;r++){const a=ce.channels[r].name,l=e.channelByteOffsets[a]*e.columns,c=e.decodeChannels[a];if(void 0===c)continue;s.value=i+l;const h=(e.height-(1+o+t))*e.outLineWidth;for(let t=0;t<e.columns;t++){const i=h+(t+n)*e.outputChannels+c;e.byteArray[i]=e.getter(A,s)}}}}}function oe(){const e=this,t=e.offset,s={value:0};for(let i=0;i<e.height/e.blockHeight;i++){const r=q(e.viewer,t)-ce.dataWindow.yMin;e.size=H(e.viewer,t),e.lines=r+e.blockHeight>e.height?e.height-r:e.blockHeight;const n=e.columns*e.totalBytes,o=e.size<e.lines*n?e.uncompress(e):F(e);t.value+=e.size;for(let t=0;t<e.blockHeight;t++){const r=i*e.blockHeight,a=t+e.scanOrder(r);if(a>=e.height)continue;const A=t*n,l=(e.height-1-a)*e.outLineWidth;for(let t=0;t<e.inputChannels.length;t++){const i=ce.channels[t].name,r=e.channelByteOffsets[i]*e.columns,n=e.decodeChannels[i];if(void 0!==n){s.value=A+r;for(let t=0;t<e.columns;t++){const i=l+t*e.outputChannels+n;e.byteArray[i]=e.getter(o,s)}}}}}}const ae={value:0},Ae=new DataView(e),le=new Uint8Array(e),ce=function(e,t,s){const i={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");i.version=e.getUint8(4);const r=e.getUint8(5);i.spec={singleTile:!!(2&r),longName:!!(4&r),deepFormat:!!(8&r),multiPart:!!(16&r)},s.value=8;let n=!0;for(;n;){const r=O(t,s);if(0==r)n=!1;else{const n=se(e,t,s,O(t,s),H(e,s));void 0===n||(i[r]=n)}}if(-7&r)throw new Error("THREE.EXRLoader: Provided file is currently unsupported.");return i}(Ae,e,ae),he=function(e,t,s,i,r){const n={size:0,viewer:t,array:s,offset:i,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,inputChannels:e.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:$};switch(e.compression){case"NO_COMPRESSION":n.blockHeight=1,n.uncompress=F;break;case"RLE_COMPRESSION":n.blockHeight=1,n.uncompress=P;break;case"ZIPS_COMPRESSION":n.blockHeight=1,n.uncompress=U;break;case"ZIP_COMPRESSION":n.blockHeight=16,n.uncompress=U;break;case"PIZ_COMPRESSION":n.blockHeight=32,n.uncompress=k;break;case"PXR24_COMPRESSION":n.blockHeight=16,n.uncompress=G;break;case"DWAA_COMPRESSION":n.blockHeight=32,n.uncompress=N;break;case"DWAB_COMPRESSION":n.blockHeight=256,n.uncompress=N;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}const o={};for(const c of e.channels)switch(c.name){case"Y":case"R":case"G":case"B":case"A":o[c.name]=!0,n.type=c.pixelType}let a=!1;if(o.R&&o.G&&o.B)a=!o.A,n.outputChannels=4,n.decodeChannels={R:0,G:1,B:2,A:3};else{if(!o.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");n.outputChannels=1,n.decodeChannels={Y:0}}if(1==n.type)switch(r){case Y:n.getter=te;break;case V:n.getter=ee}else{if(2!=n.type)throw new Error("EXRLoader.parse: unsupported pixelType "+n.type+" for "+e.compression+".");switch(r){case Y:n.getter=j;break;case V:n.getter=X}}n.columns=n.width;const A=n.width*n.height*n.outputChannels;switch(r){case Y:n.byteArray=new Float32Array(A),a&&n.byteArray.fill(1,0,A);break;case V:n.byteArray=new Uint16Array(A),a&&n.byteArray.fill(15360,0,A)}let l=0;for(const c of e.channels)void 0!==n.decodeChannels[c.name]&&(n.channelByteOffsets[c.name]=l),l+=2*c.pixelType;if(n.totalBytes=l,n.outLineWidth=n.width*n.outputChannels,"INCREASING_Y"===e.lineOrder?n.scanOrder=e=>e:n.scanOrder=e=>n.height-1-e,4==n.outputChannels?(n.format=Q,n.colorSpace=$):(n.format=L,n.colorSpace=x),e.spec.singleTile){n.blockHeight=e.tiles.ySize,n.blockWidth=e.tiles.xSize;const s=ie(e.tiles,n.width,n.height),r=re(s,n.width,e.tiles.xSize,e.tiles.roundingMode),o=re(s,n.height,e.tiles.ySize,e.tiles.roundingMode);n.tileCount=r[0]*o[0];for(let e=0;e<s;e++)for(let s=0;s<o[e];s++)for(let n=0;n<r[e];n++)W(t,i);n.decode=ne.bind(n)}else{n.blockWidth=n.width;const e=Math.ceil(n.height/n.blockHeight);for(let s=0;s<e;s++)W(t,i);n.decode=oe.bind(n)}return n}(ce,Ae,le,ae,this.type);return he.decode(),{header:ce,width:he.width,height:he.height,data:he.byteArray,format:he.format,colorSpace:he.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,s,i){return super.load(e,(function(e,s){e.colorSpace=s.colorSpace,e.minFilter=w,e.magFilter=w,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,s)}),s,i)}};async function xi(e,{onLoad:t}){return new Promise(((s,i)=>{Qi.load(e,(i=>{K.add(e,i),t&&t(i),s(i)}),(()=>{}),i)}))}xi.loader={name:"exr",extensions:[".exr"],function:xi};let bi=new class extends z{constructor(e){super(e),this.type=V}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},s=function(e,t,s){t=t||1024;let i=e.pos,r=-1,n=0,o="",a=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));for(;0>(r=a.indexOf("\n"))&&n<t&&i<e.byteLength;)o+=a,n+=a.length,i+=128,a+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));return-1<r&&(e.pos+=n+r+1,o+a.slice(0,r))},i=function(e,t,s,i){const r=e[t+3],n=Math.pow(2,r-128)/255;s[i+0]=e[t+0]*n,s[i+1]=e[t+1]*n,s[i+2]=e[t+2]*n,s[i+3]=1},r=function(e,t,s,i){const r=e[t+3],n=Math.pow(2,r-128)/255;s[i+0]=J.toHalfFloat(Math.min(e[t+0]*n,65504)),s[i+1]=J.toHalfFloat(Math.min(e[t+1]*n,65504)),s[i+2]=J.toHalfFloat(Math.min(e[t+2]*n,65504)),s[i+3]=J.toHalfFloat(1)},n=new Uint8Array(e);n.pos=0;const o=function(e){const i=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*FORMAT=(\S+)\s*$/,o=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let A,l;for((e.pos>=e.byteLength||!(A=s(e)))&&t(1,"no header found"),(l=A.match(/^#\?(\S+)/))||t(3,"bad initial token"),a.valid|=1,a.programtype=l[1],a.string+=A+"\n";A=s(e),!1!==A;)if(a.string+=A+"\n","#"!==A.charAt(0)){if((l=A.match(i))&&(a.gamma=parseFloat(l[1])),(l=A.match(r))&&(a.exposure=parseFloat(l[1])),(l=A.match(n))&&(a.valid|=2,a.format=l[1]),(l=A.match(o))&&(a.valid|=4,a.height=parseInt(l[1],10),a.width=parseInt(l[2],10)),2&a.valid&&4&a.valid)break}else a.comments+=A+"\n";return 2&a.valid||t(3,"missing format specifier"),4&a.valid||t(3,"missing image size specifier"),a}(n),a=o.width,A=o.height,l=function(e,s,i){const r=s;if(r<8||r>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);r!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const n=new Uint8Array(4*s*i);n.length||t(4,"unable to allocate buffer space");let o=0,a=0;const A=4*r,l=new Uint8Array(4),c=new Uint8Array(A);let h=i;for(;h>0&&a<e.byteLength;){a+4>e.byteLength&&t(1),l[0]=e[a++],l[1]=e[a++],l[2]=e[a++],l[3]=e[a++],2==l[0]&&2==l[1]&&(l[2]<<8|l[3])==r||t(3,"bad rgbe scanline format");let s,i=0;for(;i<A&&a<e.byteLength;){s=e[a++];const r=s>128;if(r&&(s-=128),(0===s||i+s>A)&&t(3,"bad scanline data"),r){const t=e[a++];for(let e=0;e<s;e++)c[i++]=t}else c.set(e.subarray(a,a+s),i),i+=s,a+=s}const u=r;for(let e=0;e<u;e++){let t=0;n[o]=c[e+t],t+=r,n[o+1]=c[e+t],t+=r,n[o+2]=c[e+t],t+=r,n[o+3]=c[e+t],o+=4}h--}return n}(n.subarray(n.pos),a,A);let c,h,u;switch(this.type){case Y:u=l.length/4;const e=new Float32Array(4*u);for(let s=0;s<u;s++)i(l,4*s,e,4*s);c=e,h=Y;break;case V:u=l.length/4;const t=new Uint16Array(4*u);for(let s=0;s<u;s++)r(l,4*s,t,4*s);c=t,h=V;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:a,height:A,data:c,header:o.string,gamma:o.gamma,exposure:o.exposure,type:h}}setDataType(e){return this.type=e,this}load(e,t,s,i){return super.load(e,(function(e,s){switch(e.type){case Y:case V:e.colorSpace=$,e.minFilter=w,e.magFilter=w,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,s)}),s,i)}};async function Si(e,{onLoad:t}){return new Promise(((s,i)=>{bi.load(e,(i=>{K.add(e,i),t&&t(i),s(i)}),(()=>{}),i)}))}Si.loader={name:"hdr",extensions:[".hdr"],function:Si};class Ri{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const s=this.workersResolve[e];if(s&&s(t),this.queue.length){const{resolve:t,msg:s,transfer:i}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(s,i)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((s=>{const i=this._getIdleWorker();-1!==i?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=s,this.workers[i].postMessage(e,t)):this.queue.push({resolve:s,msg:e,transfer:t})}))}dispose(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const Di=9,Ti=15,Mi=16,_i=22,Fi=37,Pi=43,Ui=76,ki=83,Li=97,Gi=100,Ni=103,Oi=109,qi=165,Hi=166;class zi{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Vi{constructor(e,t,s,i){this._dataView=new DataView(e.buffer,e.byteOffset+t,s),this._littleEndian=i,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_skip(e){return this._offset+=e,this}_scan(e,t=0){const s=this._offset;let i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+s,i)}}const $i=[171,75,84,88,32,50,48,187,13,10,26,10];function Yi(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):Buffer.from(e).toString("utf8")}let Ji,Ki,Wi;const ji={env:{emscripten_notify_memory_growth:function(e){Wi=new Uint8Array(Ki.exports.memory.buffer)}}};class Xi{init(){return Ji||(Ji="undefined"!=typeof fetch?fetch("data:application/wasm;base64,"+Zi).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,ji))).then(this._init):WebAssembly.instantiate(Buffer.from(Zi,"base64"),ji).then(this._init),Ji)}_init(e){Ki=e.instance,ji.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Ki)throw new Error("ZSTDDecoder: Await .init() before decoding.");const s=e.byteLength,i=Ki.exports.malloc(s);Wi.set(e,i),t=t||Number(Ki.exports.ZSTD_findDecompressedSize(i,s));const r=Ki.exports.malloc(t),n=Ki.exports.ZSTD_decompress(r,t,i,s),o=Wi.slice(r,r+n);return Ki.exports.free(i),Ki.exports.free(r),o}}const Zi="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IAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQh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ASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigC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C0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdB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IAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY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wOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEE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",er=new WeakMap;let tr;class sr extends W{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new Ri,this.workerSourceURL="",this.workerConfig=null}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){const e=new j(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),s=new j(this.manager);s.setPath(this.transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const i=s.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,i]).then((([e,t])=>{const s=sr.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(sr.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(sr.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(sr.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=t,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))}))}return this.transcoderPending}load(e,t,s,i){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const r=new j(this.manager);r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{if(er.has(e)){return er.get(e).promise.then(t).catch(i)}this._createTexture(e).then((e=>t?t(e):null)).catch(i)}),s,i)}_createTextureFrom(e,t){const{faces:s,width:i,height:r,format:n,type:o,error:a,dfdFlags:A}=e;if("error"===o)return Promise.reject(a);let l;if(6===t.faceCount)l=new X(s,n,Z);else{const e=s[0].mipmaps;l=t.layerCount>1?new ee(e,i,r,t.layerCount,n,Z):new te(e,i,r,n,Z)}return l.minFilter=1===s[0].mipmaps.length?w:se,l.magFilter=w,l.generateMipmaps=!1,l.needsUpdate=!0,l.colorSpace=or(t),l.premultiplyAlpha=!!(1&A),l}async _createTexture(e,t={}){const s=function(e){const t=new Uint8Array(e.buffer,e.byteOffset,$i.length);if(t[0]!==$i[0]||t[1]!==$i[1]||t[2]!==$i[2]||t[3]!==$i[3]||t[4]!==$i[4]||t[5]!==$i[5]||t[6]!==$i[6]||t[7]!==$i[7]||t[8]!==$i[8]||t[9]!==$i[9]||t[10]!==$i[10]||t[11]!==$i[11])throw new Error("Missing KTX 2.0 identifier.");const s=new zi,i=17*Uint32Array.BYTES_PER_ELEMENT,r=new Vi(e,$i.length,i,!0);s.vkFormat=r._nextUint32(),s.typeSize=r._nextUint32(),s.pixelWidth=r._nextUint32(),s.pixelHeight=r._nextUint32(),s.pixelDepth=r._nextUint32(),s.layerCount=r._nextUint32(),s.faceCount=r._nextUint32();const n=r._nextUint32();s.supercompressionScheme=r._nextUint32();const o=r._nextUint32(),a=r._nextUint32(),A=r._nextUint32(),l=r._nextUint32(),c=r._nextUint64(),h=r._nextUint64(),u=new Vi(e,$i.length+i,3*n*8,!0);for(let _=0;_<n;_++)s.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+u._nextUint64(),u._nextUint64()),uncompressedByteLength:u._nextUint64()});const g=new Vi(e,o,a,!0),d={vendorId:g._skip(4)._nextUint16(),descriptorType:g._nextUint16(),versionNumber:g._nextUint16(),descriptorBlockSize:g._nextUint16(),colorModel:g._nextUint8(),colorPrimaries:g._nextUint8(),transferFunction:g._nextUint8(),flags:g._nextUint8(),texelBlockDimension:[g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8()],bytesPlane:[g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8()],samples:[]},p=(d.descriptorBlockSize/4-6)/4;for(let _=0;_<p;_++){const e={bitOffset:g._nextUint16(),bitLength:g._nextUint8(),channelType:g._nextUint8(),samplePosition:[g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8()],sampleLower:-Infinity,sampleUpper:Infinity};64&e.channelType?(e.sampleLower=g._nextInt32(),e.sampleUpper=g._nextInt32()):(e.sampleLower=g._nextUint32(),e.sampleUpper=g._nextUint32()),d.samples[_]=e}s.dataFormatDescriptor.length=0,s.dataFormatDescriptor.push(d);const f=new Vi(e,A,l,!0);for(;f._offset<l;){const e=f._nextUint32(),t=f._scan(e),i=Yi(t),r=f._scan(e-t.byteLength);s.keyValue[i]=i.match(/^ktx/i)?Yi(r):r,f._offset%4&&f._skip(4-f._offset%4)}if(h<=0)return s;const m=new Vi(e,c,h,!0),I=m._nextUint16(),C=m._nextUint16(),B=m._nextUint32(),v=m._nextUint32(),y=m._nextUint32(),E=m._nextUint32(),w=[];for(let _=0;_<n;_++)w.push({imageFlags:m._nextUint32(),rgbSliceByteOffset:m._nextUint32(),rgbSliceByteLength:m._nextUint32(),alphaSliceByteOffset:m._nextUint32(),alphaSliceByteLength:m._nextUint32()});const Q=c+m._offset,x=Q+B,b=x+v,S=b+y,R=new Uint8Array(e.buffer,e.byteOffset+Q,B),D=new Uint8Array(e.buffer,e.byteOffset+x,v),T=new Uint8Array(e.buffer,e.byteOffset+b,y),M=new Uint8Array(e.buffer,e.byteOffset+S,E);return s.globalData={endpointCount:I,selectorCount:C,imageDescs:w,endpointsData:R,selectorsData:D,tablesData:T,extendedData:M},s}(new Uint8Array(e));if(0!==s.vkFormat)return async function(e){const{vkFormat:t}=e;if(void 0===rr[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let s;2===e.supercompressionScheme&&(tr||(tr=new Promise((async e=>{const t=new Xi;await t.init(),e(t)}))),s=await tr);const i=[];for(let n=0;n<e.levels.length;n++){const r=Math.max(1,e.pixelWidth>>n),o=Math.max(1,e.pixelHeight>>n),a=e.pixelDepth?Math.max(1,e.pixelDepth>>n):0,A=e.levels[n];let l,c;if(0===e.supercompressionScheme)l=A.levelData;else{if(2!==e.supercompressionScheme)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");l=s.decode(A.levelData,A.uncompressedByteLength)}c=nr[t]===Y?new Float32Array(l.buffer,l.byteOffset,l.byteLength/Float32Array.BYTES_PER_ELEMENT):nr[t]===V?new Uint16Array(l.buffer,l.byteOffset,l.byteLength/Uint16Array.BYTES_PER_ELEMENT):l,i.push({data:c,width:r,height:o,depth:a})}let r;if(ir.has(rr[t]))r=0===e.pixelDepth?new ue(i[0].data,e.pixelWidth,e.pixelHeight):new ge(i[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");r=new te(i,e.pixelWidth,e.pixelHeight)}return r.mipmaps=i,r.type=nr[t],r.format=rr[t],r.colorSpace=or(e),r.needsUpdate=!0,Promise.resolve(r)}(s);const i=t,r=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:i},[e]))).then((e=>this._createTextureFrom(e.data,s)));return er.set(e,{promise:r}),r}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}sr.BasisFormat={ETC1S:0,UASTC_4x4:1},sr.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},sr.EngineFormat={RGBAFormat:Q,RGBA_ASTC_4x4_Format:ie,RGBA_BPTC_Format:re,RGBA_ETC2_EAC_Format:ne,RGBA_PVRTC_4BPPV1_Format:oe,RGBA_S3TC_DXT5_Format:ae,RGB_ETC1_Format:Ae,RGB_ETC2_Format:le,RGB_PVRTC_4BPPV1_Format:ce,RGBA_S3TC_DXT1_Format:he},sr.BasisWorker=function(){let e,t,s;const i=_EngineFormat,r=_TranscoderFormat,n=_BasisFormat;self.addEventListener("message",(function(o){const h=o.data;switch(h.type){case"init":e=h.config,u=h.transcoderBinary,t=new Promise((e=>{s={wasmBinary:u,onRuntimeInitialized:e},BASIS(s)})).then((()=>{s.initializeBasis(),s.KTX2File}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:o,width:u,height:g,hasAlpha:d,format:p,dfdFlags:f}=function(t){const o=new s.KTX2File(new Uint8Array(t));function h(){o.close(),o.delete()}if(!o.isValid())throw h(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");const u=o.isUASTC()?n.UASTC_4x4:n.ETC1S,g=o.getWidth(),d=o.getHeight(),p=o.getLayers()||1,f=o.getLevels(),m=o.getFaces(),I=o.getHasAlpha(),C=o.getDFDFlags(),{transcoderFormat:B,engineFormat:v}=function(t,s,o,c){let h,u;const g=t===n.ETC1S?a:A;for(let i=0;i<g.length;i++){const r=g[i];if(e[r.if]&&(r.basisFormat.includes(t)&&!(c&&r.transcoderFormat.length<2)&&(!r.needsPowerOfTwo||l(s)&&l(o))))return h=r.transcoderFormat[c?1:0],u=r.engineFormat[c?1:0],{transcoderFormat:h,engineFormat:u}}return h=r.RGBA32,u=i.RGBAFormat,{transcoderFormat:h,engineFormat:u}}(u,g,d,I);if(!g||!d||!f)throw h(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!o.startTranscoding())throw h(),new Error("THREE.KTX2Loader: .startTranscoding failed");const y=[],E=[];for(let e=0;e<m;e++){const t=[];for(let s=0;s<f;s++){const i=[];let r,n;for(let t=0;t<p;t++){const a=o.getImageLevelInfo(s,t,e);0===e&&0===s&&0===t&&(a.origWidth%4!=0||a.origHeight),f>1?(r=a.origWidth,n=a.origHeight):(r=a.width,n=a.height);const A=new Uint8Array(o.getImageTranscodedSizeInBytes(s,t,0,B));if(!o.transcodeImage(A,s,t,e,B,0,-1,-1))throw h(),new Error("THREE.KTX2Loader: .transcodeImage failed.");i.push(A)}const a=c(i);t.push({data:a,width:r,height:n}),E.push(a.buffer)}y.push({mipmaps:t,width:g,height:d,format:v})}return h(),{faces:y,buffers:E,width:g,height:d,hasAlpha:I,format:v,dfdFlags:C}}(h.buffer);self.postMessage({type:"transcode",id:h.id,faces:t,width:u,height:g,hasAlpha:d,format:p,dfdFlags:f},o)}catch(t){self.postMessage({type:"error",id:h.id,error:t.message})}}))}var u}));const o=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[r.ASTC_4x4,r.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:Infinity,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[r.BC7_M5,r.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[r.BC1,r.BC3],engineFormat:[i.RGBA_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[r.ETC1,r.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[r.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[r.PVRTC1_4_RGB,r.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=o.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),A=o.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function l(e){return e<=2||!(e&e-1)&&0!==e}function c(e){if(1===e.length)return e[0];let t=0;for(let r=0;r<e.length;r++){t+=e[r].byteLength}const s=new Uint8Array(t);let i=0;for(let r=0;r<e.length;r++){const t=e[r];s.set(t,i),i+=t.byteLength}return s}};const ir=new Set([Q,fe,L]),rr={[Oi]:Q,[Li]:Q,[Fi]:Q,[Pi]:Q,[Ni]:fe,[ki]:fe,[Mi]:fe,[_i]:fe,[Gi]:L,[Ui]:L,[Ti]:L,[Di]:L,[Hi]:me,[qi]:me},nr={[Oi]:Y,[Li]:V,[Fi]:Z,[Pi]:Z,[Ni]:Y,[ki]:V,[Mi]:Z,[_i]:Z,[Gi]:Y,[Ui]:V,[Ti]:Z,[Di]:Z,[Hi]:Z,[qi]:Z};function or(e){const t=e.dataFormatDescriptor[0];return 1===t.colorPrimaries?2===t.transferFunction?S:$:10===t.colorPrimaries?2===t.transferFunction?de:pe:(t.colorPrimaries,x)}let ar;function Ar(){if(ar)return ar;ar=new sr;const e=Ie("vendors/basis/");return ar.setTranscoderPath(e),ar}async function lr(e,t={}){return new Promise(((s,i)=>{Ar().load(e,(i=>{K.add(e,i),t.onLoad&&t.onLoad(i),s(i)}),(()=>{}),i)}))}lr.detectSupport=e=>Ar().detectSupport(e),lr.loader={name:"ktx2",extensions:[".ktx2",".basis"],function:lr};const cr=new WeakMap;class hr extends W{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,i){const r=new j(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{this.parse(e,t,i)}),s,i)}parse(e,t,s=()=>{}){this.decodeDracoFile(e,t,null,null,S,s).catch(s)}decodeDracoFile(e,t,s,i,r=$,n=()=>{}){const o={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:r};return this.decodeGeometry(e,o).then(t).catch(n)}decodeGeometry(e,t){const s=JSON.stringify(t);if(cr.has(e)){const t=cr.get(e);if(t.key===s)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const r=this.workerNextTaskID++,n=e.byteLength,o=this._getWorker(r,n).then((s=>(i=s,new Promise(((s,n)=>{i._callbacks[r]={resolve:s,reject:n},i.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return o.catch((()=>!0)).then((()=>{i&&r&&this._releaseTask(i,r)})),cr.set(e,{key:s,promise:o}),o}_createGeometry(e){const t=new R;e.index&&t.setIndex(new D(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s],r=i.name,n=i.array,o=i.itemSize,a=new D(n,o);"color"===r&&(this._assignVertexColorSpace(a,i.vertexColorSpace),a.normalized=n instanceof Float32Array==!1),t.setAttribute(r,a)}return t}_assignVertexColorSpace(e,t){if(t!==S)return;const s=new c;for(let i=0,r=e.count;i<r;i++)s.fromBufferAttribute(e,i).convertSRGBToLinear(),e.setXYZ(i,s.r,s.g,s.b)}_loadLibrary(e,t){const s=new j(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise(((t,i)=>{s.load(e,t,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const s=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const i=ur.toString(),r=["/* draco decoder */",s,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const s=t.data;switch(s.type){case"decode":e._callbacks[s.id].resolve(s);break;case"error":e._callbacks[s.id].reject(s)}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function ur(){let e,t;function s(e,t,s,i,r,n){const o=n.num_components(),a=s.num_points()*o,A=a*r.BYTES_PER_ELEMENT,l=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,r),c=e._malloc(A);t.GetAttributeDataArrayForAllPoints(s,n,l,A,c);const h=new r(e.HEAPF32.buffer,c,a).slice();return e._free(c),{name:i,array:h,itemSize:o}}onmessage=function(i){const r=i.data;switch(r.type){case"init":e=r.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const i=r.buffer,n=r.taskConfig;t.then((e=>{const t=e.draco,o=new t.Decoder;try{const e=function(e,t,i,r){const n=r.attributeIDs,o=r.attributeTypes;let a,A;const l=t.GetEncodedGeometryType(i);if(l===e.TRIANGULAR_MESH)a=new e.Mesh,A=t.DecodeArrayToMesh(i,i.byteLength,a);else{if(l!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new e.PointCloud,A=t.DecodeArrayToPointCloud(i,i.byteLength,a)}if(!A.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+A.error_msg());const c={index:null,attributes:[]};for(const h in n){const i=self[o[h]];let A,l;if(r.useUniqueIDs)l=n[h],A=t.GetAttributeByUniqueId(a,l);else{if(l=t.GetAttributeId(a,e[n[h]]),-1===l)continue;A=t.GetAttribute(a,l)}const u=s(e,t,a,h,i,A);"color"===h&&(u.vertexColorSpace=r.vertexColorSpace),c.attributes.push(u)}l===e.TRIANGULAR_MESH&&(c.index=function(e,t,s){const i=s.num_faces(),r=3*i,n=4*r,o=e._malloc(n);t.GetTrianglesUInt32Array(s,n,o);const a=new Uint32Array(e.HEAPF32.buffer,o,r).slice();return e._free(o),{array:a,itemSize:1}}(e,t,a));return e.destroy(a),c}(t,o,new Int8Array(i),n),a=e.attributes.map((e=>e.array.buffer));e.index&&a.push(e.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:e},a)}catch(a){self.postMessage({type:"error",id:r.id,error:a.message})}finally{t.destroy(o)}}))}}}function gr(e,t){if(t===Ce)return e;if(t===Be||t===ve){let s=e.getIndex();if(null===s){const t=[],i=e.getAttribute("position");if(void 0===i)return e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,r=[];if(t===Be)for(let e=1;e<=i;e++)r.push(s.getX(0)),r.push(s.getX(e)),r.push(s.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(s.getX(e)),r.push(s.getX(e+1)),r.push(s.getX(e+2))):(r.push(s.getX(e+2)),r.push(s.getX(e+1)),r.push(s.getX(e)));r.length;const n=e.clone();return n.setIndex(r),n.clearGroups(),n}return e}function dr(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const pr={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class fr{constructor(e){this.parser=e,this.name=pr.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const r=t.json,n=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let o;const a=new c(16777215);void 0!==n.color&&a.setRGB(n.color[0],n.color[1],n.color[2],$);const A=void 0!==n.range?n.range:0;switch(n.type){case"directional":o=new Qe(a),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new we(a),o.distance=A;break;case"spot":o=new Ee(a),o.distance=A,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,o.angle=n.spot.outerConeAngle,o.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+n.type)}return o.position.set(0,0,0),o.decay=2,sn(o,n),void 0!==n.intensity&&(o.intensity=n.intensity),o.name=t.createUniqueName(n.name||"light_"+e),i=Promise.resolve(o),t.cache.add(s,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return s._getNodeRef(t.cache,r,e)}))}}class mr{constructor(){this.name=pr.KHR_MATERIALS_UNLIT}getMaterialType(){return xe}extendParams(e,t,s){const i=[];e.color=new c(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],$),e.opacity=t[3]}void 0!==r.baseColorTexture&&i.push(s.assignTexture(e,"map",r.baseColorTexture,S))}return Promise.all(i)}}class Ir{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class Cr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];if(void 0!==n.clearcoatFactor&&(t.clearcoat=n.clearcoatFactor),void 0!==n.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),void 0!==n.clearcoatRoughnessFactor&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),void 0!==n.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),void 0!==n.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),void 0!==n.clearcoatNormalTexture.scale)){const e=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new u(e,e)}return Promise.all(r)}}class Br{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}}class vr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.iridescenceFactor&&(t.iridescence=n.iridescenceFactor),void 0!==n.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),void 0!==n.iridescenceIor&&(t.iridescenceIOR=n.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==n.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),void 0!==n.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),void 0!==n.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(r)}}class yr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new c(0,0,0),t.sheenRoughness=0,t.sheen=1;const n=i.extensions[this.name];if(void 0!==n.sheenColorFactor){const e=n.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],$)}return void 0!==n.sheenRoughnessFactor&&(t.sheenRoughness=n.sheenRoughnessFactor),void 0!==n.sheenColorTexture&&r.push(s.assignTexture(t,"sheenColorMap",n.sheenColorTexture,S)),void 0!==n.sheenRoughnessTexture&&r.push(s.assignTexture(t,"sheenRoughnessMap",n.sheenRoughnessTexture)),Promise.all(r)}}class Er{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.transmissionFactor&&(t.transmission=n.transmissionFactor),void 0!==n.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(r)}}class wr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];t.thickness=void 0!==n.thicknessFactor?n.thicknessFactor:0,void 0!==n.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",n.thicknessTexture)),t.attenuationDistance=n.attenuationDistance||Infinity;const o=n.attenuationColor||[1,1,1];return t.attenuationColor=(new c).setRGB(o[0],o[1],o[2],$),Promise.all(r)}}class Qr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class xr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];t.specularIntensity=void 0!==n.specularFactor?n.specularFactor:1,void 0!==n.specularTexture&&r.push(s.assignTexture(t,"specularIntensityMap",n.specularTexture));const o=n.specularColorFactor||[1,1,1];return t.specularColor=(new c).setRGB(o[0],o[1],o[2],$),void 0!==n.specularColorTexture&&r.push(s.assignTexture(t,"specularColorMap",n.specularColorTexture,S)),Promise.all(r)}}class br{constructor(e){this.parser=e,this.name=pr.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return t.bumpScale=void 0!==n.bumpFactor?n.bumpFactor:1,void 0!==n.bumpTexture&&r.push(s.assignTexture(t,"bumpMap",n.bumpTexture)),Promise.all(r)}}class Sr{constructor(e){this.parser=e,this.name=pr.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?be:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.anisotropyStrength&&(t.anisotropy=n.anisotropyStrength),void 0!==n.anisotropyRotation&&(t.anisotropyRotation=n.anisotropyRotation),void 0!==n.anisotropyTexture&&r.push(s.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(r)}}class Rr{constructor(e){this.parser=e,this.name=pr.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,n)}}class Dr{constructor(e){this.parser=e,this.name=pr.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const n=r.extensions[t],o=i.images[n.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then((function(r){if(r)return s.loadTextureImage(e,n.source,a);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Tr{constructor(e){this.parser=e,this.name=pr.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const n=r.extensions[t],o=i.images[n.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then((function(r){if(r)return s.loadTextureImage(e,n.source,a);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Mr{constructor(e){this.name=pr.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const s=e.byteOffset||0,i=e.byteLength||0,n=e.count,o=e.byteStride,a=new Uint8Array(t,s,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(n,o,a,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(n*o);return r.decodeGltfBuffer(new Uint8Array(t),n,o,a,e.mode,e.filter),t}))}))}return null}}class _r{constructor(e){this.name=pr.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const i=t.meshes[s.mesh];for(const a of i.primitives)if(a.mode!==zr.TRIANGLES&&a.mode!==zr.TRIANGLE_STRIP&&a.mode!==zr.TRIANGLE_FAN&&void 0!==a.mode)return null;const r=s.extensions[this.name].attributes,n=[],o={};for(const a in r)n.push(this.parser.getDependency("accessor",r[a]).then((e=>(o[a]=e,o[a]))));return n.length<1?null:(n.push(this.parser.createNodeMesh(e)),Promise.all(n).then((e=>{const t=e.pop(),s=t.isGroup?t.children:[t],i=e[0].count,r=[];for(const n of s){const e=new Se,t=new Re,s=new st,a=new Re(1,1,1),A=new De(n.geometry,n.material,i);for(let r=0;r<i;r++)o.TRANSLATION&&t.fromBufferAttribute(o.TRANSLATION,r),o.ROTATION&&s.fromBufferAttribute(o.ROTATION,r),o.SCALE&&a.fromBufferAttribute(o.SCALE,r),A.setMatrixAt(r,e.compose(t,s,a));for(const i in o)if("_COLOR_0"===i){const e=o[i];A.instanceColor=new Te(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==i&&"ROTATION"!==i&&"SCALE"!==i&&n.geometry.setAttribute(i,o[i]);Me.prototype.copy.call(A,n),this.parser.assignFinalMaterial(A),r.push(A)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]})))}}const Fr="glTF",Pr=1313821514,Ur=5130562;class kr{constructor(e){this.name=pr.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Fr)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,r=new DataView(e,12);let n=0;for(;n<i;){const t=r.getUint32(n,!0);n+=4;const i=r.getUint32(n,!0);if(n+=4,i===Pr){const i=new Uint8Array(e,12+n,t);this.content=s.decode(i)}else if(i===Ur){const s=12+n;this.body=e.slice(s,s+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Lr{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=pr.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,o={},a={},A={};for(const l in n){const e=Kr[l]||l.toLowerCase();o[e]=n[l]}for(const l in e.attributes){const t=Kr[l]||l.toLowerCase();if(void 0!==n[l]){const i=s.accessors[e.attributes[l]],r=Vr[i.componentType];A[t]=r.name,a[t]=!0===i.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t,s){i.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],i=a[t];void 0!==i&&(s.normalized=i)}t(e)}),o,A,$,s)}))}))}}class Gr{constructor(){this.name=pr.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Nr{constructor(){this.name=pr.KHR_MESH_QUANTIZATION}}class Or extends ft{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let n=0;n!==i;n++)t[n]=s[r+n];return t}interpolate_(e,t,s,i){const r=this.resultBuffer,n=this.sampleValues,o=this.valueSize,a=2*o,A=3*o,l=i-t,c=(s-t)/l,h=c*c,u=h*c,g=e*A,d=g-A,p=-2*u+3*h,f=u-h,m=1-p,I=f-h+c;for(let C=0;C!==o;C++){const e=n[d+C+o],t=n[d+C+a]*l,s=n[g+C+o],i=n[g+C]*l;r[C]=m*e+I*t+p*s+f*i}return r}}const qr=new st;class Hr extends Or{interpolate_(e,t,s,i){const r=super.interpolate_(e,t,s,i);return qr.fromArray(r).normalize().toArray(r),r}}const zr={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Vr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},$r={9728:O,9729:w,9984:it,9985:rt,9986:nt,9987:se},Yr={33071:ot,33648:at,10497:q},Jr={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Kr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Wr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},jr={CUBICSPLINE:void 0,LINEAR:et,STEP:At},Xr="OPAQUE",Zr="MASK",en="BLEND";function tn(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function sn(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function rn(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,i=t.weights.length;s<i;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,i=s.length;t<i;t++)e.morphTargetDictionary[s[t]]=t}}}function nn(e){let t;const s=e.extensions&&e.extensions[pr.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+on(s.attributes):e.indices+":"+on(e.attributes)+":"+e.mode,void 0!==e.targets)for(let i=0,r=e.targets.length;i<r;i++)t+=":"+on(e.targets[i]);return t}function on(e){let t="";const s=Object.keys(e).sort();for(let i=0,r=s.length;i<r;i++)t+=s[i]+":"+e[s[i]]+";";return t}function an(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const An=new Se;class ln{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new dr,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=!1,r=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=navigator.userAgent.indexOf("Firefox")>-1,r=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||i&&r<98?this.textureLoader=new _e(this.options.manager):this.textureLoader=new Fe(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new j(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const n={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};return tn(r,n,i),sn(n,i),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(n)}))).then((function(){for(const e of n.scenes)e.updateMatrixWorld();e(n)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,r=t.length;i<r;i++){const s=t[i].joints;for(let t=0,i=s.length;t<i;t++)e[s[t]].isBone=!0}for(let i=0,r=e.length;i<r;i++){const t=e[i];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),r=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[i,n]of e.children.entries())r(n,t.children[i])};return r(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return s.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[pr.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(e,r){s.load(ye.resolveURL(t.uri,i.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+s)}))}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=Jr[i.type],t=Vr[i.componentType],s=!0===i.normalized,r=new t(i.count*e);return Promise.resolve(new D(r,e,s))}const r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],n=Jr[i.type],o=Vr[i.componentType],a=o.BYTES_PER_ELEMENT,A=a*n,l=i.byteOffset||0,c=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,h=!0===i.normalized;let u,g;if(c&&c!==A){const e=Math.floor(l/c),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let A=t.cache.get(s);A||(u=new o(r,e*c,i.count*c/a),A=new Pe(u,c/a),t.cache.add(s,A)),g=new ct(A,n,l%c/a,h)}else u=null===r?new o(i.count*n):new o(r,l,i.count*n),g=new D(u,n,h);if(void 0!==i.sparse){const t=Jr.SCALAR,s=Vr[i.sparse.indices.componentType],a=i.sparse.indices.byteOffset||0,A=i.sparse.values.byteOffset||0,l=new s(e[1],a,i.sparse.count*t),c=new o(e[2],A,i.sparse.count*n);null!==r&&(g=new D(g.array.slice(),g.itemSize,g.normalized));for(let e=0,i=l.length;e<i;e++){const t=l[e];if(g.setX(t,c[e*n]),n>=2&&g.setY(t,c[e*n+1]),n>=3&&g.setZ(t,c[e*n+2]),n>=4&&g.setW(t,c[e*n+3]),n>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return g}))}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,r=t.images[i];let n=this.textureLoader;if(r.uri){const e=s.manager.getHandler(r.uri);null!==e&&(n=e)}return this.loadTextureImage(e,i,n)}loadTextureImage(e,t,s){const i=this,r=this.json,n=r.textures[e],o=r.images[t],a=(o.uri||o.bufferView)+":"+n.sampler;if(this.textureCache[a])return this.textureCache[a];const A=this.loadImageSource(t,s).then((function(t){t.flipY=!1,t.name=n.name||o.name||"",""===t.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(t.name=o.uri);const s=(r.samplers||{})[n.sampler]||{};return t.magFilter=$r[s.magFilter]||w,t.minFilter=$r[s.minFilter]||se,t.wrapS=Yr[s.wrapS]||q,t.wrapT=Yr[s.wrapT]||q,i.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=A,A}loadImageSource(e,t){const s=this,i=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const n=i.images[e],o=self.URL||self.webkitURL;let a=n.uri||"",A=!1;if(void 0!==n.bufferView)a=s.getDependency("bufferView",n.bufferView).then((function(e){A=!0;const t=new Blob([e],{type:n.mimeType});return a=o.createObjectURL(t),a}));else if(void 0===n.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then((function(e){return new Promise((function(s,i){let n=s;!0===t.isImageBitmapLoader&&(n=function(e){const t=new k(e);t.needsUpdate=!0,s(t)}),t.load(ye.resolveURL(e,r.path),n,void 0,i)}))})).then((function(e){var t;return!0===A&&o.revokeObjectURL(a),sn(e,n),e.userData.mimeType=n.mimeType||((t=n.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw e}));return this.sourceCache[e]=l,l}assignTexture(e,t,s,i){const r=this;return this.getDependency("texture",s.index).then((function(n){if(!n)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((n=n.clone()).channel=s.texCoord),r.extensions[pr.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[pr.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(n);n=r.extensions[pr.KHR_TEXTURE_TRANSFORM].extendTexture(n,e),r.associations.set(n,t)}}return void 0!==i&&(n.colorSpace=i),e[t]=n,n}))}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Ue,ke.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Le,ke.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(i||r||n){let e="ClonedMaterial:"+s.uuid+":";i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),n&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.vertexColors=!0),n&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return Ge}loadMaterial(e){const t=this,s=this.json,i=this.extensions,r=s.materials[e];let n;const o={},a=[];if((r.extensions||{})[pr.KHR_MATERIALS_UNLIT]){const e=i[pr.KHR_MATERIALS_UNLIT];n=e.getMaterialType(),a.push(e.extendParams(o,r,t))}else{const s=r.pbrMetallicRoughness||{};if(o.color=new c(1,1,1),o.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],$),o.opacity=e[3]}void 0!==s.baseColorTexture&&a.push(t.assignTexture(o,"map",s.baseColorTexture,S)),o.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,o.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(a.push(t.assignTexture(o,"metalnessMap",s.metallicRoughnessTexture)),a.push(t.assignTexture(o,"roughnessMap",s.metallicRoughnessTexture))),n=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),a.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===r.doubleSided&&(o.side=Ne);const A=r.alphaMode||Xr;if(A===en?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,A===Zr&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&n!==xe&&(a.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new u(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&n!==xe&&(a.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&n!==xe){const e=r.emissiveFactor;o.emissive=(new c).setRGB(e[0],e[1],e[2],$)}return void 0!==r.emissiveTexture&&n!==xe&&a.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,S)),Promise.all(a).then((function(){const s=new n(o);return r.name&&(s.name=r.name),sn(s,r),t.associations.set(s,{materials:e}),r.extensions&&tn(i,s,r),s}))}createUniqueName(e){const t=Oe.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function r(e){return s[pr.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return cn(s,e,t)}))}const n=[];for(let o=0,a=e.length;o<a;o++){const s=e[o],a=nn(s),A=i[a];if(A)n.push(A.promise);else{let e;e=s.extensions&&s.extensions[pr.KHR_DRACO_MESH_COMPRESSION]?r(s):cn(new R,s,t),i[a]={primitive:s,promise:e},n.push(e)}}return Promise.all(n)}loadMesh(e){const t=this,s=this.json,i=this.extensions,r=s.meshes[e],n=r.primitives,o=[];for(let A=0,l=n.length;A<l;A++){const e=void 0===n[A].material?(void 0===(a=this.cache).DefaultMaterial&&(a.DefaultMaterial=new Ge({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:lt})),a.DefaultMaterial):this.getDependency("material",n[A].material);o.push(e)}var a;return o.push(t.loadGeometries(n)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),a=s[s.length-1],A=[];for(let c=0,h=a.length;c<h;c++){const s=a[c],l=n[c];let h;const u=o[c];if(l.mode===zr.TRIANGLES||l.mode===zr.TRIANGLE_STRIP||l.mode===zr.TRIANGLE_FAN||void 0===l.mode)h=!0===r.isSkinnedMesh?new qe(s,u):new M(s,u),!0===h.isSkinnedMesh&&h.normalizeSkinWeights(),l.mode===zr.TRIANGLE_STRIP?h.geometry=gr(h.geometry,ve):l.mode===zr.TRIANGLE_FAN&&(h.geometry=gr(h.geometry,Be));else if(l.mode===zr.LINES)h=new He(s,u);else if(l.mode===zr.LINE_STRIP)h=new ze(s,u);else if(l.mode===zr.LINE_LOOP)h=new Ve(s,u);else{if(l.mode!==zr.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);h=new $e(s,u)}Object.keys(h.geometry.morphAttributes).length>0&&rn(h,r),h.name=t.createUniqueName(r.name||"mesh_"+e),sn(h,r),l.extensions&&tn(i,h,l),t.assignFinalMaterial(h),A.push(h)}for(let i=0,r=A.length;i<r;i++)t.associations.set(A[i],{meshes:e,primitives:i});if(1===A.length)return r.extensions&&tn(i,A[0],r),A[0];const l=new Ye;r.extensions&&tn(i,l,r),t.associations.set(l,{meshes:e});for(let e=0,t=A.length;e<t;e++)l.add(A[e]);return l}))}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(i)return"perspective"===s.type?t=new Je(Ke.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===s.type&&(t=new We(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),sn(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,r=t.joints.length;i<r;i++)s.push(this._loadNodeShallow(t.joints[i]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then((function(e){const t=e.pop(),s=e,i=[],r=[];for(let n=0,o=s.length;n<o;n++){const e=s[n];if(e){i.push(e);const s=new Se;null!==t&&s.fromArray(t.array,16*n),r.push(s)}}return new je(i,r)}))}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,n=[],o=[],a=[],A=[],l=[];for(let c=0,h=i.channels.length;c<h;c++){const e=i.channels[c],t=i.samplers[e.sampler],s=e.target,r=s.node,h=void 0!==i.parameters?i.parameters[t.input]:t.input,u=void 0!==i.parameters?i.parameters[t.output]:t.output;void 0!==s.node&&(n.push(this.getDependency("node",r)),o.push(this.getDependency("accessor",h)),a.push(this.getDependency("accessor",u)),A.push(t),l.push(s))}return Promise.all([Promise.all(n),Promise.all(o),Promise.all(a),Promise.all(A),Promise.all(l)]).then((function(e){const t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],A=[];for(let r=0,l=t.length;r<l;r++){const e=t[r],l=i[r],c=n[r],h=o[r],u=a[r];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const g=s._createAnimationTracks(e,l,c,h,u);if(g)for(let t=0;t<g.length;t++)A.push(g[t])}return new Xe(r,void 0,A)}))}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,s=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],n=s.children||[];for(let a=0,A=n.length;a<A;a++)r.push(t.getDependency("node",n[a]));const o=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([i,Promise.all(r),o]).then((function(e){const t=e[0],s=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,An)}));for(let r=0,n=s.length;r<n;r++)t.add(s[r]);return t}))}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],n=r.name?i.createUniqueName(r.name):"",o=[],a=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return a&&o.push(a),void 0!==r.camera&&o.push(i.getDependency("camera",r.camera).then((function(e){return i._getNodeRef(i.cameraCache,r.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){o.push(e)})),this.nodeCache[e]=Promise.all(o).then((function(t){let o;if(o=!0===r.isBone?new Ze:t.length>1?new Ye:1===t.length?t[0]:new Me,o!==t[0])for(let e=0,s=t.length;e<s;e++)o.add(t[e]);if(r.name&&(o.userData.name=r.name,o.name=n),sn(o,r),r.extensions&&tn(s,o,r),void 0!==r.matrix){const e=new Se;e.fromArray(r.matrix),o.applyMatrix4(e)}else void 0!==r.translation&&o.position.fromArray(r.translation),void 0!==r.rotation&&o.quaternion.fromArray(r.rotation),void 0!==r.scale&&o.scale.fromArray(r.scale);return i.associations.has(o)||i.associations.set(o,{}),i.associations.get(o).nodes=e,o})),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,r=new Ye;s.name&&(r.name=i.createUniqueName(s.name)),sn(r,s),s.extensions&&tn(t,r,s);const n=s.nodes||[],o=[];for(let a=0,A=n.length;a<A;a++)o.push(i.getDependency("node",n[a]));return Promise.all(o).then((function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return i.associations=(e=>{const t=new Map;for(const[s,r]of i.associations)(s instanceof ke||s instanceof k)&&t.set(s,r);return e.traverse((e=>{const s=i.associations.get(e);null!=s&&t.set(e,s)})),t})(r),r}))}_createAnimationTracks(e,t,s,i,r){const n=[],o=e.name?e.name:e.uuid,a=[];let A;switch(Wr[r.path]===Wr.weights?e.traverse((function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)})):a.push(o),Wr[r.path]){case Wr.weights:A=ut;break;case Wr.rotation:A=gt;break;case Wr.position:case Wr.scale:A=ht;break;default:if(1===s.itemSize)A=ut;else A=ht}const l=void 0!==i.interpolation?jr[i.interpolation]:et,c=this._getArrayFromAccessor(s);for(let h=0,u=a.length;h<u;h++){const e=new A(a[h]+"."+Wr[r.path],t.array,c,l);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(e),n.push(e)}return n}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=an(t.constructor),s=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)s[i]=t[i]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof gt?Hr:Or)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function cn(e,t,s){const i=t.attributes,r=[];function n(t,i){return s.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const o in i){const t=Kr[o]||o.toLowerCase();t in e.attributes||r.push(n(i[o],t))}if(void 0!==t.indices&&!e.index){const i=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(i)}return tt.workingColorSpace,sn(e,t),function(e,t,s){const i=t.attributes,r=new dt;if(void 0===i.POSITION)return;{const e=s.json.accessors[i.POSITION],t=e.min,n=e.max;if(void 0===t||void 0===n)return;if(r.set(new Re(t[0],t[1],t[2]),new Re(n[0],n[1],n[2])),e.normalized){const t=an(Vr[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const n=t.targets;if(void 0!==n){const e=new Re,t=new Re;for(let i=0,r=n.length;i<r;i++){const r=n[i];if(void 0!==r.POSITION){const i=s.json.accessors[r.POSITION],n=i.min,o=i.max;if(void 0!==n&&void 0!==o){if(t.setX(Math.max(Math.abs(n[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(n[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(n[2]),Math.abs(o[2]))),i.normalized){const e=an(Vr[i.componentType]);t.multiplyScalar(e)}e.max(t)}}}r.expandByVector(e)}e.boundingBox=r;const o=new pt;r.getCenter(o.center),o.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=o}(e,t,s),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,s){let i=!1,r=!1,n=!1;for(let l=0,c=t.length;l<c;l++){const e=t[l];if(void 0!==e.POSITION&&(i=!0),void 0!==e.NORMAL&&(r=!0),void 0!==e.COLOR_0&&(n=!0),i&&r&&n)break}if(!i&&!r&&!n)return Promise.resolve(e);const o=[],a=[],A=[];for(let l=0,c=t.length;l<c;l++){const c=t[l];if(i){const t=void 0!==c.POSITION?s.getDependency("accessor",c.POSITION):e.attributes.position;o.push(t)}if(r){const t=void 0!==c.NORMAL?s.getDependency("accessor",c.NORMAL):e.attributes.normal;a.push(t)}if(n){const t=void 0!==c.COLOR_0?s.getDependency("accessor",c.COLOR_0):e.attributes.color;A.push(t)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(A)]).then((function(t){const s=t[0],o=t[1],a=t[2];return i&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=o),n&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e}))}const hn=new class extends W{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Cr(e)})),this.register((function(e){return new Br(e)})),this.register((function(e){return new Rr(e)})),this.register((function(e){return new Dr(e)})),this.register((function(e){return new Tr(e)})),this.register((function(e){return new yr(e)})),this.register((function(e){return new Er(e)})),this.register((function(e){return new wr(e)})),this.register((function(e){return new Qr(e)})),this.register((function(e){return new Ir(e)})),this.register((function(e){return new xr(e)})),this.register((function(e){return new vr(e)})),this.register((function(e){return new Sr(e)})),this.register((function(e){return new br(e)})),this.register((function(e){return new fr(e)})),this.register((function(e){return new Mr(e)})),this.register((function(e){return new _r(e)}))}load(e,t,s,i){const r=this;let n;if(""!==this.resourcePath)n=this.resourcePath;else if(""!==this.path){const t=ye.extractUrlBase(e);n=ye.resolveURL(t,this.path)}else n=ye.extractUrlBase(e);this.manager.itemStart(e);const o=function(t){i&&i(t),r.manager.itemError(e),r.manager.itemEnd(e)},a=new j(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(s){try{r.parse(s,n,(function(s){t(s),r.manager.itemEnd(e)}),o)}catch(ru){o(ru)}}),s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let r;const n={},o={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Fr){try{n[pr.KHR_BINARY_GLTF]=new kr(e)}catch(l){return void(i&&i(l))}r=JSON.parse(n[pr.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const A=new ln(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});A.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const e=this.pluginCallbacks[c](A);e.name,o[e.name]=e,n[e.name]=!0}if(r.extensionsUsed)for(let c=0;c<r.extensionsUsed.length;++c){const e=r.extensionsUsed[c],t=r.extensionsRequired||[];switch(e){case pr.KHR_MATERIALS_UNLIT:n[e]=new mr;break;case pr.KHR_DRACO_MESH_COMPRESSION:n[e]=new Lr(r,this.dracoLoader);break;case pr.KHR_TEXTURE_TRANSFORM:n[e]=new Gr;break;case pr.KHR_MESH_QUANTIZATION:n[e]=new Nr;break;default:t.indexOf(e)>=0&&o[e]}}A.setExtensions(n),A.setPlugins(o),A.parse(s,i)}parseAsync(e,t){const s=this;return new Promise((function(i,r){s.parse(e,t,i,r)}))}};async function un(e,t={}){return new Promise(((s,i)=>{hn.load(e,(i=>{K.add(e,i),t.onLoad&&t.onLoad(i),s(i)}),(()=>{}),i)}))}function gn(e,t){return new Promise((s=>{const i=new Image;i.loading="eager";const r=setTimeout((()=>{}),1),n=()=>{clearTimeout(r);const n={node:i,url:e};t.onLoad&&t.onLoad(n),K.add(e,n),s(n)},o=e=>{};-1===e.indexOf(location.host)&&(i.crossOrigin="anonymous"),i.decode?(i.src=e,i.decode().then(n).catch(o)):(i.onload=n,i.onerror=o,i.decoding="async",i.src=e)}))}async function dn(e,t={}){const s=await fetch(e),i=await s.json();return K.add(e,i),t.onLoad&&t.onLoad(i),i}un.initDRACOLoader=()=>{const e=new hr;e.setDecoderPath(Ie("vendors/draco/")),e.preload(),hn.setDRACOLoader(e)},un.loader={name:"gltf",extensions:[".gltf",".glb"],function:un},gn.loader={name:"image",extensions:[".jpg",".png",".webp",".avif",".gif",".jpeg"],function:gn},dn.loader={name:"json",extensions:[".json"],function:dn};const pn=e=>e;const fn={};let mn=0;class In{constructor(e={}){this.isComponent=!0,this.props=e;(this.usedMixins=[]).dynamic=[],this.static=!1,this.webgl=b(),this.scene=null,this.parent=null,this.base=null;(this.children=[]).dynamic=[],this.isInit=!1,this.isDestroyed=!1,this.uid=++mn,this.name||(this.props.name?this.name=this.props.name:this.props.id?this.name=this.props.id:(this.name=this.constructor.name,fn[this.name]?++fn[this.name]:fn[this.name]=1,fn[this.name]>1&&(this.name+="_"+(fn[this.name]-1)))),this.log=()=>{}}triggerInit(){if(!this.isInit){if(this.beforeInit&&this.beforeInit(),this.mixins){const e=this.mixins;if(Array.isArray(e))for(let t=0;t<e.length;t++){let s,i=e[t];Array.isArray(i)&&(s=i[1],i=i[0]),this.useMixin(i,s)}}this.init&&this.init(),this.isInit=!0,this.afterInit&&this.afterInit()}}bind(e,t=0){return this[e]=vt(e,this,t),this[e]}useMixin(e,t){"string"==typeof e&&(e=this.webgl.mixins[e],Array.isArray(e)&&(t=Object.assign({},e[1],t),e=e[0])),e&&(e.isMixin?e:new e(t??{})).use(this)}unuseMixin(e){e&&e.unuse()}addObject3D(e){return this.base&&this.base.add(e),e}removeObject3D(e){return this.base&&this.base.remove(e),null}add(e,t={},s){if(!e)return;if(~this.children.indexOf(e))return e;e.isComponent?t=e.props:e=new e(t);const i=e.parent;return i&&i.remove(e),e.parent=this,this.scene?e.scene=this.scene:this.isScene&&(e.scene=this),e.isInit||e.triggerInit(t),e.static||this.children.dynamic.push(e),this.children.push(e),e.base&&(s?s.add(e.base):this.base&&this.base.add(e.base)),e.destroyed?(this.remove(e),e):(this.isAttached&&Cn(this.scene,e),e)}removeFromParent(){this.parent&&this.parent.remove(this)}remove(e){const t=this.children.indexOf(e);if(!~t)return;this.children.splice(t,1);const s=this.children.dynamic.indexOf(e);return~s&&this.children.dynamic.splice(s,1),e.parent=null,e.base&&e.base.removeFromParent(),Bn(e),null}triggerUpdate(){if(!this.isInit)return;this.beforeUpdate&&this.beforeUpdate();const e=this.usedMixins.dynamic;for(let s=0,i=e.length;s<i;s++){const t=e[s];if(t&&t.update(),this.isDestroyed)break;t.isDestroyed&&(i--,s--)}if(this.isDestroyed)return;if(this.update&&this.update(),this.isDestroyed)return;const t=this.children.dynamic;for(let s=0,i=t.length;s<i;s++){const e=t[s];e&&e.triggerUpdate(),e&&(e.isDestroyed&&(i--,s--))}this.isDestroyed||this.afterUpdate&&this.afterUpdate()}destroy(){if(!this.isDestroyed){this.beforeDestroy&&this.beforeDestroy();for(let e=this.usedMixins.length-1;e>=0;e--)this.usedMixins[e].destroy();this.parent&&this.parent.remove(this);for(let e=this.children.length-1;e>=0;e--)this.children[e].destroy();if(this.base){for(let e=this.base.children.length-1;e>=0;e--)this.base.remove(this.base.children[e]);this.base.removeFromParent()}this.props=null,this.usedMixins=null,this.webgl=null,this.scene=null,this.parent=null,this.base=null,this.children=null,this.isDestroyed=!0}}}function Cn(e,t){const s=t.children,i=t.usedMixins;if(!t.isAttached){t.isAttached=!0,t.scene=e,t.attached&&t.attached();for(let e=i.length-1;e>=0;e--)i[e].componentAttached(t);for(let t=s.length-1;t>=0;t--)Cn(e,s[t])}}function Bn(e){const t=e.children,s=e.usedMixins;if(e.isAttached){for(let e=t.length-1;e>=0;e--)Bn(t[e]);for(let t=s.length-1;t>=0;t--)s[t].componentDetached(e);e.isAttached=!1,e.detached&&e.detached(),e.scene=null}else e.scene=null}In.triggerAttached=Cn,In.triggerDetached=Bn;const vn=new st,yn=new st;class En extends In{init(){this.base=null,this.useFixedLighting=this.props.useFixedLighting??!0;const e=this.scene.base;e.environment=U.$assets.textures.envmap_main,e.environmentIntensity=1,this.envRotation=new yt(-1.07,-.21,.12)}updateEnvRotation(){const e=this.scene.getCurrentCamera().cam,t=this.scene.base;this.useFixedLighting?e.getWorldQuaternion(vn):vn.identity(),vn.multiply(yn.setFromEuler(this.envRotation)),vn.invert();const s=t.environmentRotation.setFromQuaternion(vn);s.x*=-1,s.y*=-1,s.z*=-1}update(){this.updateEnvRotation()}}class wn extends In{constructor(e={}){super(e),this.isCamera=!0,this.isUsed=!1}afterInit(){this.cam&&!this.base?this.base=this.cam:this.cam||(this.cam=function(){const e=window.innerWidth/window.innerHeight;return new Je(55,e,.1,100)}()),this.base||(this.base=this.cam);const e=this.webgl.$renderer.drawingBufferSize;this.resizeSignal=e.watchImmediate(this.resize,this)}used(){}unused(){}resize(e){this.cam.aspect=e.x/e.y,this.cam.updateProjectionMatrix()}destroy(){this.resizeSignal.unwatch(),super.destroy()}}function Qn(e,t){e&&e.isUsed!=t&&(e.isUsed=!!t,e.isUsed?e.used():e.unused())}class xn extends In{constructor(e={}){e.autoAttach=!!(e.autoAttach??1),super(e,!0),this.isScene=!0,this.hooks={afterMatrixWorldUpdate:m()},this._cam={current:!1,forced:!1},this.props||(this.props=e)}triggerInit(){this.isInit||(this.base=new Et,this.base.matrixAutoUpdate=!1,this.base.matrixWorldAutoUpdate=!1,super.triggerInit(),this.camera||(this.camera=this.add(wn)),this.props.autoAttach&&this.attach())}triggerUpdate(){super.triggerUpdate(),this.isDestroyed||(this.base.updateMatrixWorld(),this.hooks.afterMatrixWorldUpdate.emit())}attach(){In.triggerAttached(this,this)}detach(){In.triggerDetached(this,this)}update(){}init(){}get camera(){return this._cam.current}set camera(e){e&&e.isCamera||(e=!1);const t=this._cam;t.current!==e&&(Qn(t.current,!1),t.current=e,t.forced||Qn(t.current,!1))}get overrideCamera(){return this._cam.forced}set overrideCamera(e){e&&e.isCamera||(e=!1);const t=this._cam;t.forced!==e&&(Qn(t.forced,!1),Qn(t.current,!1),t.forced=e,Qn(t.forced,!0))}getCurrentCamera(){return this._cam.forced||this._cam.current}render(){const e=this.webgl.$threeRenderer,t=this.getCurrentCamera();t&&e.render(this.base,t.cam)}triggerRender(){this.beforeRender&&this.beforeRender(),this.render(),this.afterRender&&this.afterRender()}destroy(){this.detach();for(let e in this.hooks)this.hooks[e].unwatchAll();super.destroy()}}class bn extends xn{constructor(e){super(e),r(this,"enterPromise",null),r(this,"leavePromise",null),r(this,"isLeft",!1),r(this,"isEntered",!1),r(this,"isEntering",!1),r(this,"isLeaving",!1)}async enter(){}async leave(){}resetEnter(){this.isLeft=!1,this.isEntered=!1,this.isEntering=!1,this.isLeaving=!1}async triggerEnter(e={}){if(this.isLeft=!1,this.isLeaving=!1,this.isEntering=!0,!this.isEntered){if(this.enterPromise)return this.enterPromise;this.enterPromise=wt(),await this.enter(e),this.enterPromise.resolve(),this.enterPromise=null,this.isEntered=!0}}async triggerLeave(e={}){if(this.isEntered=!1,this.isEntering=!1,this.isLeaving=!0,!this.isLeft){if(this.leavePromise)return this.leavePromise;this.leavePromise=wt(),await this.leave(e),this.leavePromise.resolve(),this.leavePromise=null,this.isLeft=!0}}}let Sn=0;function Rn(e,t,s){const i=()=>{},r={uid:++Sn,shader:e,use:function(e){const s=e.material||e;return s[t]=r.shader,s.needsUpdate=s.uniformsNeedUpdate=!0,s},unuse:i,clear:i,chunkChangedCalllbacks:new Set};return r}const Dn=Rn("precision highp float;varying vec4 vScreenPos;varying vec3 vNormal;varying vec3 vViewPosition;varying vec2 vUv;uniform vec4 res;uniform vec4 pointer;uniform float pointerDistance;uniform vec4 brushCoord;uniform vec3 brushColor;uniform vec2 brushSize;uniform float brushAngle;uniform float brushType;uniform float activePaintGroup;uniform float eraserMode;uniform float pencilMode;uniform sampler2D perlin;uniform float usePattern;uniform sampler2D pattern;uniform vec3 patternParams;\n#include <depth_check_pars>\n#include <mixmap>\n#include <drawline>\nvec2 rotateUV(vec2 uv,float angle){vec2 center=vec2(0.5);vec2 offset=uv-center;float s=sin(angle);float c=cos(angle);mat2 rot=mat2(c,-s,s,c);return rot*offset+center;}void main(){vec2 resolution=vec2(res.z,1.0);vec2 currentPointer=brushCoord.xy;vec2 previousPointer=brushCoord.zw;float line=segment(vScreenPos.zw,previousPointer,currentPointer);float d=0.;if(brushType<0.5){d=smoothstep(brushSize.x+1.2,brushSize.x,line);}else if(brushType<1.5){d=smoothstep(brushSize.x+1.2,0.,line);d*=0.25;}else if(brushType<2.5){d=smoothstep(brushSize.x+1.2,0.,line);vec2 bruv=vUv;float s=sin(brushAngle);float c=cos(brushAngle);mat2 rot=mat2(c,-s,s,c);bruv=rot*bruv;float l2=mix(0.1,1.0,smoothstep(0.,0.4,d));float n2=smoothstep(0.2,0.21,texture2D(perlin,bruv*vec2(40.,0.2)).r);float l=mix(0.2,0.12,d-n2);float nn=smoothstep(l,l+0.05,texture2D(perlin,vUv*100.).r);d*=nn;}if(d<0.001)discard;float df=dot(vNormal,normalize(vViewPosition));float backface=smoothstep(0.2,-0.1,df);vec3 color=brushColor;color=mix(pow(color.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),color.rgb*0.0773993808,vec3(lessThanEqual(color.rgb,vec3(0.04045))));if(usePattern>0.5){vec2 puv=rotateUV(vUv,patternParams.z)*patternParams.xy;float ptex=texture2D(pattern,puv).r;float pd=smoothstep(0.7,0.4,ptex);d*=pd;}\n#include <depth_check_frag>\ngl_FragColor=vec4(color,d);}","fragmentShader"),Tn=Rn("precision highp float;\n#include <common>\n#include <conditionals>\n#include <float_packing>\n#include <skinning_pars_vertex>\nattribute float roughnessMetalnessInterior;attribute float paintGroup;uniform float activePaintGroup;uniform float segmentedMode;uniform vec4 brushCoord;uniform vec2 brushSize;uniform vec4 res;varying vec4 vScreenPos;varying vec3 vNormal;varying vec3 vViewPosition;varying vec2 vUv;\n#include <depth_check_pars>\n#include <drawline>\n#include <mixmap>\nconst vec2 uvOffset=vec2(-10.,10.);void main(){vec3 rmi=unpackFloatToVec3(roughnessMetalnessInterior);vUv=UV_ATTR_PAINT;vUv+=uvOffset*(when_gt(rmi.z,0.5)+when_lt(paintGroup,-0.5));\n#include <beginnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nvec4 mvPosition=modelViewMatrix*vec4(transformed,1.0);vViewPosition=-mvPosition.xyz;vNormal=normalize(transformedNormal);vec4 clipPos=projectionMatrix*mvPosition;vScreenPos.xy=(clipPos.xy/clipPos.w*0.5+0.5)*res.xy;vScreenPos.zw=vec2(vScreenPos.x,res.y-vScreenPos.y)*res.w;vec4 uvPos=vec4(vUv.x*2.0-1.0,vUv.y*2.0-1.0,0.0,1.0);float diff=abs(paintGroup-activePaintGroup);uvPos.xy-=when_lt(0.002,diff*segmentedMode)*1000.0;\n#include <depth_check_vert>\ngl_Position=vec4(uvPos.xy,0.,1.);}","vertexShader");let Mn=0;function _n(e,t,s,i){const r=()=>{},n={uid:++Mn,shader:e,use:function(e){const t=e.material??e;if(!t.hotChunks){t.hotChunks=new Map;const e=function(e){t.hotChunks.forEach((t=>{const{id:s,code:i}=t,r=e.vertexShader,n=e.fragmentShader;e.vertexShader=r.replaceAll(`#include <${s}>`,i),e.fragmentShader=n.replaceAll(`#include <${s}>`,i)}))};if(t.hasOnBeforeCompileChain)t.onBeforeCompile=e;else{const s=t.onBeforeCompile;t.onBeforeCompile=function(t){s(t),e(t)}}}t.hotChunks.has(n.uid)||t.hotChunks.set(n.uid,{});const i=t.hotChunks.get(n.uid);return i.id=s,i.code=n.shader,t.needsUpdate=t.uniformsNeedUpdate=!0,t},unuse:r,clear:r,chunkChangedCalllbacks:new Set};return n}const Fn=_n("float segment(vec2 p,vec2 p1,vec2 p2){vec2 l=p2-p1;p-=p1;float L2=dot(l,l),d=min(length(p),length(p-l)),ds=dot(p,l);if(ds*(L2-ds)>0.)d=min(d,abs(-p.x*l.y+p.y*l.x)/sqrt(L2));return d;}float segmentD(in vec2 p,in vec2 a,in vec2 b){vec2 ba=b-a;vec2 pa=p-a;float h=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);vec2 closestPoint=a+h*ba;if(h<=0.0){return 1e10;}return length(p-closestPoint);}float segment2(in vec2 p,in vec2 a,in vec2 b){vec2 ba=b-a;vec2 pa=p-a;float h=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-h*ba);}float segmentB(vec2 p,vec2 p1,vec2 p2,float r1,float r2){vec2 l=p2-p1;float lengthL=length(l);vec2 dir=l/lengthL;float clampedProj=clamp(dot(p-p1,dir),0.0,lengthL);vec2 closestPoint=p1+dir*clampedProj;float d=length(p-closestPoint);float t=clampedProj/lengthL;float r=mix(r1,r2,t);return d-r;}",0,"drawline"),Pn=_n("uniform sampler2D itemDepthTexture;uniform vec3 itemDepthRange;varying float vCamDist;",0,"depth_check_pars"),Un=_n("ivec2 pc=ivec2(vScreenPos.xy);float cd=mixnorm(vCamDist,itemDepthRange.x,itemDepthRange.y);float idT=abs(cd-texelFetch(itemDepthTexture,pc+ivec2(+1,0),0).r);float idB=abs(cd-texelFetch(itemDepthTexture,pc+ivec2(-1,0),0).r);float idR=abs(cd-texelFetch(itemDepthTexture,pc+ivec2(0,+1),0).r);float idL=abs(cd-texelFetch(itemDepthTexture,pc+ivec2(0,-1),0).r);float depthTest=min(min(min(idT,idB),idR),idL)*itemDepthRange.z;d*=clamp(smoothstep(0.1,0.0001,depthTest),0.,1.);if(d<0.001)discard;",0,"depth_check_frag"),kn=_n("vCamDist=length(mvPosition.xyz);",0,"depth_check_vert"),Ln={setupMaterial:e=>{Pn.use(e),Un.use(e),kn.use(e);const t=U.$scenes.list.editor.draw.depth;Object.assign(e.uniforms,{itemDepthTexture:{value:t.texture},itemDepthRange:{value:t.depthRange}})}};class Gn extends P{constructor(){super(),this.isShaderMaterial=!0,this.type=this.name="BrushMat",this.uniforms={...this.uniforms,...U.$uniforms,usePattern:{value:0},pattern:{value:U.$assets.textures.null},patternParams:{value:new Re},perlin:{value:U.$assets.textures.noise_perlin},brushSize:{value:new u},brushCoord:{value:new Qt},brushAngle:{value:0},brushType:{value:0},activePaintGroup:{value:0},segmentedMode:{value:0},brushColor:{value:new c(16777215)},pencilMode:{value:0},eraserMode:{value:0}},this.defines={...this.defines,...U.itemAttrDefines},this.side=xt,this.depthWrite=!1,this.depthTest=!1,this.transparent=!0,Tn.use(this),Dn.use(this),Fn.use(this),Ln.setupMaterial(this)}}new c;class Nn extends In{constructor(){super(...arguments),r(this,"isDrawing",!1),r(this,"hasDrawn",!1),r(this,"prevPointerPos",new u),r(this,"pointerPos",new u),r(this,"pointerPosUnshifted",new u),r(this,"needsRender",!1),r(this,"needsPrerender",!1),r(this,"needsColorUpdate",!1),r(this,"color",new c),r(this,"lastCamMatrix",new Se),r(this,"camHasMovedSinceLastDraw",!1),r(this,"lineStatus",0),r(this,"drawBounds",new Qt(0,0,0,0)),r(this,"clampBounds",!1),r(this,"brushAnglePrevPart",-1),r(this,"brushAnglePrevUv",new u),r(this,"brushAngle",0),r(this,"prevBrushType",-1)}init(){this.base=null;const e=U.$app.$editor.edition;this.brushMat=new Gn,bt((()=>this.selectPattern(e.toolParams.patternType))),bt((()=>this.togglePatternMode("pattern"===e.activeTool))),bt((()=>this.updatePatternParams(e.toolParams.patternType,e.toolParams.patternSize,e.toolParams.patternRotation))),this.scene.item.onBeforeRender(this.renderBrushStroke.bind(this))}selectPattern(e){const t=this.brushMat.uniforms,s=U.$assets.textures["pattern_"+e],i=t.pattern.value;s!==i&&(i&&i.dispose(),t.pattern.value=s)}togglePatternMode(e){this.brushMat.uniforms.usePattern.value=e?1:0}updatePatternParams(e,t,s){const i=U.$app.$editor.config.patterns[e]??St,r=this.brushMat.uniforms,n=100/(i.minSize??1.4),o=100/(i.maxSize??10),a=Ft(t,0,100,n,o),A=s*Math.PI/180;r.patternParams.value.set(a,a*(i.aspect??1),A)}async prerender(){U.$threeRenderer.initTexture(this.brushMat.uniforms.pattern.value),this.needsPrerender=!0,this.parent.depth.needsPrerender=!0,this.parent.seamsFixer.needsPrerender=!0}update(){const e=U.$app.$editor.controls.isDrawing;!this.isDrawing&&e?this.startDraw():this.isDrawing&&!e&&this.stopDraw(),this.isDrawing&&e&&this.updateDraw()}callRender(){const e=this.drawBounds,{x:t,y:s}=this.pointerPos,{x:i,y:r}=this.prevPointerPos,n=U.$app.$editor.edition.activePointerSize,o=U.$threeRenderer,a=U.$renderer.pixelRatio.value,l=o.domElement.width/a,c=o.domElement.height/a,h=A(Math.min(i,t)-n-5,0,l),u=A(Math.min(r,s)-n-5,0,c),g=A(Math.max(i,t)+n+5,0,l)-h,d=A(Math.max(r,s)+n+5,0,c)-u;e.set(h+.5*g,u+.5*d,g,d),this.needsRender=!0,this.parent.depth.needsRender=!0,this.parent.seamsFixer.needsRender=!0}startDraw(){const e=U.$app.$editor.controls,t=U.$app.$editor.edition,s=t.toolParams,i=U.$app.$controls.touch,r=this.parent.raycast(e.pointerClip.x,e.pointerClip.y);if(r||1!==i.realFingerCount||e.toggleForceRotate(),!r)return this.stopDraw();this.isDrawing=!0,this.hasDrawn=!1;const n=this.parent.getPartFromIntersect(r);this.brushMat.uniforms.activePaintGroup.value=n.paintGroup,this.brushMat.uniforms.segmentedMode.value=s.segmentedMode?1:0;const o=this.scene.getCurrentCamera().cam.matrixWorld;this.lastCamMatrix.equals(o)||(this.camHasMovedSinceLastDraw=!0),this.updatePointerPos(!0,r),e.modifiers.SHIFT&&!this.camHasMovedSinceLastDraw||this.prevPointerPos.copy(this.pointerPos);const a=s.brushColor;t.pushColor(a,"brushColor"),this.needsColorUpdate=!0,this.parent.history.push("PAINT_RT"),this.callRender()}updatePointerPos(e=!1,t){const{pointerPos:s,pointerPosUnshifted:i}=this,r=U.$app.$editor.controls,n=U.$app.$controls.touch,o=r.modifiers.SHIFT,a=r.pointerScreen.x-.5,A=r.pointerScreen.y+.5,l=this.lineStatus;if(!o||e)s.x=a,s.y=A,i.copy(s),this.lineStatus=0;else{const e=Math.abs(n.delta.x),t=Math.abs(n.delta.y);0===this.lineStatus&&(e>.01||t>.01)&&(this.lineStatus=t>e?1:2),s.x=1===this.lineStatus?i.x:a,s.y=2===this.lineStatus?i.y:A,i.copy(s)}if(!t||s.x!==a||s.y!==A){const e=U.$app.$viewport;let i=0,r=0;o&&0===l?(i=s.x,r=s.y):(i=(s.x-.5)/e.width*2-1,r=-(s.y+.5)/e.height*2+1),t=this.parent.raycast(i,r)}if(t){const e=this.parent.getPartFromIntersect(t),s=t[U.itemAttrDefines.UV_ATTR_PAINT];e&&this.brushAnglePrevPart===e.partIndex?(this.brushAngle=Math.atan2(s.y-this.brushAnglePrevUv.y,s.x-this.brushAnglePrevUv.x),this.brushAnglePrevUv.copy(s)):(this.brushAnglePrevPart=e.partIndex,this.brushAnglePrevUv.copy(s))}}updateDraw(){this.updatePointerPos();this.pointerPos.distanceToSquared(this.prevPointerPos)>1e-5&&this.callRender()}stopDraw(){this.hasDrawn&&U.$app.$editor.persistence.requestAutosave(),this.isDrawing=!1,this.hasDrawn=!1,this.clampBounds=!1,this.lineStatus=0,this.needsColorUpdate=!0}prerenderBrushstroke(e,t,s){this.needsPrerender=!1;const i=U.$threeRenderer,r=i.getRenderTarget(),n=this.scene.item.mesh,o=this.brushMat;i.setRenderTarget(U.$assets.nullRT),i.renderBufferDirect(s,null,n.geometry,o,n,null),i.setRenderTarget(r)}renderBrushStroke(e,t,s){if(this.needsPrerender&&this.prerenderBrushstroke(e,t,s),!this.needsRender)return;this.needsRender=!1,this.hasDrawn=!0;const i=U.$app.$editor,r=U.$threeRenderer,n=this.scene.item.mesh,o=r.getRenderTarget(),a=i.edition.activeTool;let A=i.edition.brushTypeIndex;const l=this.brushMat,c=l.uniforms,{pointerPos:h,prevPointerPos:u}=this,g=c.brushAngle.value,d=h.distanceTo(u);c.brushAngle.value=Math.atan2(h.y-u.y,h.x-u.x)+.5*Math.PI,c.brushAngle.value=this.brushAngle+.5*Math.PI,c.brushCoord.value.set(u.x,u.y,h.x,h.y),c.brushSize.value.x=i.edition.activePointerSize,A!==this.prevBrushType&&(this.needsColorUpdate=!0,this.prevBrushType=A,c.brushType.value=A);const p=2===A;p&&Math.abs(g-c.brushAngle.value)>.5&&d>4&&(this.needsColorUpdate=!0),this.needsColorUpdate&&(this.color.copy(i.edition.activePointerColor),p&&this.color.offsetHSL(Rt.randomFloat(-.04,.04),Rt.randomFloat(-.05,.05),Rt.randomFloat(-.03,.1)),this.needsColorUpdate=!1),c.brushColor.value.copy(this.color),u.copy(h),"erase"===a?(l.blending=Dt,l.blendSrc=Tt,l.blendDst=Mt):l.blending=_t;const f=this.scene.getCurrentCamera().cam;this.lastCamMatrix.copy(f.matrixWorld),this.camHasMovedSinceLastDraw=!1,this.scene.disableClampRender(),r.setRenderTarget(this.parent.paintRT),r.renderBufferDirect(s,null,n.geometry,l,n,null),r.setRenderTarget(o),this.scene.clampRenderBounds(),this.clampBounds=!0}}const On=Rn("uniform vec3 itemDepthRange;varying float vCamDist;\n#include <mixmap>\nvoid main(){float c=mixnorm(vCamDist,itemDepthRange.x,itemDepthRange.y);gl_FragDepth=c;}","fragmentShader"),qn=Rn("precision highp float;\n#include <common>\n#include <conditionals>\n#include <skinning_pars_vertex>\nattribute float paintGroup;varying float vCamDist;uniform float activePaintGroup;uniform float segmentedMode;void main(){\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nfloat diff=abs(paintGroup-activePaintGroup);transformed+=when_lt(0.002,diff*segmentedMode)*100000.0;vec4 mvPosition=modelViewMatrix*vec4(transformed,1.0);vCamDist=length(mvPosition.xyz);gl_Position=projectionMatrix*mvPosition;}","vertexShader");class Hn extends P{constructor(){super(),this.isShaderMaterial=!0,this.type=this.name="DepthMat",this.uniforms={...this.uniforms,...U.$uniforms,itemDepthRange:{value:[0,0,0]},activePaintGroup:{value:-1},segmentedMode:{value:0}},this.defines={...this.defines},this.side=lt,this.colorWrite=!1,this.depthWrite=!0,this.depthTest=!0,qn.use(this),On.use(this)}}new Se;const zn=new Re,Vn=new pt;class $n extends In{constructor(){super(...arguments),r(this,"needsRender",!1),r(this,"needsPrerender",!1),r(this,"lastRenderMatrix",new Se),r(this,"lastDbs",new u),r(this,"depthRange",new Re),r(this,"lastCamMove",-1),r(this,"lastItemMove",-1),r(this,"lastPaintGroup",-1),r(this,"lastDbs",new u)}init(){this.base=null,this.mat=new Hn,this.mat.uniforms.itemDepthRange.value=this.depthRange,this.rt=U.$fbo.createBuffer({scale:1,name:"paintDepth"}),this.texture=this.rt.depthTexture=new Pt,this.scene.item.onBeforeRender(this.renderDepth.bind(this))}async prerender(){U.$threeRenderer.initRenderTarget(this.rt)}updateDepthRange(){const e=this.scene.getCurrentCamera().cam,t=this.scene.item.mesh;let s=Infinity,i=-Infinity;const r=t.geometry.boundingBox;for(let a=0;a<8;a++){const n=1&a?r.max.x:r.min.x,o=2&a?r.max.y:r.min.y,A=4&a?r.max.z:r.min.z;zn.set(n,o,A).applyMatrix4(t.matrixWorld);const l=zn.distanceTo(e.position);l<s&&(s=l),l>i&&(i=l)}const n=Vn.copy(t.geometry.boundingSphere);n.applyMatrix4(t.matrixWorld);const o=n.distanceToPoint(e.position);o<s&&(s=o),s=Math.max(.01,s),i=Math.max(s+.01,i),this.depthRange.set(s,i,i-s)}prerenderDepth(e,t,s){this.needsPrerender=!1;const i=U.$threeRenderer,r=i.getRenderTarget(),n=this.scene.item.mesh;i.setRenderTarget(U.$assets.nullRT),i.renderBufferDirect(s,t,n.geometry,this.mat,n,null),i.setRenderTarget(r)}renderDepth(e,t,s){if(this.needsPrerender&&this.prerenderDepth(e,t,s),!this.needsRender)return;this.needsRender=!1;const i=this.scene.item.mesh,r=this.scene.camera.lastMoveAt,n=this.scene.item.lastMoveAt,o=this.scene.draw.brush.brushMat.uniforms.segmentedMode.value,a=this.scene.draw.brush.brushMat.uniforms.activePaintGroup.value,A=o?a:-1;if(r===this.lastCamMove&&n===this.lastItemMove&&A===this.lastPg&&this.lastDbs.equals(U.$renderer.drawingBufferSize.value))return;this.lastDbs.copy(U.$renderer.drawingBufferSize.value),this.lastCamMove=r,this.lastItemMove=n,this.lastPg=A,this.segmentedMode=o,this.paintGroup=this.scene.draw.brush.brushMat.uniforms.activePaintGroup.value;const l=U.$threeRenderer,c=l.getRenderTarget();this.mat.uniforms.activePaintGroup.value=this.paintGroup,this.mat.uniforms.segmentedMode.value=this.segmentedMode,this.scene.disableClampRender(),l.setRenderTarget(this.rt),this.updateDepthRange(),l.clearDepth(),l.renderBufferDirect(s,t,i.geometry,this.mat,i,null),l.setRenderTarget(c),this.scene.clampRenderBounds()}}const Yn=new u(0,0);let Jn;function Kn(e,t,s={}){!function(){if(Jn)return Jn;Jn=Ys({uniforms:{tex:{value:null},multiplyAlpha:{value:0}},transparent:!0,fragmentShader:"precision highp float;uniform sampler2D tex;uniform float multiplyAlpha;varying vec2 vUv;void main(){vec4 c=texture2D(tex,vUv);c.rgb=mix(c.rgb,c.rgb/max(0.0001,c.a),multiplyAlpha);gl_FragColor=vec4(c.rgb,c.a);}"});const e=Jn.material;e.blending=Dt,e.blendSrcAlpha=Ut,e.blendDstAlpha=Tt,e.blendSrc=Ut,e.blendDst=Tt}();const i=U.$threeRenderer,r=i.getRenderTarget();i.setRenderTarget(t),Jn.uniforms.tex.value=e,Jn.uniforms.multiplyAlpha.value=s.multiplyAlpha?1:0,Jn.render(),i.setRenderTarget(r)}function Wn(e,t){const s=U.$threeRenderer,i=s.getRenderTarget();s.setRenderTarget(e),s.copyFramebufferToTexture(t,Yn,0),s.setRenderTarget(i)}new u(0,0);class jn extends In{constructor(){super(...arguments),r(this,"queueFn",null),r(this,"queueFnArg",null),r(this,"undoHistory",[]),r(this,"redoHistory",[])}init(){this.base=null;const e=U.$app.$device.type.desktop?6:3,t=this.parent.textureSize;this.blankTexData=new Uint8Array(t.width*t.height*4),this.texs=Array.from({length:e},(()=>{const e=new ue(this.blankTexData,t.width,t.height,Q);return e.needsUpdate=!0,e})),this.freeTexs=[...this.texs],this.redo=e=>{this.queueFn="execRedo",this.queueFnArg=e},this.undo=e=>{this.queueFn="execUndo",this.queueFnArg=e},this.push=e=>{this.queueFn="execPush",this.queueFnArg=e}}async prerender(){const e=U.$threeRenderer;for(let t=0;t<this.texs.length;t++)e.initTexture(this.texs[t])}pop(e){const{undoHistory:t,redoHistory:s}=this,i=e===t?s:t,r=e.pop();if(r){if(r.isTexture){const e=r;U.$quality.pause("history"),i.push(r);const t=this.parent.seamsFixer.rt;Kn(e,t),Wn(this.parent.paintRT,e),Kn(t.texture,this.parent.paintRT),this.parent.seamsFixer.needsRender=!0,U.$quality.resume(2e3,"history"),U.$app.$editor.persistence.requestAutosave()}this.updateFlags()}}getAvailableTex(){const{freeTexs:e,undoHistory:t}=this;return e.pop()??t.shift()}execPush(e){if("PAINT_RT"===e){const{freeTexs:e,undoHistory:t,redoHistory:s}=this,i=this.parent.paintRT;for(let n=0;n<s.length;n++){const t=s[n];t.isTexture&&e.push(t)}s.length=0;let r=this.getAvailableTex();if(!r||!r.isTexture)return;Wn(i,r),t.push(r),U.$app.$editor.edition.hasMadeChanges=!0}this.updateFlags()}execUndo(){this.pop(this.undoHistory)}execRedo(){this.pop(this.redoHistory)}beforeRender(){if(!this.queueFn)return;const{queueFn:e,queueFnArg:t}=this;this.queueFn=this.queueFnArg=null,this[e](t)}reset(){for(let e=0;e<this.texs.length;e++){const t=this.texs[e];t.image.data=this.blankTexData,t.needsUpdate=!0,U.$threeRenderer.initTexture(t)}this.freeTexs=[...this.texs],this.undoHistory=[],this.redoHistory=[],this.updateFlags()}updateFlags(){const e=U.$app.$editor.edition;e.undosCount=this.undoHistory.length,e.redosCount=this.redoHistory.length,e.canUndo=e.undosCount>0,e.canRedo=e.redosCount>0}update(){}}const Xn=Rn("void main(){gl_FragColor=vec4(1.0,1.0,1.0,1.0);}","fragmentShader"),Zn=Rn("precision highp float;\n#include <common>\n#include <conditionals>\n#include <float_packing>\n#include <skinning_pars_vertex>\nattribute float roughnessMetalnessInterior;attribute float paintGroup;const vec2 uvOffset=vec2(-10.,-10.);void main(){\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nvec3 rmi=unpackFloatToVec3(roughnessMetalnessInterior);vec2 paintUv=UV_ATTR_PAINT+uvOffset*(when_gt(rmi.z,0.5));vec4 uvPos=vec4(paintUv.x*2.0-1.0,(paintUv.y)*2.0-1.0,0.0,1.0);gl_Position=vec4(uvPos.xy,0.,1.);}","vertexShader");class eo extends P{constructor(){super(),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="IslandsMaterial",this.uniforms={...this.uniforms,...U.$uniforms},this.defines={...this.defines,...U.itemAttrDefines},this.side=xt,this.depthWrite=!1,this.depthTest=!1,this.precision="mediump",Zn.use(this),Xn.use(this)}}const to=new c(0),so=new c;function io(e,t=!0,s=!0,i=!1){const r=U.$threeRenderer;r.getClearColor(so);const n=r.getClearAlpha(),o=r.getRenderTarget();r.setRenderTarget(e),r.setClearColor(to,0),r.clear(t,s,i),r.setRenderTarget(o),r.setClearColor(so,n)}const ro=Rn("uniform sampler2D map;uniform sampler2D islands;varying vec2 vUv;void main(){ivec2 uv=ivec2(gl_FragCoord.xy);float island=texelFetch(islands,uv,0).r;if(island<0.5){vec4 north=texelFetch(map,ivec2(uv.x,uv.y+2),0);vec4 east=texelFetch(map,ivec2(uv.x,uv.y-2),0);vec4 west=texelFetch(map,ivec2(uv.x-2,uv.y),0);vec4 bottom=texelFetch(map,ivec2(uv.x+2,uv.y),0);vec4 result=north;if(east.a>result.a)result=east;if(west.a>result.a)result=west;if(bottom.a>result.a)result=bottom;gl_FragColor=result;}else{vec4 current=texelFetch(map,uv,0).rgba;gl_FragColor=current;}}","fragmentShader"),no=new c;class oo extends In{constructor(){super(...arguments),r(this,"currentMeshUUID",null),r(this,"needsIslandRender",!1),r(this,"needsRender",!1),r(this,"needsPrerender",!1),r(this,"clearColor",new c(0,0,0))}init(){this.base=null;const e=this.parent.textureSize,t=U.$fbo.createBuffer;this.rt=t({...e,name:"paintFixed",depth:!1}),this.islandsRT=t({...e,name:"islands",depth:!1,format:L}),this.texture=this.rt.texture,this.islandsMat=new eo,this.islandsRT.texture.format=L,this.islandsRT.texture.type=Z,this.islandsRT.texture.internalFormat="R8",this.inflateFilter=Ys({useRawShader:!1,fragmentShader:ro,transparent:!1,uniforms:{map:{value:this.parent.paintRT.texture},islands:{value:this.islandsRT.texture}}}),this.scene.item.onBeforeRender(this.renderIslands.bind(this)),queueMicrotask((()=>{this.scene.item.onBeforeRender(this.renderFix.bind(this))}))}async prerender(){const e=U.$threeRenderer;e.initRenderTarget(this.rt),e.initRenderTarget(this.islandsRT),this.needsIslandRender=!0}renderIslands(){const e=this.scene.item.mesh;if(!this.needsIslandRender)return;if(this.needsIslandRender=!1,e.uuid===this.currentMeshUUID)return;this.currentMeshUUID=e.uuid;const t=U.$threeRenderer,s=t.getRenderTarget(),i=t.getClearColor(no);this.scene.disableClampRender(),t.setRenderTarget(this.islandsRT),t.setClearColor(this.clearColor,1),t.clearColor(),t.renderBufferDirect(this.scene.base,this.scene.getCurrentCamera().cam,e.geometry,this.islandsMat,e,null),t.setRenderTarget(s),t.setClearColor(i),this.scene.clampRenderBounds()}reset(){io(this.rt,!0,!1,!1),this.needsRender=!1}prerenderFix(){this.needsPrerender=!1;const e=U.$threeRenderer,t=e.getRenderTarget();e.setRenderTarget(U.$assets.nullRT),this.inflateFilter.render(),e.setRenderTarget(t)}renderFix(){if(this.needsPrerender&&this.prerenderFix(),!this.needsRender)return;this.needsRender=!1;const e=U.$threeRenderer,t=e.getRenderTarget();this.scene.disableClampRender(),e.setRenderTarget(this.rt),this.inflateFilter.render(),e.setRenderTarget(t),this.scene.clampRenderBounds()}}const ao=Rn("uniform sampler2D map;uniform sampler2D islands;varying vec2 vUv;void main(){ivec2 uv=ivec2(gl_FragCoord.xy);vec4 img=texelFetch(map,uv,0).rgba;img.rgb=mix(pow(img.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),img.rgb*0.0773993808,vec3(lessThanEqual(img.rgb,vec3(0.04045))));float island=texelFetch(islands,uv,0).r;gl_FragColor=vec4(img.rgb*island,img.a*island);}","fragmentShader");class Ao extends In{constructor(){super(...arguments),r(this,"tempTex",new k)}init(){this.base=null;const e=(this.expertFilter=Ys({useRawShader:!1,fragmentShader:ao,transparent:!0,uniforms:{map:{value:this.tempTex},islands:{value:this.parent.seamsFixer.islandsRT.texture}}})).material;e.blending=Dt,e.blendSrcAlpha=Ut,e.blendDstAlpha=Tt,e.blendSrc=Ut,e.blendDst=Tt}async prerender(){}async importImage(e){try{const t=U.$threeRenderer,s=this.parent.textureSize;U.$quality.pause("expert-import"),e.width===s.width&&e.height===s.height||(e=await createImageBitmap(e,{resizeWidth:s.width,resizeHeight:s.height,resizeQuality:"high"})),this.parent.history.execPush("PAINT_RT"),await 0;const i=this.tempTex;i.image=e,i.needsUpdate=!0,i.generateMipmaps=!1;const r=t.getRenderTarget();t.setRenderTarget(this.parent.paintRT),this.expertFilter.render(),t.setRenderTarget(r),this.parent.history.needsRender=!0,this.parent.seamsFixer.needsRender=!0}finally{U.$quality.resume(1e3,"expert-import")}}}const lo=_n("uniform sampler2D stickerTex;uniform vec3 stickerPos;uniform vec3 stickerTransform;uniform vec4 stickerTint;vec4 drawSticker(sampler2D image,vec2 suv,vec2 pos,vec3 transform,vec3 normal){vec2 size=transform.xy*0.0008;vec2 bottomLeft=pos-size*0.5;vec2 topRight=pos+size*0.5;float rotation=-transform.z;vec2 center=pos;vec2 translatedUV=suv-center;vec2 rotatedUV=vec2(translatedUV.x*cos(rotation)-translatedUV.y*sin(rotation),translatedUV.x*sin(rotation)+translatedUV.y*cos(rotation));vec2 imgUV=(rotatedUV+center-bottomLeft)/size;float a=1.;if(imgUV.x<0.||imgUV.x>1.||imgUV.y<0.||imgUV.y>1.)a=0.;vec4 color=texture2D(image,imgUV);color.a*=a;color.rgb=mix(color.rgb,mix(stickerTint.rgb,vec3(1.),color.r),stickerTint.a);return color;}",0,"sticker_chunk_pars"),co={};co.uniforms={stickerPos:{value:new Re(500,500,0)},stickerTransform:{value:new Re(100,100,0)},stickerTint:{value:new Qt},stickerTex:{value:new k}},co.setupMaterial=e=>{Object.assign(e.uniforms,co.uniforms),lo.use(e)};const ho=Rn("precision highp float;varying vec4 vScreenPos;varying vec3 vNormal;varying vec3 vViewPosition;varying vec2 vUv;uniform vec4 res;\n#include <conditionals>\n#include <float_packing>\n#include <sticker_chunk_pars>\n#include <mixmap>\nvoid main(){vec2 pxUv=vScreenPos.zw;vec4 stick=drawSticker(stickerTex,vUv,stickerPos.xy,stickerTransform,normalize(vNormal));vec3 color=stick.rgb;float d=stick.a;if(stick.a<0.0001)discard;gl_FragColor=vec4(color,d);}","fragmentShader"),uo=Rn("precision highp float;\n#include <common>\n#include <conditionals>\n#include <float_packing>\n#include <skinning_pars_vertex>\nattribute float roughnessMetalnessInterior;attribute float partIndex;uniform vec4 res;uniform vec3 stickerPos;varying vec4 vScreenPos;varying float vDistance;varying vec3 vNormal;varying vec3 vViewPosition;varying vec2 vUv;\n#include <mixmap>\nconst vec2 uvOffset=vec2(-100.,-100.);void main(){vec3 rmi=unpackFloatToVec3(roughnessMetalnessInterior);vUv=UV_ATTR_PAINT+uvOffset*(when_gt(rmi.z,0.5)+when_gt(abs(partIndex-stickerPos.z),0.002));\n#include <beginnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nvec4 mvPosition=modelViewMatrix*vec4(transformed,1.0);vViewPosition=-mvPosition.xyz;vNormal=normalize(transformedNormal);vec4 clipPos=projectionMatrix*mvPosition;vScreenPos.xy=(clipPos.xy/clipPos.w*0.5+0.5)*res.xy;vScreenPos.zw=vec2(vScreenPos.x,res.y-vScreenPos.y)*res.w;vec4 uvPos=vec4(vUv.x*2.0-1.0,vUv.y*2.0-1.0,0.0,1.0);gl_Position=vec4(uvPos.xy,0.,1.);}","vertexShader");class go extends P{constructor({itemDepthTexture:e,itemDepthRange:t}={}){super(),this.isShaderMaterial=!0,this.type=this.name="StickerMat",this.uniforms={...this.uniforms,...U.$uniforms,itemDepthRange:{value:t},itemDepthTexture:{value:e}},this.defines={...this.defines,...U.itemAttrDefines},this.side=xt,this.depthWrite=!1,this.depthTest=!1,this.transparent=!0,uo.use(this),ho.use(this),co.setupMaterial(this),Ln.setupMaterial(this)}}const po=new Re,fo=new c;let mo;const Io=Nt([[.3792424455915516,.3033939564732413],[.4901074013873118,.4557998832902],[1.1025444622065648,1.2127989084272213],[1.665051126621691,1.9314593068811614]]),Co=Nt([[70,55],[122,116],[150,149],[250,250],[720,828.575]]),Bo={sxm:1,sym:1,rm:1};class vo extends In{constructor(){super(...arguments),r(this,"isDropped",!1),r(this,"isExpanded",!1),r(this,"isRaycasting",!1),r(this,"hasRenderSticker",!1),r(this,"raycastMult",0),r(this,"raycastedId",-1),r(this,"transformOffsets",{...Bo}),r(this,"scaleAppear",0),r(this,"scaleAppearSmooth",0),r(this,"needsRender",!1),r(this,"zoomScale",1),r(this,"scaleRatio",new u(1,1)),r(this,"canStick",!1),r(this,"prevTintColor",""),r(this,"prevCanTint",!1)}init(){mo=U.$app.$editor.stickers,this.stickerMat=new go({itemDepthTexture:this.parent.depth.texture,itemDepthRange:this.parent.depth.depthRange});const e=this.stickerMat.uniforms;e.stickerTransform={value:e.stickerTransform.value.clone()},e.stickerPos={value:e.stickerPos.value.clone()},this.scene.item.onBeforeRender(this.renderSticker.bind(this))}async prerender(){}onExpand(){this.isDropped=mo.overlayComponent.isDropped,this.isExpanded=!0,this.scaleAppear=1;const e=this.scene.getCurrentCamera().cam,t=this.scene.item,s=e.worldToLocal(t.base.getWorldPosition(po)),i=2*Math.tan(e.fov*(Math.PI/180)/2)*(Math.abs(s.z)/6);this.zoomScale=Io(i);const r=co.uniforms,n=mo.texture;if(r.stickerPos.value.set(-10,-10),r.stickerTex.value!==n){r.stickerTex.value.dispose(),r.stickerTex.value=n;const e=mo.naturalSize,t=e.width/e.height;t>1?this.scaleRatio.set(1,1/t):this.scaleRatio.set(t,1)}}onCollapse(){this.isExpanded=!1,co.uniforms,this.scaleAppear=0}update(){mo.isExpanded&&!this.isExpanded?this.onExpand():!mo.isExpanded&&this.isExpanded&&this.onCollapse();const e=U.$time.dt,t=co.uniforms;let s=.3;this.scaleAppear<.5&&this.isDropped&&(s=.55);let i=this.scaleAppearSmooth=kt(this.scaleAppearSmooth,this.scaleAppear,s,e);this.scaleAppearSmooth>.001?this.updateVisible():this.canStick=!1,this.raycastMult=kt(this.raycastMult,-1===this.raycastedId?0:1,-1===this.raycastedId?.5:.3,e),-1===this.raycastedId&&this.raycastMult<.05&&(this.raycastMult=0),i*=this.raycastMult,!this.isExpanded&&i<1e-4&&(i=0);const r=t.stickerTransform.value,n=Co(mo.size),o=this.transformOffsets;if(r.x=n*i*this.scaleRatio.x,r.y=n*i*this.scaleRatio.y,r.x*=this.zoomScale*o.sxm,r.y*=this.zoomScale*o.sym,r.z=mo.rotation*o.rm,i>0){const e=U.$app.$editor,s=t.stickerTint.value,i=e.edition.toolParams.brushColor,r=e.stickers.isUni;if(this.prevCanTint!==r||this.prevTintColor!==i){const e=Lt(Gt(i));fo.setRGB(e[0]/255,e[1]/255,e[2]/255),fo.convertSRGBToLinear(),s.set(fo.r,fo.g,fo.b,r?1:0),this.prevTintColor=i,this.prevCanTint=r}}this.hasRenderSticker&&(this.hasRenderSticker=!1,this.scene.item.shake(.7))}updateVisible(){const e=co.uniforms;e.stickerPos.value;let t=mo.x,s=mo.y;const i=U.$viewport.size.value,r=t/i.x*2-1,n=s/i.y*-2+1,o=this.parent.raycast(r,n);this.isRaycasting=!!o;let a,A,l=!1;if(o?(a=this.parent.getPartFromIntersect(o),A=a.partIndex,this.canStick=l=a.canStick):this.canStick=!1,l){const{x:e,y:t}=o.uv,s=co.uniforms;if(A!==this.raycastedId){this.raycastMult=.15;const e=(null==a?void 0:a.stickerOffsets)??Bo;Object.assign(this.transformOffsets,e)}this.raycastedId=A,s.stickerPos.value.set(e,t,A)}else this.raycastedId=-1,this.isExpanded||e.stickerPos.value.set(-10,-10,-10)}callRender(){if(this.needsRender)return;const e=this.stickerMat.uniforms;e.stickerPos.value.copy(co.uniforms.stickerPos.value),e.stickerTransform.value.copy(co.uniforms.stickerTransform.value),this.scaleAppear=0,this.scaleAppearSmooth=0,this.needsRender=!0,this.parent.depth.needsRender=!0,this.parent.seamsFixer.needsRender=!0,this.parent.history.push("PAINT_RT")}renderSticker(){if(!this.needsRender)return;this.needsRender=!1,U.$app.$editor;const e=U.$threeRenderer,t=this.scene.item.mesh,s=e.getRenderTarget(),i=this.scene.getCurrentCamera().cam,r=this.stickerMat;r.uniforms,e.setRenderTarget(this.parent.paintRT),e.renderBufferDirect(i,null,t.geometry,r,t,null),e.setRenderTarget(s),this.hasRenderSticker=!0,U.$app.$editor.persistence.requestAutosave()}}const yo={classes:{Texture:k,DataTexture:ue,Vector2:u,Vector3:Re,Vector4:Qt,Color:c,Object3D:Me,Spherical:Ot},z:((e=0)=>({logo:e++,item:e++,background:e++,ground:e++}))(),layers:{base:0,itemOnly:1,shadowCaster:2,thumbnail:3,ui:4},itemAttrDefines:{UV_ATTR_PAINT:"uv",UV_ATTR_DIFFUSE:"uv1",UV_ATTR_NORMAL:"uv2"}};new u(0,0);const Eo=yo.itemAttrDefines.UV_ATTR_PAINT,wo=new c,Qo=[0,0,0],xo=new u;new u;class bo extends In{constructor(){super(...arguments),r(this,"current",new u),r(this,"pos",new u),r(this,"smoothedPos",new u),r(this,"ang",0),r(this,"smoothedAng",qt({tension:.1,friction:.32,step:5})),r(this,"scale",0),r(this,"scaleSpring",qt({tension:.15,friction:.4,step:5})),r(this,"pendingIsVisibleOn",!1),r(this,"isVisible",!1),r(this,"isActive",null),r(this,"isProcessing",!1),r(this,"isMounted",!1),r(this,"isPressed",!1),r(this,"isClicked",!1),r(this,"prevR",0),r(this,"prevG",0),r(this,"prevB",0),r(this,"visMult",0)}init(){this.scaleSpringFriction=this.scaleSpring._D,this.scaleSpringTension=this.scaleSpring._K,this.base=null,this.dom=document.createElement("aside"),this.dom.classList.add("picker-preview"),this.domColor=document.createElement("div"),this.domColor.classList.add("color"),this.dom.appendChild(this.domColor)}update(){const e=U.$app.$controls.touch,t=U.$app.$editor;this.isClicked=!t.controls.canForceRotate&&e.clickOut&&this.isPressed,this.isPressed=!t.controls.canForceRotate&&e.primaryPressed;const s="picker"===U.$app.$editor.edition.activeTool,i=this.isVisible;this.pendingIsVisibleOn&&(this.isVisible=!0);const r=U.$time.dt;s!==this.isActive&&(this.isActive=s,s?this.onToggleOn():this.onToggleOff()),this.isActive?this.updateActive():this.raycasting=!1;const n=i!==this.isVisible;if(this.isVisible){this.isMounted||(document.body.appendChild(this.dom),this.isMounted=!0);const s=this.useTouch?0:10,i=this.useTouch?40:10;let o=xo.copy(this.smoothedPos);this.pos.set(e.pos.x+s,e.pos.y-i),this.smoothedPos.damp(this.pos,.6,r),n&&(o.copy(this.pos),this.smoothedPos.copy(this.pos));const a=2*(this.smoothedPos.x-o.x),A=2*(this.smoothedPos.y-o.y),l=Math.abs(a)>Math.abs(A),c=Math.sign(l?a:A);let h=l?-a:-A;h*=l?c<0?.25:.5:c<0?.7:.4,this.smoothedAng.setTarget(h),this.smoothedAng.update(r),h=this.smoothedAng.value;const u=this.smoothedPos,g=u.x.toFixed(3),d=u.y.toFixed(3);this.scaleSpring.update(r);const p=this.raycasting&&!t.controls.canForceRotate&&t.controls.canUseClickTools()&&(e.useTouch&&e.pressed||t.controls.isMouseInCanvas);this.visMult=kt(this.visMult,+(this.isActive&&p),.51,r),this.scale=this.visMult*this.scaleSpring.value,h+=30*(1-this.scale),this.dom.style.transform=`translate3d(${g}px, ${d}px, 0) rotate(${h}deg) scale(${this.scale})`,!this.isActive&&this.scale<.001&&(this.isVisible=!1)}else this.isMounted&&(document.body.removeChild(this.dom),this.isMounted=!1)}async onToggleOn(){this.useTouch=U.$app.$controls.touch.useTouch,this.dom.classList.toggle("use-touch",this.useTouch),this.scaleSpring.setValue(this.scale),this.scaleSpring.setTarget(1),this.isProcessing=!0;const e=await Ht.toBuffer(this.parent.paintRT);this.array=e.arr,this.isProcessing=!1,this.pendingIsVisibleOn=!0}onToggleOff(){this.pendingIsVisibleOn=!1}updateActive(){if(this.isProcessing)return;const e=U.$app.$controls.touch,t=U.$app.$editor,s=this.parent.raycast();if(this.raycasting=!!s,!s)return void(e.clickIn&&t.controls.toggleForceRotate());if(e.primaryPressed&&!e.useTouch){const s=e.relativePos;Math.sqrt(s.x*s.x+s.y*s.y)>20&&t.controls.toggleForceRotate()}const i=s[Eo],r=this.array,n=Math.sqrt(r.length/4),o=Math.floor(i.x*n),a=4*(Math.floor(i.y*n)*n+o);let A=r[a],l=r[a+1],c=r[a+2],h=r[a+3];const u=wo.setRGB(A/255,l/255,c/255);u.convertLinearToSRGB(),A=255*u.r,l=255*u.g,c=255*u.b,h/=255,A=zt(255,A,h),l=zt(255,l,h),c=zt(255,c,h),A===this.prevR&&l===this.prevG&&c===this.prevB||(this.prevR=A,this.prevG=l,this.prevB=c,this.domColor.style.backgroundColor=`rgb(${A}, ${l}, ${c})`),this.isClicked&&this.setColor(A,l,c,h)}setColor(e,t,s,i){const r=U.$app.$editor.edition,n=r.toolParams,o=r.reopenColorInput,a=r.previousTool,A=U.$app.$editor.config.tools[a];Qo[0]=e,Qo[1]=t,Qo[2]=s;const l=Vt($t(Qo));let c="brushColor";o&&o.param?c=o.param:(null==A?void 0:A.colorParam)&&(c=A.colorParam),n[c]=l;const h=r.previousTool&&"picker"!==r.previousTool?r.previousTool:r.lastDrawingTool;r.setTool(h)}}const So=Rn("precision highp float;uniform vec4 res;uniform vec3 fillColor;void main(){gl_FragColor=vec4(fillColor,1.0);}","fragmentShader"),Ro=Rn("precision highp float;\n#include <common>\n#include <conditionals>\n#include <float_packing>\n#include <skinning_pars_vertex>\nattribute float roughnessMetalnessInterior;attribute float paintGroup;uniform float activeFillGroup;uniform vec4 res;const vec2 uvOffset=vec2(-10.,10.);void main(){vec3 rmi=unpackFloatToVec3(roughnessMetalnessInterior);vec2 puv=UV_ATTR_PAINT;puv+=uvOffset*(when_gt(rmi.z,0.5)+when_lt(paintGroup,-0.5)+when_lt(0.002,abs(paintGroup-activeFillGroup)));\n#include <beginnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nvec4 uvPos=vec4(puv.x*2.0-1.0,puv.y*2.0-1.0,0.0,1.0);gl_Position=vec4(uvPos.xy,0.,1.);}","vertexShader");class Do extends P{constructor(){super(),this.isShaderMaterial=!0,this.type=this.name="FillMat",this.uniforms={...this.uniforms,...U.$uniforms,activeFillGroup:{value:0},fillColor:{value:new c(16777215)}},this.defines={...this.defines,...U.itemAttrDefines},this.side=xt,this.depthWrite=!1,this.depthTest=!1,this.transparent=!0,Ro.use(this),So.use(this)}}class To extends In{constructor(){super(...arguments),r(this,"isActive",null),r(this,"isPressed",!1),r(this,"isClicked",!1),r(this,"needsRender",!1),r(this,"needsPrerender",!1),r(this,"hasRenderFill",!1),r(this,"currentGroup",-1),r(this,"color",new c),r(this,"timeSinceActive",0),r(this,"fade",0)}init(){B((()=>U.$app.$editor.edition.toolParams.fillColor),(e=>{const t=Lt(Gt(e));this.color.set(t[0]/255,t[1]/255,t[2]/255).convertSRGBToLinear()}),{immediate:!0}),this.scene.item.onBeforeRender(this.renderFill.bind(this)),this.material=new Do}update(){const e=U.$app.$controls.touch,t=U.$app.$editor,s=U.$app.$editor.edition.activeTool,i=U.$time.dt,r=t.controls.canForceRotate;this.isClicked=!r&&e.clickOut&&this.isPressed,this.isPressed=!r&&e.primaryPressed;"fill"===s?this.timeSinceActive<150?(this.isActive=!1,this.timeSinceActive+=i):this.isActive=!0:(this.isActive=!1,this.timeSinceActive=0);const n=U.$app.$editor.controls,o=n.pointerClip.x,a=n.pointerClip.y,A=this.isActive&&this.parent.raycast(o,a);if(this.isActive&&(!A&&e.clickIn&&t.controls.toggleForceRotate(),e.primaryPressed)){const s=e.relativePos;Math.sqrt(s.x*s.x+s.y*s.y)>20&&t.controls.toggleForceRotate()}const l=A&&this.parent.getPartFromIntersect(A),c=this.scene.item.mesh.material,h=!r&&t.controls.canUseClickTools()&&(e.useTouch&&this.isClicked||t.controls.isMouseInCanvas),u=c.uniforms.fillPreviewState.value,g=c.uniforms.fillPreviewColor.value;if(!(h&&A&&l&&l.canFill))return this.fade=0,void u.set(-1,0);const d=l.paintGroup;this.currentGroup!==d&&(this.fade=0,this.currentGroup=d);const p=.5*Math.sin(this.fade-.5*Math.PI)+.5;u.set(d,p),g.copy(this.color),this.fade+=.011*i,e.useTouch&&(this.fade=0),this.isClicked&&this.queueRender(),this.hasRenderFill&&(this.hasRenderFill=!1,this.scene.item.shake(.9))}updateActive(){}queueRender(){this.needsRender=!0,this.parent.depth.needsRender=!0,this.parent.seamsFixer.needsRender=!0,this.parent.history.push("PAINT_RT")}async prerender(){this.needsPrerender=!0,this.parent.depth.needsPrerender=!0,this.parent.seamsFixer.needsPrerender=!0}prerenderFill(e,t,s){this.needsPrerender=!1;const i=U.$threeRenderer,r=i.getRenderTarget(),n=this.scene.item.mesh,o=this.material;i.setRenderTarget(U.$assets.nullRT),i.renderBufferDirect(s,null,n.geometry,o,n,null),i.setRenderTarget(r)}renderFill(e,t,s){if(this.needsPrerender&&this.prerenderFill(e,t,s),!this.needsRender)return;this.needsRender=!1,this.log("render");const i=U.$threeRenderer,r=this.scene.item.mesh,n=i.getRenderTarget(),o=this.material,a=o.uniforms;a.activeFillGroup.value=this.currentGroup,a.fillColor.value.copy(this.color),this.scene.disableClampRender(),i.setRenderTarget(this.parent.paintRT),i.renderBufferDirect(s,null,r.geometry,o,r,null),i.setRenderTarget(n),this.scene.clampRenderBounds(),this.hasRenderFill=!0,U.$app.$editor.persistence.requestAutosave()}}const Mo=new u,_o=Jt("undw3-imgs");let Fo=[];class Po extends In{constructor(s){super(s),o(this,e,null),o(this,t,!1),r(this,"raycaster",new Yt);let i=Kt;U.$app.$device.type.phone&&(i=Kt);const n=this.textureSize={width:i,height:i},a=U.$fbo.createBuffer;this.paintRT=a({...n,name:"paint",depth:!1})}init(){var e,s,i;this.base=null,this.depth=this.add($n),this.brush=this.add(Nn),this.sticker=this.add(vo),this.picker=this.add(bo),this.fill=this.add(To),this.history=this.add(jn),this.seamsFixer=this.add(oo),this.expert=this.add(Ao),n(e=this,s=t,"read from private field"),(i?i.call(e):s.get(e))&&(this.seamsFixer.needsRender=!0),this.texture=this.seamsFixer.texture,this.uniforms={},this.uniforms.paintMap={value:this.texture},this.raycaster.firstHitOnly=!0}async load(){const e=await _o.getItem("paint_rt");if(!e)return;const s=new Blob([e],{type:"image/png"}),i=await createImageBitmap(s),r=new k;var o,a,A,l;r.image=i,r.generateMipmaps=!1,r.needsUpdate=!0,r.premultiplyAlpha=!0,Kn(r,this.paintRT,{multiplyAlpha:!0}),r.dispose(),A=!0,n(o=this,a=t,"write to private field"),l?l.call(o,A):a.set(o,A)}prerender(){U.$threeRenderer.initRenderTarget(this.paintRT),this.brush.prerender(),this.fill.prerender(),this.depth.prerender(),this.seamsFixer.prerender(),this.expert.prerender(),this.sticker.prerender(),this.history.prerender()}raycast(e,t,s){const i=U.$app.$editor.controls,{scene:r,raycaster:n}=this,o=r.getCurrentCamera().cam;void 0===e?Mo.copy(i.pointerClip):Mo.set(e,t),n.setFromCamera(Mo,o),Fo.length=0;const a=r.item.mesh,A=n.intersectObject(s??a,!1,Fo);return null==A?void 0:A[0]}getPartFromIntersect(e){if(!e)return null;const t=this.scene.item.mesh.geometry,s=e.faceIndex,i=t.index.getX(3*s),r=t.attributes.partIndex.array[i];return U.$app.$editor.getPartConfig(this.scene.item.id,r)}async importExpertImage(e){await this.expert.importImage(e),U.$app.$editor.persistence.requestAutosave()}reset(){io(this.paintRT,!0,!1,!1),this.seamsFixer.reset(),this.history.reset(),U.$app.$editor.persistence.autosave()}async toFile(){let e=this.paintRT,t=this.seamsFixer.rt;const s=t,i=()=>new Promise((e=>requestAnimationFrame(e))),r=new E(this.paintRT.width,this.paintRT.height);for(let a=0;a<10;a++){if(this.seamsFixer.rt=t,this.seamsFixer.inflateFilter.material.uniforms.map.value=e.texture,this.seamsFixer.needsRender=!0,this.seamsFixer.renderFix(),0===a)e=t,t=r;else{let s=e;e=t,t=s}await i()}Kn(s.texture,r,{multiplyAlpha:!0}),await i(),this.seamsFixer.rt=s,this.seamsFixer.inflateFilter.material.uniforms.map.value=this.paintRT.texture;const n=await Ht.toBuffer(r);r.dispose(),await i();const o=new Blob([n.result.buffer],{type:"image/png"});return new File([o],"paintTexture.png",{lastModified:Date.now(),type:"image/png"})}}e=new WeakMap,t=new WeakMap;let Uo=new Set,ko=new Set;const Lo=new Re;class Go extends wn{constructor(){super(...arguments),r(this,"isMoving",!1),r(this,"lastMoveAt",0),r(this,"forwardPt",new Re)}init(){this.base=this.cam=new Je(45,1,.1,200),this.base.position.y=1,this.base.position.z=7,this.base.lookAt(0,0,0),this.base.updateMatrixWorld(),this.base.layers.set(U.layers.base)}afterUpdate(){const e=this.base.localToWorld(Lo.set(0,0,-100));this.isMoving=!this.forwardPt.equals(e),this.forwardPt.copy(e),this.isMoving&&(this.lastMoveAt=performance.now())}}const No=["radius","phi","theta","x","y","z"],Oo=new Re(0,1,0),qo=new Re,Ho=new Re,zo=new Ot;new Re;const Vo={minDolly:2.6,maxDolly:12.1,minPhi:.15,maxPhi:.85*Math.PI,minTheta:-Infinity,maxTheta:Infinity,minTargetRadius:-Infinity,maxTargetRadius:4},$o={tweening:{target:.195,dolly:.19*1.5,spherical:.195},active:{target:.35,dolly:.35,spherical:.35},activeTouch:{target:.89,dolly:.89,spherical:.89},instant:{target:1,dolly:1,spherical:1},idle:{target:.09,dolly:.35,spherical:.11}};function Yo(e,t,s,i){return s>=1?t:kt(e,t,s,i)}class Jo{constructor(e){r(this,"domElement",U.$renderer.instance.domElement),r(this,"limits",{...Vo}),r(this,"eases",{...$o}),r(this,"cursor",new Re),r(this,"isDirectionalZoom",!1),r(this,"zoomDirection",new Re),r(this,"spherical",new Ot),r(this,"sphericalSmooth",new Ot),r(this,"sphericalDelta",new Ot),r(this,"spherical0",new Ot),r(this,"offset",new Re(0,0,0)),r(this,"target",new Re),r(this,"targetSmooth",new Re),r(this,"targetDelta",new Re),r(this,"zoomDelta",0),r(this,"zoomTarget",0),r(this,"isTweening",!1),r(this,"prevIsGrabbing",!1),r(this,"isGrabbing",!1),r(this,"isTouching",!1),r(this,"isInstant",!1),r(this,"isWheelZooming",!1),r(this,"currentTweenId",0),r(this,"isTweenFinished",!0),r(this,"isClampingDisabled",!1),this.object=e,this.setSphericalFromVector3(this.object.position,!0),this.qtUp=(new st).setFromUnitVectors(e.up,Oo),this.qtUpInverse=this.qtUp.clone().invert(),this.spherical0.copy(this.spherical)}updateDefaultSpherical(e){e&&this.spherical0.copy(e)}setLimits(e){Object.assign(this.limits,e)}rotateLeft(e){this.isTweenLocked||(this.sphericalDelta.theta-=e)}rotateUp(e){this.isTweenLocked||(this.sphericalDelta.phi-=e)}getZoomScale(e){const t=Math.abs(.01*e);return Math.pow(.95,t)}setSphericalFromVector3(e,t){qo.copy(e).sub(this.target),this.spherical.setFromVector3(qo),t&&this.sphericalSmooth.copy(this.spherical)}pan(e,t){if(this.isTweenLocked)return;const s=this.domElement,i=this.object,r=i.position;qo.copy(r).sub(this.target);let n=qo.length();n*=Math.tan(i.fov/2*Math.PI/180),this.panLeft(2*e*n/s.clientHeight),this.panUp(2*t*n/s.clientHeight)}panLeft(e){if(this.isTweenLocked)return;const t=this.object.matrix;Ho.setFromMatrixColumn(t,0),Ho.multiplyScalar(-e),this.targetDelta.add(Ho)}panUp(e){if(this.isTweenLocked)return;const t=this.object.matrix;Ho.setFromMatrixColumn(t,1),Ho.multiplyScalar(e),this.targetDelta.add(Ho)}zoom(e,t,s){const{object:i,isTweenLocked:r,domElement:n,zoomDirection:o}=this;if(!r){if(this.isDirectionalZoom=null!=t||null!=s,this.isDirectionalZoom){const e=n.getBoundingClientRect(),r=t-e.left,a=s-e.top;let A=r/e.width*2-1,l=-a/e.height*2+1;o.set(A,l,1).unproject(i).sub(i.position).normalize().multiplyScalar(1.4)}e<0?this.dollyIn(this.getZoomScale(e)):e>0&&this.dollyOut(this.getZoomScale(e))}}dollyOut(e){this.isTweenLocked||(this.sphericalDelta.radius/=e)}dollyIn(e){this.isTweenLocked||(this.sphericalDelta.radius*=e)}reset(e=!1){this.moveTo(this.spherical0,qo.setScalar(0),e)}import(e,t=!1){return zo.set(e[0],e[1],e[2]),qo.set(e[3],e[4],e[5]),this.moveTo(zo,qo,t)}export(e,t=!1){e||(e=new Array(6));const s=t?this.target:this.targetSmooth,i=t?this.spherical:this.sphericalSmooth,r=qo.copy(s);for(let n=0;n<3;n++)e[n]=i[No[n]];for(let n=3;n<6;n++)e[n]=r[No[n]];return e}moveTo(e,t,s=!1){return e instanceof Ot?this.spherical.copy(e):this.spherical.setFromVector3(e),this.spherical.theta=jt(0,this.spherical.theta),this.sphericalSmooth.theta=jt(0,this.sphericalSmooth.theta),this.target.copy(t),this.currentTweenId++,this.isTweening=this.isTweenLocked=!0,this.isTweenFinished=!1,s&&(this.sphericalSmooth.copy(this.spherical),this.targetSmooth.copy(this.target),this.isTweening=this.isTweenLocked=!1,this.isTweenFinished=!0),this.currentTweenId}resetDeltas(){this.targetDelta.set(0,0,0),this.sphericalDelta.set(1,0,0),this.isDirectionalZoom=!1}clampSpherical(e){if(this.isClampingDisabled)return;const{limits:t}=this;e.theta=A(e.theta,t.minTheta,t.maxTheta),e.phi=A(e.phi,t.minPhi,t.maxPhi),e.radius=A(e.radius,t.minDolly,t.maxDolly),e.makeSafe()}clampTargetToCursor(e){if(this.isClampingDisabled)return;const{limits:t,cursor:s}=this,i=qo.copy(s);e.sub(i),e.clampLength(t.minTargetRadius,t.maxTargetRadius),e.add(i)}setGrab(e,t){this.isGrabbing=e,this.isTouching=e&&t}setTargetToSmooth(){this.spherical.copy(this.sphericalSmooth),this.target.copy(this.targetSmooth)}update(){const{object:e,spherical:t,sphericalSmooth:s,sphericalDelta:i,target:r,targetSmooth:n,targetDelta:o,limits:a,isTweenLocked:l,prevIsGrabbing:c,isGrabbing:h,isTweening:u,isTouching:g,isInstant:d,qtUp:p,zoomDirection:f}=this,m=U.$time.stableDt,I=e.position;if(l&&this.resetDeltas(),this.isDirectionalZoom){const s=this.isWheelZooming;this.isTouching||(this.isWheelZooming=!0),!s&&this.isWheelZooming&&this.setTargetToSmooth(),l||(this.isTweening=!1);let n=qo;n.setFromSpherical(t).applyQuaternion(this.qtUp),I.copy(r).add(n);const o=t.radius*i.radius,c=t.radius-A(o,a.minDolly,a.maxDolly);I.addScaledVector(f,c),e.updateMatrixWorld(),n.copy(I).sub(r).applyQuaternion(p);const h=zo.setFromVector3(n),u=h.radius-t.radius;t.radius+=u,this.clampSpherical(h),this.clampSpherical(t);const g=qo.setFromSpherical(h).add(r),d=Ho.setFromSpherical(t).add(r);r.add(g.sub(d))}h&&this.isWheelZooming&&(this.isWheelZooming=!1),h&&!l&&(this.isTweening=!1);let C=this.eases.idle;d?C=this.eases.instant:u?C=this.eases.tweening:h&&g?C=this.eases.activeTouch:(h||this.isWheelZooming)&&(C=this.eases.active),h&&!c?(this.prevIsGrabbing=!0,this.setTargetToSmooth()):!h&&c&&(this.prevIsGrabbing=!1),t.theta+=i.theta,t.phi+=i.phi,this.isDirectionalZoom||(t.radius*=i.radius),this.clampSpherical(t),s.theta=Yo(s.theta,t.theta,C.spherical,m),s.phi=Yo(s.phi,t.phi,C.spherical,m),s.radius=Yo(s.radius,t.radius,C.dolly,m),r.add(o),this.clampTargetToCursor(r),C.target>=1?n.copy(r):n.damp(r,C.target,m),this.assign(),this.resetDeltas(),this.isTweenLocked&&qo.copy(r).sub(this.targetSmooth).lengthSq()<.06&&jt(s.theta,t.theta)<.03&&jt(s.phi,t.phi)<.03&&Math.abs(s.radius-t.radius)<.06&&(this.isTweenLocked=!1),!this.isTweenFinished&&qo.copy(r).sub(this.targetSmooth).lengthSq()<.01&&jt(s.theta,t.theta)<.02&&jt(s.phi,t.phi)<.02&&Math.abs(s.radius-t.radius)<.01&&(this.isTweenFinished=!0)}assign(){const e=qo;e.setFromSpherical(this.sphericalSmooth),e.applyQuaternion(this.qtUp),this.object.position.copy(this.targetSmooth).add(e),this.object.lookAt(this.targetSmooth)}}class Ko{constructor(e={}){this.isMixin=!0,this.isCreated=!1,this.isDestroyed=!1,this.options=e,this.base=null,this.webgl=b()}created(){}used(){}unused(){}destroyed(){}componentAttached(){}componentDetached(){}use(e){if(this.isDestroyed||this.base===e)return;this.base=e;const t=e.usedMixins;this.uid&&e.uid!==this.uid||(this.uid=e.uid,this.isCreated||(this.static=null!=this.static?this.static:!this.update,this.isCreated=!0,this.created(e,this.options)),t.push(this),this.static||t.dynamic.push(this),this.used(e))}unuse(){if(this.isDestroyed||!this.base)return;let e;this.unused(this.base),e=this.base.usedMixins.indexOf(this),e>=0&&this.base.usedMixins.splice(e,1),e=this.base.usedMixins.dynamic.indexOf(this),e>=0&&this.base.usedMixins.dynamic.splice(e,1),this.base=null}destroy(){if(this.isDestroyed)return;const e=this.base;this.unuse(),this.base=e,this.destroyed(),this.base=null,this.isDestroyed=!0,this.options=null,this.webgl=null}extendProto(e,t,s){const i=this.base.constructor.prototype;!s&&i[e]||(i[e]=t)}}class Wo extends Ko{created(){const e=this.base;e._disposablesSignals=[],e._unwatchers=[],e.store||(e.store={}),e.hooks||(e.hooks={}),this.effectScope=Xt(!0);const t=e.init.bind(e);e.init=()=>this.effectScope.run(t),this.options.extendProto?(this.extendProto("watchSignal",Xo),this.extendProto("watchSignalImmediate",Zo),this.extendProto("addWatcher",jo)):(e.watchSignal=vt(Xo,e,4),e.watchSignalImmediate=vt(Zo,e,3),e.addWatcher=vt(jo,e,1))}destroyed(){const e=this.base;for(let t=0,s=e._unwatchers.length;t<s;t++)e._unwatchers[t]();this.effectScope&&(this.effectScope.stop(),this.effectScope=null);for(let t=0,s=e._disposablesSignals.length;t<s;t++){const s=e._disposablesSignals[t];s.destroy?s.destroy():s.unwatch&&s.unwatch()}for(let t in e.store){const s=e.store[t];s.unwatchAll&&s.unwatchAll()}for(let t in e.hooks){const s=e.hooks[t];s.unwatchAll&&s.unwatchAll()}e.store=e.hooks=null,e._disposablesSignals=null}}function jo(e){if(Array.isArray(e))for(let t=0,s=e.length;t<s;t++)this.addWatcher(e[t]);else e.isSignal?this._disposablesSignals.push(e):"function"==typeof e&&this._unwatchers.push(e);return e}function Xo(e,t,s,i=!1){"string"==typeof t&&(t=this[t]),s||(s=this);const r=i?e.watchImmediate(t,s):e.watch(t,s);return this._disposablesSignals.push(r),r}function Zo(e,t,s){return this.watchSignal(e,t,s,!0)}let ea=0,ta=class extends Ko{created(){this._animsArray=[],this._animsMap=new Map,this.base.timeline=vt(this.timeline,this,2),this.base.tween=vt(this.tween,this,2),this.base.clearAnim=vt(this.clearAnim,this,1),this.base.isAnimRunning=vt(this.isAnimRunning,this,1)}clearAnim(e){if(void 0!==e)return this._removeAnim(e);for(let t=this._animsArray.length-1;t>=0;t--)this._removeAnim(!0,t,this._animsArray[t])}_addAnim(e,t){return this._animsArray.push(t),void 0===e||(t.__id=e??"ANIM_AUTOID_"+ea++,this._animsMap.set(e,t)),t}_removeAnim(e,t,s){if(void 0!==e&&(s=s??this._animsMap.get(e)))return s.isTimeline?s.destroy(!0,!0,!0):s.destroy(),this._animsMap.delete(e),this._animsArray.splice(t??this._animsArray.indexOf(s),1),s}isAnimRunning(e){const t=this._animsMap.get(e);return t&&!t.isCompleted}tween(e,{selfDestruct:t=!0,...s}={}){this._animsMap.get(e)&&this.clearAnim(e);const i=Zt({...s,manualUpdate:!0});return i.__selfDestruct=t,this._addAnim(e,i),i}timeline(e,{selfDestruct:t=!0,...s}={}){this._animsMap.get(e)&&this.clearAnim(e);const i=es({...s,manualUpdate:!0});return i.__selfDestruct=t,this._addAnim(e,i),i}update(){const e=U.$time.dt;for(let t=this._animsArray.length-1;t>=0;t--){const s=this._animsArray[t];s?s&&s.__selfDestruct&&(s.isCompleted||s.destroyed)?this._removeAnim(s.__id,t):s.update(e):this._removeAnim(s.__id,t)}}destroyed(){this.clearAnim(null)}};const sa=new u,ia=new Ot;class ra extends Go{constructor(){super(...arguments),r(this,"wasZoomed",!1),r(this,"currentSph0",null),r(this,"forcedPreset",null),r(this,"forcedInfluence",0),r(this,"forcedPos",new Qt),r(this,"forcedQt",new st),r(this,"forcedPosTarget",new Qt),r(this,"forcedQtTarget",new st),r(this,"tilt",0),r(this,"tiltTarget",0),r(this,"rotationTransition",0),r(this,"transformTransition",0),r(this,"viewOffset",[0,0,0,0])}get mixins(){return[ta]}init(){super.init(),this.base.position.y=-.05,this.base.position.z=8,this.base.lookAt(0,0,0),this.ang=0,this.angY=0,this.controls=new Jo(this.base),this.offsetY=2.5,this.targetOffsetY=this.offsetY,this.base.zoom=1,this.initial=U.$app.$editor.persistence.initialCameraPreset??null;const e=this.initial&&this.initial.every((e=>0===e));this.initial&&!e&&this.import(this.initial,!0)}reset(){this.controls.reset()}updateBaseViewOffset(){const e=U.$threeRenderer.getSize(sa),t=this.viewOffset,s=e.x,i=e.y,r=this.scene.thumbGen.offsetY/2;t[0]=s,t[1]=i,t[2]=0,t[3]=r}resetViewOffset(){const e=this.viewOffset;this.base.setViewOffset(e[0],e[1],e[2],e[3],e[0],e[1])}setCustomViewOffset(e,t,s,i,r,n){const o=this.viewOffset;this.base.setViewOffset(e,t,s+o[2],i+o[3],r,n)}updateDefaultSpherical(){const e=this.scene.item;if(e&&e.config.camSpherical0!==this.currentSph0){this.currentSph0=e.config.camSpherical0;const t=this.currentSph0?ia.set(...this.currentSph0):null;this.controls.updateDefaultSpherical(t)}}beforeSceneUpdate(){const e=this.controls,t=U.$app.$editor.controls.isDrawing;e.isInstant=t,this.updateDefaultSpherical(),this.base.zoom=this.scene.thumbGen.scale,this.updateBaseViewOffset(),this.resetViewOffset(),!this.isDrawing&&t&&(this.lastDrawingAt=performance.now(),e.setTargetToSmooth(),e.setGrab(!0,!0),e.update(),this.addOffsets()),this.isDrawing=t}update(){const e=this.controls,t=U.$app.$editor.controls,{orbit:s,pan:i,zoom:r,pointerScreen:n}=t,o=U.$time.stableDt;0!==s.x&&e.rotateLeft(s.x),0!==s.y&&e.rotateUp(s.y),r&&e.zoom(-300*r,n.x,n.y),0===i.x&&0===i.y||e.pan(i.x,i.y);const a=U.$app.$overlay.isOverlayVisible;this.wasZoomed!==a&&(this.wasZoomed=a,a?(e.isClampingDisabled=!0,e.zoom(250)):(e.isClampingDisabled=!1,e.zoom(-250)));const A=this.scene.item.camOffsetY??0,l=this.scene.item.mesh.userData.offsetY??-2.1;this.targetOffsetY=-l+A;t.isDrawing||(this.offsetY=ts(this.offsetY,this.targetOffsetY,.09,o,.001)),this.isDrawing?e.assign():(e.setGrab(t.isRotating||t.isPanning||t.isDrawing,U.$app.$editor.controls.useTouch),e.update()),this.tilt=ts(this.tilt,this.tiltTarget,.21,o,.001),this.addOffsets()}addOffsets(){this.cam.position.y+=this.offsetY,this.cam.rotateZ(this.tilt),this.cam.updateMatrixWorld()}zoomIn(){this.controls.zoom(-500)}zoomOut(){this.controls.zoom(500)}import(e,t){return this.controls.import(e,t)}export(e,t){return this.controls.export(e,t)}setForcedPreset(e,t=!1){const s=this.controls.eases.tweening;if(e)"string"==typeof e&&(e=this.scene.item.config.camPresets[e]),this.import(e.ctrls,t),this.tiltTarget=e.camTilt,this.controls.eases.tweening=$o.tweening,s.target=.095,s.dolly=.19,s.spherical=.13;else{this.tiltTarget=0;for(const e in s)s[e]=$o.tweening[e]}t&&(this.tilt=this.tiltTarget)}}const na=new dt,oa=new ss(1,1,1,64,1);oa.scale(-1,-1,-1);class aa extends In{init(){this.base=new M(this.geo??oa,this.mat),this.base.renderOrder=U.z.background,this.base.scale.set(100,150,100),this.prevMesh=null,this.base.matrixWorldAutoUpdate=!1,this.base.updateMatrixWorld(),this.base.layers.set(U.layers.base)}set color(e){this.mat.uniforms.color.value.copy(e)}get color(){return this.mat.uniforms.color.value}update(){const e=this.scene.item.mesh.uuid;this.prevMesh!==e&&this.updateGround()}updateGround(){const e=this.scene.item.mesh;if(this.prevMesh=e.uuid,!e)return;e.geometry.boundingBox||e.geometry.computeBoundingBox();const t=na;e.updateMatrixWorld(),t.copy(e.geometry.boundingBox).applyMatrix4(e.matrixWorld),this.mat.groundLevel=t.min.y}}const Aa=Rn("precision highp float;\n#include <common>\n#include <dithering_pars_fragment>\n#include <fog_pars_fragment>\nvarying vec2 vUv;varying vec3 vPos;uniform vec4 res;uniform vec3 color;void main(){vec2 sp=gl_FragCoord.xy/res.xy;vec2 uv=vUv;uv=fract(uv*vec2(150.,33.)*2.);float circle=1.-smoothstep(0.05,0.08,length(uv-0.5));float grad=smoothstep(0.9,0.1,sp.y);vec3 bg=mix(mix(color,color*color,0.7),color*1.02+0.05,grad*1.6+0.4);gl_FragColor=vec4(bg,1.);\n#include <colorspace_output_srgb>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}","fragmentShader"),la=Rn("#include <common>\n#include <fog_pars_vertex>\nvarying vec2 vUv;varying vec3 vPos;void main(){vUv=uv;vec3 transformed=vec3(position);vec4 mvPosition=vec4(transformed,1.0);mvPosition=modelViewMatrix*mvPosition;vPos=position;gl_Position=projectionMatrix*mvPosition;\n#include <fog_vertex>\n}","vertexShader");class ca extends P{constructor(){super(),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="EditorBgMaterial",this.uniforms={...this.uniforms,res:U.$uniforms.res,groundLevel:{value:0},color:{value:new c}},this.defines={...this.defines},this.depthWrite=!1,this.transparent=!0,la.use(this),Aa.use(this)}set groundLevel(e){this.uniforms.groundLevel.value=e}get groundLevel(){return this.uniforms.groundLevel.value}}class ha extends aa{constructor(){super(...arguments),r(this,"mat",new ca)}}const ua=Rn("#include <common>\n#include <dithering_pars_fragment>\n#include <fog_pars_fragment>\nuniform vec4 res;uniform float opacity;uniform vec3 color;uniform sampler2D map;varying vec2 vUv;varying vec3 vPos;varying float vFade;void main(){vec2 sp=gl_FragCoord.xy/res.xy;vec2 uv=vPos.xy;float shadow=0.;shadow=texture2D(map,(vUv-0.5)*1.8+0.5).a;float dist=length(vUv.xy-0.5);float s=9.;float eps=0.02;uv*=s;vec2 g=vec2(0.);vec2 guv=uv;guv.x+=0.5*step(0.5,fract(guv.y));guv=abs(fract(guv)-0.5);g.x=smoothstep(0.25-eps,0.25+eps,guv.x);guv-=0.25;guv.y+=0.5*step(0.5,fract(guv.x));guv=abs(fract(guv)-0.5);g.y=smoothstep(0.25-eps,0.25+eps,guv.y);float grid=smoothstep(0.9,0.4,g.y*g.x)*0.3;float falloff=smoothstep(0.8,0.0,length(vPos.xy));vec3 bgColor=color*0.92;vec3 bg=mix(bgColor,bgColor,smoothstep(0.2,1.,smoothstep(0.9,0.2,sp.y)));vec3 col=bg;vec3 shadowTint=bg*bg*bg*bg;col=mix(col,col*shadowTint*0.8,grid*0.32);col=mix(col,col*shadowTint*0.2-0.05,shadow*1.0);col=mix(col,col*shadowTint*0.8,smoothstep(0.4,0.0,dist)*0.3);falloff*=opacity;gl_FragColor=vec4(col,falloff);\n#include <colorspace_output_srgb>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}","fragmentShader"),ga=Rn("#include <common>\n#include <fog_pars_vertex>\nuniform float time;varying vec2 vUv;varying vec3 vPos;varying float vFade;void main(){vUv=uv;vec3 transformed=vec3(position);float d=length(transformed.xz);vec4 mvPosition=vec4(transformed,1.0);mvPosition=modelViewMatrix*mvPosition;vec3 viewDirection=-mvPosition.xyz;vec3 transformedNormal=vec3(normal);transformedNormal=normalMatrix*transformedNormal;vPos=position;vFade=dot(normalize(transformedNormal),normalize(mvPosition.xyz));gl_Position=projectionMatrix*mvPosition;\n#include <fog_vertex>\n}","vertexShader"),da=_n("uniform float diag;uniform vec4 color1;uniform vec4 color2;uniform vec4 color3;uniform float time;uniform sampler2D perlin;float circle(float rad){vec2 spr=gl_FragCoord.xy/res.xy-0.5;vec2 sp=spr*res.xy;rad*=diag;vec3 n=texture2D(perlin,gl_FragCoord.xy).rgb;sp.x+=cos(spr.y*5.5+time*10.2)*40.;return 1.-smoothstep(rad,rad+0.1*res.x,length(sp));}",0,"color_mask_chunk_pars"),pa=_n("vec3 color=vec3(0.8);color=mix(color,color1.rgb,circle(color1.a)*smoothstep(0.,0.4,color1.a));color=mix(color,color2.rgb,circle(color2.a)*smoothstep(0.,0.4,color2.a));",0,"color_mask_chunk");let fa=!1;const ma={uniforms:{},setupMaterial:e=>{fa||(Object.assign(ma.uniforms,{time:U.$uniforms.time,diag:{value:.5},color1:{value:new Qt(0,0,0,0)},color2:{value:new Qt(0,0,0,0)},perlin:{value:U.$assets.textures.noise_perlin}}),U.$viewport.size.watchImmediate((e=>{const t=Math.sqrt(e.width**2+e.height**2);ma.uniforms.diag.value=t})),fa=!0),Object.assign(e.uniforms,ma.uniforms),da.use(e),pa.use(e)}};class Ia extends P{constructor(){super(),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="GroundMaterial",this.uniforms={...this.uniforms,res:U.$uniforms.res,map:{value:U.$assets.textures.null},opacity:{value:0},color:{value:new c}},this.defines={...this.defines},this.transparent=!0,ga.use(this),ua.use(this),ma.setupMaterial(this)}get map(){return this.uniforms.map.value}set map(e){this.uniforms.map.value=e}}function Ca(e,t){var s,i,r,n,o,a,A,l;const c=U.$assets.textures.null;if(!t)return c;if(null==e.__currentSwapTex)return(e=t).__currentSwapTex=t.uuid,t;{if(e.__currentSwapTex===t.uuid)return e||c;const h=(null==(s=null==e?void 0:e.image)?void 0:s.naturalWidth)??(null==(i=null==e?void 0:e.image)?void 0:i.width),u=(null==(r=null==e?void 0:e.image)?void 0:r.naturalHeight)??(null==(n=null==e?void 0:e.image)?void 0:n.height),g=(null==(o=null==t?void 0:t.image)?void 0:o.naturalWidth)??(null==(a=null==t?void 0:t.image)?void 0:a.width),d=(null==(A=null==t?void 0:t.image)?void 0:A.naturalHeight)??(null==(l=null==t?void 0:t.image)?void 0:l.height);return h!==g||u!==d?(e.__currentSwapTex=null,e.dispose(),t.__currentSwapTex=t.uuid,t):(e.__currentSwapTex=t.uuid,U.$threeRenderer.copyTextureToTexture(t,e),e)}}const Ba=Rn("precision highp float;\n#define STANDARD\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <map_pars_fragment>\n#include <aomap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <tonemapping_chunk_pars>\nmat3 getTangentFrame(vec3 eye_pos,vec3 surf_norm,vec2 uv){vec3 q0=dFdx(eye_pos.xyz);vec3 q1=dFdy(eye_pos.xyz);vec2 st0=dFdx(uv.st);vec2 st1=dFdy(uv.st);vec3 N=surf_norm;vec3 q1perp=cross(q1,N);vec3 q0perp=cross(N,q0);vec3 T=q1perp*st0.x+q0perp*st1.x;vec3 B=q1perp*st0.y+q0perp*st1.y;float det=max(dot(T,T),dot(B,B));float scale=(det==0.0)?0.0:inversesqrt(det);return mat3(T*scale,B*scale,N);}uniform vec3 diffuse;uniform vec3 emissive;uniform float roughness;uniform float metalness;uniform float opacity;uniform vec4 res;uniform float time;uniform float showProgress;varying vec3 vViewPosition;varying vec4 vClipPos;varying vec2 vUv;vec2 rotate2D(vec2 v,float a){float s=sin(a);float c=cos(a);mat2 m=mat2(c,s,-s,c);return m*v;}void main(){ReflectedLight reflectedLight=ReflectedLight(vec3(0.),vec3(0.),vec3(0.),vec3(0.));vec3 totalEmissiveRadiance=emissive;vec2 newUV=rotate2D(vUv,-.4);float threads=vUv.y;int maxThreads=100;float fMaxThreads=float(maxThreads);for(int i=0;i<maxThreads;i++){float index=float(i);float gradient=mix(newUV.y,1.-newUV.y,mod(index,2.));threads=mix(threads,gradient/fMaxThreads+(index/fMaxThreads),step(index/fMaxThreads,newUV.x));}float a=smoothstep(threads-.05,threads,mod(showProgress,1.31));float aB=smoothstep(threads-.03,threads+.3,mod(showProgress,1.31));vec4 diffuseColor=vec4(diffuse,opacity);vec4 sampledDiffuseColor=texture2D(map,vec2(vUv.x,vUv.y*.6+(vUv.y*.4*aB)+.1*(1.-aB)));diffuseColor*=sampledDiffuseColor;diffuseColor.rgb+=diffuseColor.rgb*.75*(1.-aB);diffuseColor.rgb=mix(pow(diffuseColor.rgb*0.9478672986+vec3(0.0521327014),vec3(1.9)),diffuseColor.rgb*0.0773993808,vec3(lessThanEqual(diffuseColor.rgb,vec3(0.04045))));if(diffuseColor.a<0.1)discard;float normalFactor=1.0;float roughnessFactor=roughness;float metalnessFactor=metalness;float faceDirection=gl_FrontFacing?1.0:-1.0;vec3 normal=normalize(vNormal);mat3 tbn=getTangentFrame(-vViewPosition,normal,vUv);vec3 nonPerturbedNormal=normal;vec3 mapN=texture2D(map,vUv+vec2(0.,0.5)).xyz*2.0-1.0;mapN.xy*=normalFactor*-0.9;normal=normalize(tbn*mapN);\n#include <emissivemap_fragment>\n#include <lights_physical_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 totalDiffuse=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse*0.75;vec3 totalSpecular=reflectedLight.directSpecular+reflectedLight.indirectSpecular;vec3 outgoingLight=totalDiffuse+totalSpecular+totalEmissiveRadiance;float fresnel=pow(1.-dot(geometryNormal,geometryViewDir),1.5);outgoingLight=mix(outgoingLight,outgoingLight*2.4,fresnel);gl_FragColor=vec4(outgoingLight,1.);gl_FragColor.rgb=tonemapping(gl_FragColor.rgb)*1.2;gl_FragColor.a=a*diffuseColor.a;\n#include <fog_fragment>\n#include <colorspace_output_srgb>\n}","fragmentShader"),va=Rn("precision highp float;\n#define STANDARD\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\nvarying vec3 vViewPosition;varying vec4 vClipPos;varying vec2 vUv;void main(){vUv=uv;\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\nvNormal=normalize(transformedNormal);vClipPos=projectionMatrix*modelViewMatrix*vec4(position,1.0);}","vertexShader"),ya=_n("vec3 rrt_and_odt_fit(vec3 v){vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}vec3 tonemapping(vec3 color){const mat3 ACESInputMat=mat3(vec3(0.59719,0.07600,0.02840),vec3(0.35458,0.90834,0.13383),vec3(0.04823,0.01566,0.83777));const mat3 ACESOutputMat=mat3(vec3(1.60475,-0.10208,-0.00327),vec3(-0.53108,1.10813,-0.07276),vec3(-0.07367,-0.00605,1.07602));color*=2.16667;color=mix(color,color*color,0.25);color=ACESInputMat*color;color=ACESOutputMat*rrt_and_odt_fit(color);return clamp(color,0.0,1.0);}",0,"tonemapping_chunk_pars"),Ea={setupMaterial:function(e){ya.use(e)}};class wa extends Ge{constructor(){super(),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="LogoMaterial",this.transparent=!0,this.uniforms={showProgress:{value:0},...this.uniforms,...is.clone(rs.standard.uniforms),...U.$uniforms},this.defines={...this.defines},this.map=U.$assets.textures.null,this.side=lt,this.roughness=1,this.metalness=0,va.use(this),Ba.use(this),Ea.setupMaterial(this)}swapType(e,t){const s=U.$assets.textures["logo_"+e];this.map=Ca(this.map,s)}}class Qa extends In{constructor(){super(...arguments),r(this,"isHidden",!0)}get mixins(){return[ta]}init(){this.base=null,Qa.material||(Qa.material=new wa);const e=this.mesh=this.props.mesh;this.material=e.material=Qa.material,e.renderOrder=U.z.logo,e.frustumCulled=!1,e.visible=!1,e.layers.set(U.layers.base),e.layers.enable(U.layers.itemOnly),e.layers.enable(U.layers.thumbnail),e.matrixWorldAutoUpdate=!1,e.updateMatrixWorld()}beforeDestroy(){const e=this.mesh.geometry;e&&e.dispose()}showInstant(){this.isHidden=!1,this.mesh.visible=!0,this.clearAnim("anim"),this.mesh.material.uniforms.showProgress.value=1.3}hideInstant(){this.isHidden=!0,this.mesh.visible=!1,this.clearAnim("anim")}show(){this.clearAnim("anim");const e=this.timeline("anim");this.mesh.material.uniforms.showProgress.value=.1,e.to(this.mesh.material.uniforms.showProgress,{value:1.3,duration:430,easing:"outCubic"}),this.isHidden=!1,this.mesh.visible=!0}hide(){this.clearAnim("anim"),this.isHidden=!0,this.mesh.visible=!1}}const xa=Rn("uniform float occluding;void main(){float a=occluding;gl_FragColor=vec4(a,a,a,1.0);}","fragmentShader"),ba=Rn("precision highp float;\n#include <common>\n#include <conditionals>\n#include <float_packing>\n#include <skinning_pars_vertex>\nattribute float interiorOccluder;void main(){float interior=interiorOccluder;\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nvec4 mvPosition=modelViewMatrix*vec4(transformed,1.0);mvPosition+=-1000000.*when_lt(0.5,interior);gl_Position=projectionMatrix*mvPosition;}","vertexShader");class Sa extends P{constructor(){super(),this.isShaderMaterial=!0,this.type=this.name="InteriorMat",this.uniforms={occluding:{value:0}},this.defines={...this.defines},this.side=lt,ba.use(this),xa.use(this)}}const Ra=new Me,Da=new Me,Ta=new Se,Ma=new Re,_a=new Re;Da.matrixAutoUpdate=!1,Ra.matrixAutoUpdate=!1;class Fa extends In{constructor(){super(...arguments),r(this,"instant",0),r(this,"logOnce",!1)}init(){const e=this.skeleton=this.props.skeleton;this.parseSkeleton(e)}parseSkeleton(){this.baseBones=[],this.bones=[];const e=this.skeleton.bones;for(let t=0;t<e.length;t++){const s=e[t];null!==s.parent&&s.parent.isBone||this.parseBones(s,0)}}parseBones(e,t,s){0===t&&this.baseBones.push(e),0===this.bones.length?e.updateWorldMatrix(!0,!0):0===t&&e.updateWorldMatrix(!1,!0),this.bones.push(e),e.updateMatrix(),e.wiggle={index:this.bones.length-1,level:t,parent:s??e.parent,matrix:e.matrix.clone(),matrix0:e.matrix.clone(),matrixWorld:e.matrixWorld.clone(),matrixWorld0:e.matrixWorld.clone(),wPosSmooth:e.getWorldPosition(new Re),wPos0:e.getWorldPosition(new Re),pos:e.position.clone(),pos0:e.position.clone(),scale0:e.scale.clone(),qt0:e.quaternion.clone(),wQt0:e.getWorldQuaternion(new st)};const i=e.children;for(let r=0;r<i.length;r++){const s=i[r];this.parseBones(s,t+1,e)}}reset(){this.instant=1;for(let e=0;e<this.bones.length;e++){const t=this.bones[e],s=t.wiggle;s.matrix.copy(s.matrix0),s.matrixWorld.copy(s.matrixWorld0),s.wPosSmooth.copy(s.wPos0),s.pos.copy(s.pos0),t.position.copy(s.pos0),t.matrix.copy(s.matrix)}}update(){const e=U.$time.dt,t=this.baseBones[0];t.parent&&t.parent.updateWorldMatrix(!0,!1),this.step(e),this.instant>0&&this.instant--}step(e){for(let t=0;t<this.bones.length;t++)this.boneStep(e,this.bones[t])}boneStep(e,t){var s;const i=t.wiggle,r=i.parent,n=(null==(s=null==r?void 0:r.wiggle)?void 0:s.matrixWorld)??(null==r?void 0:r.matrixWorld),o=Ma.copy(i.pos0);n&&o.applyMatrix4(n),this.instant>0?i.wPosSmooth.copy(o):i.wPosSmooth.damp(o,.32,e);const a=i.wPosSmooth;i.pos=_a.copy(a),i.pos.applyMatrix4(Ta.copy(n).invert()),i.matrix.compose(i.pos,i.qt0,i.scale0),n?i.matrixWorld.multiplyMatrices(n,i.matrix):i.matrixWorld.copy(i.matrix),t.position.copy(i.pos)}}const Pa=ns(),Ua=new Re,ka=new c,La=new st;class Ga extends In{constructor(){super(...arguments),r(this,"bones",[]),r(this,"tentacles",[]),r(this,"wiggleBones",[]),r(this,"needsUpdate",!1),r(this,"needsRender",!1),r(this,"lastMoveAt",0),r(this,"isMoving",!1),r(this,"isResting",!1),r(this,"isAlmostResting",!1),r(this,"prevNoRender",!1)}init(){if(this.queueMesh&&this.reset(this.queueMesh),!Ga.interiorRt){const e=Ga.interiorRt=U.$fbo.createBuffer({name:"interiorRt",format:L,scale:1});e.texture.format=L,e.texture.type=Z,e.texture.internalFormat="R8",Ga.interiorMat=new Sa}this.interiorMat=Ga.interiorMat,this.interiorRt=Ga.interiorRt,this.scene.item.onBeforeRender(this.renderInteriorRt.bind(this))}reset(e){var t,s,i;if(!this.scene)return this.queueMesh=e;this.queueMesh=null;const r=this.skeleton;this.skinnedMesh=null,this.baseBone=null,this.skeleton=null,this.bones.length=0,this.tentacles.length=0,e.traverse((e=>{e.skeleton?(this.skinnedMesh=e,this.skeleton=e.skeleton):e.isBone&&!e.parent.isBone&&e.children.length&&(this.baseBone=e)})),r&&this.skeleton!==r&&r.dispose(),this.baseBone&&this.initBone(this.baseBone),this.skeleton&&!this.skeleton.rig&&(this.skeleton.rig=new Fa({skeleton:this.skeleton}),this.skeleton.rig.init()),this.rig=null==(t=this.skeleton)?void 0:t.rig,this.rig&&(null==(i=(s=this.rig).reset)||i.call(s))}initBone(e,t=1,s=null){if(s||(s={idx:0}),!e.isInit){const i=e.name;e.isInit=!0,e.index=s.idx++,e.lvl=t,e.uid=Math.random();const r=e.position.x,n=e.position.y;e.noise=(e,t=1)=>Pa(r*t+e,n*t+e),e.isArm=i.match(/^[RL][0-9]$/),e.isTentacle=i.match(/^T[FB][RL][0-9]$/),e.wPos=e.getWorldPosition(new Re),e.pos0=e.position.clone(),e.qt0=e.quaternion.clone().normalize(),e.matrix0=e.matrix.clone(),e.matrixBackup=e.matrix.clone()}this.bones.push(e),e.isTentacle&&this.tentacles.push(e);for(let i=0;i<e.children.length;i++){const s=e.children[i];s.isBone&&this.initBone(s,t+1)}}update(){if(!this.skeleton)return;for(let i=0;i<this.bones.length;i++){const e=this.bones[i];this.updateBone(e)}this.rig&&this.rig.update();let e=0,t=1,s=1;for(let i=0;i<this.bones.length;i++){const r=this.bones[i],n=r.getWorldPosition(Ua),o=n.distanceToSquared(r.wPos);r.wPos.copy(n);const a=r.position.distanceToSquared(r.pos0),A=Math.abs(La.copy(r.quaternion).normalize().dot(r.qt0));t&=a<1e-6&&A>.99999999,s&=a<.001&&A>.99999,e|=o>1e-7}this.isMoving=!!e,this.isResting=!!t,this.isAlmostResting=!!s,this.isMoving&&(this.lastMoveAt=performance.now())}updateBone(e){U.$time.elapsed,this.resetBone(e)}backupBones(){for(let e=0;e<this.bones.length;e++){const t=this.bones[e];t.matrixBackup.copy(t.matrix)}}resetBone(e){e.matrix.copy(e.matrix0),e.matrix.decompose(e.position,e.quaternion,e.scale)}resetBones(){for(let e=0;e<this.bones.length;e++){const t=this.bones[e];this.resetBone(t)}}restoreBones(){for(let e=0;e<this.bones.length;e++){const t=this.bones[e];t.matrix.copy(t.matrixBackup),t.matrix.decompose(t.position,t.quaternion,t.scale)}}disableOccluder(){this.isForceDisabled=!0,this.scene.item.occluder._prevVisible=this.scene.item.occluder.visible,this.scene.item.occluder.visible=!1}enableOccluder(){this.isForceDisabled=!1,this.scene.item.occluder.visible=this.scene.item.occluder._prevVisible}renderInteriorRt(e,t,s){var i,r,n,o;const a=!this.isAlmostResting&&(this.scene.camera.isMoving||this.isMoving),A=this.scene.item.meshMaterial.uniforms.interiorMap,l=this.interiorRt.texture,c=this.isForceDisabled||!a&&!this.needsRender;if(c&&this.prevNoRender)return;this.prevNoRender=c,this.needsRender=!1;const h=U.$threeRenderer,u=this.scene.item.mesh,g=this.scene.item.occluder,d=h.getRenderTarget(),p=h.getClearAlpha(),f=h.getClearColor(ka),m=this.interiorMat;if(u){if(null==(r=(i=this.scene).disableClampRender)||r.call(i),h.setRenderTarget(this.interiorRt),h.setClearColor(0,0),h.clear(),!c&&(m.uniforms.occluding.value=1,h.renderBufferDirect(s,null,u.geometry,m,u,null),g)){const e=g.material,t=g.visible;g.material=m,g.visible=!0,m.uniformsNeedUpdate=!0,m.uniforms.occluding.value=0,h.render(g,s),g.material=e,g.visible=t}h.setRenderTarget(d),h.setClearColor(f,p),null==(o=(n=this.scene).clampRenderBounds)||o.call(n),A.value!==l&&(A.value=l)}}}function Na(e){const t=new Map,s=new Map,i=e.clone();return Oa(e,i,(function(e,i){t.set(i,e),s.set(e,i)})),i.traverse((function(e){if(!e.isSkinnedMesh)return;const i=e,r=t.get(e),n=r.skeleton.bones;i.skeleton=r.skeleton.clone(),i.bindMatrix.copy(r.bindMatrix),i.skeleton.bones=n.map((function(e){return s.get(e)})),i.bind(i.skeleton,i.bindMatrix)})),i}function Oa(e,t,s){s(e,t);for(let i=0;i<e.children.length;i++)Oa(e.children[i],t.children[i],s)}const qa=1e-4,Ha=new dt,za=new R;za.setIndex([0,1,2,0,2,3]);const Va=(e,t,s)=>{s?s=new Float32Array(s):2===t?s=new Float32Array(new Array(8).fill(0)):3===t?s=new Float32Array(new Array(12).fill(0)):4===t&&(s=new Float32Array(new Array(16).fill(0))),za.setAttribute(e,new D(s,t))};Va("position",3,[-1,-1,0,1,-1,0,1,1,0,-1,1,0]),Va("normal",3),Va("uv",2),Va("uv1",2),Va("uv2",2),Va("skinIndex",4),Va("skinWeight",4),Va("_partIndex",1);class $a extends In{constructor(e){super(e),r(this,"canRenderDuringItem",!1),r(this,"isSwappingAnimationActive",!1),r(this,"isSwapping",!1),r(this,"isInitialized",!1),r(this,"setItemID",0),r(this,"leaveID",0),r(this,"enterID",0),r(this,"leavePromise",null),r(this,"enterPromise",null),r(this,"currentAssets",null),r(this,"uuid",null),r(this,"swapIndex",0),r(this,"camOffsetY",0),r(this,"shakeOffset",qt({precisionStop:1e-4,perfectStop:!0,step:5})),r(this,"offsetY",0),r(this,"transitionTransforms",{scale:1,turn:0,x:0,y:0,z:0}),r(this,"currentLogoMeshesList",null),r(this,"logos",{}),r(this,"beforeRenders",new Set),r(this,"skeleton",new Ga),r(this,"lastLoad",null),r(this,"lastLoadKey",null),r(this,"setID",0),r(this,"needsInstantOffset",!1),r(this,"triggerEnterID",0),r(this,"currentEnterCall",null),r(this,"triggerLeaveID",0),r(this,"currentLeaveCall",null),this.enter=os(this.enter.bind(this)),this.leave=os(this.leave.bind(this)),this.set=this.set.bind(this),this.setInstant=this.setInstant.bind(this),this.visible=!1,this.base=new Ye,this.meshBase=new Ye,this.base.frustumCulled=!1,this.mesh=new M(za,this.meshMaterial),this.base.add(this.meshBase),this.meshBase.add(this.mesh),this.shadowCaster=new M(new ss(1,1),new as),this.shadowCaster.geometry.translate(0,.9,0),this.hooks||(this.hooks={}),this.hooks.onItemSwap=m()}get mixins(){return[Wo,ta]}init(){this.skeleton=this.add(this.skeleton)}getCacheKey(e){let t=e.id,s=e.logoType,i=e.logoSpot,r=e.paintTextureUrl;return e.paintTextureUrl&&(t=e.itemId,s=e.itemData.logoType,i=e.itemData.logoSpot),t+"_"+s+"_"+i+"_"+r}afterInit(){if(!this.mesh.material)return;const e=this.mesh.material;e.onBeforeRenderCustom=(e,t,s,i,r,n)=>{for(const o of this.beforeRenders)o(e,t,s,i,r,n)},e.onAfterRenderCustom=(e,t,s,i,r,n)=>{}}onBeforeRender(e){return this.beforeRenders.add(e),()=>this.beforeRenders.delete(e)}async load(e){const t=this.getCacheKey(e);if(this.lastLoadKey===t)return this.lastLoad;this.lastLoadKey=t,this.lastLoad=wt();let s=e.id;U.$quality.pause("item-load");const i=U.$assets.load,r=U.$app.$baluchon;let n,o,a=e.logoType,A=e.logoSpot;e.paintTextureUrl&&(s=e.itemId,n=e.paintTextureUrl,a=e.itemData.logoType,A=e.itemData.logoSpot,o=e.dominantColor);const l=U.$app.$editor.config.items[s],c=l.assetId??l.id??s,h=`items-diffuse/${c}/diffuse`;let u=h;l.diffuseTexture&&(u="shared-items-diffuse/"+l.diffuseTexture,r.get(u)||(u=`items-diffuse/${c}/`+l.diffuseTexture),r.get(u)||(u=h));const g=`items-normal/${c}/normal`;let d=g;l.normalTexture&&(d="shared-items-normal/"+l.normalTexture,r.get(d)||(d=`items-normal/${c}/`+l.normalTexture),r.get(d)||(d=g));let p=null;l.tileableNormalTexture&&(p="shared-tileable-normal/"+l.tileableNormalTexture,r.get(p)||(p=null));const[f,m,I,C,B,v,y]=await Promise.all([i(`items-model/${c}/model`,{id:c+"Model",onLoad:e=>function(e,t){const s=new Map;function i(t){if(s.has(t))return s.get(t);if(s.has("default")){const e=s.get("default");s.set(t,e),s.delete("default")}const i={logos:{}};return Na(e.scene).traverse((e=>{let t;if(e.name&&(e.name.match(/armature/i)&&(i.base=e),e.name.match(/sweat/i)&&(i.base=e),e.name.match(/item_mesh/i)&&(i.mesh=e),e.name.match(/occluder/i)&&(i.occluder=e),t=e.name.match(/croco_([a-z0-9]*)/i))){const s=t[1].replace(/[0-9]*$/,"");i.logos[s]=e}})),i.mesh.frustrumCulled=!1,i.base.frustrumCulled=!1,i.occluder&&(i.occluder.material=new as,i.occluder.frustrumCulled=!1,i.occluder.visible=!1),s.set(t,i),i}const r=i("default");r.mesh.geometry.boundingBox||r.mesh.geometry.computeBoundingBox();const n=r.mesh.geometry;let o=n.attributes._part_index.array;for(let p=0;p<o.length;p++)o[p]=~~(255*o[p]);n.setAttribute("partIndex",new D(new Uint8Array(o),1)),delete n.attributes._part_index,o=null;const a=n.attributes._ao.array;delete n.attributes._ao;const A={ao:1,paintGroup:1,tileableNormal:1,roughnessMetalnessInterior:1,interiorOccluder:1},l=Object.keys(A).length,c=n.attributes.position.count,h=new Float32Array(c*l),u=new Pe(h,l);u.setUsage(us),u.needsUpdate=!0;let g=0;for(const p in A){const e=A[p],t=new ct(u,e,g,!1);n.setAttribute(p,t),g+=e}const d=n.attributes.partIndex.array;for(let p=0;p<c;p++){const e=d[p],s=U.$app.$editor.getPartConfig(t,e);let i=p*l;h[i++]=a[p],h[i++]=s.paintGroup,h[i++]=s.tileableNormal;const r=s.roughness,n=s.metalness,o=s.isInterior?1:0;h[i++]=gs(r,n,o),h[i++]=s.forceOccluder?0:o}return{getItemModelInstance:i}}(e,c)}),i(u,{id:u}),i(d,{id:d,srgb:!1,repeat:!0,colorSpace:""}),p&&i(p,{id:p,srgb:!1,repeat:!0,colorSpace:""}),i(`items-sample-pts/${c}/samples`,{onLoad:async e=>(e=new Float32Array(e),(await As.registerSamplePointsArray(s,e)).arr)}),U.loadLogo(a),U.$assets.loadPaintTexture(n)]);C.colorSpace="",I.colorSpace="",I&&(I.generateMipmaps=!0);const E=f.getItemModelInstance(this.constructor.name),w={id:s,config:l,logoSpot:A,logoType:a,model:E,diffuse:m,normal:I,tile:C,paintTexture:y,dominantColor:o};return this.lastLoad.resolve(w),w}async set(e={},t={}){const s=++this.setID;(e=this.normalizeSetItemParams(e)).enterOnly=e.enterOnly??!1;const i=this.getCacheKey(e),r=t.loadPromise??t.loadResult??this.load(e);this.isSwappingAnimationActive=!0;let n=await this.triggerLeave(!1,e.enterOnly);if(n||s!==this.setID)return!0;const o=await r;if(this.currentCacheKey!==i&&(this.isSwapping=!0,this.currentCacheKey=i,this.swap(o),this.reset(),await Wt(100),this.isSwapping=!1),t.beforeEnter&&t.beforeEnter(),n=await this.triggerEnter(!1),n||s!==this.setID)return!0;this.isSwappingAnimationActive=!1}async setInstant(e={}){const t=++this.setID;e=this.normalizeSetItemParams(e);const s=await this.load(e);if(t!==this.setID)return!0;const i=this.getCacheKey(e);this.currentCacheKey!==i&&(this.currentCacheKey=i,this.isSwapping=!0,this.swap(s),this.reset(),this.needsInstantOffset=!0,this.isSwapping=!1,this.isSwappingAnimationActive=!1)}normalizeSetItemParams(e){const t=U.$app.$editor;if(e.itemData){const s=e.itemId,i=t.config.items[s].logoSpots;let r=e.itemData.logoSpot,n=e.itemData.logoType;t.config.logos[n]||(n=t.config.defaultLogo.id),i?i[r]||(r=Object.keys(i)[0]):r="torso ",e.itemData.logoSpot=r,e.itemData.logoType=n}return e}swap(e){var t,s,i,r,n,o;this.id=e.id,this.config=e.config,this.dominantColor=ls(e.dominantColor),U.$threeRenderer;const a=e.model,A=this.mesh,l=this.meshBase;this.geometry=this.mesh.geometry;const c=this.material=this.mesh.material;if(a.base!==this.meshBase){this.base.remove(this.meshBase);const e=this.mesh=a.mesh,t=this.meshBase=a.base;if(this.occluder=a.occluder,this.uuid=e.uuid,e.layers.set(U.layers.base),e.layers.enable(U.layers.itemOnly),e.layers.enable(U.layers.thumbnail),e.renderOrder=U.z.item,e.material=this.material,e.matrix0||(e.matrix0=e.matrix.clone()),e.matrix0.decompose(e.position,e.quaternion,e.scale),t.matrix0||(t.matrix0=t.matrix.clone()),t.matrix0.decompose(t.position,t.quaternion,t.scale),null==e.userData.offsetY){const t=Ha;e.updateMatrixWorld(),t.copy(e.geometry.boundingBox).applyMatrix4(e.matrixWorld),e.userData.offsetY=t.min.y+U.$app.$store.floatItemOffsetY}this.camOffsetY=this.config.camOffsetY??0,this.offsetY=-e.userData.offsetY,this.shadowCaster.position.y=e.userData.offsetY,this.shadowCaster.scale.set(.8,1,.8),this.shadowCaster.layers.set(U.layers.shadowCaster),this.skeleton.reset(t),this.base.add(t),this.meshBase.add(this.shadowCaster),this.base.frustumCulled=this.mesh.frustumCulled=this.meshBase.frustumCulled=!1,this.occluder&&(this.occluder.frustumCulled=!1),this.base.updateWorldMatrix(!0,!0)}if(a.mesh.geometry!==this.geometry&&(null==(s=null==(t=this.geometry)?void 0:t.dispose)||s.call(t),this.geometry=a.mesh.geometry),a.logos!==this.currentLogoMeshesList){this.currentLogoMeshesList=a.logos;for(const e in this.logos)this.logos[e].destroy();this.logos={};for(const t in a.logos){const s=this.logos[t]=new Qa({mesh:a.logos[t],key:t});this.add(s),e.logoSpot&&(e.logoSpot===t?s.showInstant():s.hideInstant())}e.logoType&&Qa.material.swapType(e.logoType)}c.map!==e.diffuse&&(null==(r=null==(i=c.map)?void 0:i.dispose)||r.call(i),c.map=e.diffuse),c.normalMap!==e.normal&&(null==(o=null==(n=c.normalMap)?void 0:n.dispose)||o.call(n),c.normalMap=e.normal),e.tile&&c.tileableNormalMap!==e.tile&&(c.tileableNormalMap=Ca(c.tileableNormalMap,e.tile));const h=c.uniforms;U.$app.$device.type.phone?h.tileableNormalScale.value=this.config.tileableNormalScaleMobile:h.tileableNormalScale.value=this.config.tileableNormalScale,this.afterSwap(l,this.meshBase,A,this.mesh,e),this.hooks.onItemSwap.emit(),this.isInitialized=!0,this.swapIndex++,U.$quality.resume(1e3,"item-load")}afterSwap(){}reset(){}*enter(){this.clearAnim("enterLeave");const e=wt(),t=this.timeline("enterLeave",{onComplete:()=>{e.resolve()}}),s=this.transitionTransforms,i=s.isInitial,r=this.isEditable;s.isInitial=!1,t.fromTo(s,{scale:qa,turn:i?r?-2:1.6*-Math.PI:-Math.PI,y:i?.7:-.4},{scale:1,turn:0,y:0,duration:i?1e3:600,easing:i?cs.out(.26,.3):cs.out(.3,.3)}),yield e}*leave(){this.clearAnim("enterLeave");const e=wt(),t=this.timeline("enterLeave",{onComplete:()=>{e.resolve()}}),s=zt(.01,1,this.transitionTransforms.scale);t.to(this.transitionTransforms,{scale:qa,turn:Math.PI,y:.5,duration:700*s,easing:hs(.335,-.005,.8,-.515)}),yield e,yield Wt(50)}setToBeforeEnter(){var e,t,s,i;this.clearAnim("enterLeave"),this.triggerEnterID++,this.triggerLeaveID++,null==(t=null==(e=this.currentEnterCall)?void 0:e.cancel)||t.call(e),null==(i=null==(s=this.currentLeaveCall)?void 0:s.cancel)||i.call(s),this.enterPromise=null,this.leavePromise=null;const r=this.transitionTransforms;r.isInitial=!0,r.scale=qa,r.turn=-Math.PI,r.y=-.2}async triggerEnter(e=!0,t){var s,i;const r=++this.triggerEnterID;if(this.leavePromise&&await this.leavePromise,r!==this.triggerEnterID)return!0;if(!t&&this.enterPromise)return await this.enterPromise,r!==this.triggerEnterID;const n=this.enterPromise=wt();return null==(i=null==(s=this.currentEnterCall)?void 0:s.cancel)||i.call(s),this.currentEnterCall=this.enter(t),await this.currentEnterCall,this.enterPromise=null,n.resolve(),r!==this.triggerEnterID}async triggerLeave(e=!0,t){var s,i;const r=++this.triggerLeaveID;if(this.enterPromise&&await this.enterPromise,r!==this.triggerLeaveID)return!0;if(!t&&this.leavePromise)return await this.leavePromise,r!==this.triggerLeaveID;const n=this.leavePromise=wt();return null==(i=null==(s=this.currentLeaveCall)?void 0:s.cancel)||i.call(s),this.currentLeaveCall=this.leave(t),await this.currentLeaveCall,this.leavePromise=null,n.resolve(),r!==this.triggerLeaveID}beforeUpdate(){const e=this.isInitialized&&this.material&&this.transitionTransforms.scale>qa;this.base.visible=e,this.needsInstantOffset&&(this.needsInstantOffset=!1,this.scene.camera.offsetY=this.scene.camera.targetOffsetY)}get isResting(){return this.skeleton.isResting}get isMoving(){return this.skeleton.isMoving}get lastMoveAt(){return this.skeleton.lastMoveAt}forceVisibility(){this.base.visible=!0,this.base.scale.setScalar(1),this.base.position.setScalar(0),this.base.quaternion.identity()}shake(e=1){this.shakeOffset.setValue(e)}update(){const e=U.$time.dt,{base:t}=this;t.scale.setScalar(1,1,1),t.quaternion.identity(),t.position.setScalar(0),t.position.y+=this.offsetY,this.shakeOffset.update(e);const s=this.shakeOffset.value;t.rotation.x+=.08*s,t.scale.multiplyScalar(1-.18*s),t.scale.multiplyScalar(this.transitionTransforms.scale),t.rotation.y+=this.transitionTransforms.turn,t.position.x+=this.transitionTransforms.x,t.position.y+=this.transitionTransforms.y,t.position.z+=this.transitionTransforms.z}}const Ya=Rn("precision highp float;\n#define STANDARD\n#include <common>\n#include <packing>\n#include <conditionals>\n#include <float_packing>\n#include <dithering_pars_fragment>\n#include <map_pars_fragment>\n#include <aomap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <luma>\nuniform vec3 diffuse;uniform vec3 emissive;uniform float roughness;uniform float metalness;uniform float opacity;uniform vec4 res;uniform float time;uniform sampler2D tileableNormalMap;uniform float tileableNormalScale;varying vec3 vViewPosition;varying vec3 vColor;varying vec4 vClipPos;varying vec2 vUvDiffuse;varying vec2 vUvPaint;varying vec2 vUvNormal;varying float vPartIndex;varying vec3 vAO_TileableNormal_PaintGroup;varying vec3 vRoughness_Metalness_Interior;uniform sampler2D paintMap;uniform sampler2D interiorMap;\n#ifdef IS_EDITABLE\n#include <sticker_chunk_pars>\nuniform vec3 fillPreviewColor;uniform vec2 fillPreviewState;\n#endif\n#ifdef IS_DEBUG\n#include <print_numbers>\nuniform sampler2D dirTex;uniform float showOnlyUnconfig;uniform float useDebugIndexes;varying vec3 vDebugPartColor;varying float vNotConfigured;\n#endif\n#include <tonemapping_chunk_pars>\nfloat mixmap(float value,float min1,float max1,float min2,float max2){return min2+(value-min1)*(max2-min2)/(max1-min1);}void main(){float vRoughness=vRoughness_Metalness_Interior.x;float vMetalness=vRoughness_Metalness_Interior.y;float vInterior=vRoughness_Metalness_Interior.z;float vAO=vAO_TileableNormal_PaintGroup.x;float vTileableNormal=vAO_TileableNormal_PaintGroup.y;float vPaintGroup=vAO_TileableNormal_PaintGroup.z;vec2 pxUv=vec2(gl_FragCoord.x*res.w,(res.y-gl_FragCoord.y)*res.w);ReflectedLight reflectedLight=ReflectedLight(vec3(0.),vec3(0.),vec3(0.),vec3(0.));vec3 totalEmissiveRadiance=emissive;vec2 screenUv=gl_FragCoord.xy/res.xy;float isOccluder=texture2D(interiorMap,screenUv).r;if(isOccluder>0.5&&vInterior>0.5){discard;}vec4 diffuseColor=vec4(diffuse,opacity);vec4 sampledDiffuseColor=texture2D(map,vUvDiffuse);diffuseColor*=sampledDiffuseColor;vec4 paint=texture2D(paintMap,vUvPaint);\n#ifdef IS_EDITABLE\npaint.rgb/=max(0.0001,paint.a);\n#endif\ndiffuseColor.rgb=mix(diffuseColor.rgb,paint.rgb,paint.a);\n#ifdef IS_EDITABLE\nfloat fillActive=step(abs(vPaintGroup-fillPreviewState.x),0.5);diffuseColor.rgb=mix(diffuseColor.rgb,fillPreviewColor.rgb,fillActive*fillPreviewState.y);float part=vPartIndex;float diff=abs(part-stickerPos.z);if(stickerTransform.x>0.001&&diff<0.002){vec4 stick=drawSticker(stickerTex,vUvPaint,stickerPos.xy,stickerTransform,normalize(vNormal));diffuseColor.rgb=mix(diffuseColor.rgb,stick.rgb,stick.a);}\n#endif\nfloat normalFactor=1.0;float roughnessFactor=roughness;float metalnessFactor=metalness;roughnessFactor*=vRoughness;metalnessFactor*=vMetalness;vec3 normal=normalize(vNormal);mat3 tbn=getTangentFrame(-vViewPosition,normal,vUvNormal);vec3 nonPerturbedNormal=normal;vec3 mapN=texture2D(normalMap,vUvNormal).xyz*2.-1.;mapN.xy*=normalFactor*1.5;normal=mix(normal,normalize(tbn*mapN),step(0.0125,length(mapN.xy)));mat3 tbn2=getTangentFrame(-vViewPosition,normal,vUvPaint*tileableNormalScale);vec3 mapN2=texture2D(tileableNormalMap,vUvPaint*tileableNormalScale).xyz*2.-1.;mapN2.xy*=vTileableNormal;normal=normalize(tbn2*mapN2);\n#include <lights_physical_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nfloat ambientOcclusion=1.-((1.-vAO)*1.0);reflectedLight.indirectDiffuse*=ambientOcclusion;float dotNV=saturate(dot(geometryNormal,geometryViewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.roughness);float paintLum=luma(diffuseColor.rgb);float lightMult=mix(1.8,1.,smoothstep(0.,0.07,paintLum));vec3 totalDiffuse=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse;vec3 totalSpecular=reflectedLight.directSpecular+reflectedLight.indirectSpecular*lightMult;vec3 outgoingLight=totalDiffuse+totalSpecular+totalEmissiveRadiance;float fresnel=pow(1.-dot(geometryNormal,geometryViewDir),2.);outgoingLight=mix(outgoingLight,outgoingLight*(1.4*lightMult),fresnel*vAO);float aoM=mix(0.03,0.04,vInterior);outgoingLight=mix(max(vec3(0.),outgoingLight-aoM),outgoingLight,vAO);outgoingLight=mix(outgoingLight,outgoingLight*0.5,max(mapN2.y*1.2,mapN.x*0.6));gl_FragColor=vec4(outgoingLight,diffuseColor.a);gl_FragColor.rgb=tonemapping(gl_FragColor.rgb)*1.06;\n#include <fog_fragment>\n#include <colorspace_output_srgb>\n#ifdef IS_DEBUG\nfloat debugAO=(1.-vAO)*0.5;if(vNotConfigured<0.5&&showOnlyUnconfig>0.5){if(mod(pxUv.x/res.w,2.)<1.){discard;}else{gl_FragColor.rgba=vec4(vec3(0.7)-debugAO,1.);}return;}vec2 duv=vUvPaint;vec2 dg=duv*100.;dg.x=fract(dg.x+step(0.5,fract(dg.y))*0.5)*2.;dg.y=fract(dg.y*2.);float dDir=texture2D(dirTex,dg).r;dDir=smoothstep(0.3,0.4,dDir);vec2 dNumUv=gl_FragCoord.xy*vec2(1.,2.);float dNum=printNumbers(dNumUv,floor(dNumUv/90.)*90.,vec2(14.,40.),vPartIndex,4.,0.);dDir=mix(dDir,dNum,useDebugIndexes);dg.x=step(1.,dg.x);gl_FragColor.rgb=mix(vDebugPartColor,vec3(1.,0.,0.),vNotConfigured*(cos(time*10.)+1.));gl_FragColor.rgb=mix(gl_FragColor.rgb,1.-gl_FragColor.rgb,dDir);gl_FragColor.rgb-=debugAO;gl_FragColor.rgb=clamp(gl_FragColor.rgb,0.,1.);\n#endif\n}","fragmentShader"),Ja=Rn("precision highp float;\n#define STANDARD\n#include <common>\n#include <conditionals>\n#include <float_packing>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\nvarying vec3 vViewPosition;varying vec4 vClipPos;attribute vec2 uv1;attribute vec2 uv2;attribute float partIndex;attribute float ao;attribute float tileableNormal;attribute float paintGroup;attribute float roughnessMetalnessInterior;varying vec2 vUvDiffuse;varying vec2 vUvPaint;varying vec2 vUvNormal;varying float vPartIndex;varying vec3 vAO_TileableNormal_PaintGroup;varying vec3 vRoughness_Metalness_Interior;attribute float interiorOccluder;attribute float debugPartColor;attribute float debugNotConfigured;varying float vNotConfigured;varying vec3 vDebugPartColor;attribute vec4 color;uniform float time;void main(){\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <skinning_vertex>\nvec4 mPosition=modelMatrix*vec4(transformed,1.0);vec4 mvPosition=viewMatrix*mPosition;gl_Position=projectionMatrix*mvPosition;vViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\nvNormal=normalize(transformedNormal);vUvPaint=UV_ATTR_PAINT;vUvDiffuse=UV_ATTR_DIFFUSE;vUvNormal=UV_ATTR_NORMAL;vPartIndex=partIndex;vRoughness_Metalness_Interior=unpackFloatToVec3(roughnessMetalnessInterior);vRoughness_Metalness_Interior.z=interiorOccluder;vAO_TileableNormal_PaintGroup=vec3(ao,tileableNormal,paintGroup);vClipPos=projectionMatrix*modelViewMatrix*vec4(position,1.0);vDebugPartColor=unpackFloatToVec3(debugPartColor);vNotConfigured=debugNotConfigured;}","vertexShader");class Ka extends Ge{constructor(){super(),r(this,"_currentTileableNormalTexture",null),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="ItemMaterial",this.uniforms={...this.uniforms,...is.clone(rs.standard.uniforms),...U.$uniforms,perlin:{value:U.$assets.textures.noise_perlin},paintMap:{value:U.$assets.textures.null},tileableNormalScale:{value:1},tileableNormalMap:{value:U.$assets.textures.null},interiorMap:{value:U.$assets.textures.null}},this.defines={...this.defines,...U.itemAttrDefines},this.side=lt,this.roughness=1,this.metalness=0,Ja.use(this),Ya.use(this),Ea.setupMaterial(this),co.setupMaterial(this),this.map=U.$assets.textures.null,this.normalMap=U.$assets.textures.null}get paintMap(){return this.uniforms.paintMap.value}set paintMap(e){this.uniforms.paintMap.value=e}get tileableNormalMap(){return this.uniforms.tileableNormalMap.value}set tileableNormalMap(e){this.uniforms.tileableNormalMap.value=e}get tileableNormalScale(){return this.uniforms.tileableNormalScale.value}set tileableNormalScale(e){this.uniforms.tileableNormalScale.value=e}}class Wa extends Ka{constructor(e){super(e),this.type=this.name="ItemEditorMaterial",this.defines={...this.defines,IS_EDITABLE:!0},Object.assign(this.uniforms,{fillPreviewColor:{value:new c(0)},fillPreviewState:{value:new u(0,0)}})}}const ja=1.25,Xa=65535,Za=Math.pow(2,-24),eA=Symbol("SKIP_GENERATION");function tA(e){return function(e){return e.index?e.index.count:e.attributes.position.count}(e)/3}function sA(e,t){if(!e.index){const s=e.attributes.position.count,i=function(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}(s,t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);e.setIndex(new D(i,1));for(let e=0;e<s;e++)i[e]=e}}function iA(e,t){const s=tA(e),i=t||e.drawRange,r=i.start/3,n=(i.start+i.count)/3,o=Math.max(0,r),a=Math.min(s,n)-o;return[{offset:Math.floor(o),count:Math.floor(a)}]}function rA(e,t){if(!e.groups||!e.groups.length)return iA(e,t);const s=[],i=new Set,r=t||e.drawRange,n=r.start/3,o=(r.start+r.count)/3;for(const A of e.groups){const e=A.start/3,t=(A.start+A.count)/3;i.add(Math.max(n,e)),i.add(Math.min(o,t))}const a=Array.from(i.values()).sort(((e,t)=>e-t));for(let A=0;A<a.length-1;A++){const e=a[A],t=a[A+1];s.push({offset:Math.floor(e),count:Math.floor(t-e)})}return s}function nA(e,t,s,i,r){let n=Infinity,o=Infinity,a=Infinity,A=-Infinity,l=-Infinity,c=-Infinity,h=Infinity,u=Infinity,g=Infinity,d=-Infinity,p=-Infinity,f=-Infinity;for(let m=6*t,I=6*(t+s);m<I;m+=6){const t=e[m+0],s=e[m+1],i=t-s,r=t+s;i<n&&(n=i),r>A&&(A=r),t<h&&(h=t),t>d&&(d=t);const I=e[m+2],C=e[m+3],B=I-C,v=I+C;B<o&&(o=B),v>l&&(l=v),I<u&&(u=I),I>p&&(p=I);const y=e[m+4],E=e[m+5],w=y-E,Q=y+E;w<a&&(a=w),Q>c&&(c=Q),y<g&&(g=y),y>f&&(f=y)}i[0]=n,i[1]=o,i[2]=a,i[3]=A,i[4]=l,i[5]=c,r[0]=h,r[1]=u,r[2]=g,r[3]=d,r[4]=p,r[5]=f}function oA(e,t,s){return s.min.x=t[e],s.min.y=t[e+1],s.min.z=t[e+2],s.max.x=t[e+3],s.max.y=t[e+4],s.max.z=t[e+5],s}function aA(e){let t=-1,s=-Infinity;for(let i=0;i<3;i++){const r=e[i+3]-e[i];r>s&&(s=r,t=i)}return t}function AA(e,t){t.set(e)}function lA(e,t,s){let i,r;for(let n=0;n<3;n++){const o=n+3;i=e[n],r=t[n],s[n]=i<r?i:r,i=e[o],r=t[o],s[o]=i>r?i:r}}function cA(e,t,s){for(let i=0;i<3;i++){const r=t[e+2*i],n=t[e+2*i+1],o=r-n,a=r+n;o<s[i]&&(s[i]=o),a>s[i+3]&&(s[i+3]=a)}}function hA(e){const t=e[3]-e[0],s=e[4]-e[1],i=e[5]-e[2];return 2*(t*s+s*i+i*t)}const uA=32,gA=(e,t)=>e.candidate-t.candidate,dA=new Array(uA).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),pA=new Float32Array(6);class fA{constructor(){this.boundingData=new Float32Array(6)}}function mA(e,t,s,i,r,n){let o=i,a=i+r-1;const A=n.pos,l=2*n.axis;for(;;){for(;o<=a&&s[6*o+l]<A;)o++;for(;o<=a&&s[6*a+l]>=A;)a--;if(!(o<a))return o;for(let e=0;e<3;e++){let s=t[3*o+e];t[3*o+e]=t[3*a+e],t[3*a+e]=s}for(let e=0;e<6;e++){let t=s[6*o+e];s[6*o+e]=s[6*a+e],s[6*a+e]=t}o++,a--}}function IA(e,t,s,i,r,n){let o=i,a=i+r-1;const A=n.pos,l=2*n.axis;for(;;){for(;o<=a&&s[6*o+l]<A;)o++;for(;o<=a&&s[6*a+l]>=A;)a--;if(!(o<a))return o;{let t=e[o];e[o]=e[a],e[a]=t;for(let e=0;e<6;e++){let t=s[6*o+e];s[6*o+e]=s[6*a+e],s[6*a+e]=t}o++,a--}}}function CA(e,t){return 65535===t[e+15]}function BA(e,t){return t[e+6]}function vA(e,t){return t[e+14]}function yA(e){return e+8}function EA(e,t){return t[e+6]}function wA(e,t){return t[e+7]}let QA,xA,bA,SA;const RA=Math.pow(2,32);function DA(e){return"count"in e?1:1+DA(e.left)+DA(e.right)}function TA(e,t,s){return QA=new Float32Array(s),xA=new Uint32Array(s),bA=new Uint16Array(s),SA=new Uint8Array(s),MA(e,t)}function MA(e,t){const s=e/4,i=e/2,r="count"in t,n=t.boundingData;for(let o=0;o<6;o++)QA[s+o]=n[o];if(r){if(t.buffer){const i=t.buffer;SA.set(new Uint8Array(i),e);for(let t=e,r=e+i.byteLength;t<r;t+=32){CA(t/2,bA)||(xA[t/4+6]+=s)}return e+i.byteLength}{const r=t.offset,n=t.count;return xA[s+6]=r,bA[i+14]=n,bA[i+15]=Xa,e+32}}{const i=t.left,r=t.right,n=t.splitAxis;let o;if(o=MA(e+32,i),o/4>RA)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return xA[s+6]=o/4,o=MA(o,r),xA[s+7]=n,o}}function _A(e,t,s,i,r){const{maxDepth:n,verbose:o,maxLeafTris:a,strategy:A,onProgress:l,indirect:c}=r,h=e._indirectBuffer,u=e.geometry,g=u.index?u.index.array:null,d=c?IA:mA,p=tA(u),f=new Float32Array(6);let m=!1;const I=new fA;return nA(t,s,i,I.boundingData,f),function e(s,i,r,o=null,l=0){!m&&l>=n&&(m=!0);if(r<=a||l>=n)return C(i+r),s.offset=i,s.count=r,s;const c=function(e,t,s,i,r,n){let o=-1,a=0;if(0===n)o=aA(t),-1!==o&&(a=(t[o]+t[o+3])/2);else if(1===n)o=aA(e),-1!==o&&(a=function(e,t,s,i){let r=0;for(let n=t,o=t+s;n<o;n++)r+=e[6*n+2*i];return r/s}(s,i,r,o));else if(2===n){const n=hA(e);let A=ja*r;const l=6*i,c=6*(i+r);for(let e=0;e<3;e++){const i=t[e],h=(t[e+3]-i)/uA;if(r<8){const t=[...dA];t.length=r;let i=0;for(let r=l;r<c;r+=6,i++){const n=t[i];n.candidate=s[r+2*e],n.count=0;const{bounds:o,leftCacheBounds:a,rightCacheBounds:A}=n;for(let e=0;e<3;e++)A[e]=Infinity,A[e+3]=-Infinity,a[e]=Infinity,a[e+3]=-Infinity,o[e]=Infinity,o[e+3]=-Infinity;cA(r,s,o)}t.sort(gA);let h=r;for(let e=0;e<h;e++){const s=t[e];for(;e+1<h&&t[e+1].candidate===s.candidate;)t.splice(e+1,1),h--}for(let r=l;r<c;r+=6){const i=s[r+2*e];for(let e=0;e<h;e++){const n=t[e];i>=n.candidate?cA(r,s,n.rightCacheBounds):(cA(r,s,n.leftCacheBounds),n.count++)}}for(let s=0;s<h;s++){const i=t[s],l=i.count,c=r-i.count,h=i.leftCacheBounds,u=i.rightCacheBounds;let g=0;0!==l&&(g=hA(h)/n);let d=0;0!==c&&(d=hA(u)/n);const p=1+ja*(g*l+d*c);p<A&&(o=e,A=p,a=i.candidate)}}else{for(let e=0;e<uA;e++){const t=dA[e];t.count=0,t.candidate=i+h+e*h;const s=t.bounds;for(let e=0;e<3;e++)s[e]=Infinity,s[e+3]=-Infinity}for(let r=l;r<c;r+=6){let t=~~((s[r+2*e]-i)/h);t>=uA&&(t=31);const n=dA[t];n.count++,cA(r,s,n.bounds)}const t=dA[31];AA(t.bounds,t.rightCacheBounds);for(let e=30;e>=0;e--){const t=dA[e],s=dA[e+1];lA(t.bounds,s.rightCacheBounds,t.rightCacheBounds)}let u=0;for(let s=0;s<31;s++){const t=dA[s],i=t.count,l=t.bounds,c=dA[s+1].rightCacheBounds;0!==i&&(0===u?AA(l,pA):lA(l,pA,pA)),u+=i;let h=0,g=0;0!==u&&(h=hA(pA)/n);const d=r-u;0!==d&&(g=hA(c)/n);const p=1+ja*(h*u+g*d);p<A&&(o=e,A=p,a=t.candidate)}}}}return{axis:o,pos:a}}(s.boundingData,o,t,i,r,A);if(-1===c.axis)return C(i+r),s.offset=i,s.count=r,s;const u=d(h,g,t,i,r,c);if(u===i||u===i+r)C(i+r),s.offset=i,s.count=r;else{s.splitAxis=c.axis;const n=new fA,o=i,a=u-i;s.left=n,nA(t,o,a,n.boundingData,f),e(n,o,a,f,l+1);const A=new fA,h=u,g=r-a;s.right=A,nA(t,h,g,A.boundingData,f),e(A,h,g,f,l+1)}return s}(I,s,i,f),I;function C(e){l&&l(e/p)}}function FA(e,t){const s=e.geometry;t.indirect&&(e._indirectBuffer=function(e,t){const s=(e.index?e.index.count:e.attributes.position.count)/3,i=s>65536,r=i?4:2,n=t?new SharedArrayBuffer(s*r):new ArrayBuffer(s*r),o=i?new Uint32Array(n):new Uint16Array(n);for(let a=0,A=o.length;a<A;a++)o[a]=a;return o}(s,t.useSharedArrayBuffer),function(e,t){const s=tA(e),i=rA(e,t).sort(((e,t)=>e.offset-t.offset)),r=i[i.length-1];r.count=Math.min(s-r.offset,r.count);let n=0;return i.forEach((({count:e})=>n+=e)),s!==n}(s,t.range)&&t.verbose),e._indirectBuffer||sA(s,t);const i=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,r=function(e,t=null,s=null,i=null){const r=e.attributes.position,n=e.index?e.index.array:null,o=tA(e),a=r.normalized;let A;null===t?(A=new Float32Array(6*o),s=0,i=o):(A=t,s=s||0,i=i||o);const l=r.array,c=r.offset||0;let h=3;r.isInterleavedBufferAttribute&&(h=r.data.stride);const u=["getX","getY","getZ"];for(let g=s;g<s+i;g++){const e=3*g,t=6*g;let s=e+0,i=e+1,o=e+2;n&&(s=n[s],i=n[i],o=n[o]),a||(s=s*h+c,i=i*h+c,o=o*h+c);for(let n=0;n<3;n++){let e,c,h;a?(e=r[u[n]](s),c=r[u[n]](i),h=r[u[n]](o)):(e=l[s+n],c=l[i+n],h=l[o+n]);let g=e;c<g&&(g=c),h<g&&(g=h);let d=e;c>d&&(d=c),h>d&&(d=h);const p=(d-g)/2,f=2*n;A[t+f+0]=g+p,A[t+f+1]=p+(Math.abs(g)+p)*Za}}return A}(s),n=t.indirect?iA(s,t.range):rA(s,t.range);e._roots=n.map((s=>{const n=_A(e,r,s.offset,s.count,t),o=DA(n),a=new i(32*o);return TA(0,n,a),a}))}class PA{constructor(){this.min=Infinity,this.max=-Infinity}setFromPointsField(e,t){let s=Infinity,i=-Infinity;for(let r=0,n=e.length;r<n;r++){const n=e[r][t];s=n<s?n:s,i=n>i?n:i}this.min=s,this.max=i}setFromPoints(e,t){let s=Infinity,i=-Infinity;for(let r=0,n=t.length;r<n;r++){const n=t[r],o=e.dot(n);s=o<s?o:s,i=o>i?o:i}this.min=s,this.max=i}isSeparated(e){return this.min>e.max||e.min>this.max}}PA.prototype.setFromBox=function(){const e=new Re;return function(t,s){const i=s.min,r=s.max;let n=Infinity,o=-Infinity;for(let a=0;a<=1;a++)for(let s=0;s<=1;s++)for(let A=0;A<=1;A++){e.x=i.x*a+r.x*(1-a),e.y=i.y*s+r.y*(1-s),e.z=i.z*A+r.z*(1-A);const l=t.dot(e);n=Math.min(l,n),o=Math.max(l,o)}this.min=n,this.max=o}}();const UA=function(){const e=new Re,t=new Re,s=new Re;return function(i,r,n){const o=i.start,a=e,A=r.start,l=t;s.subVectors(o,A),e.subVectors(i.end,i.start),t.subVectors(r.end,r.start);const c=s.dot(l),h=l.dot(a),u=l.dot(l),g=s.dot(a),d=a.dot(a)*u-h*h;let p,f;p=0!==d?(c*h-g*u)/d:0,f=(c+p*h)/u,n.x=p,n.y=f}}(),kA=function(){const e=new u,t=new Re,s=new Re;return function(i,r,n,o){UA(i,r,e);let a=e.x,A=e.y;if(a>=0&&a<=1&&A>=0&&A<=1)return i.at(a,n),void r.at(A,o);if(a>=0&&a<=1)return A<0?r.at(0,o):r.at(1,o),void i.closestPointToPoint(o,!0,n);if(A>=0&&A<=1)return a<0?i.at(0,n):i.at(1,n),void r.closestPointToPoint(n,!0,o);{let e,l;e=a<0?i.start:i.end,l=A<0?r.start:r.end;const c=t,h=s;return i.closestPointToPoint(l,!0,t),r.closestPointToPoint(e,!0,s),c.distanceToSquared(l)<=h.distanceToSquared(e)?(n.copy(c),void o.copy(l)):(n.copy(e),void o.copy(h))}}}(),LA=function(){const e=new Re,t=new Re,s=new ds,i=new ps;return function(r,n){const{radius:o,center:a}=r,{a:A,b:l,c}=n;i.start=A,i.end=l;if(i.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;i.start=A,i.end=c;if(i.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;i.start=l,i.end=c;if(i.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;const h=n.getPlane(s);if(Math.abs(h.distanceToPoint(a))<=o){const e=h.projectPoint(a,t);if(n.containsPoint(e))return!0}return!1}}();function GA(e){return Math.abs(e)<1e-15}class NA extends fs{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new Re)),this.satBounds=new Array(4).fill().map((()=>new PA)),this.points=[this.a,this.b,this.c],this.sphere=new pt,this.plane=new ds,this.needsUpdate=!0}intersectsSphere(e){return LA(e,this)}update(){const e=this.a,t=this.b,s=this.c,i=this.points,r=this.satAxes,n=this.satBounds,o=r[0],a=n[0];this.getNormal(o),a.setFromPoints(o,i);const A=r[1],l=n[1];A.subVectors(e,t),l.setFromPoints(A,i);const c=r[2],h=n[2];c.subVectors(t,s),h.setFromPoints(c,i);const u=r[3],g=n[3];u.subVectors(s,e),g.setFromPoints(u,i),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}}NA.prototype.closestPointToSegment=function(){const e=new Re,t=new Re,s=new ps;return function(i,r=null,n=null){const{start:o,end:a}=i,A=this.points;let l,c=Infinity;for(let h=0;h<3;h++){const o=(h+1)%3;s.start.copy(A[h]),s.end.copy(A[o]),kA(s,i,e,t),l=e.distanceToSquared(t),l<c&&(c=l,r&&r.copy(e),n&&n.copy(t))}return this.closestPointToPoint(o,e),l=o.distanceToSquared(e),l<c&&(c=l,r&&r.copy(e),n&&n.copy(o)),this.closestPointToPoint(a,e),l=a.distanceToSquared(e),l<c&&(c=l,r&&r.copy(e),n&&n.copy(a)),Math.sqrt(c)}}(),NA.prototype.intersectsTriangle=function(){const e=new NA,t=new Array(3),s=new Array(3),i=new PA,r=new PA,n=new Re,o=new Re,a=new Re,A=new Re,l=new Re,c=new ps,h=new ps,u=new ps,g=new Re;function d(e,t,s){const i=e.points;let r=0,n=-1;for(let a=0;a<3;a++){const{start:e,end:A}=c;e.copy(i[a]),A.copy(i[(a+1)%3]),c.delta(o);const l=GA(t.distanceToPoint(e));if(GA(t.normal.dot(o))&&l){s.copy(c),r=2;break}const h=t.intersectLine(c,g);if(!h&&l&&g.copy(e),(h||l)&&!GA(g.distanceTo(A))){if(r<=1){(1===r?s.start:s.end).copy(g),l&&(n=r)}else if(r>=2){(1===n?s.start:s.end).copy(g),r=2;break}if(r++,2===r&&-1===n)break}}return r}return function(o,c=null,g=!1){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(e.copy(o),e.update(),o=e);const p=this.plane,f=o.plane;if(Math.abs(p.normal.dot(f.normal))>1-1e-10){const e=this.satBounds,a=this.satAxes;s[0]=o.a,s[1]=o.b,s[2]=o.c;for(let t=0;t<4;t++){const r=e[t],n=a[t];if(i.setFromPoints(n,s),r.isSeparated(i))return!1}const A=o.satBounds,l=o.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let s=0;s<4;s++){const e=A[s],r=l[s];if(i.setFromPoints(r,t),e.isSeparated(i))return!1}for(let o=0;o<4;o++){const e=a[o];for(let o=0;o<4;o++){const a=l[o];if(n.crossVectors(e,a),i.setFromPoints(n,t),r.setFromPoints(n,s),i.isSeparated(r))return!1}}return c&&(c.start.set(0,0,0),c.end.set(0,0,0)),!0}{const e=d(this,f,h);if(1===e&&o.containsPoint(h.end))return c&&(c.start.copy(h.end),c.end.copy(h.end)),!0;if(2!==e)return!1;const t=d(o,p,u);if(1===t&&this.containsPoint(u.end))return c&&(c.start.copy(u.end),c.end.copy(u.end)),!0;if(2!==t)return!1;if(h.delta(a),u.delta(A),a.dot(A)<0){let e=u.start;u.start=u.end,u.end=e}const s=h.start.dot(a),i=h.end.dot(a),r=u.start.dot(a),n=u.end.dot(a);return(s===n||r===i||i<r!==s<n)&&(c&&(l.subVectors(h.start,u.start),l.dot(a)>0?c.start.copy(h.start):c.start.copy(u.start),l.subVectors(h.end,u.end),l.dot(a)<0?c.end.copy(h.end):c.end.copy(u.end)),!0)}}}(),NA.prototype.distanceToPoint=function(){const e=new Re;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),NA.prototype.distanceToTriangle=function(){const e=new Re,t=new Re,s=["a","b","c"],i=new ps,r=new ps;return function(n,o=null,a=null){const A=o||a?i:null;if(this.intersectsTriangle(n,A))return(o||a)&&(o&&A.getCenter(o),a&&A.getCenter(a)),0;let l=Infinity;for(let t=0;t<3;t++){let i;const r=s[t],A=n[r];this.closestPointToPoint(A,e),i=A.distanceToSquared(e),i<l&&(l=i,o&&o.copy(e),a&&a.copy(A));const c=this[r];n.closestPointToPoint(c,e),i=c.distanceToSquared(e),i<l&&(l=i,o&&o.copy(c),a&&a.copy(e))}for(let c=0;c<3;c++){const A=s[c],h=s[(c+1)%3];i.set(this[A],this[h]);for(let c=0;c<3;c++){const A=s[c],h=s[(c+1)%3];r.set(n[A],n[h]),kA(i,r,e,t);const u=e.distanceToSquared(t);u<l&&(l=u,o&&o.copy(e),a&&a.copy(t))}}return Math.sqrt(l)}}();class OA{constructor(e,t,s){this.isOrientedBox=!0,this.min=new Re,this.max=new Re,this.matrix=new Se,this.invMatrix=new Se,this.points=new Array(8).fill().map((()=>new Re)),this.satAxes=new Array(3).fill().map((()=>new Re)),this.satBounds=new Array(3).fill().map((()=>new PA)),this.alignedSatBounds=new Array(3).fill().map((()=>new PA)),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),s&&this.matrix.copy(s)}set(e,t,s){this.min.copy(e),this.max.copy(t),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}OA.prototype.update=function(){return function(){const e=this.matrix,t=this.min,s=this.max,i=this.points;for(let A=0;A<=1;A++)for(let r=0;r<=1;r++)for(let n=0;n<=1;n++){const o=i[1*A|2*r|4*n];o.x=A?s.x:t.x,o.y=r?s.y:t.y,o.z=n?s.z:t.z,o.applyMatrix4(e)}const r=this.satBounds,n=this.satAxes,o=i[0];for(let A=0;A<3;A++){const e=n[A],t=r[A],s=i[1<<A];e.subVectors(o,s),t.setFromPoints(e,i)}const a=this.alignedSatBounds;a[0].setFromPointsField(i,"x"),a[1].setFromPointsField(i,"y"),a[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}(),OA.prototype.intersectsBox=function(){const e=new PA;return function(t){this.needsUpdate&&this.update();const s=t.min,i=t.max,r=this.satBounds,n=this.satAxes,o=this.alignedSatBounds;if(e.min=s.x,e.max=i.x,o[0].isSeparated(e))return!1;if(e.min=s.y,e.max=i.y,o[1].isSeparated(e))return!1;if(e.min=s.z,e.max=i.z,o[2].isSeparated(e))return!1;for(let a=0;a<3;a++){const s=n[a],i=r[a];if(e.setFromBox(s,t),i.isSeparated(e))return!1}return!0}}(),OA.prototype.intersectsTriangle=function(){const e=new NA,t=new Array(3),s=new PA,i=new PA,r=new Re;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(e.copy(n),e.update(),n=e);const o=this.satBounds,a=this.satAxes;t[0]=n.a,t[1]=n.b,t[2]=n.c;for(let e=0;e<3;e++){const i=o[e],r=a[e];if(s.setFromPoints(r,t),i.isSeparated(s))return!1}const A=n.satBounds,l=n.satAxes,c=this.points;for(let e=0;e<3;e++){const t=A[e],i=l[e];if(s.setFromPoints(i,c),t.isSeparated(s))return!1}for(let e=0;e<3;e++){const n=a[e];for(let e=0;e<4;e++){const o=l[e];if(r.crossVectors(n,o),s.setFromPoints(r,t),i.setFromPoints(r,c),s.isSeparated(i))return!1}}return!0}}(),OA.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}(),OA.prototype.distanceToPoint=function(){const e=new Re;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),OA.prototype.distanceToBox=function(){const e=["x","y","z"],t=new Array(12).fill().map((()=>new ps)),s=new Array(12).fill().map((()=>new ps)),i=new Re,r=new Re;return function(n,o=0,a=null,A=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(a||A)&&(n.getCenter(r),this.closestPointToPoint(r,i),n.closestPointToPoint(i,r),a&&a.copy(i),A&&A.copy(r)),0;const l=o*o,c=n.min,h=n.max,u=this.points;let g=Infinity;for(let e=0;e<8;e++){const t=u[e];r.copy(t).clamp(c,h);const s=t.distanceToSquared(r);if(s<g&&(g=s,a&&a.copy(t),A&&A.copy(r),s<l))return Math.sqrt(s)}let d=0;for(let i=0;i<3;i++)for(let r=0;r<=1;r++)for(let n=0;n<=1;n++){const o=(i+1)%3,a=(i+2)%3,A=1<<i|r<<o|n<<a,l=u[r<<o|n<<a],g=u[A];t[d].set(l,g);const p=e[i],f=e[o],m=e[a],I=s[d],C=I.start,B=I.end;C[p]=c[p],C[f]=r?c[f]:h[f],C[m]=n?c[m]:h[f],B[p]=h[p],B[f]=r?c[f]:h[f],B[m]=n?c[m]:h[f],d++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let s=0;s<=1;s++){r.x=e?h.x:c.x,r.y=t?h.y:c.y,r.z=s?h.z:c.z,this.closestPointToPoint(r,i);const n=r.distanceToSquared(i);if(n<g&&(g=n,a&&a.copy(i),A&&A.copy(r),n<l))return Math.sqrt(n)}for(let e=0;e<12;e++){const n=t[e];for(let e=0;e<12;e++){const t=s[e];kA(n,t,i,r);const o=i.distanceToSquared(r);if(o<g&&(g=o,a&&a.copy(i),A&&A.copy(r),o<l))return Math.sqrt(o)}}return Math.sqrt(g)}}();class qA{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class HA extends qA{constructor(){super((()=>new NA))}}const zA=new HA;const VA=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=s=>{t&&e.push(t),t=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==e.length&&this.setBuffer(e.pop())}}};let $A,YA;const JA=[],KA=new qA((()=>new dt));function WA(e,t,s,i,r,n){$A=KA.getPrimitive(),YA=KA.getPrimitive(),JA.push($A,YA),VA.setBuffer(e._roots[t]);const o=jA(0,e.geometry,s,i,r,n);VA.clearBuffer(),KA.releasePrimitive($A),KA.releasePrimitive(YA),JA.pop(),JA.pop();const a=JA.length;return a>0&&(YA=JA[a-1],$A=JA[a-2]),o}function jA(e,t,s,i,r=null,n=0,o=0){const{float32Array:a,uint16Array:A,uint32Array:l}=VA;let c=2*e;if(CA(c,A)){const t=BA(e,l),s=vA(c,A);return oA(e,a,$A),i(t,s,!1,o,n+e,$A)}{let c=function(e){const{uint16Array:t,uint32Array:s}=VA;let i=2*e;for(;!CA(i,t);)i=2*(e=yA(e));return BA(e,s)},h=function(e){const{uint16Array:t,uint32Array:s}=VA;let i=2*e;for(;!CA(i,t);)i=2*(e=EA(e,s));return BA(e,s)+vA(i,t)};const u=yA(e),g=EA(e,l);let d,p,f,m,I=u,C=g;if(r&&(f=$A,m=YA,oA(I,a,f),oA(C,a,m),d=r(f),p=r(m),p<d)){I=g,C=u;const e=d;d=p,p=e,f=m}f||(f=$A,oA(I,a,f));const B=s(f,CA(2*I,A),d,o+1,n+I);let v;if(2===B){const e=c(I);v=i(e,h(I)-e,!0,o+1,n+I,f)}else v=B&&jA(I,t,s,i,r,n,o+1);if(v)return!0;m=YA,oA(C,a,m);const y=s(m,CA(2*C,A),p,o+1,n+C);let E;if(2===y){const e=c(C);E=i(e,h(C)-e,!0,o+1,n+C,m)}else E=y&&jA(C,t,s,i,r,n,o+1);return!!E}}const XA=new Re,ZA=new Re;const el=parseInt(ms)>=169,tl=new Re,sl=new Re,il=new Re,rl=new u,nl=new u,ol=new u,al=new Re,Al=new Re,ll=new Re,cl=new Re;function hl(e,t,s,i,r,n,o,a,A,l,c){tl.fromBufferAttribute(t,n),sl.fromBufferAttribute(t,o),il.fromBufferAttribute(t,a);const h=function(e,t,s,i,r,n,o,a){let A;if(A=n===xt?e.intersectTriangle(i,s,t,!0,r):e.intersectTriangle(t,s,i,n!==Ne,r),null===A)return null;const l=e.origin.distanceTo(r);return l<o||l>a?null:{distance:l,point:r.clone()}}(e,tl,sl,il,cl,A,l,c);if(h){const t=new Re;fs.getBarycoord(cl,tl,sl,il,t),i&&(rl.fromBufferAttribute(i,n),nl.fromBufferAttribute(i,o),ol.fromBufferAttribute(i,a),h.uv=fs.getInterpolation(cl,tl,sl,il,rl,nl,ol,new u)),r&&(rl.fromBufferAttribute(r,n),nl.fromBufferAttribute(r,o),ol.fromBufferAttribute(r,a),h.uv1=fs.getInterpolation(cl,tl,sl,il,rl,nl,ol,new u)),s&&(al.fromBufferAttribute(s,n),Al.fromBufferAttribute(s,o),ll.fromBufferAttribute(s,a),h.normal=fs.getInterpolation(cl,tl,sl,il,al,Al,ll,new Re),h.normal.dot(e.direction)>0&&h.normal.multiplyScalar(-1));const A={a:n,b:o,c:a,normal:new Re,materialIndex:0};fs.getNormal(tl,sl,il,A.normal),h.face=A,h.faceIndex=n,el&&(h.barycoord=t)}return h}function ul(e,t,s,i,r,n,o){const a=3*i;let A=a+0,l=a+1,c=a+2;const h=e.index;e.index&&(A=h.getX(A),l=h.getX(l),c=h.getX(c));const{position:u,normal:g,uv:d,uv1:p}=e.attributes,f=hl(s,u,g,d,p,A,l,c,t,n,o);return f?(f.faceIndex=i,r&&r.push(f),f):null}function gl(e,t,s,i){const r=e.a,n=e.b,o=e.c;let a=t,A=t+1,l=t+2;s&&(a=s.getX(a),A=s.getX(A),l=s.getX(l)),r.x=i.getX(a),r.y=i.getY(a),r.z=i.getZ(a),n.x=i.getX(A),n.y=i.getY(A),n.z=i.getZ(A),o.x=i.getX(l),o.y=i.getY(l),o.z=i.getZ(l)}function dl(e,t,s,i,r,n,o){const{geometry:a}=s,{index:A}=a,l=a.attributes.position;for(let c=e,h=t+e;c<h;c++){let e;if(e=c,gl(o,3*e,A,l),o.needsUpdate=!0,i(o,e,r,n))return!0}return!1}function pl(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));const s=e.geometry,i=s.index?s.index.array:null,r=s.attributes.position;let n,o,a,A,l=0;const c=e._roots;for(let u=0,g=c.length;u<g;u++)n=c[u],o=new Uint32Array(n),a=new Uint16Array(n),A=new Float32Array(n),h(0,l),l+=n.byteLength;function h(e,s,n=!1){const l=2*e;if(a[l+15]===Xa){const t=o[e+6];let s=Infinity,n=Infinity,c=Infinity,h=-Infinity,u=-Infinity,g=-Infinity;for(let e=3*t,o=3*(t+a[l+14]);e<o;e++){let t=i[e];const o=r.getX(t),a=r.getY(t),A=r.getZ(t);o<s&&(s=o),o>h&&(h=o),a<n&&(n=a),a>u&&(u=a),A<c&&(c=A),A>g&&(g=A)}return(A[e+0]!==s||A[e+1]!==n||A[e+2]!==c||A[e+3]!==h||A[e+4]!==u||A[e+5]!==g)&&(A[e+0]=s,A[e+1]=n,A[e+2]=c,A[e+3]=h,A[e+4]=u,A[e+5]=g,!0)}{const i=e+8,r=o[e+6],a=i+s,l=r+s;let c=n,u=!1,g=!1;t?c||(u=t.has(a),g=t.has(l),c=!u&&!g):(u=!0,g=!0);const d=c||g;let p=!1;(c||u)&&(p=h(i,s,c));let f=!1;d&&(f=h(r,s,c));const m=p||f;if(m)for(let t=0;t<3;t++){const s=i+t,n=r+t,o=A[s],a=A[s+3],l=A[n],c=A[n+3];A[e+t]=o<l?o:l,A[e+t+3]=a>c?a:c}return m}}}function fl(e,t,s,i,r){let n,o,a,A,l,c;const h=1/s.direction.x,u=1/s.direction.y,g=1/s.direction.z,d=s.origin.x,p=s.origin.y,f=s.origin.z;let m=t[e],I=t[e+3],C=t[e+1],B=t[e+3+1],v=t[e+2],y=t[e+3+2];return h>=0?(n=(m-d)*h,o=(I-d)*h):(n=(I-d)*h,o=(m-d)*h),u>=0?(a=(C-p)*u,A=(B-p)*u):(a=(B-p)*u,A=(C-p)*u),!(n>A||a>o)&&((a>n||isNaN(n))&&(n=a),(A<o||isNaN(o))&&(o=A),g>=0?(l=(v-f)*g,c=(y-f)*g):(l=(y-f)*g,c=(v-f)*g),!(n>c||l>o)&&((l>n||n!=n)&&(n=l),(c<o||o!=o)&&(o=c),n<=r&&o>=i))}function ml(e,t,s,i,r,n,o){const{geometry:a}=s,{index:A}=a,l=a.attributes.position;for(let c=e,h=t+e;c<h;c++){let e;if(e=s.resolveTriangleIndex(c),gl(o,3*e,A,l),o.needsUpdate=!0,i(o,e,r,n))return!0}return!1}function Il(e,t,s,i,r,n,o){VA.setBuffer(e._roots[t]),Cl(0,e,s,i,r,n,o),VA.clearBuffer()}function Cl(e,t,s,i,r,n,o){const{float32Array:a,uint16Array:A,uint32Array:l}=VA,c=2*e;if(CA(c,A)){!function(e,t,s,i,r,n,o,a){const{geometry:A,_indirectBuffer:l}=e;for(let c=i,h=i+r;c<h;c++)ul(A,t,s,c,n,o,a)}(t,s,i,BA(e,l),vA(c,A),r,n,o)}else{const A=yA(e);fl(A,a,i,n,o)&&Cl(A,t,s,i,r,n,o);const c=EA(e,l);fl(c,a,i,n,o)&&Cl(c,t,s,i,r,n,o)}}const Bl=["x","y","z"];function vl(e,t,s,i,r,n){VA.setBuffer(e._roots[t]);const o=yl(0,e,s,i,r,n);return VA.clearBuffer(),o}function yl(e,t,s,i,r,n){const{float32Array:o,uint16Array:a,uint32Array:A}=VA;let l=2*e;if(CA(l,a)){return function(e,t,s,i,r,n,o){const{geometry:a,_indirectBuffer:A}=e;let l=Infinity,c=null;for(let h=i,u=i+r;h<u;h++){let e;e=ul(a,t,s,h,null,n,o),e&&e.distance<l&&(c=e,l=e.distance)}return c}(t,s,i,BA(e,A),vA(l,a),r,n)}{const a=wA(e,A),l=Bl[a],c=i.direction[l]>=0;let h,u;c?(h=yA(e),u=EA(e,A)):(h=EA(e,A),u=yA(e));const g=fl(h,o,i,r,n)?yl(h,t,s,i,r,n):null;if(g){const e=g.point[l];if(c?e<=o[u+a]:e>=o[u+a+3])return g}const d=fl(u,o,i,r,n)?yl(u,t,s,i,r,n):null;return g&&d?g.distance<=d.distance?g:d:g||d||null}}const El=new dt,wl=new NA,Ql=new NA,xl=new Se,bl=new OA,Sl=new OA;function Rl(e,t,s,i){VA.setBuffer(e._roots[t]);const r=Dl(0,e,s,i);return VA.clearBuffer(),r}function Dl(e,t,s,i,r=null){const{float32Array:n,uint16Array:o,uint32Array:a}=VA;let A=2*e;null===r&&(s.boundingBox||s.computeBoundingBox(),bl.set(s.boundingBox.min,s.boundingBox.max,i),r=bl);if(!CA(A,o)){const o=e+8,A=a[e+6];oA(o,n,El);if(r.intersectsBox(El)&&Dl(o,t,s,i,r))return!0;oA(A,n,El);return!!(r.intersectsBox(El)&&Dl(A,t,s,i,r))}{const r=t.geometry,l=r.index,c=r.attributes.position,h=s.index,u=s.attributes.position,g=BA(e,a),d=vA(A,o);if(xl.copy(i).invert(),s.boundsTree){oA(e,n,Sl),Sl.matrix.copy(xl),Sl.needsUpdate=!0;const t=s.boundsTree.shapecast({intersectsBounds:e=>Sl.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(i),e.b.applyMatrix4(i),e.c.applyMatrix4(i),e.needsUpdate=!0;for(let t=3*g,s=3*(d+g);t<s;t+=3)if(gl(Ql,t,l,c),Ql.needsUpdate=!0,e.intersectsTriangle(Ql))return!0;return!1}});return t}for(let e=3*g,t=3*(d+g);e<t;e+=3){gl(wl,e,l,c),wl.a.applyMatrix4(xl),wl.b.applyMatrix4(xl),wl.c.applyMatrix4(xl),wl.needsUpdate=!0;for(let e=0,t=h.count;e<t;e+=3)if(gl(Ql,e,h,u),Ql.needsUpdate=!0,wl.intersectsTriangle(Ql))return!0}}}const Tl=new Se,Ml=new OA,_l=new OA,Fl=new Re,Pl=new Re,Ul=new Re,kl=new Re;function Ll(e,t,s,i={},r={},n=0,o=Infinity){t.boundingBox||t.computeBoundingBox(),Ml.set(t.boundingBox.min,t.boundingBox.max,s),Ml.needsUpdate=!0;const a=e.geometry,A=a.attributes.position,l=a.index,c=t.attributes.position,h=t.index,u=zA.getPrimitive(),g=zA.getPrimitive();let d=Fl,p=Pl,f=null,m=null;r&&(f=Ul,m=kl);let I=Infinity,C=null,B=null;return Tl.copy(s).invert(),_l.matrix.copy(Tl),e.shapecast({boundsTraverseOrder:e=>Ml.distanceToBox(e),intersectsBounds:(e,t,s)=>s<I&&s<o&&(t&&(_l.min.copy(e.min),_l.max.copy(e.max),_l.needsUpdate=!0),!0),intersectsRange:(e,i)=>{if(t.boundsTree){return t.boundsTree.shapecast({boundsTraverseOrder:e=>_l.distanceToBox(e),intersectsBounds:(e,t,s)=>s<I&&s<o,intersectsRange:(t,r)=>{for(let o=t,a=t+r;o<a;o++){gl(g,3*o,h,c),g.a.applyMatrix4(s),g.b.applyMatrix4(s),g.c.applyMatrix4(s),g.needsUpdate=!0;for(let t=e,s=e+i;t<s;t++){gl(u,3*t,l,A),u.needsUpdate=!0;const e=u.distanceToTriangle(g,d,f);if(e<I&&(p.copy(d),m&&m.copy(f),I=e,C=t,B=o),e<n)return!0}}}})}for(let r=0,o=tA(t);r<o;r++){gl(g,3*r,h,c),g.a.applyMatrix4(s),g.b.applyMatrix4(s),g.c.applyMatrix4(s),g.needsUpdate=!0;for(let t=e,s=e+i;t<s;t++){gl(u,3*t,l,A),u.needsUpdate=!0;const e=u.distanceToTriangle(g,d,f);if(e<I&&(p.copy(d),m&&m.copy(f),I=e,C=t,B=r),e<n)return!0}}}}),zA.releasePrimitive(u),zA.releasePrimitive(g),Infinity===I?null:(i.point?i.point.copy(p):i.point=p.clone(),i.distance=I,i.faceIndex=C,r&&(r.point?r.point.copy(m):r.point=m.clone(),r.point.applyMatrix4(Tl),p.applyMatrix4(Tl),r.distance=p.sub(r.point).length(),r.faceIndex=B),i)}function Gl(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));const s=e.geometry,i=s.index?s.index.array:null,r=s.attributes.position;let n,o,a,A,l=0;const c=e._roots;for(let u=0,g=c.length;u<g;u++)n=c[u],o=new Uint32Array(n),a=new Uint16Array(n),A=new Float32Array(n),h(0,l),l+=n.byteLength;function h(s,n,l=!1){const c=2*s;if(a[c+15]===Xa){const t=o[s+6];let n=Infinity,l=Infinity,h=Infinity,u=-Infinity,g=-Infinity,d=-Infinity;for(let s=t,o=t+a[c+14];s<o;s++){const t=3*e.resolveTriangleIndex(s);for(let e=0;e<3;e++){let s=t+e;s=i?i[s]:s;const o=r.getX(s),a=r.getY(s),A=r.getZ(s);o<n&&(n=o),o>u&&(u=o),a<l&&(l=a),a>g&&(g=a),A<h&&(h=A),A>d&&(d=A)}}return(A[s+0]!==n||A[s+1]!==l||A[s+2]!==h||A[s+3]!==u||A[s+4]!==g||A[s+5]!==d)&&(A[s+0]=n,A[s+1]=l,A[s+2]=h,A[s+3]=u,A[s+4]=g,A[s+5]=d,!0)}{const e=s+8,i=o[s+6],r=e+n,a=i+n;let c=l,u=!1,g=!1;t?c||(u=t.has(r),g=t.has(a),c=!u&&!g):(u=!0,g=!0);const d=c||g;let p=!1;(c||u)&&(p=h(e,n,c));let f=!1;d&&(f=h(i,n,c));const m=p||f;if(m)for(let t=0;t<3;t++){const r=e+t,n=i+t,o=A[r],a=A[r+3],l=A[n],c=A[n+3];A[s+t]=o<l?o:l,A[s+t+3]=a>c?a:c}return m}}}function Nl(e,t,s,i,r,n,o){VA.setBuffer(e._roots[t]),Ol(0,e,s,i,r,n,o),VA.clearBuffer()}function Ol(e,t,s,i,r,n,o){const{float32Array:a,uint16Array:A,uint32Array:l}=VA,c=2*e;if(CA(c,A)){!function(e,t,s,i,r,n,o,a){const{geometry:A,_indirectBuffer:l}=e;for(let c=i,h=i+r;c<h;c++)ul(A,t,s,l?l[c]:c,n,o,a)}(t,s,i,BA(e,l),vA(c,A),r,n,o)}else{const A=yA(e);fl(A,a,i,n,o)&&Ol(A,t,s,i,r,n,o);const c=EA(e,l);fl(c,a,i,n,o)&&Ol(c,t,s,i,r,n,o)}}const ql=["x","y","z"];function Hl(e,t,s,i,r,n){VA.setBuffer(e._roots[t]);const o=zl(0,e,s,i,r,n);return VA.clearBuffer(),o}function zl(e,t,s,i,r,n){const{float32Array:o,uint16Array:a,uint32Array:A}=VA;let l=2*e;if(CA(l,a)){return function(e,t,s,i,r,n,o){const{geometry:a,_indirectBuffer:A}=e;let l=Infinity,c=null;for(let h=i,u=i+r;h<u;h++){let e;e=ul(a,t,s,A?A[h]:h,null,n,o),e&&e.distance<l&&(c=e,l=e.distance)}return c}(t,s,i,BA(e,A),vA(l,a),r,n)}{const a=wA(e,A),l=ql[a],c=i.direction[l]>=0;let h,u;c?(h=yA(e),u=EA(e,A)):(h=EA(e,A),u=yA(e));const g=fl(h,o,i,r,n)?zl(h,t,s,i,r,n):null;if(g){const e=g.point[l];if(c?e<=o[u+a]:e>=o[u+a+3])return g}const d=fl(u,o,i,r,n)?zl(u,t,s,i,r,n):null;return g&&d?g.distance<=d.distance?g:d:g||d||null}}const Vl=new dt,$l=new NA,Yl=new NA,Jl=new Se,Kl=new OA,Wl=new OA;function jl(e,t,s,i){VA.setBuffer(e._roots[t]);const r=Xl(0,e,s,i);return VA.clearBuffer(),r}function Xl(e,t,s,i,r=null){const{float32Array:n,uint16Array:o,uint32Array:a}=VA;let A=2*e;null===r&&(s.boundingBox||s.computeBoundingBox(),Kl.set(s.boundingBox.min,s.boundingBox.max,i),r=Kl);if(!CA(A,o)){const o=e+8,A=a[e+6];oA(o,n,Vl);if(r.intersectsBox(Vl)&&Xl(o,t,s,i,r))return!0;oA(A,n,Vl);return!!(r.intersectsBox(Vl)&&Xl(A,t,s,i,r))}{const r=t.geometry,l=r.index,c=r.attributes.position,h=s.index,u=s.attributes.position,g=BA(e,a),d=vA(A,o);if(Jl.copy(i).invert(),s.boundsTree){oA(e,n,Wl),Wl.matrix.copy(Jl),Wl.needsUpdate=!0;const r=s.boundsTree.shapecast({intersectsBounds:e=>Wl.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(i),e.b.applyMatrix4(i),e.c.applyMatrix4(i),e.needsUpdate=!0;for(let s=g,i=d+g;s<i;s++)if(gl(Yl,3*t.resolveTriangleIndex(s),l,c),Yl.needsUpdate=!0,e.intersectsTriangle(Yl))return!0;return!1}});return r}for(let e=g,s=d+g;e<s;e++){const s=t.resolveTriangleIndex(e);gl($l,3*s,l,c),$l.a.applyMatrix4(Jl),$l.b.applyMatrix4(Jl),$l.c.applyMatrix4(Jl),$l.needsUpdate=!0;for(let e=0,t=h.count;e<t;e+=3)if(gl(Yl,e,h,u),Yl.needsUpdate=!0,$l.intersectsTriangle(Yl))return!0}}}const Zl=new Se,ec=new OA,tc=new OA,sc=new Re,ic=new Re,rc=new Re,nc=new Re;function oc(e,t,s,i={},r={},n=0,o=Infinity){t.boundingBox||t.computeBoundingBox(),ec.set(t.boundingBox.min,t.boundingBox.max,s),ec.needsUpdate=!0;const a=e.geometry,A=a.attributes.position,l=a.index,c=t.attributes.position,h=t.index,u=zA.getPrimitive(),g=zA.getPrimitive();let d=sc,p=ic,f=null,m=null;r&&(f=rc,m=nc);let I=Infinity,C=null,B=null;return Zl.copy(s).invert(),tc.matrix.copy(Zl),e.shapecast({boundsTraverseOrder:e=>ec.distanceToBox(e),intersectsBounds:(e,t,s)=>s<I&&s<o&&(t&&(tc.min.copy(e.min),tc.max.copy(e.max),tc.needsUpdate=!0),!0),intersectsRange:(i,r)=>{if(t.boundsTree){const a=t.boundsTree;return a.shapecast({boundsTraverseOrder:e=>tc.distanceToBox(e),intersectsBounds:(e,t,s)=>s<I&&s<o,intersectsRange:(t,o)=>{for(let v=t,y=t+o;v<y;v++){const t=a.resolveTriangleIndex(v);gl(g,3*t,h,c),g.a.applyMatrix4(s),g.b.applyMatrix4(s),g.c.applyMatrix4(s),g.needsUpdate=!0;for(let s=i,o=i+r;s<o;s++){const t=e.resolveTriangleIndex(s);gl(u,3*t,l,A),u.needsUpdate=!0;const i=u.distanceToTriangle(g,d,f);if(i<I&&(p.copy(d),m&&m.copy(f),I=i,C=s,B=v),i<n)return!0}}}})}for(let o=0,a=tA(t);o<a;o++){gl(g,3*o,h,c),g.a.applyMatrix4(s),g.b.applyMatrix4(s),g.c.applyMatrix4(s),g.needsUpdate=!0;for(let t=i,s=i+r;t<s;t++){const s=e.resolveTriangleIndex(t);gl(u,3*s,l,A),u.needsUpdate=!0;const i=u.distanceToTriangle(g,d,f);if(i<I&&(p.copy(d),m&&m.copy(f),I=i,C=t,B=o),i<n)return!0}}}}),zA.releasePrimitive(u),zA.releasePrimitive(g),Infinity===I?null:(i.point?i.point.copy(p):i.point=p.clone(),i.distance=I,i.faceIndex=C,r&&(r.point?r.point.copy(m):r.point=m.clone(),r.point.applyMatrix4(Zl),p.applyMatrix4(Zl),r.distance=p.sub(r.point).length(),r.faceIndex=B),i)}const ac=new VA.constructor,Ac=new VA.constructor,lc=new qA((()=>new dt)),cc=new dt,hc=new dt,uc=new dt,gc=new dt;let dc=!1;function pc(e,t,s,i,r,n=0,o=0,a=0,A=0,l=null,c=!1){let h,u;c?(h=Ac,u=ac):(h=ac,u=Ac);const g=h.float32Array,d=h.uint32Array,p=h.uint16Array,f=u.float32Array,m=u.uint32Array,I=u.uint16Array,C=2*t,B=CA(2*e,p),v=CA(C,I);let y=!1;if(v&&B)y=c?r(BA(t,m),vA(2*t,I),BA(e,d),vA(2*e,p),A,o+t,a,n+e):r(BA(e,d),vA(2*e,p),BA(t,m),vA(2*t,I),a,n+e,A,o+t);else if(v){const l=lc.getPrimitive();oA(t,f,l),l.applyMatrix4(s);const h=yA(e),u=EA(e,d);oA(h,g,cc),oA(u,g,hc);const p=l.intersectsBox(cc),m=l.intersectsBox(hc);y=p&&pc(t,h,i,s,r,o,n,A,a+1,l,!c)||m&&pc(t,u,i,s,r,o,n,A,a+1,l,!c),lc.releasePrimitive(l)}else{const h=yA(t),u=EA(t,m);oA(h,f,uc),oA(u,f,gc);const p=l.intersectsBox(uc),I=l.intersectsBox(gc);if(p&&I)y=pc(e,h,s,i,r,n,o,a,A+1,l,c)||pc(e,u,s,i,r,n,o,a,A+1,l,c);else if(p)if(B)y=pc(e,h,s,i,r,n,o,a,A+1,l,c);else{const t=lc.getPrimitive();t.copy(uc).applyMatrix4(s);const l=yA(e),u=EA(e,d);oA(l,g,cc),oA(u,g,hc);const p=t.intersectsBox(cc),f=t.intersectsBox(hc);y=p&&pc(h,l,i,s,r,o,n,A,a+1,t,!c)||f&&pc(h,u,i,s,r,o,n,A,a+1,t,!c),lc.releasePrimitive(t)}else if(I)if(B)y=pc(e,u,s,i,r,n,o,a,A+1,l,c);else{const t=lc.getPrimitive();t.copy(gc).applyMatrix4(s);const l=yA(e),h=EA(e,d);oA(l,g,cc),oA(h,g,hc);const p=t.intersectsBox(cc),f=t.intersectsBox(hc);y=p&&pc(u,l,i,s,r,o,n,A,a+1,t,!c)||f&&pc(u,h,i,s,r,o,n,A,a+1,t,!c),lc.releasePrimitive(t)}}return y}const fc=new OA,mc=new dt,Ic={strategy:0,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class Cc{static serialize(e,t={}){t={cloneBuffers:!0,...t};const s=e.geometry,i=e._roots,r=e._indirectBuffer,n=s.getIndex();let o;return o=t.cloneBuffers?{roots:i.map((e=>e.slice())),index:n?n.array.slice():null,indirectBuffer:r?r.slice():null}:{roots:i,index:n?n.array:null,indirectBuffer:r},o}static deserialize(e,t,s={}){s={setIndex:!0,indirect:Boolean(e.indirectBuffer),...s};const{index:i,roots:r,indirectBuffer:n}=e,o=new Cc(t,{...s,[eA]:!0});if(o._roots=r,o._indirectBuffer=n||null,s.setIndex){const s=t.getIndex();if(null===s){const s=new D(e.index,1,!1);t.setIndex(s)}else s.array!==i&&(s.array.set(i),s.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((t=Object.assign({...Ic,[eA]:!1},t)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[eA]||(FA(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new dt))),this.resolveTriangleIndex=t.indirect?e=>this._indirectBuffer[e]:e=>e}refit(e=null){return(this.indirect?Gl:pl)(this,e)}traverse(e,t=0){const s=this._roots[t],i=new Uint32Array(s),r=new Uint16Array(s);!function t(n,o=0){const a=2*n,A=r[a+15]===Xa;if(A){const t=i[n+6],l=r[a+14];e(o,A,new Float32Array(s,4*n,6),t,l)}else{const r=n+8,a=i[n+6],l=i[n+7];e(o,A,new Float32Array(s,4*n,6),l)||(t(r,o+1),t(a,o+1))}}(0)}raycast(e,t=lt,s=0,i=Infinity){const r=this._roots,n=this.geometry,o=[],a=t.isMaterial,A=Array.isArray(t),l=n.groups,c=a?t.side:t,h=this.indirect?Nl:Il;for(let u=0,g=r.length;u<g;u++){const r=A?t[l[u].materialIndex].side:c,n=o.length;if(h(this,u,r,e,o,s,i),A){const e=l[u].materialIndex;for(let t=n,s=o.length;t<s;t++)o[t].face.materialIndex=e}}return o}raycastFirst(e,t=lt,s=0,i=Infinity){const r=this._roots,n=this.geometry,o=t.isMaterial,a=Array.isArray(t);let A=null;const l=n.groups,c=o?t.side:t,h=this.indirect?Hl:vl;for(let u=0,g=r.length;u<g;u++){const r=h(this,u,a?t[l[u].materialIndex].side:c,e,s,i);null!=r&&(null==A||r.distance<A.distance)&&(A=r,a&&(r.face.materialIndex=l[u].materialIndex))}return A}intersectsGeometry(e,t){let s=!1;const i=this._roots,r=this.indirect?jl:Rl;for(let n=0,o=i.length;n<o&&(s=r(this,n,e,t),!s);n++);return s}shapecast(e){const t=zA.getPrimitive(),s=this.indirect?ml:dl;let{boundsTraverseOrder:i,intersectsBounds:r,intersectsRange:n,intersectsTriangle:o}=e;if(n&&o){const e=n;n=(i,r,n,a,A)=>!!e(i,r,n,a,A)||s(i,r,this,o,n,a,t)}else n||(n=o?(e,i,r,n)=>s(e,i,this,o,r,n,t):(e,t,s)=>s);let a=!1,A=0;const l=this._roots;for(let c=0,h=l.length;c<h;c++){const e=l[c];if(a=WA(this,c,r,n,i,A),a)break;A+=e.byteLength}return zA.releasePrimitive(t),a}bvhcast(e,t,s){let{intersectsRanges:i,intersectsTriangles:r}=s;const n=zA.getPrimitive(),o=this.geometry.index,a=this.geometry.attributes.position,A=this.indirect?e=>{const t=this.resolveTriangleIndex(e);gl(n,3*t,o,a)}:e=>{gl(n,3*e,o,a)},l=zA.getPrimitive(),c=e.geometry.index,h=e.geometry.attributes.position,u=e.indirect?t=>{const s=e.resolveTriangleIndex(t);gl(l,3*s,c,h)}:e=>{gl(l,3*e,c,h)};if(r){const e=(e,s,i,o,a,c,h,g)=>{for(let d=i,p=i+o;d<p;d++){u(d),l.a.applyMatrix4(t),l.b.applyMatrix4(t),l.c.applyMatrix4(t),l.needsUpdate=!0;for(let t=e,i=e+s;t<i;t++)if(A(t),n.needsUpdate=!0,r(n,l,t,d,a,c,h,g))return!0}return!1};if(i){const t=i;i=function(s,i,r,n,o,a,A,l){return!!t(s,i,r,n,o,a,A,l)||e(s,i,r,n,o,a,A,l)}}else i=e}return function(e,t,s,i){if(dc)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");dc=!0;const r=e._roots,n=t._roots;let o,a=0,A=0;const l=(new Se).copy(s).invert();for(let c=0,h=r.length;c<h;c++){ac.setBuffer(r[c]),A=0;const e=lc.getPrimitive();oA(0,ac.float32Array,e),e.applyMatrix4(l);for(let t=0,r=n.length;t<r&&(Ac.setBuffer(n[t]),o=pc(0,0,s,l,i,a,A,0,0,e),Ac.clearBuffer(),A+=n[t].length,!o);t++);if(lc.releasePrimitive(e),ac.clearBuffer(),a+=r[c].length,o)break}return dc=!1,o}(this,e,t,i)}intersectsBox(e,t){return fc.set(e.min,e.max,t),fc.needsUpdate=!0,this.shapecast({intersectsBounds:e=>fc.intersectsBox(e),intersectsTriangle:e=>fc.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,s={},i={},r=0,n=Infinity){return(this.indirect?oc:Ll)(this,e,t,s,i,r,n)}closestPointToPoint(e,t={},s=0,i=Infinity){return function(e,t,s={},i=0,r=Infinity){const n=i*i,o=r*r;let a=Infinity,A=null;if(e.shapecast({boundsTraverseOrder:e=>(XA.copy(t).clamp(e.min,e.max),XA.distanceToSquared(t)),intersectsBounds:(e,t,s)=>s<a&&s<o,intersectsTriangle:(e,s)=>{e.closestPointToPoint(t,XA);const i=t.distanceToSquared(XA);return i<a&&(ZA.copy(XA),a=i,A=s),i<n}}),Infinity===a)return null;const l=Math.sqrt(a);return s.point?s.point.copy(ZA):s.point=ZA.clone(),s.distance=l,s.faceIndex=A,s}(this,e,t,s,i)}getBoundingBox(e){e.makeEmpty();return this._roots.forEach((t=>{oA(0,new Float32Array(t),mc),e.union(mc)})),e}}function Bc(e,t,s){return null===e?null:(e.point.applyMatrix4(t.matrixWorld),e.distance=e.point.distanceTo(s.ray.origin),e.object=t,e)}const vc=new Is,yc=new Re,Ec=new Se,wc=M.prototype.raycast,Qc=Cs.prototype.raycast,xc=new Re,bc=new M,Sc=[];function Rc(e,t){this.isBatchedMesh?Dc.call(this,e,t):Tc.call(this,e,t)}function Dc(e,t){if(this.boundsTrees){const s=this.boundsTrees,i=this._drawInfo,r=this._drawRanges,n=this.matrixWorld;bc.material=this.material,bc.geometry=this.geometry;const o=bc.geometry.boundsTree,a=bc.geometry.drawRange;null===bc.geometry.boundingSphere&&(bc.geometry.boundingSphere=new pt);for(let A=0,l=i.length;A<l;A++){if(!this.getVisibleAt(A))continue;const o=i[A].geometryIndex;if(bc.geometry.boundsTree=s[o],this.getMatrixAt(A,bc.matrixWorld).premultiply(n),!bc.geometry.boundsTree){this.getBoundingBoxAt(o,bc.geometry.boundingBox),this.getBoundingSphereAt(o,bc.geometry.boundingSphere);const e=r[o];bc.geometry.setDrawRange(e.start,e.count)}bc.raycast(e,Sc);for(let e=0,s=Sc.length;e<s;e++){const s=Sc[e];s.object=this,s.batchId=A,t.push(s)}Sc.length=0}bc.geometry.boundsTree=o,bc.geometry.drawRange=a,bc.material=null,bc.geometry=null}else Qc.call(this,e,t)}function Tc(e,t){if(this.geometry.boundsTree){if(void 0===this.material)return;Ec.copy(this.matrixWorld).invert(),vc.copy(e.ray).applyMatrix4(Ec),xc.setFromMatrixScale(this.matrixWorld),yc.copy(vc.direction).multiply(xc);const s=yc.length(),i=e.near/s,r=e.far/s,n=this.geometry.boundsTree;if(!0===e.firstHitOnly){const s=Bc(n.raycastFirst(vc,this.material,i,r),this,e);s&&t.push(s)}else{const s=n.raycast(vc,this.material,i,r);for(let i=0,r=s.length;i<r;i++){const r=Bc(s[i],this,e);r&&t.push(r)}}}else wc.call(this,e,t)}const Mc=3e3;class _c extends $a{constructor(e){super(e),r(this,"isEditable",!0)}get meshMaterial(){return this._meshMat=this._meshMat??new Wa}init(){super.init(),this.base.visible=!0,this.base.prevMatrix=this.base.matrix.clone(),this.base.matrixUpdateTimer=Mc,this.yRotOffsetMin=0,this.yRotOffsetMax=-.4,this.yRotOffset=0,this.yRotOffsetEased=0}normalizeSetItemParams(e){const{logoType:t,logoSpot:s}=U.$app.$editor.edition;return e.logoType=e.logoType??t,e.logoSpot=e.logoSpot??s,e}afterSwap(){var e;const t=this.mesh;this.base.matrixUpdateTimer=Mc,t.geometry.boundsTree||(t.updateWorldMatrix(!0,!0),t.raycast=Rc,t.geometry.boundsTree=new Cc(t.geometry,{setBoundingBox:!0}),t.geometry.boundsTree.refit()),(null==(e=this.parent)?void 0:e.draw)&&(this.parent.draw.seamsFixer.needsIslandRender=!0),this.needsLogoFocusUpdate=!0}update(){super.update(),this.base.updateMatrix(),this.needsLogoFocusUpdate&&(this.scene.logoFocus.instantRefresh(),this.needsLogoFocusUpdate=!1),this.meshBase.rotation.x=this.scene.ctrls.rx,this.meshBase.rotation.y=this.scene.ctrls.ry,this.yRotOffset=Bs(this.yRotOffsetMax,this.yRotOffsetMin,this.webgl.$app.$editor.controls.isInEditableView),this.yRotOffsetEased=Bs(this.yRotOffsetEased,this.yRotOffset,.1),this.meshBase.rotation.y+=this.yRotOffsetEased}afterUpdate(){const e=U.$time.dt,t=this.base,s=t.matrixUpdateTimer-=Math.min(100,e);t.prevMatrix.equals(t.matrix)?t.matrixWorldAutoUpdate=s>0:(t.matrixUpdateTimer=Mc,t.matrixWorldAutoUpdate=!0)}reset(){var e,t;null==(t=null==(e=this.scene)?void 0:e.group)||t.reset()}}class Fc extends In{constructor(){super(...arguments),r(this,"isInLogoTool",!1),r(this,"currentSpot",null),r(this,"currentType",null),r(this,"needsLogoAppear",!1),r(this,"currentTween",-1),r(this,"prevPos",null),r(this,"currentLogo",null),r(this,"i",0)}init(){this.base=null}update(){const{$app:e}=U,t="logo"===e.$editor.edition.activeTool&&e.$editor.controls.isInEditableView;if(this.isInLogoTool!==t?(this.isInLogoTool=t,this.onLogoToolChanges()):t&&this.hasLogoChanged()&&this.focusOnLogo(),this.needsLogoAppear){const e=this.scene.camera.controls,t=e.currentTweenId!==this.currentTween||e.isTweenFinished,s=!this.currentLogo||this.currentLogo.isHidden;t&&s&&this.showLogo()}}showLogo(){const{logoType:e,logoSpot:t}=U.$app.$editor.edition;this.needsLogoAppear=!1,Qa.material.swapType(e),this.currentLogo=this.parent.item.logos[t],this.currentLogo.show(),this.scene.item.shake(.24)}hasLogoChanged(){const{logoType:e,logoSpot:t}=U.$app.$editor.edition;return t!==this.currentSpot||e!==this.currentType}onLogoToolChanges(){const{scene:e}=this.scene;this.isInLogoTool?(this.prevPos=e.camera.export(),this.focusOnLogo()):this.prevPos?e.camera.import(this.prevPos):e.camera.reset()}focusOnLogo(){const{$app:e}=U,t=e.$editor.edition,s=e.$editor.config.items[t.activeItem],i=t.logoSpot,r=t.logoType,n=s.logoSpots[i];this.needsLogoAppear=this.hasLogoChanged(),this.currentLogo&&this.needsLogoAppear&&this.currentLogo.hide(),this.currentTween=this.scene.camera.import(n),this.currentSpot=i,this.currentType=r}resetLogo(){U.$app.$editor.edition.setLogoSpot(null),U.$app.$editor.edition.setLogoType(null),this.instantRefresh()}instantRefresh(){const{logoType:e,logoSpot:t}=U.$app.$editor.edition;Qa.material.swapType(e,!0),this.currentLogo&&this.currentLogo.hideInstant(),this.currentSpot=t,this.currentType=e,this.currentLogo=this.parent.item.logos[t],this.currentLogo.showInstant()}}const Pc=Rn("precision highp float;varying vec2 vUv;uniform vec4 res;uniform float time;uniform sampler2D scene;uniform float brushSize;uniform vec4 brushCoords;uniform vec4 thumbCoords;uniform float thumbVisibility;\n#include <luma>\n#include <drawline>\nfloat drawRect(vec2 pixelCoords,vec2 rectCenter,vec2 rectSize){vec2 halfSize=rectSize*0.5;vec2 minBound=rectCenter-halfSize;vec2 maxBound=rectCenter+halfSize;bool inside=(pixelCoords.x>=minBound.x&&pixelCoords.x<=maxBound.x&&pixelCoords.y>=minBound.y&&pixelCoords.y<=maxBound.y);return inside?1.0:0.0;}void main(){vec2 pxUv=vec2(gl_FragCoord.x*res.w,(res.y-gl_FragCoord.y)*res.w);vec4 texel=texture2D(scene,vUv);vec3 col=texel.rgb;float vignette=1.-length(vUv-0.5)*1.5;vec3 c2=mix(col,col*col,0.5);col=mix(col,c2-0.06,(1.-smoothstep(-0.1,0.7,vignette)));col=mix(col,c2-0.3,(1.-smoothstep(-0.2,0.4,vignette))*0.4);float yGrad=smoothstep(150.0,-50.0,pxUv.y);col=mix(col,mix(col,col*col,0.4)-0.04,yGrad);float thumb=1.-drawRect(pxUv,thumbCoords.xy,thumbCoords.zw);vec3 thumbCol=vec3(0.0080,0.3813,0.0222)*(luma(col*0.6)*0.3+0.2)+luma(col)*0.1;col=mix(col,thumbCol,max(thumb,smoothstep(190.,30.,thumbCoords.z)));float circ=distance(pxUv,brushCoords.xy);float e=2.;float brushShape=(smoothstep(brushSize+e+0.6,brushSize+e,circ)-smoothstep(brushSize+0.6,brushSize,circ))*sign(brushSize);vec3 brushCol=smoothstep(0.2,0.9,vec3(1.-luma(col+0.1)));brushCol*=brushCol;col=mix(col,brushCol,brushShape);gl_FragColor=vec4(col,1.);}","fragmentShader");class Uc extends In{constructor(){super(),this.baseRT=Uc.rt??U.$fbo.createBuffer({name:"PostFX",scale:1,samples:4}),B((()=>U.$app.$store.rtSamples),(e=>{this.baseRT.samples=e}))}}class kc extends Uc{constructor(){super(...arguments),r(this,"isSubmitActive",!1),r(this,"forceThumb",h(!1))}init(){this.filter=Ys({useRawShader:!1,fragmentShader:Pc,uniforms:{scene:{value:this.baseRT.texture},res:U.$uniforms.res,time:U.$uniforms.time,brushSize:{value:0},brushCoords:{value:new Qt},thumbCoords:{value:new Qt}}}),Fn.use(this.filter.material)}attached(){U.$viewport.size.watchImmediate((()=>this.updateThumbEffect(!0)))}updateCursor(e,t,s){const i=this.filter.uniforms,r=i.brushCoords.value,n=i.brushSize.value<.001||s<.001;i.brushSize.value=s,n?r.set(e,t,e,t):r.set(e,t,r.x,r.y)}render(){const e=this.scene.getCurrentCamera();if(!e)return;const t=U.$threeRenderer,s=t.getRenderTarget();t.setRenderTarget(this.baseRT),this.scene.updateRenderBounds(),this.scene.clampRenderBounds(),U.$threeRenderer.clearDepth(),e.cam.layers.set(U.layers.base),t.render(this.scene.base,e.cam),this.scene.disableClampRender(),t.setRenderTarget(s),this.filter.render()}updateThumbEffect(e){const t=U.$time.dt,s=this.forceThumb.value,i=this.isSubmitActive,r=this.scene.thumbGen.coords,n=this.filter.uniforms.thumbCoords.value,o=U.$viewport.size.value.x,a=U.$viewport.size.value.y;let A=o,l=a,c=.5*a;if(s?(A=r.z,l=r.w,c=r.y):i&&(A=0,l=0,c=r.y),e)n.x=r.x,n.y=c,n.z=A,n.w=l;else{const e=this.isSubmitActive?.23:.2;n.x=r.x,n.y=kt(n.y,c,e,t),n.z=kt(n.z,A,e,t),n.w=kt(n.w,l,e,t)}}update(){this.updateThumbEffect()}toggleSubmitEffect(e){this.isSubmitActive=e}}new Qt,new Qt,new Re;const Lc=new u,Gc=new Float32Array(16),Nc=new Float32Array(16),Oc=new Float32Array(16),qc=new Float32Array(16);function Hc(e,t){return e.matrix.fromArray(t),e.matrix.decompose(e.position,e.quaternion,e.scale),e}class zc extends In{constructor(){super(...arguments),r(this,"coords",new Qt),r(this,"scale",1),r(this,"offsetY",0),r(this,"renderQueue",[]),r(this,"isQueueRunning",!1),r(this,"static",!0)}init(){this.baseRT=new E(vs,vs,{samples:4,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),this.smallRT=new E(250,250,{}),this.base=null,U.$fbo.registerBuffer("thumbnailBig",this.baseRT),U.$fbo.registerBuffer("thumbnailSmall",this.smallRT),U.$viewport.size.watchImmediate(this.updateBounds,this)}updateBounds({x:e,y:t}){const s=U.$app.$store.ui,i=this.coords;let r=.6*t,n=r;const o=this.scale=Math.min(1,.8*e/n);n*=o,r*=o,i.z=n,i.w=r;const a=(s.mobile?45:60)*s.scale;this.offsetY=1.5*a;const A=.5*(t-this.offsetY);i.x=.5*e,i.y=A}startQueue(){this.isQueueRunning=!0,this.renderNextFromQueue()}async renderNextFromQueue(){if(0===this.renderQueue.length)return this.isQueueRunning=!1;U.$quality.pause("thumbnail-queue-render");const e=this.renderQueue.shift();this.render(e.thumbID,this.smallRT),await Wt(20);const t=(await Ht.toUrl(this.smallRT,{cleanLevel:2})).result.url,s=wt();e.node.onload=()=>s.resolve(),e.node.src=t,await s,URL.revokeObjectURL(t),e.callback(e),await Wt(20),U.$quality.resume("thumbnail-queue-render"),this.renderNextFromQueue()}renderToImage(e=null,t=ys){const s={thumbID:e,callback:t,node:document.createElement("img")};this.renderQueue.push(s),this.isQueueRunning||this.startQueue();const i=this;return function(){i.renderQueue.splice(i.renderQueue.indexOf(s),1)}}render(e=null,t){const s=U.$app.$editor,i=s.edition.activeItem,r=s.config.items[i].thumbPresets??{};let n;if(n="object"==typeof e?e:r[e]??null,!n)return;const o=U.$threeRenderer,a=this.scene,A=a.camera.cam,l=o.getRenderTarget(),c=o.getClearAlpha(),h=A.matrix.toArray(Oc),u=A.projectionMatrix.toArray(qc),g=a.item.base.matrix.toArray(Gc),d=a.item.meshBase.matrix.toArray(Nc),p=a.item.base.visible,f=a.item.meshBase.visible;o.setClearAlpha(0),o.setRenderTarget(t),A.projectionMatrix.fromArray(n.cpmat),Hc(A,n.cmat),Hc(a.item.base,n.basemat),Hc(a.item.meshBase,n.meshmat),A.updateWorldMatrix(!0,!0),a.item.meshBase.updateWorldMatrix(!0,!0),A.updateProjectionMatrix(),a.lighting.updateEnvRotation(),a.item.base.visible=!0,a.item.meshBase.visible=!0;const m=o.getSize(Lc),I=this.coords.z,C=this.coords.w,B=.5*(m.x-I),v=.5*(m.y-C);A.setViewOffset(m.x,m.y,B,v,I,C),A.layers.set(U.layers.thumbnail),a.item.skeleton.backupBones(),a.item.skeleton.resetBones(),a.item.skeleton.disableOccluder(),a.base.updateMatrixWorld(!0,!0),U.$threeRenderer.clear(),o.render(a.base,A),A.clearViewOffset(),a.item.skeleton.restoreBones(),a.item.skeleton.enableOccluder(),Hc(a.item.base,g),Hc(a.item.meshBase,d),a.item.base.visible=p,a.item.meshBase.visible=f,A.projectionMatrix.fromArray(u),Hc(A,h),A.updateProjectionMatrix(),A.updateWorldMatrix(!0,!0),a.lighting.updateEnvRotation(),o.setClearAlpha(c),o.setRenderTarget(l)}async toFile(e=null,t="thumbnail.png",s){this.render(e,s);const i=(await Ht.toBuffer(s,{cleanLevel:2})).result.buffer,r=new Blob([i],{type:"image/png"});return new File([r],t,{lastModified:Date.now(),type:"image/png"})}async bigThumbToFile(e=null,t="thumbnail.png"){return this.toFile(e,t,this.baseRT)}async smallThumbToFile(e=null,t="thumbnail.png"){return this.toFile(e,t,this.smallRT)}}const Vc=new c(0),$c=new We(-1,1,1,-1,0,1),Yc=new Float32Array([-2,0,0,0,-2,0,2,2,0]),Jc=(new R).setAttribute("position",new D(Yc,3)),Kc=["precision highp float;","attribute vec2 position;","varying vec2 uv;","void main() {","uv = position;","gl_Position = vec4(2.0*position-1.0,0.,1);","}"].join("\n"),Wc=[.051,.0918,.12245,.1531,.1633],jc=new F({uniforms:{t:{value:null},h:{value:1/512},v:{value:1/512}},vertexShader:Kc,fragmentShader:["precision highp float;","uniform sampler2D t;","uniform float h;","uniform float v;","varying vec2 uv;","void main() {","vec4 c = vec4( 0.0 );",...[...Wc,...Wc.slice(0,-1).reverse()].map(((e,t)=>{const s=t-(Wc.length-1),i=0!==s?(s>0?"+"+s:s)+".0":"+0.";return`c.a+=texture2D(t,vec2(uv.x${i}*h,uv.y${i}*v)).a*${e};`})),"gl_FragColor = c;","}"].join("\n"),depthTest:!1,depthWrite:!1}),Xc=new c,Zc=new Re;class eh extends Ye{constructor({material:e,scene:t,cameraYOffset:s=0,scale:i=1}){super(),r(this,"prevSwapIndex",0),this.scene=t,this.needsRender=!0,this.shadowColor=new c(0),this.shadowSize=64,this.fbos=new Array(2).fill().map((()=>{const e=new E(this.shadowSize,this.shadowSize);return this.currentShadowSize=this.shadowSize,e})),this.planeGeo=new Es(i,i),this.planeMaterial=e??new xe({map:this.fbos[0].texture,opacity:1,transparent:!0,depthWrite:!1}),this.planeMaterial.map=this.fbos[0].texture,U.$fbo.registerBuffer("contactShadows",this.fbos[0]),this.plane=new M(this.planeGeo,this.planeMaterial),this.plane.renderOrder=U.z.ground,this.fxPlane=new M(Jc,jc),this.fxPlane.visible=!1;const n=-.005+s;this.plane.rotation.x=-Math.PI/2,this.plane.scale.set(-6.5,6.5,1),this.plane.position.y+=.01,this.add(this.plane),this.shadowCamera=new We(3.25,-3.25,-3.25,3.25,0,1.6),this.shadowCamera.position.y=n,this.shadowCamera.rotation.x=Math.PI/2,this.shadowCamera.layers.set(U.layers.shadowCaster),this.add(this.shadowCamera),this.highQuality=!1,this.depthMaterial=new ws;const o=this.darkness={value:.03};this.depthMaterial.onBeforeCompile=function(e){e.uniforms.darkness=o,e.vertexShader=e.vertexShader.replace(/void main\(\) ?{/,"uniform float inflate;\nvoid main() {").replace("#include <skinning_vertex>","#include <skinning_vertex>"),e.fragmentShader=e.fragmentShader.replace(/void main\(\) ?{/,"uniform float darkness;\nvoid main() {").replace(/gl_FragColor ?= ?vec4\( ?vec3\( ?1.?0? ?- ?fragCoordZ ?\), ?opacity ?\);/,"gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * darkness );")},this.depthMaterial.skinning=!0,this.depthMaterial.depthTest=!0,this.depthMaterial.depthWrite=!0,this.plane.onBeforeRender=this.onBeforeRender.bind(this),this.renderingShadow=!1,this.scene.hooks.afterMatrixWorldUpdate.watch(this.afterMatrixWorldUpdate,this)}afterMatrixWorldUpdate(){var e,t;const s=this.scene.getCurrentCamera().cam,i=Zc.copy(s.position).sub(this.plane.position).normalize().dot(this.plane.up),r=Ft(i,0,.3,0,1);(null==(t=null==(e=this.plane.material)?void 0:e.uniforms)?void 0:t.opacity)&&(this.plane.material.uniforms.opacity.value=r)}hide(){this._visible=this.visible,this.visible=!1}show(){this.visible=this._visible}blurShadow(e,t=3,s=2,i,r,n){this.fxPlane.visible=!0,this.fxPlane.material=jc;for(let o=0;o<s;o++){const s=t/256;jc.uniforms.t.value=i.texture,jc.uniforms.h.value=s,jc.uniforms.v.value=0,e.setRenderTarget(r),e.render(this.fxPlane,$c),jc.uniforms.t.value=r.texture,jc.uniforms.h.value=0,jc.uniforms.v.value=s,e.setRenderTarget(n),e.render(this.fxPlane,$c)}this.fxPlane.visible=!1}onBeforeRender(e,t){var s,i,r,n;if(this.renderingShadow)return;if(!(this.scene.item.skeleton.isMoving||this.scene.item.swapIndex!==this.prevSwapIndex)&&!this.needsRender)return;this.prevSwapIndex=this.scene.item.swapIndex,this.needsRender=!1,this.renderingShadow=!0,this.visible=!1;const o=e.sortObjects,a=e.getRenderTarget(),A=e.shadowMap.autoUpdate,l=t.matrixWorldAutoUpdate,c=e.autoClear,h=e.getClearColor(Xc),u=e.getClearAlpha();if(this.shadowSize!==this.currentShadowSize){this.currentShadowSize=this.shadowSize;for(let e=0,t=this.fbos.length;e<t;e++)this.fbos[e].setSize(this.shadowSize,this.shadowSize)}this.enabled=!0,this.highQuality=!1,this.darkness.value=.9,this.shadowCamera.rotation.z=0,this.plane.rotation.z=0,this.shadowCamera.updateMatrix(),this.shadowCamera.updateMatrixWorld(),this.plane.updateMatrix(),this.plane.updateMatrixWorld(),t.matrixWorldAutoUpdate=!0,e.shadowMap.autoUpdate=!1,e.autoClear=!1,e.sortObjects=!1;const g=this.fbos;e.setRenderTarget(g[0]),e.setClearColor(Vc,0),e.clear(),U.$scenes.list.preview.item.shadowCaster.material=this.depthMaterial,t.overrideMaterial=this.depthMaterial,e.render(t,this.shadowCamera),t.overrideMaterial=null,null==(i=(s=this.scene).disableClampRender)||i.call(s),e.setRenderTarget(g[0]),e.clear(),e.render(t,this.shadowCamera),this.blurPasses=2,this.blurAmount=6;const d=this.blurAmount,p=this.blurPasses;this.blurShadow(e,d,p,g[0],g[1],g[0]),e.setClearColor(h,u),e.setRenderTarget(a),null==(n=(r=this.scene).clampRenderBounds)||n.call(r),e.shadowMap.autoUpdate=A,e.autoClear=c,e.sortObjects=o,t.matrixWorldAutoUpdate=l,this.renderingShadow=!1,this.visible=!0}}const th=Rn("#include <common>\n#include <dithering_pars_fragment>\n#include <fog_pars_fragment>\nuniform sampler2D map;uniform vec4 res;uniform float opacity;varying vec2 vUv;varying vec3 vPos;\n#include <color_mask_chunk_pars>\nvoid main(){vec2 sp=gl_FragCoord.xy/res.xy;vec2 uv=vPos.xz;\n#include <color_mask_chunk>\nfloat shadow=texture2D(map,vUv).a;vec3 bgColor=color*0.92;vec3 shadowTint=bgColor*bgColor*bgColor*bgColor*bgColor*0.5;float dist=length(vUv.xy-0.5);shadow+=smoothstep(0.48,0.0,dist)*0.2;vec3 col=shadowTint;gl_FragColor=vec4(col,shadow);\n#include <colorspace_output_srgb>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}","fragmentShader"),sh=Rn("#include <common>\n#include <fog_pars_vertex>\nuniform float time;varying vec2 vUv;varying vec3 vPos;varying float vFade;void main(){vUv=uv;vec3 transformed=vec3(position);vec4 mvPosition=vec4(transformed,1.0);mvPosition=modelViewMatrix*mvPosition;vec3 viewDirection=-mvPosition.xyz;vec3 transformedNormal=vec3(normal);transformedNormal=normalMatrix*transformedNormal;vPos=position;vFade=dot(normalize(transformedNormal),normalize(mvPosition.xyz));gl_Position=projectionMatrix*mvPosition;\n#include <fog_vertex>\n}","vertexShader");class ih extends P{constructor(){super(),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="GroundMaterial",this.uniforms={...this.uniforms,res:U.$uniforms.res,map:{value:U.$assets.textures.null},opacity:{value:0},color:{value:new c}},this.defines={...this.defines},this.transparent=!0,sh.use(this),th.use(this),ma.setupMaterial(this)}get map(){return this.uniforms.map.value}set map(e){this.uniforms.map.value=e}}class rh extends In{constructor(){super(...arguments),r(this,"pPressed",!1),r(this,"ryTarget",0),r(this,"ryVel",0),r(this,"ry",0),r(this,"rxTarget",0),r(this,"rxVel",0),r(this,"rxSpring",qt({tension:.05,friction:.19,step:8})),r(this,"rx",0),r(this,"zoom",0),r(this,"scrollDelta",0)}init(){this.scene.item.hooks.onItemSwap.watch(this.reset,this)}guard(e){}reset(){this.rxTarget=this.rxVel=this.rx=0,this.ryTarget=this.ryVel=this.ry=0}update(){const e=this.webgl.$time.dt,t=this.webgl.$app.$controls.touch,s=t.primaryPressed,i=t.useTouch?2.1:1,r=t.delta.x*i,n=t.delta.y*i;if(U.$app.$editor.controls.isInEditableView)return void this.reset();if(U.$scenes.current!==this.scene)return;!this.pPressed&&s&&(this.ryTarget=this.ry),s&&(this.ryTarget+=.003*r);const o=s?.4:.8,a=this.ry;this.ry=kt(this.ry,this.ryTarget,o,e),s?this.ryVel=this.ry-a:(this.ryVel=kt(this.ryVel,0,.09,e),this.ryTarget+=.5*this.ryVel),s?(this.pPressed||(this.rxTarget=this.rxSpring.value),this.rxTarget=A(this.rxTarget+.003*n,-.78,.78),this.rx=kt(this.rx,this.rxTarget,.35,e)):(this.pPressed&&(this.rxSpring.setValue(this.rx),this.rxSpring.setTarget(0)),this.rxSpring.update(e),this.rx=this.rxSpring.value),this.scrollDelta=0,this.scene.item.isSwappingAnimationActive&&(this.zoom=kt(this.zoom,0,.27,e)),this.pPressed=s}}const nh=new u,oh=new c,ah=new c;class Ah extends bn{constructor(e){super(e),r(this,"item",new _c),r(this,"draw",new Po),r(this,"isRenderClamped",!1),r(this,"renderBounds",null),r(this,"bgColorCache",null),r(this,"bgColor",new c),r(this,"bgColorTarget",new c),r(this,"preloadPromise",null),r(this,"isPrerendered",!1),r(this,"isBgColorChanging",!1),r(this,"colorNotChangingFrames",0),r(this,"inputEl",null),r(this,"sliderEl",null),r(this,"thumbEl",null),r(this,"activeParam",null),r(this,"paramConfig",null),r(this,"smoothSize",0),r(this,"isFirstEnter",!0),U.$editor=this}init(){this.ctrls=this.add(rh),this.handle=this.addObject3D(new Ye),this.pfx=this.add(kc),this.thumbGen=this.add(zc),this.lighting=this.add(En),this.bg=this.add(ha),this.camera=this.add(ra),this.item=this.add(this.item),this.logoFocus=this.add(Fc),this.draw=this.add(this.draw),this.handle.add(this.shadows=new eh({material:new Ia,scene:this,cameraYOffset:0,scale:2})),this.handle.rotation.x=-0,this.item.meshMaterial.uniforms.paintMap=this.draw.uniforms.paintMap,this.isDepthRendering=!0,this.hooks.beforeDepthRender=m(),this.hooks.afterDepthRender=m()}beforeUpdate(){this.camera.beforeSceneUpdate()}async preload(){if(this.preloadPromise)return this.preloadPromise;this.preloadPromise=wt(),await Promise.all([this.draw.load()]),this.preloadPromise.resolve()}async prerender(){this.isPrerendered||(await this.draw.prerender(),await async function(e){await 0,e.base.traverse((e=>{e.visible?ko.add(e):Uo.add(e),e.visible=!0,e.frustumCulled=!1})),e.base.updateMatrixWorld(!0),e.triggerRender(),Uo.forEach((e=>e.visible=!1)),ko.forEach((e=>e.visible=!0)),await Wt(100)}(this),this.isPrerendered=!0)}update(){const e=U.$app.$editor,t=e.edition.bgColor;if(this.bgColorCache!==t){const e=null===this.bgColorCache;this.bgColorCache=t,ah.set(t).convertLinearToSRGB(),oh.set(t).lerp(ah,.5),this.bgColorTarget.set(oh.r,oh.g,oh.b,0),e&&this.bgColor.copy(this.bgColorTarget)}const s=U.$time.dt,i=e.controls.isInEditableView?.1:.2;this.bgColor.damp(this.bgColorTarget,i,s),Math.abs(this.bgColor.r-this.bgColorTarget.r)<.005&&Math.abs(this.bgColor.g-this.bgColorTarget.g)<.005&&Math.abs(this.bgColor.b-this.bgColorTarget.b)<.005&&this.bgColor.copy(this.bgColorTarget),this.bgColor.equals(this.bgColorTarget)?this.colorNotChangingFrames++:this.colorNotChangingFrames=0,this.isBgColorChanging=this.colorNotChangingFrames<2,this.shadows.plane.material.uniforms.color.value.set(this.bgColor),this.bg.color.set(this.bgColor),this.updateUIParamPreview()}updateUIParamPreview(){const e=U.$app.$editor,t=e.edition,s=e.controls,i=U.$time.dt;let r=s.pointerScreen.x-.5,n=s.pointerScreen.y+.5,o=e.edition.activePointerSize;t.isCursorRadiusVisible||(o*=0);const a=U.$app.$store.currentToolbarInputElement;a&&a!==this.inputEl&&(this.inputEl=a,this.activeParam=t.activeParamInput,this.paramConfig=e.config.toolParams[this.activeParam.param],this.sliderEl=this.inputEl.querySelector(".slider"),this.thumbEl=this.inputEl.querySelector(".thumb"));let A=!1,l=!1;if(this.paramConfig&&"number"===this.paramConfig.type){const e=U.$app.$controls.touch;A=this.sliderEl.getAttribute("aria-grabbed"),l=e.useTouch||A}if(a&&this.paramConfig.previewCursorSize)if(l)if(this.smoothSize=kt(this.smoothSize,e.edition.activePointerSize,.5,i),o=this.smoothSize,this.thumbEl){const e=this.inputEl.getBoundingClientRect().height,t=this.thumbEl.getBoundingClientRect();r=t.left+.5*t.width,n=t.top+.5*t.height-.65*e-o-5}else r=.5*U.$app.$viewport.width,n=.5*U.$app.$viewport.height;else this.smoothSize=0;else this.activeParam=this.inputEl=this.sliderEl=this.thumbEl=null,this.paramConfig=null,this.smoothSize=0;this.pfx.updateCursor(r,n,o)}async resetEnter(){this.item.forceVisibility(),this.triggerRender(),this.item.setToBeforeEnter(),this.pfx.isSubmitActive=!1,this.pfx.updateThumbEffect(!0),await new Promise((e=>requestAnimationFrame(e))),await new Promise((e=>requestAnimationFrame(e))),this.isFirstEnter&&(this.isFirstEnter=!1,await Wt(150))}enter(){this.log("ENTER PREVIEW"),this.item.triggerEnter(!0)}async leave(){await Wt(100)}beforeRender(){this.draw.history.beforeRender()}updateRenderBounds(){const e=this.draw.brush;(this.camera.isMoving||this.item.isMoving||!e.isDrawing||this.isBgColorChanging)&&(e.clampBounds=!1),e.clampBounds?this.renderBounds=e.drawBounds:this.renderBounds=null}clampRenderBounds(){const e=this.scene.getCurrentCamera(),t=this.renderBounds;if(e!==this.camera||!t||t.z<.1)return this.disableClampRender();const s=U.$threeRenderer,i=this.pfx.baseRT,r=s.getSize(nh),n=s.getPixelRatio();let o=i.width/(r.x*n);const a=r.x,A=r.y,l=Math.floor(t.x),c=Math.floor(t.y),h=Math.floor(t.width),u=Math.floor(t.height),g=.5*h,d=.5*u;this.camera.setCustomViewOffset(a,A,l-g,c-d,h,u),s.setScissorTest(!0),s.setScissor((l-g)*o,(A-c-d)*o,h*o,u*o),s.setViewport((l-g)*o,(A-c-d)*o,h*o,u*o),this.isRenderClamped=!0}disableClampRender(){if(!this.isRenderClamped)return;const e=U.$threeRenderer,t=e.getSize(nh);e.setScissorTest(!1),e.setViewport(0,0,t.width,t.height),this.camera.resetViewOffset(),this.isRenderClamped=!1}render(){this.pfx.render()}}const lh=new c;class ch extends bn{resetEnter(){const e=this.webgl.$threeRenderer.getClearColor(lh),t=this.webgl.$threeRenderer.getClearAlpha();U.$threeRenderer.setClearColor(16777215,1),U.$threeRenderer.clear(),U.$threeRenderer.setClearColor(e,t)}prerender(){}update(){}render(){}}function hh(e=1,t=1,{name:s,...i}={}){const r={read:null,write:null,uniform:{value:null},swap:function(){const e=r.read;r.read=r.write,r.write=e,r.uniform.value=r.read.texture},compile:function(){U.$threeRenderer.initRenderTarget(r.read),U.$threeRenderer.initRenderTarget(r.write)},setSize:function(e,t){r.read.setSize(e,t),r.write.setSize(e,t)}};return r.read=new E(e,t,i),r.write=new E(e,t,i),r.uniform.value=r.read.texture,r}const uh=Rn("precision highp float;precision highp sampler2D;varying vec2 vUv;uniform sampler2D uVelocity;uniform sampler2D uSource;uniform vec2 texelSize;uniform float dt;uniform float dissipation;void main(){vec2 coord=vUv-dt*texture2D(uVelocity,vUv).xy*texelSize;gl_FragColor=dissipation*texture2D(uSource,coord);gl_FragColor.a=1.0;}","fragmentShader"),gh=Rn("precision mediump float;precision mediump sampler2D;varying highp vec2 vUv;uniform sampler2D uTexture;uniform float value;void main(){gl_FragColor=value*texture2D(uTexture,vUv);}","fragmentShader"),dh=Rn("precision mediump float;precision mediump sampler2D;varying highp vec2 vUv;varying highp vec2 vL;varying highp vec2 vR;varying highp vec2 vT;varying highp vec2 vB;uniform sampler2D uVelocity;void main(){float L=texture2D(uVelocity,vL).y;float R=texture2D(uVelocity,vR).y;float T=texture2D(uVelocity,vT).x;float B=texture2D(uVelocity,vB).x;float vorticity=R-L-T+B;gl_FragColor=vec4(0.5*vorticity,0.0,0.0,1.0);}","fragmentShader"),ph=Rn("precision mediump float;precision mediump sampler2D;varying highp vec2 vUv;varying highp vec2 vL;varying highp vec2 vR;varying highp vec2 vT;varying highp vec2 vB;uniform sampler2D uVelocity;void main(){float L=texture2D(uVelocity,vL).x;float R=texture2D(uVelocity,vR).x;float T=texture2D(uVelocity,vT).y;float B=texture2D(uVelocity,vB).y;vec2 C=texture2D(uVelocity,vUv).xy;if(vL.x<0.0){L=-C.x;}if(vR.x>1.0){R=-C.x;}if(vT.y>1.0){T=-C.y;}if(vB.y<0.0){B=-C.y;}float div=0.5*(R-L+T-B);gl_FragColor=vec4(div,0.0,0.0,1.0);}","fragmentShader"),fh=Rn("precision mediump float;precision mediump sampler2D;varying highp vec2 vUv;varying highp vec2 vL;varying highp vec2 vR;varying highp vec2 vT;varying highp vec2 vB;uniform sampler2D uPressure;uniform sampler2D uVelocity;void main(){float L=texture2D(uPressure,vL).x;float R=texture2D(uPressure,vR).x;float T=texture2D(uPressure,vT).x;float B=texture2D(uPressure,vB).x;vec2 velocity=texture2D(uVelocity,vUv).xy;velocity.xy-=vec2(R-L,T-B);gl_FragColor=vec4(velocity,0.0,1.0);}","fragmentShader"),mh=Rn("precision mediump float;precision mediump sampler2D;varying highp vec2 vUv;varying highp vec2 vL;varying highp vec2 vR;varying highp vec2 vT;varying highp vec2 vB;uniform sampler2D uPressure;uniform sampler2D uDivergence;void main(){float L=texture2D(uPressure,vL).x;float R=texture2D(uPressure,vR).x;float T=texture2D(uPressure,vT).x;float B=texture2D(uPressure,vB).x;float C=texture2D(uPressure,vUv).x;float divergence=texture2D(uDivergence,vUv).x;float pressure=(L+R+B+T-divergence)*0.25;gl_FragColor=vec4(pressure,0.0,0.0,1.0);}","fragmentShader"),Ih=Rn("precision highp float;precision highp sampler2D;varying vec2 vUv;uniform sampler2D uTarget;uniform float aspectRatio;uniform vec3 color;uniform vec2 point;uniform float radius;void main(){vec2 p=vUv-point.xy;p.x*=aspectRatio;vec3 splat=exp(-dot(p,p)/radius)*color;vec3 base=texture2D(uTarget,vUv).xyz;gl_FragColor=vec4(base+splat,1.0);}","fragmentShader"),Ch=Rn("precision highp float;precision highp sampler2D;varying vec2 vUv;varying vec2 vL;varying vec2 vR;varying vec2 vT;varying vec2 vB;uniform sampler2D uVelocity;uniform sampler2D uCurl;uniform float curl;uniform float dt;void main(){float L=texture2D(uCurl,vL).x;float R=texture2D(uCurl,vR).x;float T=texture2D(uCurl,vT).x;float B=texture2D(uCurl,vB).x;float C=texture2D(uCurl,vUv).x;vec2 force=0.5*vec2(abs(T)-abs(B),abs(R)-abs(L));force/=length(force)+0.0001;force*=curl*C;force.y*=-1.0;vec2 vel=texture2D(uVelocity,vUv).xy;gl_FragColor=vec4(vel+force*dt,0.0,1.0);}","fragmentShader"),Bh={type:V,depthBuffer:!1,stencilBuffer:!1,resolveDepthBuffer:!1,resolveStencilBuffer:!1},vh=new R;vh.setAttribute("position",new D(new Float32Array([-1,-1,3,-1,-1,3]),2)),vh.setAttribute("uv",new D(new Float32Array([0,0,2,0,0,2]),2));const yh=class e{constructor({renderer:t=U.$threeRenderer,enabled:s=!0,simRes:i=128,dyeRes:n=512,...o}={}){r(this,"enabled",!0),r(this,"simRes",128),r(this,"dyeRes",512),r(this,"invDyeRes",1/this.dyeRes),r(this,"invSimRes",1/this.simRes),r(this,"splats",[]),r(this,"opts",{iterations:3,densityDissipation:.97,velocityDissipation:.98,pressureDissipation:.8,curlStrength:20,radius:.002,velocityStrength:1}),this.renderer=t,this.enabled=s,this.simRes=i,this.dyeRes=n,this.invDyeRes=1/this.dyeRes,this.invSimRes=1/this.simRes,Object.assign(this.opts,o),this.texelSize={value:(new u).setScalar(this.invSimRes)},this.rt={},this.programs={},this.rt.density=hh(this.dyeRes,this.dyeRes,{...Bh,format:Q}),this.rt.velocity=hh(this.simRes,this.simRes,{...Bh,format:fe}),this.rt.pressure=hh(this.simRes,this.simRes,{...Bh,format:L,minFilter:O}),this.rt.divergence=new E(this.simRes,this.simRes,{...Bh,format:L,minFilter:O}),this.rt.curl=new E(this.simRes,this.simRes,{...Bh,format:L,minFilter:O}),this.programs.clearMesh=new M(e.geometry,wh(gh,{name:"clearProgram",texelSize:this.texelSize,uTexture:{value:null},value:{value:this.opts.pressureDissipation}})),this.programs.splatMesh=new M(e.geometry,wh(Ih,{name:"splatProgram",texelSize:this.texelSize,uTarget:{value:null},aspectRatio:{value:1},point:{value:new u},color:{value:new c},radius:{value:this.opts.radius}})),this.programs.advectionMesh=new M(e.geometry,wh(uh,{name:"advectionProgram",texelSize:this.texelSize,dyeTexelSize:{value:(new u).setScalar(this.invDyeRes)},uVelocity:{value:null},uSource:{value:null},dt:{value:.016},dissipation:{value:1}})),this.programs.divergenceMesh=new M(e.geometry,wh(ph,{name:"divergenceProgram",texelSize:this.texelSize,uVelocity:{value:null}})),this.programs.curlMesh=new M(e.geometry,wh(dh,{name:"curlProgram",texelSize:this.texelSize,uVelocity:{value:null}})),this.programs.vorticityMesh=new M(e.geometry,wh(Ch,{name:"vorticityProgram",texelSize:this.texelSize,uVelocity:{value:null},uCurl:{value:null},curl:{value:this.opts.curlStrength},dt:{value:.016}})),this.programs.pressureMesh=new M(e.geometry,wh(mh,{name:"pressureProgram",texelSize:this.texelSize,uPressure:{value:null},uDivergence:{value:null}})),this.programs.gradientSubtractMesh=new M(e.geometry,wh(fh,{name:"gradientSubtractProgram",texelSize:this.texelSize,uPressure:{value:null},uVelocity:{value:null}})),[this.programs.clearMesh,this.programs.splatMesh,this.programs.advectionMesh,this.programs.divergenceMesh,this.programs.curlMesh,this.programs.vorticityMesh,this.programs.pressureMesh,this.programs.gradientSubtractMesh].forEach((e=>{e.frustumCulled=!1})),U.$renderer.drawingBufferSize.watchImmediate((()=>{this.programs.splatMesh.material.uniforms.aspectRatio.value=U.$viewport.ratio.value}))}prerender(){[this.rt.pressure,this.rt.velocity,this.rt.density].forEach((e=>e.compile()));const t=this.renderer,s=t.sortObjects,i=t.autoClear;t.sortObjects=!1,t.autoClear=!1,t.initRenderTarget(this.rt.divergence),t.initRenderTarget(this.rt.curl),[this.programs.clearMesh,this.programs.splatMesh,this.programs.advectionMesh,this.programs.divergenceMesh,this.programs.curlMesh,this.programs.vorticityMesh,this.programs.pressureMesh,this.programs.gradientSubtractMesh].forEach((s=>{t.render(s,e.cam)})),t.sortObjects=s,t.autoClear=i}emit({x:e,y:t,dx:s,dy:i,dz:r}){this.splats.push({x:e,y:t,dx:s,dy:i,dz:r})}renderSplat({x:t,y:s,dx:i,dy:r,dz:n=1}){this.programs.splatMesh.material.uniforms.uTarget.value=this.rt.velocity.read.texture,this.programs.splatMesh.material.uniforms.point.value.set(t,s),this.programs.splatMesh.material.uniforms.color.value.set(i*this.opts.velocityStrength,r*this.opts.velocityStrength,n*this.opts.velocityStrength);const o=this.renderer;o.setRenderTarget(this.rt.velocity.write),o.render(this.programs.splatMesh,e.cam),this.rt.velocity.swap(),this.programs.splatMesh.material.uniforms.uTarget.value=this.rt.density.read.texture,o.setRenderTarget(this.rt.density.write),o.render(this.programs.splatMesh,e.cam),this.rt.density.swap()}render(){if(!this.enabled)return;const t=this.renderer,s=t.getRenderTarget(),i=t.sortObjects,r=t.autoClear;t.sortObjects=!1,t.autoClear=!1;const{curlMesh:n,vorticityMesh:o,divergenceMesh:a,pressureMesh:A,advectionMesh:l,clearMesh:c,gradientSubtractMesh:h,curlMesh:{material:u},vorticityMesh:{material:g},divergenceMesh:{material:d},pressureMesh:{material:p},advectionMesh:{material:f},clearMesh:{material:m},gradientSubtractMesh:{material:I}}=this.programs,{velocity:C,density:B,pressure:v,divergence:y,curl:E}=this.rt;for(let e=this.splats.length-1;e>=0;e--){const e=this.splats.pop();this.renderSplat(e)}this.opts.curlStrength>0&&(u.uniforms.uVelocity.value=C.read.texture,t.setRenderTarget(E),t.render(n,e.cam)),g.uniforms.uVelocity.value=C.read.texture,g.uniforms.uCurl.value=E.texture,t.setRenderTarget(C.write),t.render(o,e.cam),C.swap(),d.uniforms.uVelocity.value=C.read.texture,t.setRenderTarget(y),t.render(a,e.cam),m.uniforms.uTexture.value=v.read.texture,t.setRenderTarget(v.write),t.render(c,e.cam),v.swap(),p.uniforms.uDivergence.value=y.texture;for(let w=0;w<this.opts.iterations;w++)p.uniforms.uPressure.value=v.read.texture,t.setRenderTarget(v.write),t.render(A,e.cam),v.swap();I.uniforms.uPressure.value=v.read.texture,I.uniforms.uVelocity.value=C.read.texture,t.setRenderTarget(C.write),t.render(h,e.cam),C.swap(),f.uniforms.dyeTexelSize.value.setScalar(this.invSimRes),f.uniforms.uVelocity.value=C.read.texture,f.uniforms.uSource.value=C.read.texture,f.uniforms.dissipation.value=this.opts.velocityDissipation,t.setRenderTarget(C.write),t.render(l,e.cam),C.swap(),f.uniforms.dyeTexelSize.value.setScalar(this.invDyeRes),f.uniforms.uVelocity.value=C.read.texture,f.uniforms.uSource.value=B.read.texture,f.uniforms.dissipation.value=this.opts.densityDissipation,t.setRenderTarget(B.write),t.render(l,e.cam),B.swap(),t.setRenderTarget(s),t.sortObjects=i,t.autoClear=r}get texture(){return this.rt.density.read.texture}};r(yh,"cam",(new _).translateZ(1)),r(yh,"geometry",vh),r(yh,"vertexShader","\n\tprecision highp float;\n\tattribute lowp vec2 position;\n\tattribute vec2 uv;\n\tvarying vec2 vUv;\n\tvarying vec2 vL;\n\tvarying vec2 vR;\n\tvarying vec2 vT;\n\tvarying vec2 vB;\n\tuniform vec2 texelSize;\n\tvoid main () {\n\t\tvUv = uv;\n\t\tvL = vUv - vec2(texelSize.x, 0.0);\n\t\tvR = vUv + vec2(texelSize.x, 0.0);\n\t\tvT = vUv + vec2(0.0, texelSize.y);\n\t\tvB = vUv - vec2(0.0, texelSize.y);\n\t\tgl_Position = vec4(position, 0, 1);\n\t}");let Eh=yh;function wh(e,{name:t="",defines:s={},...i}={}){const r=new F({name:t,vertexShader:Eh.vertexShader,uniforms:i,defines:s,depthTest:!1,depthWrite:!1});return e.use(r),r}const Qh=new u,xh=new Re,bh=new Re,Sh=new Qt;class Rh extends Go{constructor(){super(...arguments),r(this,"targetOffsetY",0),r(this,"offsetY",0),r(this,"targetQt",new st),r(this,"targetPos",new Re),r(this,"smoothedTargetPos",new Re),r(this,"smoothedTargetQt",new st),r(this,"prevBounds",new Qt),r(this,"prevViewport",new u),r(this,"homeScale",1),r(this,"prevHome",null),r(this,"mouseOffset",new u)}init(){super.init(),this.base.position.z=8,this.base.position.y=-.1,this.base.lookAt(0,0,0),this.base.position.y-=.15,this.base.far=100,this.base.updateProjectionMatrix(),this.qt0=this.base.quaternion.clone(),this.pos0=this.base.position.clone(),U.$viewport.size.watchImmediate(this.updateBounds,this)}updateBounds({x:e,y:t}){this.scale=Math.min(1,1.3*e/t)}beforeSceneUpdate(){this.base.zoom=this.scale,this.updateViewOffset(),this.scene.isOnHome&&(this.base.zoom*=this.homeScale),this.base.updateProjectionMatrix()}updateViewOffset(){const e=this.base,t=U.$app.$store.poloBounds,s=U.$viewport.size.value,i=Sh.set(t.x+.5*t.width,t.y+.5*t.height,t.width,t.height);if(!i.equals(this.prevBounds)||!s.equals(this.prevViewport)||this.prevHome!==this.scene.isOnHome)if(this.prevHome=this.scene.isOnHome,this.prevBounds.copy(i),this.prevViewport.copy(s),this.scene.isOnHome){const t=.5*s.x-i.x,r=.5*s.y-i.y;this.homeScale=this.scene.isMobileLayout?1:i.height/s.y/.8*1.1,e.setViewOffset(s.x,s.y,t,r,s.x,s.y)}else e.clearViewOffset()}update(){const e=this.webgl.$time.dt;let t=this.scene.item.camOffsetY??0;const s=this.scene.item.mesh.userData.offsetY??-2.1;this.scene.isOnHome||(t-=.17),this.targetOffsetY=-s+t,this.offsetY=kt(this.offsetY,this.targetOffsetY,.12,e);const i=this.base.position;i.copy(this.pos0);const r=this.scene.ctrls.zoom,n=xh.copy(this.scene.item.meshBase.position);this.base.quaternion.copy(this.qt0);const o=bh.copy(this.pos0).sub(n).normalize();this.targetPos.lerpVectors(this.pos0,o.multiplyScalar(-3.5).add(this.pos0),r),this.smoothedTargetPos.damp(this.targetPos,.3,e),this.base.position.copy(this.smoothedTargetPos),i.y+=this.offsetY-.2;const a=U.$app.$controls.touch,A=a.normalizePos.x*!a.useTouch,l=a.normalizePos.y*!a.useTouch;this.mouseOffset.damp(Qh.set(A,l),.05,e);const c=.5;i.x+=.07*this.mouseOffset.x*c,i.y+=.05*this.mouseOffset.y*c,this.base.rotateY(.01*this.mouseOffset.x*c),this.base.rotateX(-.008*this.mouseOffset.y*c),this.scene.isOnHome&&!this.scene.isMobileLayout&&(this.base.position.x+=.2)}}class Dh extends Ka{constructor(e){super(e),this.type=this.name="ItemPreviewMaterial",this.defines={...this.defines}}}const Th=new u;class Mh extends $a{constructor(){super(...arguments),r(this,"currentPaintTexture",null),r(this,"floatingTime",0),r(this,"mouseOffset",new u)}get meshMaterial(){return this._meshMat=this._meshMat??new Dh}afterSwap(e,t,s,i,r){const n=i.material,o=r.paintTexture;o!==this.currentPaintTexture&&(this.currentPaintTexture=o,n.paintMap=Ca(n.paintMap,o.tex))}update(){const e=U.$time.dt;super.update(),this.floatingTime+=.01*e,this.base.position.y+=.04*Math.sin(.2*this.floatingTime),this.meshBase.rotation.z=.02*Math.cos(.14*this.floatingTime)-.01,this.meshBase.rotation.y=this.scene.ctrls.ry,this.scene.isOnHome&&this.scene.isMobileLayout?this.meshBase.rotation.y+=-.07:this.meshBase.rotation.y+=-.4,this.meshBase.rotation.x=this.scene.ctrls.rx;const t=U.$app.$controls.touch,s=t.normalizePos.x*!t.useTouch,i=t.normalizePos.y*!t.useTouch;let r=1;this.scene.isOnHome&&(r=2.5),this.mouseOffset.damp(Th.set(s,i),.2,e),this.base.rotation.y+=.04*this.mouseOffset.x*r,this.base.rotation.x+=-.04*this.mouseOffset.y*r}}const _h=Rn("precision highp float;\n#include <common>\n#include <dithering_pars_fragment>\n#include <fog_pars_fragment>\nvarying vec2 vUv;varying vec3 vPos;uniform vec4 res;uniform vec4 lineBounds;uniform sampler2D fluidMap;uniform float homeProgress;uniform float useBottomGrad;uniform float gradMult;\n#include <luma>\n#include <color_mask_chunk_pars>\nfloat aastep(float threshold,float value){\n#ifdef GL_OES_standard_derivatives\nfloat afwidth=length(vec2(dFdx(value),dFdy(value)))*0.70710678118654757;return smoothstep(threshold-afwidth,threshold+afwidth,value);\n#else\nreturn step(threshold,value);\n#endif\n}float rectangle(vec2 st,vec2 size){size=vec2(0.5)-size*0.5;vec2 uv=vec2(aastep(size.x,st.x),aastep(size.y,st.y));uv*=vec2(aastep(size.x,(size.x*2.)*(1.-homeProgress)-st.x),aastep(size.y,1.0-st.y));return uv.x*uv.y;}void main(){vec2 sp=gl_FragCoord.xy/res.xy;vec2 pxUv=vec2(gl_FragCoord.x*res.w,(res.y-gl_FragCoord.y)*res.w);vec2 uv=vUv;uv=fract(uv*vec2(150.,33.)*2.);\n#include <color_mask_chunk>\nvec4 fluid=texture2D(fluidMap,sp);vec2 fluidOffset=(fluid.rg)*-0.0012*fluid.b*0.9;vec2 guv=abs(fract(vPos.xy*0.7*res.y/900.*res.w)-0.5+fluidOffset)*20.;float thickness=0.7;float eps=1.0;float grid=(1.-(smoothstep(thickness-eps,thickness+eps,guv.x)*smoothstep(thickness-eps,thickness+eps,guv.y)));float grad=smoothstep(0.0,0.03,vPos.z);vec3 col=color;color=mix(color,mix(color*color-0.2,color*color-0.5,smoothstep(0.,1.,fluid.b)),grid*0.06*grad);color=mix(color+mix(0.0,0.07,useBottomGrad*2.2),color*color,smoothstep(0.0,0.1,vPos.z));float yGrad=smoothstep(150.0,-50.0,pxUv.y);float maxY=res.y*res.w;color=mix(color,mix(color,color*color,0.2)-0.04,yGrad*0.4);yGrad=smoothstep(maxY-300.,maxY,pxUv.y);color=mix(color,mix(color,color*color,0.3)-0.3,yGrad*0.4*useBottomGrad*1.5);color=mix(color,vec3(0.),yGrad*gradMult*0.35);color=mix(color,color+color*0.03,fluid.b*0.5*max(grad,0.4)*smoothstep(0.2,0.3,sp.y));gl_FragColor=vec4(color,1.);\n#include <colorspace_output_srgb>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\nfloat line=rectangle(pxUv-lineBounds.xy,lineBounds.zw);gl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(1.),line);}","fragmentShader"),Fh=Rn("#include <common>\n#include <fog_pars_vertex>\nvarying vec2 vUv;varying vec3 vPos;void main(){vUv=uv;vec3 transformed=vec3(position);vec4 mvPosition=vec4(transformed,1.0);mvPosition=modelMatrix*mvPosition;vPos=mvPosition.xyz;vPos.z=position.y;gl_Position=projectionMatrix*viewMatrix*mvPosition;\n#include <fog_vertex>\n}","vertexShader");class Ph extends P{constructor(){super(),this.uniformsGroups=[],this.isShaderMaterial=!0,this.type=this.name="BgMaterial",this.uniforms={...this.uniforms,res:U.$uniforms.res,lineBounds:{value:new Qt},groundLevel:{value:0},fluidMap:{value:U.$assets.textures.null},homeProgress:{value:0},useBottomGrad:{value:0},gradMult:{value:1}},this.defines={...this.defines},this.depthWrite=!1,this.transparent=!0,Fh.use(this),_h.use(this),ma.setupMaterial(this)}get groundLevel(){return this.uniforms.groundLevel.value}set groundLevel(e){this.uniforms.groundLevel.value=e}get lineBounds(){return this.uniforms.lineBounds.value}set lineBounds(e){this.uniforms.lineBounds.value=e}get fluidMap(){return this.uniforms.fluidMap.value}set fluidMap(e){this.uniforms.fluidMap.value=e}get useBottomGrad(){return this.uniforms.useBottomGrad.value}set useBottomGrad(e){this.uniforms.useBottomGrad.value=e}get gradMult(){return this.uniforms.gradMult.value}set gradMult(e){this.uniforms.gradMult.value=e}}const Uh=new Qt,kh=hs("outSwift");class Lh extends aa{constructor(){super(...arguments),r(this,"mat",new Ph),r(this,"geo",new Qs(1,1,1)),r(this,"prevBounds",new Qt)}init(){this.geo.scale(1,1,-1),this.geo.translate(0,.5,0),super.init(),this.homeProgress=0,this.homeProgressEased=0,this.base.scale.set(600,250,100),this.base.updateMatrixWorld()}update(){this.updateLineBounds();const e=U.$time.dt;this.scene.isOnHome&&!this.needsHomeAnimation&&(this.homeProgress=0),this.needsHomeAnimation&&(this.homeProgress+=e/1e3),this.homeProgress=A(this.homeProgress,0,1),this.homeProgressEased=kh(this.homeProgress),this.scene.isOnHome||(this.homeProgressEased=0),this.mat.uniforms.homeProgress.value=this.homeProgressEased}updateLineBounds(){const e=U.$app.$store.lineBounds;if(!e)return;const t=this.prevBounds,s=Uh.set(e.x+.5*e.width,e.y+.5*e.height,e.width,e.height);t.equals(s)||(t.copy(s),this.mat.uniforms.lineBounds.value.copy(s))}}class Gh extends In{constructor(){super(...arguments),r(this,"pPressed",!1),r(this,"ryTarget",0),r(this,"ryVel",0),r(this,"ry",0),r(this,"rxTarget",0),r(this,"rxVel",0),r(this,"rxSpring",qt({tension:.05,friction:.19,step:8})),r(this,"rx",0),r(this,"zoom",0),r(this,"scrollDelta",0)}init(){this.scene.item.hooks.onItemSwap.watch(this.reset,this),xs(window,this.onWheel.bind(this),{passive:!1})}guard(e){}onWheel(e,t){U.$scenes.current===this.scene&&(this.scrollDelta+=.01*t)}reset(){this.rxTarget=this.rxVel=this.rx=0,this.ryTarget=this.ryVel=this.ry=0}update(){const e=this.webgl.$time.dt,t=this.webgl.$app.$controls.touch,s=t.primaryPressed,i=t.useTouch?2.1:1,r=t.delta.x*i,n=t.delta.y*i;if(U.$scenes.current!==this.scene)return;!this.pPressed&&s&&(this.ryTarget=this.ry),s&&(this.ryTarget+=.003*r);const o=s?.4:.8,a=this.ry;this.ry=kt(this.ry,this.ryTarget,o,e),s?this.ryVel=this.ry-a:(this.ryVel=kt(this.ryVel,0,.09,e),this.ryTarget+=.5*this.ryVel),s?(this.pPressed||(this.rxTarget=this.rxSpring.value),this.rxTarget=A(this.rxTarget+.003*n,-.78,.78),this.rx=kt(this.rx,this.rxTarget,.35,e)):(this.pPressed&&(this.rxSpring.setValue(this.rx),this.rxSpring.setTarget(0)),this.rxSpring.update(e),this.rx=this.rxSpring.value),this.scene.isOnHome||(this.zoom=A(this.zoom+-.03*this.scrollDelta+.03*t.pinchDelta,0,1)),this.scrollDelta=0,this.scene.item.isSwappingAnimationActive&&(this.zoom=kt(this.zoom,0,.27,e)),this.pPressed=s}}const Nh=Rn("precision highp float;varying vec2 vUv;uniform vec4 res;uniform float time;uniform sampler2D scene;uniform vec4 lineBounds;\n#include <luma>\nvoid main(){vec2 pxUv=vec2(gl_FragCoord.x*res.w,(res.y-gl_FragCoord.y)*res.w);vec4 texel=texture2D(scene,vUv);vec3 col=texel.rgb;float vignette=1.-length(vUv-0.5)*1.5;vec3 c2=mix(col,col*col,0.5);col=mix(col,c2-0.1,(1.-smoothstep(-0.1,0.7,vignette)));col=mix(col,c2-0.5,(1.-smoothstep(-0.2,0.4,vignette))*0.4);gl_FragColor=vec4(col,1.);}","fragmentShader");new Qt;class Oh extends Uc{constructor(){super(...arguments),r(this,"isSubmitActive",!1),r(this,"forceThumb",h(!1))}init(){this.filter=Ys({useRawShader:!1,fragmentShader:Nh,uniforms:{scene:{value:this.baseRT.texture},res:U.$uniforms.res,time:U.$uniforms.time,lineBounds:{value:new Qt}}})}render(){const e=this.scene.getCurrentCamera();if(!e)return;const t=U.$threeRenderer,s=t.getRenderTarget();t.setRenderTarget(this.baseRT),U.$threeRenderer.setClearColor(16777215),U.$threeRenderer.clear(),e.cam.layers.set(U.layers.base),t.render(this.scene.base,e.cam),t.setRenderTarget(s),this.filter.render()}update(){}}const qh=new c,Hh=new c;class zh extends bn{constructor(){super(...arguments),r(this,"item",new Mh),r(this,"currentDominantColor",bs),r(this,"isOnHome",!1),r(this,"isMobileLayout",!1),r(this,"preloadPromise",null),r(this,"isPrerendered",!1),r(this,"currentBg",0),r(this,"gradMult",1),r(this,"gradMultTarget",1),r(this,"prevUseFluid",!1),r(this,"speed",!1)}get mixins(){return[ta]}init(){this.handle=this.addObject3D(new Ye),this.ctrls=this.add(Gh),this.fluid=U.fluidSim=U.fluidSim??new Eh({densityDissipation:.92,pressureDissipation:.1,velocityDissipation:.89,velocityStrength:2,simRes:64,radius:.024,iterations:2,curlStrength:0}),this.pfx=this.add(Oh),this.camera=this.add(Rh),this.item=this.add(this.item,{},this.handle),this.lighting=this.add(En),this.handle.add(this.shadows=new eh({material:new ih,scene:this})),this.bg=this.add(Lh),this.handle.rotation.x=-.1,bt((()=>this.isOnHome="Home"===U.$app.$router.currentRoute.value.name)),bt((()=>this.isMobileLayout=U.$app.$store.ui.mobile))}async preload(){if(this.preloadPromise)return this.preloadPromise;this.preloadPromise=wt(),this.preloadPromise.resolve()}prerender(){this.isPrerendered||this.webgl.$app.$controls.touch.useTouch||this.fluid.prerender()}async resetEnter(){this.item.dominantColor&&this.changeBackgroundColor(this.item.dominantColor,!0),this.item.forceVisibility(),this.triggerRender(),this.item.setToBeforeEnter(),this.item.mouseOffset.setScalar(0);const e=this.ctrls;e.zoom=e.scrollDelta=e.rx=e.rxVel=e.rxTarget=e.ry=e.ryTarget=0,await new Promise((e=>requestAnimationFrame(e))),await new Promise((e=>requestAnimationFrame(e)))}enter(){this.log("ENTER PREVIEW"),this.item.triggerEnter(!0)}swapItem(){}changeBackgroundColor(e,t){if(this.bgs||(this.bgs=Object.keys(ma.uniforms).reduce(((e,t)=>(t.match(/color\d+/)&&e.push(new Qt(0,0,0,0)),e)),[])),this.currentDominantColor=e,qh.set(e),qh.getHSL(qh),qh.l>.6&&qh.s<.05?this.gradMultTarget=1:this.gradMultTarget=0,Hh.set(e).convertLinearToSRGB(),qh.set(e).lerp(Hh,.5),t){this.currentBg=0;for(let e=0;e<this.bgs.length;e++)this.clearAnim("bg_"+e),this.bgs[e].set(qh.r,qh.g,qh.b,1)}else{this.currentBg=(this.currentBg+1)%this.bgs.length;const e="bg_"+this.currentBg;this.clearAnim(e);const t=this.timeline(e),s=this.bgs[this.currentBg];s.set(qh.r,qh.g,qh.b,0),t.to(s,{w:1,duration:800,easing:"outCubic"})}for(let s=0;s<this.bgs.length;s++){const e=(1+s+this.currentBg)%this.bgs.length;ma.uniforms["color"+(s+1)].value=this.bgs[e]}}beforeUpdate(){this.camera.beforeSceneUpdate()}useFluid(){return!U.$app.$controls.touch.useTouch&&U.$quality.current.value>4}triggerLeave(){super.triggerLeave(),this.bg.needsHomeAnimation=!1}update(){const e=U.$app.$controls.touch,t=this.useFluid(),s=U.$time.dt;let i=this.item.dominantColor;if(this.currentDominantColor!==i&&this.changeBackgroundColor(i,!1),this.gradMult=kt(this.gradMult,this.gradMultTarget,.1,s),t){const{delta:t,normalizePos:i}=e,r=Math.sqrt(t.x*t.x+t.y*t.y),n=Ss(r,8,50);this.speed=kt(this.speed,n,.1,s),n>.001&&this.speed>.001&&this.fluid.emit({x:.5*i.x+.5,y:.5*i.y+.5,dx:t.x*this.speed,dy:-t.y*this.speed,dz:2*this.speed})}this.prevUseFluid!==t&&(this.bg.mat.fluidMap=t?this.fluid.texture:U.$assets.textures.null,this.prevUseFluid=t),this.bg.mat.useBottomGrad=this.isOnHome?0:1,this.bg.mat.gradMult=this.isOnHome?0:this.gradMult}render(){this.useFluid()&&this.fluid.render(),this.pfx.render()}}let Vh=0;class $h extends Ko{created(){this._animsArray=[],this._animsMap=new Map,this.base.timeline=vt(this.timeline,this,2),this.base.tween=vt(this.tween,this,2),this.base.clearAnim=vt(this.clearAnim,this,1),this.base.isAnimRunning=vt(this.isAnimRunning,this,1)}clearAnim(e){if(void 0!==e)return this._removeAnim(e);for(let t=this._animsArray.length-1;t>=0;t--)this._removeAnim(!0,t,this._animsArray[t])}_addAnim(e,t){return this._animsArray.push(t),void 0===e||(t.__id=e??"ANIM_AUTOID_"+Vh++,this._animsMap.set(e,t)),t}_removeAnim(e,t,s){if(void 0!==e&&(s=s??this._animsMap.get(e)))return s.isTimeline?s.destroy(!0,!0,!0):s.destroy(),this._animsMap.delete(e),this._animsArray.splice(t??this._animsArray.indexOf(s),1),s}isAnimRunning(e){const t=this._animsMap.get(e);return t&&!t.isCompleted}tween(e,{selfDestruct:t=!0,...s}={}){this._animsMap.get(e)&&this.clearAnim(e);const i=Zt({...s,manualUpdate:!0});return i.__selfDestruct=t,this._addAnim(e,i),i}timeline(e,{selfDestruct:t=!0,...s}={}){this._animsMap.get(e)&&this.clearAnim(e);const i=es({...s,manualUpdate:!0});return i.__selfDestruct=t,this._addAnim(e,i),i}update(){let e=U.$time.dt;e>22&&(e=22);for(let t=this._animsArray.length-1;t>=0;t--){const s=this._animsArray[t];s?s&&s.__selfDestruct&&(s.isCompleted||s.destroyed)?this._removeAnim(s.__id,t):s.update(e):this._removeAnim(s.__id,t)}}destroyed(){this.clearAnim(null)}}const Yh=Rn("precision highp float;\n#include <conditionals>\n#define PI 3.1415926535897932384626433832795\nvarying vec2 vUv;uniform vec4 res;uniform float diag;uniform vec3 fillColor;uniform float fillProgress;uniform float fillType;uniform float invert;float linearstep(float begin,float end,float t){return clamp((t-begin)/(end-begin),0.0,1.0);}float roundbox(vec2 sp,float size){sp=(sp-0.5)*2.0;float cornerRadius=0.1;vec2 halfSize=vec2(size+cornerRadius*0.25);sp=abs(sp)-halfSize+cornerRadius;float box=length(max(sp,0.0))+min(max(sp.x,sp.y),0.0)-cornerRadius;return box;}const float eps=0.0001;const vec3 green=vec3(0.0003,0.0262,0.0091)*3.0;void main(){float gm=40.;vec2 spm=res.xy*res.w*0.5;vec2 uv=vUv;vec2 pxUv=(uv*2.-1.)*spm;vec2 gridUv=fract(pxUv/gm);vec2 stepUv=floor(pxUv/gm)*gm/spm;vec3 c=fillColor;vec2 bsuv=stepUv*0.5+vec2(0.,0.5);bsuv.y=linearstep(-0.02,1.0,bsuv.y);float alpha=0.;float a;float p;float cd=distance(stepUv*vec2(1.,res.y/res.x),vec2(0.,0.))/(diag*1.07);p=fillProgress*2.-1.;a=linearstep(max(p,0.),min(p+1.,1.),cd);a*=smoothstep(1.,0.8,p);a=mix(1.,a,smoothstep(-1.,-0.3,p));a=step(roundbox(gridUv,a),0.0001)*smoothstep(0.,0.2,a);float preloaderOut=max(smoothstep(1.0,0.1,fillProgress)*0.5,a)*smoothstep(1.0,0.9,p);float isPreloader=when_lt(abs(fillType-1.0),0.5);c=mix(c,green,isPreloader);alpha+=preloaderOut*isPreloader;p=fillProgress;vec2 guv=floor(uv*10.)/10.;float ox=sin(guv.x*PI)*sin(p*PI)*2.5+1.0;a=smoothstep(p+mix(0.,0.1+ox,p),p-mix(0.1,0.,p),vUv.y);float isGradient=when_lt(abs(fillType-2.0),0.5);float gradient=mix(a,1.-a,invert)*isGradient;float gradientFade=smoothstep(0.0,0.85,p)*isGradient;gradientFade=mix(gradientFade,1.-gradientFade,invert);c=mix(c,vec3(0.),isGradient);c=mix(c,mix(fillColor,c,gradientFade-gradient),isGradient);alpha+=max(alpha,max(gradient,gradientFade*0.5)*isGradient);float fade=mix(fillProgress,1.-fillProgress,invert);alpha+=fade*when_lt(abs(fillType-3.0),0.5);gl_FragColor=vec4(c,alpha);}","fragmentShader"),Jh=1e-4,Kh=document.createElement("aside");document.body.appendChild(Kh),Kh.className="spinner",Object.assign(Kh.style,{zIndex:200,position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"0.65em",height:"3.7em",background:"#16a629",opacity:0,transition:"opacity 50ms",pointerEvents:"none",animation:"loadSpinCenter 500ms infinite ease"});class Wh extends xn{constructor(){super(...arguments),r(this,"hiddenTimeout",0),r(this,"visibleSpinnerTime",0),r(this,"hideSpinnerTime",0),r(this,"needsAdditionalDelay",!1),r(this,"needsAdditionalDelayAt",0),r(this,"spinnerDelay",600),r(this,"reqAnim",0)}get mixins(){return[$h]}init(){this.cursor=U.$app.$cursor.useCursor(100,null),this.filter=Ys({name:"OverlayFilter",renderer:U.$overlay.renderer,useRawShader:!1,fragmentShader:Yh,extensions:{derivatives:!0},uniforms:{res:U.$uniforms.res,diag:{value:0},fillProgress:{value:0},fillColor:{value:new c(0)},fillType:{value:1},invert:{value:0}}}),U.$viewport.size.watchImmediate((e=>{const t=Math.sqrt(e.width**2+e.height**2);this.filter.uniforms.diag.value=t/e.width})),this.preloaderOut=this.preloaderOut.bind(this),this.gradientIn=this.gradientIn.bind(this),this.gradientOut=this.gradientOut.bind(this),this.fadeIn=this.fadeIn.bind(this),this.fadeOut=this.fadeOut.bind(this)}triggerRender(){const e=U.$time.dt,t=this.filter.uniforms;this.isHidden&&t.fillType.value>1?this.hiddenTimeout-=e:this.hiddenTimeout=500,this.hiddenTimeout<0||this.filter.render()}update(){const e=U.$time.dt,t=this.filter.uniforms;0===t.invert.value&&t.fillProgress.value>.5||1===t.invert.value&&t.fillProgress.value<.3?this.cursor.set("wait"):this.cursor.set(null);if(t.fillType.value>1&&(0===t.invert.value&&t.fillProgress.value>.4||1===t.invert.value&&t.fillProgress.value<.05)){const t=this.visibleSpinnerTime,s=this.visibleSpinnerTime+=e,i=this.spinnerDelay;this.hideSpinnerTime=0,t<i&&s>=i&&(Kh.style.visibility="visible",Kh.style.animationPlayState="running",Kh.style.transitionDuration="600ms",this.needsAdditionalDelayAt=performance.now()),s>=i?(this.needsAdditionalDelay=!0,Kh.style.opacity=1):this.needsAdditionalDelay=!1}else{const t=this.hideSpinnerTime;this.hideSpinnerTime+=e,this.visibleSpinnerTime=0,0===t&&(Kh.style.transitionDuration="150ms"),Kh.style.opacity=0,this.hideSpinnerTime>2e3&&(Kh.style.visibility="hidden",Kh.style.animationPlayState="paused")}}async consumeSpinnerDelay(){if(!this.needsAdditionalDelay)return;this.needsAdditionalDelay=!1;const e=800-(performance.now()-this.needsAdditionalDelayAt);e<=1||await Wt(e)}preloaderOut(e=!1){const t=this.filter.uniforms;if(++this.reqAnim,this.clearAnim("anim"),t.invert.value=1,!e)return new Promise((e=>{this.clearAnim("anim");const t=this.filter.uniforms,s=this.timeline("anim");t.fillProgress.value=0,t.fillType.value=1,t.fillColor.value.set(0,0,0),s.to(t.fillProgress,{value:1,duration:1500,easing:hs(.5,.005,.25,.995),onUpdate:t=>{t>.8&&e()}})}));t.fillProgress.value=1}gradientIn(e=!1){return++this.reqAnim,this.clearAnim("anim"),e&&this.isHidden||!e&&this.isFilled?Promise.resolve():new Promise((t=>{const s=this.filter.uniforms,i=this.timeline("anim",{onComplete:t});s.invert.value=e?1:0,s.fillProgress.value=0,s.fillType.value=2,s.fillColor.value.set(1,1,1),i.to(s.fillProgress,{value:1,duration:e?1200:400,easing:e?"outQuint":"inQuad",onUpdate:s=>{e&&s>.01&&t()}}),e||i.wait(20)}))}gradientOut(){return this.gradientIn(!0)}fadeIn(e=!1){return++this.reqAnim,this.clearAnim("anim"),e&&this.isHidden||!e&&this.isFilled?Promise.resolve():new Promise((t=>{const s=this.filter.uniforms,i=this.timeline("anim",{onComplete:t});s.invert.value=e?1:0,s.fillProgress.value=0,s.fillType.value=3,s.fillColor.value.set(1,1,1),i.to(s.fillProgress,{value:1,duration:e?900:150,easing:e?"outQuad":"inQuad"}),e||i.wait(50)}))}fadeOut(){return this.fadeIn(!0)}get isHidden(){const e=this.filter.uniforms;return 0===e.invert.value&&e.fillProgress.value<Jh||1===e.invert.value&&e.fillProgress.value>1-Jh}get isFilled(){const e=this.filter.uniforms;return 0===e.invert.value&&e.fillProgress.value>1-Jh||1===e.invert.value&&e.fillProgress.value<Jh}}r(Wh,"pluginMethods",["consumeSpinnerDelay"]);const jh=[function(e){const t=l(20),s=l(6);let i=!1,r=performance.now(),n=!1;const o=l(20);let c=0,h=0,u=0;const g=l(6);e.$hooks.afterSetup.watchOnce((()=>{e.$viewport&&e.$viewport.visible.watch((()=>i=!0))})),e.$hooks.afterFrame.watchOnce((()=>{i=!0}));const d=e.$time={dt:0,qualityDt:0,clampedDt:0,averageDt:16.6667,stableDt:16.6667,elapsed:0,playingElapsed:0,frameNum:0,isPaused:!0,isStarted:!0,clampFps:0,set clampTo60Fps(e){d.clampFps=e?60:0},start:function(){n?d.isStarted=!0:(d.customLoop?d.customLoop(p):a.add(p),n=!0,d.isStarted=!0,d.isPaused=!1)},stop:function(){d.isStarted=!1},resume:function(){d.isPaused=!1},pause:function(){d.isPaused=!0},customLoop:null};function p(n){const a=r;if(r=performance.now(),0===(n=r-a)&&(n=16.6667),i&&(i=!1,n=16.6667,t.reset(),s.reset(),g.reset(),h=c=u=0,o.reset()),d.clampFps>0){const e=o.push(n),t=1e3/d.clampFps,s=Math.max(0,t-e);if(h+=s,h>=t)return c=0,h=Math.max(0,h-t),void(u+=n);c>=10?h=c=0:c+=1,n+=u,u=0}d.qualityDt=g.push(n),d.clampedDt=A(void 0===n?16.6667:n,1,130),d.averageDt=t.push(n);let l=d.averageDt;for(let e=0,t=Ms.length;e<t;e++){const t=Ms[e];if(l>=t[2]){l<=t[0]&&(l=t[1]);break}}d.stableDt=s.push(l),d.dt=n,d.frameNum=(d.frameNum+1)%Ts,d.elapsed+=n,d.t=d.elapsed,d.sdt=d.stableDt,d.isStarted&&(d.isPaused||(d.playingElapsed+=n),e.$hooks.frame())}},function(e){let t;const s=new c(16777215),i=h(new u),r=h(1);let n=1,o=2,a=_s["3k"];const l={antialias:!1,alpha:!1,depth:!0,stencil:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"},C={beforeInit:m(),afterInit:m()},B=e.$renderer={setup:function({Renderer:r,...n}={}){var o;Object.assign(l,n),l.canvas=e.$canvas,C.beforeInit.emit();t=new(r??I)(l),g(t),t.debug={checkShaderErrors:!1},e.$renderer.instance=t,e.$threeRenderer=t,B.isWebGL2=!!((null==(o=null==t?void 0:t.capabilities)?void 0:o.isWebGL2)??1),t.getDrawingBufferSize(i.value),E(),t.setClearColor(s,1),t.autoClear=!1,t.shadowMap.enabled=!1,t.shadowMap.type=d,t.info.autoReset=!1,e.$hooks.beforeFrame.watch((()=>t.info.reset())),C.afterInit.emit(),e.$viewport.changed.watch(E)},options:l,hooks:C,clearColor:s,resize:E,setMinPixelRatio:function(e){if(n===e)return;n=e,y()},setMaxPixelRatio:function(e){if(o===e)return;o=e,y()},setMaxPixelCount:function(e){if("string"==typeof e){if(!(e=_s[e.toLowerCase()]))return}else null==e&&(e=0);a=e,y()},drawingBufferSize:i,pixelRatio:r};let v=!1;function y(){v||(v=!0,e.$hooks.beforeFrame.watchOnce(E))}function E(){v=!1;let s=A(e.$viewport.pixelRatio.value,n,o);const l=e.$viewport.size.value,c=u.get();let h=s*l.x*l.y;a>0&&h>a&&(s/=h/a),t.getSize(c),t.getPixelRatio()!==s&&t.setPixelRatio(s),c.equals(l)||t.setSize(l.x,l.y),function(){const e=i.value,s=u.get();t.getDrawingBufferSize(s),p(),s.equals(e)||i.set(e.copy(s),!0);r.set(t.getPixelRatio()),s.release(),f()}(),c.release()}},function(e,t={}){const s=e.$app.$viewport,i=h(new u(s.width,s.height)),r=h(i.value.x/i.value.y),n=h(s.pixelRatio),o=h(s.visible),a=m(),A=t.debounceDelay??150;let l=A<=0?y:C(y,A);e.$viewport={size:i,visible:o,ratio:r,pixelRatio:n,changed:a,resize:I,useManualResize:t.useManualResize??!1,frame:E,set debounceDelay(e=16){l=e<=0?e:C(y,e)},setDebounce(e=16,t={},s=!1){l=e<=0?e:C(y,e,t,s)}};let c=0,g=0,d=0;function I(){e.$canvas.style.width=s.width+"px",e.$canvas.style.height=s.height+"px",l()}function y(){c=s.width,g=s.height,d=s.pixelRatio}function E(){const e=i.value,t=e.x!==c||e.y!==g,s=n.value!==d;(t||s)&&(p(),t&&(e.set(c,g),i.set(e,!0),r.set(e.x/e.y)),s&&n.set(d),a.emit(),f())}B(s,(()=>{e.$viewport.useManualResize||I(s.width,s.height)}),{immediate:!0}),v((()=>{o.set(s.visible)})),e.$hooks.afterStart.watchOnce(I),e.$hooks.beforeFrame.watch(E)},function(e){var t;const s="webgl-quality",i=300,r=(null==(t=null==e?void 0:e.$app)?void 0:t.$localStorage)??localStorage;let n=58,o=52,a=30,l=i,c=i,u=0,g=0,d=!1,p=!1,f=5,m=5,I=10;const C=new Float64Array(3);let B=0;const v=new Float64Array([-1,-1,-1]);let E=0,w=0,Q=!1;const x=h(60),b=h(60),S=h(1);e.$hooks.afterSetup.watchOnce((function(){const t=e.$app.$device,i=t&&t.gpu?t.gpu.qualityIndex:3,n=function(){const e=r.getItem(s);return null==e||isNaN(e)?null:0|e}(),o=null!=n?n:i;S.watch((e=>{t&&t.updateQuality(e),function(e){r.setItem(s,e)}(e)})),_(o),e.$hooks.beforeFrame.watch(M)})),e.$hooks.beforeStart.watchOnce((async function(){const t=e.$viewport;t.visible.watch((()=>T()));const s=t.size.value;let r=s.x*s.y;t.changed.watch((()=>{const e=t.size.value,s=e.x*e.y;Math.abs(r-s)<2e5?T(!1,i):(r=s,T(!0,i))}))}));const R=e.$quality={get pingPongScore(){return E},get bigPingPongScore(){return w},fps:x,fpsAverage:b,quality:S,current:S,pause:function(e){D=e,Q=!0},resume:function(e=150,t){if(t&&D!==t)return;Q=!1,T(!1,e)},reset:(e=300)=>T(!1,e),hardReset:(e=300)=>T(!0,e),updateQuality:F,limitQuality:e=>{m=A(e,0,5),F()},setThresholds:function(e={}){e.high&&(n=e.high);e.low&&(o=e.low);e.critical&&(a=e.critical)}};let D=null;function T(e,t){d=!0,p=p||e,t&&(l=t)}function M(){if(I>0)return I--;const t=e.$time.qualityDt;if(d&&(u=0,g=0,p&&(f=5,B=0,E=0,w=0),c=l||i,d=p=!1,l=i),c>0)return c-=t;u+=t,g++,u>=1e3&&function(){Q||(C[B++]=g,B%=C.length+1);x.set(g),g=0,u%=1e3,Q||B!=C.length||F()}()}function _(e){v[2]=v[1],v[1]=v[0],v[0]=e,S.set(e)}function F(e){let t=v[0];const s=y(C);e?t=e:s<=a?t-=2:s<o?t-=1:s>n&&(t+=1),t=A(t,0,Math.min(m,f)),t===v[0]?(E=Math.max(0,E-.2),w=Math.max(0,w-.2)):t!==v[0]&&t!==v[1]?E=0:t===v[1]&&(E+=1),t===v[2]&&t<v[0]&&w++,E>=2&&(f=Math.min(v[1],v[0],f,m),E=0),w>=2&&(f=Math.min(y(v),f,m),w=0),t=Math.min(t,f,m),t!==S.value&&_(t),b.set(s)}return R},function(e){var t;const s={createBuffer:function(e){return Us(e)},registerBuffer:Js,unregisterBuffer:Js};(null==(t=null==e?void 0:e.$debug)?void 0:t.storage)??localStorage,e.$fbo=s},function(e){mt.registerLoader(dn),mt.registerLoader(lr),mt.registerLoader(un),mt.registerLoader(xi),mt.registerLoader(Si),mt.registerLoader(gn);const{$hooks:t,$app:s}=e,{$baluchon:i,$preloader:r}=s;let n;t.afterSetup.watchOnce((()=>{lr.detectSupport(e.$threeRenderer),un.initDRACOLoader(),n=new It(e.$renderer.instance),n.compileEquirectangularShader()}));const o=e.$assets={};o.materials={},o.nullRT=new E(1,1),o.plane=e=>new Mesh(new PlaneGeometry,e),o.sphere=e=>new Mesh(new Ct,e);const a={ktx2:v,basis:v,tex:B,spritesheet:async function({id:e,file:t,...s}){const i="spritesheet-"+e,[r]=await Promise.all([mt.load(t.data),B({id:i,file:t,flipY:!1,...s})]),n=p[e]=function(e,t={}){const s={sprites:{},meta:e.meta},i=e.frames,r=null==t.keepRatio||t.keepRatio;e.animations||(e.animations={});for(const n in e.animations){const t=e.animations[n],o=s.sprites[n]=[];for(let s=0,a=t.length;s<a;s++){const a=i[t[s]];a.keepRatio=r,delete i[t[s]],o.push(Ws(a,e.meta,n,s))}}for(const n in i){const t=i[n];t.keepRatio=r;const o=(t.filename?t.filename.toString():n).replace(/[^a-zA-Z0-9-_-]/g,"").replace("png",""),a=s.sprites[o]=[];delete i[n],a.push(Ws(t,e.meta,o,0))}return s}(r,s.opts);return n.texture=d[i],n},gltf:async function({id:e,file:t,onLoad:s}){let i=await mt.load(t.url??t);s&&(i=s(i)??i);return l[e]=i},json:async function({id:e,file:t}){const s=await mt.load(t);return c[e]=s},hdr:async function({id:e,file:t,opts:s}){const i=await mt.load(t),r=n.fromEquirectangular(i),o=d[e]=r.texture;return d[e]=o},exr:async function({id:e,file:t,opts:s}){const i=await mt.load(t),r=n.fromEquirectangular(i),o=d[e]=r.texture;return d[e]=o},bin:async function({id:e,file:t,onLoad:s}){let i=await mt.load(t);s&&(i=await s(i));return K.add(t,i),u[e]=i,i}};a.avif=a.webp=a.jpg=a.png=a.tex,a.glb=a.gltf;const A={},l={},c={},h={},u={},g=new ue(new Uint8Array([0,0,0,0]),1,1);g.isNullTexture=!0;const d={null:g,currentTileableNormal:g,sticker:g},p={},f=[];d.null.needsUpdate=!0;const m={curve:function(e){return A[e]},json:function(e){return c[e]},texture:function(e){return d[e]??d["spritesheet-"+e]},textures:function(e){const t=Object.keys(d),s={};for(let i=0,r=t.length;i<r;i++){const r=t[i];r.includes(e)&&(s[r]=d[r])}return s},envmap:function(e){return h[e]},spritesheet:function(e){return p[e]},object:function(e){return l[e]}};Object.assign(o,{jsons:c,curves:A,envmaps:h,textures:d,spritesheets:p,objects:l,buffers:u,load:function(e,t={}){return f[e]?f[e]:f[e]=function(e,{onLoad:t,type:s,id:n,...o}={}){var A;const l=r.finished?pn:r.task;let c=i.get(e);Array.isArray(c)&&(c=null==(A=c[0])?void 0:A.value);if(!c)return;const h=c.url??c;if(!h)return;n=n||e.split("/").pop(),!s&&c.data&&c.data.endsWith("json")&&(s="spritesheet");if(s)return l(a[s]({id:n,file:c,onLoad:t,opts:o}));const u=h.split(".").pop(),g=a[u];if(!g)return;return l(g({id:n,file:c,url:h,onLoad:t,opts:o}))}(e,t)},get:m,loadPaintTexture:function(e){if(!e)return;if(e.startsWith("https://storage.googleapis.com/")){const t=(e=(e=e.replace("https://storage.googleapis.com/","")).split("/")).shift();e="https://"+t+".storage.googleapis.com/"+e.join("/")}return new Promise((t=>{const s=new Image;s.loading="eager",s.src=e,s.crossOrigin="anonymous";const i=async()=>{const i={node:s,url:e};K.add(e,i);const r=await createImageBitmap(s,{premultiplyAlpha:"none",colorSpaceConversion:"none"});i.tex=Ks({img:r,srgb:!1}),t(i)},r=e=>{t()};s.decode?(s.src=e,s.decode().then(i).catch(r)):(s.onload=i,s.onerror=r,s.decoding="async",s.src=e)}))}});const I=["normal","roughness","metalness","ao","displacement","specular","rmo","orm"].join("|"),C=new RegExp(`(${I})`,"i");async function B({id:e,file:t,opts:s}){const i=t.url??t;if(i.endsWith(".ktx2"))return v({id:e,file:t,opts:s});const{node:r}=await mt.load(i),n=s.flipY??!1,o=s.premultiplyAlpha??!1,a=await createImageBitmap(r,{imageOrientation:n?"flipY":void 0,premultiplyAlpha:o?"premultiply":"none",colorSpaceConversion:!1===s.srgb?"none":"default"});s.flipY=void 0,s.premultiplyAlpha=void 0;const A=d[e]=Ks({id:e,img:a,srgb:!C.test(e),...s});return s.envmap?y(e,d[e],s):A}async function v({id:e,file:t,opts:s}){if(!t.url.endsWith(".ktx2"))return B({id:e,file:t,opts:s});const i=await mt.load(t.url);return s.repeat&&(i.wrapS=i.wrapT=q),void 0!==s.flipY&&(i.flipY=s.flipY),void 0!==s.linear&&(i.minFilter=i.magFilter=w),void 0!==s.srgb?i.colorSpace=s.srgb?"srgb":"srgb-linear":i.colorSpace="srgb",!1===s.srgb&&(i.colorSpace=x),i.needsUpdate=!0,d[e]=i,i.userData.file=t,!1===s.mips&&(i.generateMipmaps=!1),s.envmap?y(e,i,s):i}function y(e,t,s={}){const i=h[e]=t.clone();i.mapping=Bt,s.srgb&&(i.colorSpace=S),s.srgbLinear&&(i.colorSpace=$),s.data&&(i.colorSpace=x),i.needsUpdate=!0}},function(e){const t={},s=e.$scenes={list:t,preload:i,current:null,set:function(e){if(!e)return;s.current&&(s.current.isLeaving=!0,s.current.isEntering=!1);"string"==typeof e&&(e=t[e]);e.enterPromise=null,e.leavePromise=null,e.isLeaving=!1,e.isEntering=!1,e.isEntered=!1,s.current=e},enter:async function(e,i={}){if(!e)return;"string"==typeof e&&(e=t[e]);if(e.isEntering)return;const a=++o;s.current!==e&&await A(s.current);n&&await n;if(a!==o)return;r=wt(),s.current=e,await e.triggerEnter(i),r.resolve(),r=null},leave:A,update:function(){s.current&&s.current.triggerUpdate()},render:function(){s.current&&s.current.triggerRender()}};function i(){return Promise.all(Object.values(t).map((e=>{var t;return null==(t=e.preload)?void 0:t.call(e)})))}let r;e.$hooks.afterSetup.watchOnce((function(){t.editor=new Ah(e),t.gallery=new ch(e),t.preview=new zh(e)})),e.$hooks.afterStart.watchOnce((function(){})),e.preload=i;let n,o=0,a=0;async function A(e,i={}){if(!e)return;if("string"==typeof e&&(e=t[e]),e!==s.current||e.isLeaving)return;const o=++a;r&&await r,o===a&&(n=wt(),await e.triggerLeave(i),s.current===e&&(s.current=null),n.resolve(),n=null)}},function(e){let t;e.$hooks.afterSetup.watchOnce((function(){t=e.$renderer;const r=document.createElement("canvas"),n=document.createElement("aside");n.className="webgl-wrapper-top",Object.assign(n.style,{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:10,overflow:"clip",pointerEvents:"none",userSelect:"none"}),n.appendChild(r),document.body.appendChild(n),s.renderer=new I({...t.options,canvas:r,alpha:!0}),s.renderer.debug={checkShaderErrors:!1},s.renderer.autoClear=!1,t.drawingBufferSize.watchImmediate(i)})),e.$hooks.beforeStart.watchOnce((function(){s.scene=new Wh,s.scene.triggerInit();const e=[...Wh.pluginMethods??[]];for(const t in s.scene)(t.endsWith("Out")||t.endsWith("In"))&&e.push(t);[...new Set(e)].forEach((e=>{const t=s.scene[e];s[e]="function"==typeof t?t.bind(s.scene):t}))})),e.$hooks.afterUpdate.watch((function(){s.scene.triggerUpdate()})),e.$hooks.afterRender.watch((function(){s.scene.triggerRender()}));const s=e.$overlay={};function i(e){const i=t.pixelRatio.value;s.renderer.setPixelRatio(i),s.renderer.setSize(e.x/i,e.y/i)}}],Xh=Object.freeze(Object.defineProperty({__proto__:null,default:"float mixmap(float value,float min1,float max1,float min2,float max2){return min2+(value-min1)*(max2-min2)/(max1-min1);}float mixnorm(float value,float min1,float max1){return(value-min1)/(max1-min1);}"},Symbol.toStringTag,{value:"Module"})),Zh=Object.freeze(Object.defineProperty({__proto__:null,default:"const float kCharBlank=12.0;const float kCharMinus=11.0;const float kCharDecimalPoint=10.0;float InRect(const in vec2 vUV,const in vec4 vRect){vec2 vTestMin=step(vRect.xy,vUV.xy);vec2 vTestMax=step(vUV.xy,vRect.zw);vec2 vTest=vTestMin*vTestMax;return vTest.x*vTest.y;}float SampleDigit(const in float fDigit,const in vec2 vUV){const float x0=0.0/4.0;const float x1=1.0/4.0;const float x2=2.0/4.0;const float x3=3.0/4.0;const float x4=4.0/4.0;const float y0=0.0/5.0;const float y1=1.0/5.0;const float y2=2.0/5.0;const float y3=3.0/5.0;const float y4=4.0/5.0;const float y5=5.0/5.0;vec4 vRect0=vec4(0.0);vec4 vRect1=vec4(0.0);vec4 vRect2=vec4(0.0);if(fDigit<0.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x1,y1,x2,y4);}else if(fDigit<1.5){vRect0=vec4(x1,y0,x2,y5);vRect1=vec4(x0,y0,x0,y0);}else if(fDigit<2.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x0,y3,x2,y4);vRect2=vec4(x1,y1,x3,y2);}else if(fDigit<3.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x0,y3,x2,y4);vRect2=vec4(x0,y1,x2,y2);}else if(fDigit<4.5){vRect0=vec4(x0,y1,x2,y5);vRect1=vec4(x1,y2,x2,y5);vRect2=vec4(x2,y0,x3,y3);}else if(fDigit<5.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x1,y3,x3,y4);vRect2=vec4(x0,y1,x2,y2);}else if(fDigit<6.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x1,y3,x3,y4);vRect2=vec4(x1,y1,x2,y2);}else if(fDigit<7.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x0,y0,x2,y4);}else if(fDigit<8.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x1,y1,x2,y2);vRect2=vec4(x1,y3,x2,y4);}else if(fDigit<9.5){vRect0=vec4(x0,y0,x3,y5);vRect1=vec4(x1,y3,x2,y4);vRect2=vec4(x0,y1,x2,y2);}else if(fDigit<10.5){vRect0=vec4(x1,y0,x2,y1);}else if(fDigit<11.5){vRect0=vec4(x0,y2,x3,y3);}float fResult=InRect(vUV,vRect0)+InRect(vUV,vRect1)+InRect(vUV,vRect2);return mod(fResult,2.0);}float PrintValue(const in vec2 vStringCharCoords,const in float fValue,const in float fMaxDigits,const in float fDecimalPlaces){float fAbsValue=abs(fValue);float fStringCharIndex=floor(vStringCharCoords.x);float fLog10Value=log2(fAbsValue)/log2(10.0);float fBiggestDigitIndex=max(floor(fLog10Value),0.0);float fDigitCharacter=kCharBlank;float fDigitIndex=fMaxDigits-fStringCharIndex;if(fDigitIndex>(-fDecimalPlaces-1.5)){if(fDigitIndex>fBiggestDigitIndex){if(fValue<0.0){if(fDigitIndex<(fBiggestDigitIndex+1.5)){fDigitCharacter=kCharMinus;}}}else{if(fDigitIndex==-1.0){if(fDecimalPlaces>0.0){fDigitCharacter=kCharDecimalPoint;}}else{if(fDigitIndex<0.0){fDigitIndex+=1.0;}float fDigitValue=(fAbsValue/(pow(10.0,fDigitIndex)));fDigitCharacter=mod(floor(0.0001+fDigitValue),10.0);}}}vec2 vCharPos=vec2(fract(vStringCharCoords.x),vStringCharCoords.y);return SampleDigit(fDigitCharacter,vCharPos);}float printNumbers(in vec2 fragCoord,const in vec2 vPixelCoords,const in vec2 vFontSize,const in float fValue,const in float fMaxDigits,const in float fDecimalPlaces){return PrintValue((fragCoord.xy-vPixelCoords)/vFontSize,fValue,fMaxDigits,fDecimalPlaces);}"},Symbol.toStringTag,{value:"Module"})),eu=Object.freeze(Object.defineProperty({__proto__:null,default:"float when_lt(float x,float y){return max(sign(y-x),0.0);}vec2 when_lt(vec2 x,vec2 y){return max(sign(y-x),0.0);}vec3 when_lt(vec3 x,vec3 y){return max(sign(y-x),0.0);}vec4 when_lt(vec4 x,vec4 y){return max(sign(y-x),0.0);}"},Symbol.toStringTag,{value:"Module"}));new u;const tu=Rs({data:yo,methods:{async loadSticker(e){if(U.$app.$editor.config.stickers.includes(e))return U.$assets.load(`stickers/${e}`,{id:`sticker_${e}`,mipmaps:!1})},async loadPattern(e){if(U.$app.$editor.config.toolParams.patternType.list.includes(e))return U.$assets.load(`patterns-tex/${e}_tex`,{id:`pattern_${e}`,repeat:!0})},async loadLogo(e){const t=U.$app.$editor.config.logos[e];if(!t)return;return(0,U.$assets.load)(`logos-tex/${t.path}`,{id:`logo_${t.id}`,srgb:!1})}},shaderChunks:Object.assign({"./shaders/chunks/mixmap.glsl":Xh,"./shaders/chunks/print_numbers.glsl":Zh,"./shaders/chunks/when_lt.glsl":eu}),plugins:[],async setup(){U.$uniforms=function(){const e={res:{value:new Qt},time:{value:0},editorPausableTime:{value:0}};U.$renderer.drawingBufferSize.watchImmediate((t=>{const s=U.$renderer.pixelRatio.value;e.res.value.set(t.width,t.height,t.width/t.height,1/s)}));let t=1;return U.$hooks.beforeUpdate.watch((()=>{const s=U.$time.dt/1e3,i=(e.time.value+s)%4e7;if(e.time.value=i,U.$scenes.list.editor.renderBounds)t=0;else{t=kt(t,1,.04,U.$time.dt);const i=s*t,r=(e.editorPausableTime.value+i)%4e7;e.editorPausableTime.value=r}})),e}();const{$renderer:e,$viewport:t}=U;e.setup({antialias:!1,depth:!1,stencil:!1,alpha:!1}),e.precision="highp",t.setDebounce(10);e.instance.setClearColor(0,1),U.$app.$device.type.phone&&e.setMaxPixelRatio(2),U.$quality.current.watchImmediate(su)},async preload(){const{$assets:e,$scenes:t}=U,s=e.load,i=U.$app.$editor.edition;await Promise.all([s("envmaps-exr/envmapB",{id:"envmap_main",srgbLinear:!0}),s("noises/perlin",{id:"noise_perlin",repeat:!0}),U.loadPattern(i.toolParams.patternType)]),U.$log("preload done")},async start(){const{$renderer:e,$time:t}=U;e.resize(),t.clampTo60fps=!1,t.start()},update(){const{$scenes:e}=U;e.update()},async prerender(){U.isPrerendered=!0},render(){if(!U.isPrerendered)return;if(U.stopRender)return;const{$scenes:e}=U;U.$threeRenderer,e.render()}});function su(e){const{$fx:t,$renderer:s}=U,i=U.$app.$device.type.desktop;switch(e){case 5:s.setMaxPixelRatio(i?1.4:1.6),s.setMinPixelRatio(1),U.$app.$store.rtSamples=i?8:4;break;case 4:s.setMaxPixelRatio(i?1.25:1.4),s.setMinPixelRatio(1),U.$app.$store.rtSamples=4;break;case 3:s.setMaxPixelRatio(i?1.15:1.25),s.setMinPixelRatio(0),U.$app.$store.rtSamples=2;break;case 2:s.setMaxPixelRatio(1),s.setMinPixelRatio(0),U.$app.$store.rtSamples=2;break;case 1:s.setMaxPixelRatio(1),s.setMinPixelRatio(0),U.$app.$store.rtSamples=0;break;default:s.setMaxPixelRatio(.8),s.setMinPixelRatio(0),U.$app.$store.rtSamples=0}}function iu(e={}){return Ds({config:tu,defaultPlugins:jh,...e})}export{iu as loadWebgl};
